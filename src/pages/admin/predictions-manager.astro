---
/**
 * ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢
 * æ ¸ï¼ˆCoreï¼‰: è¤‡æ•°ã‚µã‚¤ãƒˆã§å…±é€šåˆ©ç”¨ã™ã‚‹åŸºç›¤ãƒ‡ãƒ¼ã‚¿
 * æ‹¡å¼µï¼ˆExtensionï¼‰: ã‚µã‚¤ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªé ˜åŸŸ
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢">
  <div class="container">
    <h1>ğŸ‡ ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢</h1>
    <p class="subtitle">
      è¤‡æ•°ã‚µã‚¤ãƒˆã§è‡ªå‹•èª¿æ•´å¯èƒ½ãªäºˆæƒ³å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ ¸ï¼‰
    </p>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯1: ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
    <section class="section">
      <h2>ğŸ“‹ [1] ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h2>
      <div class="race-info-form">
        <div class="form-row">
          <div class="form-group">
            <label for="raceDate">æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰</label>
            <input type="date" id="raceDate" required />
          </div>
          <div class="form-group">
            <label for="track">ç«¶é¦¬å ´</label>
            <select id="track" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å¤§äº•ç«¶é¦¬">å¤§äº•ç«¶é¦¬</option>
              <option value="èˆ¹æ©‹ç«¶é¦¬">èˆ¹æ©‹ç«¶é¦¬</option>
              <option value="å·å´ç«¶é¦¬">å·å´ç«¶é¦¬</option>
              <option value="æµ¦å’Œç«¶é¦¬">æµ¦å’Œç«¶é¦¬</option>
              <option value="ä¸­å±±ç«¶é¦¬">ä¸­å±±ç«¶é¦¬</option>
              <option value="æ±äº¬ç«¶é¦¬">æ±äº¬ç«¶é¦¬</option>
              <option value="é˜ªç¥ç«¶é¦¬">é˜ªç¥ç«¶é¦¬</option>
              <option value="äº¬éƒ½ç«¶é¦¬">äº¬éƒ½ç«¶é¦¬</option>
            </select>
          </div>
          <div class="form-group">
            <label for="raceNumber">ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <input
              type="text"
              id="raceNumber"
              placeholder="11R"
              required
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="raceName">ãƒ¬ãƒ¼ã‚¹å</label>
            <input
              type="text"
              id="raceName"
              placeholder="æ±äº¬è¨˜å¿µ"
              required
            />
          </div>
          <div class="form-group">
            <label for="distance">è·é›¢</label>
            <input
              type="text"
              id="distance"
              placeholder="ãƒ€2,400m"
              required
            />
          </div>
          <div class="form-group">
            <label for="horseCount">é ­æ•°</label>
            <input type="number" id="horseCount" min="1" max="18" required />
          </div>
          <div class="form-group">
            <label for="startTime">ç™ºèµ°æ™‚åˆ»</label>
            <input type="time" id="startTime" required />
          </div>
        </div>
      </div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯2: HTMLå…¥åŠ› -->
    <section class="section">
      <h2>ğŸ“¥ [2] ç«¶é¦¬ãƒ–ãƒƒã‚¯HTMLè²¼ã‚Šä»˜ã‘</h2>
      <p class="description">
        ç«¶é¦¬ãƒ–ãƒƒã‚¯ã®å‡ºé¦¬è¡¨HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆ<code>&lt;table&gt;...&lt;/table&gt;</code>ã‚’å«ã‚€å…¨ä½“ï¼‰
      </p>
      <textarea
        id="htmlInput"
        rows="10"
        placeholder="<table class='default syutuba'>...çœç•¥...</table>"
      ></textarea>
      <button id="extractBtn" class="btn-primary">ğŸ” è‡ªå‹•æŠ½å‡ºå®Ÿè¡Œ</button>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯3: æŠ½å‡ºçµæœ -->
    <section class="section" id="extractionResultSection" style="display: none;">
      <h2>âœ… [3] æŠ½å‡ºçµæœ</h2>
      <div id="extractionStatus"></div>
      <div class="table-wrapper">
        <table id="extractionTable" class="data-table">
          <thead>
            <tr>
              <th>é¦¬ç•ª</th>
              <th>é¦¬å</th>
              <th>umacd</th>
              <th id="predictorHeaders"></th>
              <th>ã‚ªãƒƒã‚º</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="extractionTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯4: å‡ºåŠ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <section class="section" id="previewSection" style="display: none;">
      <h2>ğŸ‘ï¸ [4] å‡ºåŠ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæŠ½å‡ºãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼‰</h2>
      <div id="previewContent" class="preview-content"></div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯5: ä¿å­˜ -->
    <section class="section" id="saveSection" style="display: none;">
      <h2>ğŸ’¾ [5] ä¿å­˜ï¼ˆGitHub API / Pushï¼‰</h2>
      <p class="description">
        æŠ½å‡ºã—ãŸäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’keiba-data-sharedãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ã—ã¾ã™ã€‚å„ã‚µã‚¤ãƒˆã§è‡ªç”±ã«åŠ å·¥ã—ã¦ãã ã•ã„ã€‚
      </p>
      <div id="saveStatus"></div>
      <button id="saveBtn" class="btn-success">ğŸš€ ä¿å­˜ã—ã¦Git Push</button>
    </section>
  </div>

  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background: #ffffff;
      color: #000000;
      min-height: 100vh;
    }

    .container p,
    .container div,
    .container span,
    .container td,
    .container th,
    .container li {
      color: inherit;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      background: none;
      color: #000000;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }

    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #333333;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }

    .description {
      color: #666666;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: #000000;
    }

    input,
    select,
    textarea {
      padding: 0.5rem;
      border: 1px solid #dddddd;
      border-radius: 4px;
      font-size: 1rem;
      background: #ffffff;
      color: #000000;
    }

    textarea {
      width: 100%;
      font-family: monospace;
      resize: vertical;
    }

    select[multiple] {
      padding: 0.5rem;
    }

    .btn-primary,
    .btn-success {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #dddddd;
      padding: 0.5rem;
      text-align: left;
      background: #ffffff;
      color: #000000;
    }

    .data-table th {
      background: #f3f4f6;
      font-weight: 600;
      color: #000000;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    .data-table tbody tr:hover td {
      background: #f9fafb;
      color: #000000;
    }

    .proposal {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .extension-panel {
      margin-top: 1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
      font-weight: 600;
    }

    .preview-content {
      background: #1f2937;
      color: #f3f4f6;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
    }

    .preview-content pre {
      margin: 0;
      font-family: monospace;
      font-size: 0.875rem;
    }

    code {
      background: #f3f4f6;
      padding: 0.125rem 0.25rem;
      border-radius: 2px;
      font-family: monospace;
    }

    #extractionStatus,
    #saveStatus {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
  </style>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let extractionResult = null;

    // ãƒ–ãƒ­ãƒƒã‚¯2: HTMLæŠ½å‡º
    document.getElementById("extractBtn").addEventListener("click", async () => {
      const html = document.getElementById("htmlInput").value;

      if (!html.trim()) {
        alert("HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
        return;
      }

      try {
        // æŠ½å‡ºå‡¦ç†ï¼ˆextractor.tsã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
        const result = await extractPredictions(html);

        if (!result.success) {
          showExtractionStatus(false, result.errors.join("\n"));
          return;
        }

        extractionResult = result;
        showExtractionResult(result);
        showExtractionStatus(true, `âœ… ${result.horses.length}é ­ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`);

        // ãƒ–ãƒ­ãƒƒã‚¯3, 4, 5ã‚’è¡¨ç¤º
        document.getElementById("extractionResultSection").style.display = "block";
        document.getElementById("previewSection").style.display = "block";
        document.getElementById("saveSection").style.display = "block";

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        showPreview();

      } catch (error) {
        showExtractionStatus(false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    });

    // æŠ½å‡ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showExtractionStatus(success, message) {
      const status = document.getElementById("extractionStatus");
      status.className = success ? "status-success" : "status-error";
      status.textContent = message;
    }

    // æŠ½å‡ºçµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
    function showExtractionResult(result) {
      const tbody = document.getElementById("extractionTableBody");
      tbody.innerHTML = "";

      const headers = document.getElementById("predictorHeaders");
      headers.innerHTML = result.predictors.map(p => `<th>${p}</th>`).join("");

      result.horses.forEach((horse) => {
        const row = tbody.insertRow();
        row.insertCell().textContent = horse.number;
        row.insertCell().textContent = horse.name;
        row.insertCell().textContent = horse.umacd || "-";

        result.predictors.forEach(predictor => {
          row.insertCell().textContent = horse.marks[predictor] || "-";
        });

        row.insertCell().textContent = horse.odds ? horse.odds.toFixed(1) : "-";
        row.insertCell().innerHTML = `<button class="btn-small">ä¿®æ­£</button>`;
      });
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function showPreview() {
      const coreData = generateCoreData();
      const content = document.getElementById("previewContent");
      content.innerHTML = `<pre>${JSON.stringify(coreData, null, 2)}</pre>`;
    }

    // æ ¸ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆå®Œæˆç³» - å„ã‚µã‚¤ãƒˆã§è‡ªå‹•èª¿æ•´å¯èƒ½ï¼‰
    function generateCoreData() {
      const raceInfo = {
        raceDate: document.getElementById("raceDate").value,
        track: document.getElementById("track").value,
        raceNumber: document.getElementById("raceNumber").value,
        raceName: document.getElementById("raceName").value,
        distance: document.getElementById("distance").value,
        horseCount: parseInt(document.getElementById("horseCount").value),
        startTime: document.getElementById("startTime").value,
      };

      const now = new Date().toISOString();

      return {
        version: "1.0.0",
        createdAt: now,
        lastUpdated: now,
        raceInfo,
        rawHtml: document.getElementById("htmlInput").value,
        horses: extractionResult.horses,
        predictors: extractionResult.predictors,
      };
    }

    // HTMLæŠ½å‡ºé–¢æ•°ï¼ˆextractor.tsã®æ©Ÿèƒ½ã‚’ç§»æ¤ï¼‰
    async function extractPredictions(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const table = doc.querySelector("table.default.syutuba");
      if (!table) {
        return { success: false, errors: ["å‡ºé¦¬è¡¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"], horses: [], predictors: [] };
      }

      const headerRow = table.querySelector("thead tr");
      if (!headerRow) {
        return { success: false, errors: ["ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"], horses: [], predictors: [] };
      }

      // äºˆæƒ³è€…åˆ—ã‚’æ¤œå‡º
      const predictors = [];
      headerRow.querySelectorAll("th").forEach(th => {
        const text = th.textContent.trim();
        if (text.includes("My") || text === "CPU" || (text.length <= 3 && text.length > 0)) {
          predictors.push(text);
        }
      });

      // é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const horses = [];
      table.querySelectorAll("tbody tr").forEach(row => {
        const tds = Array.from(row.querySelectorAll("td"));

        const umabanTd = tds.find(td => td.classList.contains("umaban"));
        const bameiTd = tds.find(td => td.classList.contains("bamei"));
        const markTds = tds.filter(td => td.classList.contains("tmyoso"));
        const oddsTd = tds.find(td => td.classList.contains("odds5"));

        if (!umabanTd || !bameiTd) return;

        const number = parseInt(umabanTd.textContent.trim(), 10);
        const link = bameiTd.querySelector("a");
        const name = link ? link.textContent.trim() : "";
        const href = link ? link.getAttribute("href") : "";
        const umacdMatch = href.match(/\/uma\/(\d+)/);
        const umacd = umacdMatch ? umacdMatch[1] : undefined;

        const marks = {};
        markTds.forEach((td, index) => {
          if (index < predictors.length) {
            const mark = td.querySelector("svg") ? "â–²" : td.textContent.trim();
            marks[predictors[index]] = mark || "-";
          }
        });

        let odds = undefined;
        if (oddsTd) {
          const oddsText = oddsTd.textContent.trim();
          odds = oddsText === "â˜†" ? 999.9 : parseFloat(oddsText);
        }

        horses.push({ number, name, umacd, marks, odds });
      });

      // å°ã®é›†è¨ˆï¼ˆè‡ªå‹•ææ¡ˆï¼‰
      const scores = {};
      const markScores = { "â—": 5, "â—‹": 4, "â–²": 3, "â–³": 2, "ç©´": 2, "æ³¨": 1 };

      horses.forEach(horse => {
        let score = 0;
        Object.values(horse.marks).forEach(mark => {
          score += markScores[mark] || 0;
        });
        scores[horse.number] = score;
      });

      const sorted = Object.entries(scores)
        .sort(([, a], [, b]) => b - a)
        .map(([num]) => parseInt(num, 10));

      const suggestedMarks = {
        main: sorted.slice(0, 3),
        sub: sorted.slice(3, 6),
        hole: sorted.slice(6, 10),
      };

      return {
        success: true,
        horses,
        predictors,
        errors: [],
        suggestedMarks,
      };
    }


    // ä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const coreData = generateCoreData();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!coreData.raceInfo.raceDate || !coreData.raceInfo.track || !coreData.raceInfo.raceNumber) {
        showSaveStatus(false, "âŒ ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
        return;
      }

      if (!coreData.horses || coreData.horses.length === 0) {
        showSaveStatus(false, "âŒ é¦¬ãƒ‡ãƒ¼ã‚¿ãŒæŠ½å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }

      try {
        showSaveStatus(true, "ğŸ”„ ä¿å­˜ä¸­...");

        const response = await fetch("/.netlify/functions/save-predictions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            raceDate: coreData.raceInfo.raceDate,
            track: coreData.raceInfo.track,
            raceNumber: coreData.raceInfo.raceNumber,
            data: {
              raceDate: coreData.raceInfo.raceDate,
              lastUpdated: coreData.lastUpdated,
              track: coreData.raceInfo.track,
              totalRaces: 1,
              races: [coreData],
            },
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showSaveStatus(true, `âœ… ä¿å­˜æˆåŠŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«: ${result.path}\nã‚³ãƒŸãƒƒãƒˆ: ${result.sha.substring(0, 7)}\nURL: ${result.url}`);
        } else {
          showSaveStatus(false, `âŒ ä¿å­˜å¤±æ•—: ${result.error}\nè©³ç´°: ${result.details || ""}`);
        }
      } catch (error) {
        showSaveStatus(false, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    });

    function showSaveStatus(success, message) {
      const status = document.getElementById("saveStatus");
      status.className = success ? "status-success" : "status-error";
      status.textContent = message;
    }

    // åˆæœŸåŒ–: ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("raceDate").value = today;
    });
  </script>

  <style>
    .extension-horse,
    .extension-strategies {
      background: #f9fafb;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .extension-horse h3,
    .extension-strategies h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: #1f2937;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      background: #e5e7eb;
      border: none;
      border-radius: 2px;
      cursor: pointer;
    }

    .btn-small:hover {
      background: #d1d5db;
    }
  </style>
</BaseLayout>
