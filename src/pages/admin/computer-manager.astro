---
// ã‚³ãƒ³ãƒ”æŒ‡æ•°ç®¡ç†ç”»é¢ï¼ˆå…¨ç«¶é¦¬å ´å¯¾å¿œï¼‰
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚³ãƒ³ãƒ”æŒ‡æ•°ç®¡ç† | keiba-data-shared-admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.95;
    }

    .content {
      padding: 30px;
    }

    .form-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid #e9ecef;
    }

    .form-section h2 {
      color: #495057;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #FF6B6B;
      font-size: 1.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
      font-size: 0.95rem;
    }

    input, select, textarea {
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #FF6B6B;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    textarea {
      resize: vertical;
      font-family: monospace;
      line-height: 1.6;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    button {
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .status-message {
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 2px solid #bee5eb;
    }

    .preview-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-top: 25px;
      border: 2px solid #e9ecef;
      max-height: 800px;
      overflow-y: auto;
    }

    .preview-section h3 {
      color: #495057;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }

    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 20px;
      border-radius: 10px;
      overflow-x: auto;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .helper-text {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }

    .category-info {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .category-info strong {
      color: #856404;
    }

    .race-input-area {
      margin-top: 20px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FF6B6B;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: white;
      color: #667eea;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .back-link:hover {
      background: #f8f9fa;
      transform: translateX(-5px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ã‚³ãƒ³ãƒ”æŒ‡æ•°ç®¡ç†</h1>
      <p>æ—¥åˆŠã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ãƒ»ä¿å­˜ï¼ˆå…¨ç«¶é¦¬å ´å¯¾å¿œï¼‰</p>
    </div>

    <div class="content">
      <a href="/" class="back-link">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>

      <div class="form-section">
        <h2>ğŸ“… åŸºæœ¬æƒ…å ±</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="raceDate">é–‹å‚¬æ—¥ *</label>
            <input type="date" id="raceDate" required>
            <span class="helper-text">ã‚³ãƒ³ãƒ”æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿æ—¥ä»˜</span>
          </div>

          <div class="form-group">
            <label for="venue">ç«¶é¦¬å ´ *</label>
            <select id="venue" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <optgroup label="ä¸­å¤®ç«¶é¦¬">
                <option value="æ±äº¬">æ±äº¬</option>
                <option value="ä¸­å±±">ä¸­å±±</option>
                <option value="é˜ªç¥">é˜ªç¥</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="ä¸­äº¬">ä¸­äº¬</option>
                <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
                <option value="å°å€‰">å°å€‰</option>
                <option value="æœ­å¹Œ">æœ­å¹Œ</option>
                <option value="å‡½é¤¨">å‡½é¤¨</option>
                <option value="ç¦å³¶">ç¦å³¶</option>
              </optgroup>
              <optgroup label="å—é–¢ç«¶é¦¬">
                <option value="å¤§äº•">å¤§äº•</option>
                <option value="å·å´">å·å´</option>
                <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
                <option value="æµ¦å’Œ">æµ¦å’Œ</option>
              </optgroup>
              <optgroup label="åœ°æ–¹ç«¶é¦¬">
                <option value="é–€åˆ¥">é–€åˆ¥</option>
                <option value="ç››å²¡">ç››å²¡</option>
                <option value="æ°´æ²¢">æ°´æ²¢</option>
                <option value="é‡‘æ²¢">é‡‘æ²¢</option>
                <option value="ç¬ æ¾">ç¬ æ¾</option>
                <option value="åå¤å±‹">åå¤å±‹</option>
                <option value="åœ’ç”°">åœ’ç”°</option>
                <option value="å§«è·¯">å§«è·¯</option>
                <option value="é«˜çŸ¥">é«˜çŸ¥</option>
                <option value="ä½è³€">ä½è³€</option>
              </optgroup>
            </select>
            <span class="helper-text">é–‹å‚¬ç«¶é¦¬å ´ã‚’é¸æŠ</span>
          </div>
        </div>

        <div class="category-info" id="categoryInfo" style="display: none;">
          <strong>ğŸ“ ä¿å­˜å…ˆ:</strong> <span id="categoryPath"></span>
        </div>
      </div>

      <div class="form-section">
        <h2>ğŸ‡ ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>

        <div class="form-group race-input-area">
          <label for="computerData">ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ *</label>
          <textarea
            id="computerData"
            rows="25"
            placeholder="ã“ã“ã«æ—¥åˆŠã‚³ãƒ³ãƒ”æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...

ä¾‹:
1R
ï¼£ï¼“

å¤§äº•1R 10:55ç™ºèµ° / ãƒ€ãƒ¼ãƒˆ1200m (å³)

ä¸€èˆ¬ è³é‡‘:1ç€80ä¸‡å††ã€2ç€32ä¸‡å††ã€3ç€20ä¸‡å††ã€4ç€12ä¸‡å††ã€5ç€8ä¸‡å††
æ 
é¦¬ç•ª

é¦¬å

æŒ‡æ•°

äººæ°—
2
3

ãƒ­ãƒ¼ã‚¼ãƒ³ãƒŠã‚¤ãƒ„

88

1ä½
2
4

ã‚¸ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ãƒ—ãƒ©ãƒ

74

2ä½
..."></textarea>
          <span class="helper-text">æ—¥åˆŠã‚³ãƒ³ãƒ”æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„</span>
        </div>

        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
          <button type="button" class="btn-primary" onclick="parseAndPreview()">ãƒ‘ãƒ¼ã‚¹ï¼†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <div class="loading" id="loadingIndicator">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #495057;">å‡¦ç†ä¸­...</p>
      </div>

      <div class="preview-section" id="previewSection" style="display: none;">
        <h3>ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä¿å­˜å‰ç¢ºèªï¼‰</h3>

        <!-- äººé–“ãŒèª­ã¿ã‚„ã™ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div id="previewContent" style="margin-bottom: 25px;"></div>

        <!-- JSONè¡¨ç¤ºï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
        <details style="margin-top: 20px;">
          <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px; font-weight: 600;">
            ğŸ“„ JSONå½¢å¼ã§ç¢ºèªï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰
          </summary>
          <pre id="jsonPreview" style="margin-top: 15px;"></pre>
        </details>

        <div class="button-group" style="margin-top: 25px;">
          <button type="button" class="btn-secondary" onclick="hidePreview()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn-primary" onclick="confirmAndSave()">âœ… ã“ã®å†…å®¹ã§ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    let parsedData = null;

    // ç«¶é¦¬å ´ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
    function getCategoryByVenue(venue) {
      const jra = ['æ±äº¬', 'ä¸­å±±', 'é˜ªç¥', 'äº¬éƒ½', 'ä¸­äº¬', 'æ–°æ½Ÿ', 'å°å€‰', 'æœ­å¹Œ', 'å‡½é¤¨', 'ç¦å³¶'];
      const nankan = ['å¤§äº•', 'å·å´', 'èˆ¹æ©‹', 'æµ¦å’Œ'];

      if (jra.includes(venue)) return 'jra';
      if (nankan.includes(venue)) return 'nankan';
      return 'local';
    }

    // ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰å–å¾—
    function getVenueCode(venue) {
      const codes = {
        // JRAä¸­å¤®ç«¶é¦¬
        'æ±äº¬': 'TOK', 'ä¸­å±±': 'NAK', 'é˜ªç¥': 'HAN', 'äº¬éƒ½': 'KYO',
        'ä¸­äº¬': 'CHU', 'æ–°æ½Ÿ': 'NII', 'å°å€‰': 'KOK', 'æœ­å¹Œ': 'SAP',
        'å‡½é¤¨': 'HKD', 'ç¦å³¶': 'FKS',
        // å—é–¢ç«¶é¦¬
        'å¤§äº•': 'OOI', 'å·å´': 'KAW', 'èˆ¹æ©‹': 'FUN', 'æµ¦å’Œ': 'URA',
        // åœ°æ–¹ç«¶é¦¬
        'é–€åˆ¥': 'MON', 'ç››å²¡': 'MOR', 'æ°´æ²¢': 'MIZ', 'é‡‘æ²¢': 'KNZ',
        'ç¬ æ¾': 'KSM', 'åå¤å±‹': 'NGY', 'åœ’ç”°': 'SON', 'å§«è·¯': 'HIM',
        'é«˜çŸ¥': 'KOC', 'ä½è³€': 'SAG'
      };
      return codes[venue] || 'XXX';
    }

    // ä¿å­˜å…ˆãƒ‘ã‚¹æ›´æ–°
    function updateCategoryPath() {
      const venue = document.getElementById('venue').value;
      const raceDate = document.getElementById('raceDate').value;

      if (venue && raceDate) {
        const category = getCategoryByVenue(venue);
        const venueCode = getVenueCode(venue);
        const categoryInfo = document.getElementById('categoryInfo');
        const categoryPath = document.getElementById('categoryPath');

        const [year, month] = raceDate.split('-');
        categoryPath.textContent = `${category}/predictions/computer/${year}/${month}/${raceDate}-${venueCode}.json`;
        categoryInfo.style.display = 'block';
      } else if (venue) {
        const category = getCategoryByVenue(venue);
        const venueCode = getVenueCode(venue);
        const categoryInfo = document.getElementById('categoryInfo');
        const categoryPath = document.getElementById('categoryPath');

        categoryPath.textContent = `${category}/predictions/computer/YYYY/MM/YYYY-MM-DD-${venueCode}.json`;
        categoryInfo.style.display = 'block';
      } else {
        document.getElementById('categoryInfo').style.display = 'none';
      }
    }

    // ç«¶é¦¬å ´é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('venue').addEventListener('change', updateCategoryPath);

    // æ—¥ä»˜é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('raceDate').addEventListener('change', updateCategoryPath);

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    function clearForm() {
      if (confirm('å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        document.getElementById('computerData').value = '';
        document.getElementById('raceDate').value = '';
        document.getElementById('venue').value = '';
        document.getElementById('categoryInfo').style.display = 'none';
        hidePreview();
        hideStatus();
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º
    function hidePreview() {
      document.getElementById('previewSection').style.display = 'none';
      parsedData = null;
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message status-' + type;
      statusEl.style.display = 'block';

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }
    }

    function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loadingIndicator').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    // ãƒ‘ãƒ¼ã‚¹ï¼†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
    async function parseAndPreview() {
      hideStatus();
      hidePreview();

      const raceDate = document.getElementById('raceDate').value;
      const venue = document.getElementById('venue').value;
      const computerData = document.getElementById('computerData').value.trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!raceDate || !venue || !computerData) {
        showStatus('âš ï¸ ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      showLoading();
      showStatus('ğŸ“Š ãƒ‘ãƒ¼ã‚¹å‡¦ç†ä¸­... ç«¶é¦¬ãƒ–ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¨ç…§åˆã—ã¾ã™', 'info');

      try {
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼APIã‚’å‘¼ã³å‡ºã—ï¼ˆç«¶é¦¬ãƒ–ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¨ã®è£œå®Œã‚’å«ã‚€ï¼‰
        const response = await fetch('/.netlify/functions/preview-computer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            raceDate,
            venue,
            computerData
          })
        });

        if (!response.ok) {
          throw new Error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.statusText);
        }

        parsedData = await response.json();

        // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
        console.log('[Preview] å–å¾—ãƒ‡ãƒ¼ã‚¿:', parsedData);
        console.log('[Preview] ãƒ¬ãƒ¼ã‚¹æ•°:', parsedData.races?.length);
        if (parsedData.races && parsedData.races[0]) {
          console.log('[Preview] 1Rã®é¦¬æ•°:', parsedData.races[0].horses?.length);
          console.log('[Preview] 1Rã®æœ€åˆã®é¦¬:', parsedData.races[0].horses?.[0]);
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const previewHTML = generatePreviewHTML(parsedData);
        document.getElementById('previewContent').innerHTML = previewHTML;
        document.getElementById('jsonPreview').textContent = JSON.stringify(parsedData, null, 2);
        document.getElementById('previewSection').style.display = 'block';

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

        // è£œå®Œã®æœ‰ç„¡ã‚’ç¢ºèª
        const hasEnrichedData = parsedData.enrichedAt ? true : false;
        const enrichedCount = parsedData.races.reduce((count, race) => {
          return count + race.horses.filter(h => h.enrichedFrom === 'keiba-book').length;
        }, 0);

        if (hasEnrichedData && enrichedCount > 0) {
          showStatus(`âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æˆåŠŸï¼ç«¶é¦¬ãƒ–ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ ${enrichedCount}é ­ã®æƒ…å ±ã‚’è£œå®Œã—ã¾ã—ãŸ`, 'success');
        } else {
          showStatus('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æˆåŠŸï¼å†…å®¹ã‚’ç¢ºèªã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„', 'success');
        }

      } catch (error) {
        console.error('Error:', error);
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ
    function generatePreviewHTML(data) {
      let html = `
        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 15px; color: #495057;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            <div>
              <strong>æ—¥ä»˜:</strong> ${data.date}
            </div>
            <div>
              <strong>ç«¶é¦¬å ´:</strong> ${data.venue}
            </div>
            <div>
              <strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${data.category}
            </div>
            <div>
              <strong>ãƒ¬ãƒ¼ã‚¹æ•°:</strong> ${data.races.length}R
            </div>
            <div>
              <strong>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</strong> æ—¥åˆŠã‚³ãƒ³ãƒ”
            </div>
          </div>
        </div>
      `;

      // ãƒ¬ãƒ¼ã‚¹è©³ç´°
      data.races.forEach(race => {
        const hasEnrichedData = race.horses.some(h => h.jockey || h.trainer);

        html += `
          <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e9ecef;">
            <h4 style="margin-bottom: 15px; color: #FF6B6B;">
              ğŸ‡ ${race.raceNumber}R ${race.raceName || ''}
              ${hasEnrichedData ? '<span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem; margin-left: 10px;">ç«¶é¦¬ãƒ–ãƒƒã‚¯ã§è£œå®Œæ¸ˆã¿</span>' : ''}
            </h4>
            <div style="margin-bottom: 15px; color: #6c757d; font-size: 0.9rem;">
              ${race.distance ? `${race.distance}m` : ''}
              ${race.surface || ''}
              ${race.track ? `(${race.track})` : ''}
              ${race.startTime ? `${race.startTime}ç™ºèµ°` : ''}
            </div>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: 10px; text-align: center;">é¦¬ç•ª</th>
                  <th style="padding: 10px; text-align: left;">é¦¬å</th>
                  <th style="padding: 10px; text-align: center;">æŒ‡æ•°</th>
                  <th style="padding: 10px; text-align: center;">äººæ°—</th>
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: left;">é¨æ‰‹</th>' : ''}
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: left;">èª¿æ•™å¸«</th>' : ''}
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: center;">æ–¤é‡</th>' : ''}
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: center;">é¦¬é½¢æ€§</th>' : ''}
                </tr>
              </thead>
              <tbody>
        `;

        race.horses.forEach((horse, idx) => {
          const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
          html += `
            <tr style="background: ${bgColor}; border-bottom: 1px solid #e9ecef;">
              <td style="padding: 10px; text-align: center; font-weight: bold;">${horse.number || '-'}</td>
              <td style="padding: 10px;">${horse.name || '-'}</td>
              <td style="padding: 10px; text-align: center; font-weight: bold; color: #FF6B6B;">${horse.computerIndex !== undefined ? horse.computerIndex : '-'}</td>
              <td style="padding: 10px; text-align: center;">${horse.popularity ? horse.popularity + 'ä½' : '-'}</td>
              ${hasEnrichedData ? `<td style="padding: 10px;">${horse.jockey || '-'}</td>` : ''}
              ${hasEnrichedData ? `<td style="padding: 10px; font-size: 0.9rem;">${horse.trainer || '-'}</td>` : ''}
              ${hasEnrichedData ? `<td style="padding: 10px; text-align: center;">${horse.weight || '-'}</td>` : ''}
              ${hasEnrichedData ? `<td style="padding: 10px; text-align: center;">${horse.ageGender || '-'}</td>` : ''}
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;
      });

      return html;
    }

    // ä¿å­˜ç¢ºèªï¼†å®Ÿè¡Œ
    async function confirmAndSave() {
      if (!parsedData) {
        showStatus('âŒ ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      if (!confirm('ã“ã®å†…å®¹ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      showLoading();
      hideStatus();

      try {
        const response = await fetch('/.netlify/functions/save-computer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(parsedData)
        });

        if (!response.ok) {
          throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.statusText);
        }

        const result = await response.json();

        showStatus('ğŸ‰ ä¿å­˜æˆåŠŸï¼ãƒ•ã‚¡ã‚¤ãƒ«: ' + result.filePath, 'success');

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
        setTimeout(() => {
          if (confirm('ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
            clearForm();
          }
        }, 1000);

      } catch (error) {
        console.error('Error:', error);
        showStatus('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸå€¤ã«ã‚»ãƒƒãƒˆ
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('raceDate').value = today;
    });
  </script>
</body>
</html>
