---
/**
 * ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ï¼ˆ12ãƒ¬ãƒ¼ã‚¹å¯¾å¿œç‰ˆï¼‰
 * results-managerã¨åŒã˜æ§‹é€ ã§å„ãƒ¬ãƒ¼ã‚¹å€‹åˆ¥å…¥åŠ›
 *
 * è‘—ä½œæ¨©å¯¾å¿œ: è¨˜è€…åã‚’å°ç•ªå·åŒ–ï¼ˆå°3/å°2/å°1/å°0ï¼‰
 */
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout
  title="äºˆæƒ³ç®¡ç†ç”»é¢"
  description="äºˆæƒ³HTMLã‚’è‡ªå‹•è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">ğŸ¯ å—é–¢ç«¶é¦¬ äºˆæƒ³ç®¡ç†</h1>
      <p class="page-description">
        å„ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥å…¥åŠ›ã§ãã¾ã™ã€‚<br>
        <strong>â€» ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«è²¼ã‚Šä»˜ã‘ã¦è§£æãƒ»ä¿å­˜ã—ã¦ãã ã•ã„</strong>
      </p>

      <!-- å…±é€šæƒ…å ±å…¥åŠ› -->
      <div class="card common-info-card">
        <h2>ğŸ“… é–‹å‚¬æƒ…å ±ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹å…±é€šï¼‰</h2>
        <div class="common-info-grid">
          <div class="form-group">
            <label for="commonDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="commonDate"
              class="form-input"
              value={new Date().toISOString().split('T')[0]}
            />
          </div>
          <div class="form-group">
            <label for="commonVenue">ç«¶é¦¬å ´</label>
            <select id="commonVenue" class="form-select">
              <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
              <option value="å¤§äº•">å¤§äº•</option>
              <option value="å·å´">å·å´</option>
              <option value="æµ¦å’Œ">æµ¦å’Œ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 12ãƒ¬ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="races-container">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(raceNum => (
          <details class="race-section card" data-race-number={raceNum}>
            <summary class="race-section-header">
              <span class="race-number-badge">ç¬¬{raceNum}R</span>
              <span class="race-status" data-status="æœªå…¥åŠ›">æœªå…¥åŠ›</span>
            </summary>

            <div class="race-section-content">
              <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div class="input-area">
                <label for={`raceInput${raceNum}`}>ç¬¬{raceNum}R äºˆæƒ³HTMLè²¼ã‚Šä»˜ã‘</label>
                <textarea
                  id={`raceInput${raceNum}`}
                  class="race-textarea"
                  rows="15"
                  placeholder={`ç¬¬${raceNum}Rã®äºˆæƒ³HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„

ä¾‹:
<div class='racename'>
  2026å¹´1æœˆ30æ—¥ å¤§äº•ç«¶é¦¬ ç¬¬${raceNum}R
  åˆå‡ªç‰¹åˆ¥ç«¶èµ°ï¼£ï¼’äºŒ é¸æŠœ
  ...
</div>
<table class='default syutuba'>
  <thead>...</thead>
  <tbody>...</tbody>
</table>`}
                ></textarea>
                <button
                  type="button"
                  class="btn btn-primary w-full"
                  onclick={`parseRace(${raceNum})`}
                >
                  ğŸ” ç¬¬{raceNum}R ã‚’è§£æ
                </button>
              </div>

              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
              <div id={`preview${raceNum}`} class="preview-area" style="display: none;">
                <h3>âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id={`previewContent${raceNum}`} class="preview-content"></div>

                <!-- JSONè¡¨ç¤º -->
                <div class="json-display">
                  <h4>JSON ãƒ‡ãƒ¼ã‚¿</h4>
                  <textarea
                    id={`jsonOutput${raceNum}`}
                    class="json-textarea"
                    rows="10"
                    readonly
                  ></textarea>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <div class="action-buttons">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick={`navigator.clipboard.writeText(document.getElementById('jsonOutput${raceNum}').value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))`}
                  >
                    ğŸ“‹ JSONã‚³ãƒ”ãƒ¼
                  </button>
                  <button
                    type="button"
                    id={`saveBtn${raceNum}`}
                    class="btn btn-success"
                    onclick={`saveRaceToGit(${raceNum}, false)`}
                  >
                    ğŸš€ ä¿å­˜ã—ã¦Git Push
                  </button>
                  <button
                    type="button"
                    class="btn btn-warning"
                    onclick={`if(confirm('ã“ã®æ—¥ä»˜ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) saveRaceToGit(${raceNum}, true)`}
                  >
                    ğŸ”¥ å®Œå…¨ä¸Šæ›¸ãä¿å­˜
                  </button>
                </div>
                <div id={`saveStatus${raceNum}`} class="save-status" style="display: none;"></div>
              </div>
            </div>
          </details>
        ))}
      </div>

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ğŸ“– ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´</strong>ã‚’ä¸Šéƒ¨ã§é¸æŠ</li>
          <li>å„ãƒ¬ãƒ¼ã‚¹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¬¬1Rã€œç¬¬12Rï¼‰ã‚’å±•é–‹</li>
          <li>äºˆæƒ³ã‚µã‚¤ãƒˆã‹ã‚‰<strong>è©²å½“ãƒ¬ãƒ¼ã‚¹ã®ã¿ã‚³ãƒ”ãƒ¼</strong></li>
          <li>ã€Œè§£æã€ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</li>
          <li>ã€Œä¿å­˜ã—ã¦Git Pushã€ã§ keiba-data-shared ã«ä¿å­˜</li>
          <li>å…¨ãƒ¬ãƒ¼ã‚¹ä¿å­˜å¾Œã€è‡ªå‹•çš„ã«å„äºˆæƒ³ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ ğŸ‰</li>
        </ol>

        <h3>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</h3>
        <ul>
          <li>ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥ã«è²¼ã‚Šä»˜ã‘ãƒ»ä¿å­˜ã§ãã¾ã™</li>
          <li>æ—¢å­˜ãƒ¬ãƒ¼ã‚¹ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ï¼‰</li>
          <li>å®Œå…¨ä¸Šæ›¸ãä¿å­˜ã‚’ä½¿ã†ã¨ã€ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¦æ–°è¦ä¿å­˜ã—ã¾ã™</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .common-info-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-2xl);
    }

    .common-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input,
    .form-select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .races-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .race-section {
      border: 2px solid var(--border-color);
      transition: border-color 0.3s ease;
    }

    .race-section[open] {
      border-color: var(--primary-end);
    }

    .race-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      cursor: pointer;
      font-weight: 600;
      font-size: 1.25rem;
      user-select: none;
    }

    .race-section-header:hover {
      background: var(--bg-secondary);
    }

    .race-number-badge {
      color: var(--primary-end);
      font-size: 1.5rem;
    }

    .race-status {
      font-size: 0.875rem;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .race-status[data-status="æœªå…¥åŠ›"] {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-tertiary);
    }

    .race-status[data-status="è§£ææ¸ˆã¿"] {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .race-status[data-status="ä¿å­˜æ¸ˆã¿"] {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .race-section-content {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .input-area {
      margin-bottom: var(--spacing-xl);
    }

    .input-area label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }

    .race-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
      margin-bottom: var(--spacing-md);
    }

    .preview-area {
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    .preview-area h3 {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-lg);
      color: var(--success);
    }

    .preview-content {
      margin-bottom: var(--spacing-lg);
    }

    .json-display {
      margin-top: var(--spacing-lg);
    }

    .json-display h4 {
      font-size: 1.125rem;
      margin-bottom: var(--spacing-sm);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .action-buttons .btn {
      flex: 1;
    }

    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
    }

    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-2xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .w-full {
      width: 100%;
    }

    @media (max-width: 768px) {
      .common-info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>

  <script is:inline>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆå„ãƒ¬ãƒ¼ã‚¹ã®ãƒ‘ãƒ¼ã‚¹çµæœã‚’ä¿å­˜ï¼‰
    const raceResults = {};

    // ãƒ¬ãƒ¼ã‚¹ãƒ‘ãƒ¼ã‚¹é–¢æ•°
    function parseRace(raceNum) {
      const textarea = document.getElementById(`raceInput${raceNum}`);
      const html = textarea.value;

      if (!html.trim()) {
        alert(`ç¬¬${raceNum}Rã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
        return;
      }

      try {
        // å…±é€šæƒ…å ±å–å¾—
        const date = document.getElementById('commonDate').value;
        const venue = document.getElementById('commonVenue').value;

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        const extracted = extractPredictions(html);
        if (!extracted.success) {
          alert(`æŠ½å‡ºå¤±æ•—: ${extracted.errors.join(', ')}`);
          return;
        }

        const raceInfo = extractRaceInfo(html);
        const scored = scoreAndAssign(extracted);

        // ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
        const data = {
          version: "1.0.0",
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          raceInfo: {
            date: raceInfo.date,
            track: venue,
            raceNumber: `${raceNum}R`,
            raceName: raceInfo.raceName,
            raceType: raceInfo.raceType,
            distance: raceInfo.distance,
            surface: raceInfo.surface,
          },
          horses: scored.horses.map(h => ({
            number: h.number,
            name: h.name,
            umacd: h.umacd,
            marks: h.marks,
            seirei: h.seirei,
            kisyu: h.kisyu,
            kinryo: h.kinryo,
            kyusya: h.kyusya,
            totalScore: h.totalScore,
            assignment: h.assignment,
          })),
          predictors: scored.predictors,
          assignments: {
            main: scored.assignments.main?.number,
            sub: scored.assignments.sub?.number,
            hole: scored.assignments.hole?.number,
            connectTop: scored.assignments.connectTop?.number,
            connect: scored.assignments.connect.map(h => h.number),
            reserve: scored.assignments.reserve.map(h => h.number),
            none: scored.assignments.none.map(h => h.number),
          },
        };

        // çµæœã‚’ä¿å­˜
        raceResults[raceNum] = {
          data,
          date,
          venue
        };

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        displayPreview(raceNum, data, date, venue);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        updateRaceStatus(raceNum, 'è§£ææ¸ˆã¿');

      } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error(error);
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function displayPreview(raceNum, data, date, venue) {
      const previewDiv = document.getElementById(`preview${raceNum}`);
      const previewContent = document.getElementById(`previewContent${raceNum}`);
      const jsonOutput = document.getElementById(`jsonOutput${raceNum}`);

      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±HTMLç”Ÿæˆ
      let html = `
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
          <h4 style="margin-bottom: 0.5rem;">ğŸ“‹ ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h4>
          <p><strong>æ—¥ä»˜:</strong> ${date} ${venue}ç«¶é¦¬ ç¬¬${raceNum}R</p>
          <p><strong>ãƒ¬ãƒ¼ã‚¹å:</strong> ${data.raceInfo.raceName || '-'}</p>
          <p><strong>è·é›¢:</strong> ${data.raceInfo.surface}${data.raceInfo.distance}m</p>
        </div>
      `;

      // æŒ¯ã‚Šåˆ†ã‘çµæœ
      html += '<div style="margin-bottom: 1rem;">';
      html += '<h4 style="margin-bottom: 0.5rem;">ğŸ¯ æŒ¯ã‚Šåˆ†ã‘çµæœ</h4>';

      if (data.assignments.main) {
        const mainHorse = data.horses.find(h => h.number === data.assignments.main);
        html += `<p><strong>â— æœ¬å‘½:</strong> ${data.assignments.main}ç•ª ${mainHorse?.name} (${mainHorse?.totalScore}ç‚¹)</p>`;
      }

      if (data.assignments.sub) {
        const subHorse = data.horses.find(h => h.number === data.assignments.sub);
        html += `<p><strong>â—‹ å¯¾æŠ—:</strong> ${data.assignments.sub}ç•ª ${subHorse?.name} (${subHorse?.totalScore}ç‚¹)</p>`;
      }

      if (data.assignments.hole) {
        const holeHorse = data.horses.find(h => h.number === data.assignments.hole);
        html += `<p><strong>â–² å˜ç©´:</strong> ${data.assignments.hole}ç•ª ${holeHorse?.name} (${holeHorse?.totalScore}ç‚¹)</p>`;
      }

      if (data.assignments.connectTop) {
        const connectTopHorse = data.horses.find(h => h.number === data.assignments.connectTop);
        html += `<p><strong>â–³ é€£ä¸‹æœ€ä¸Šä½:</strong> ${data.assignments.connectTop}ç•ª ${connectTopHorse?.name} (${connectTopHorse?.totalScore}ç‚¹)</p>`;
      }

      if (data.assignments.connect && data.assignments.connect.length > 0) {
        html += `<p><strong>é€£ä¸‹:</strong> ${data.assignments.connect.join(', ')}ç•ª</p>`;
      }

      html += '</div>';

      // å…¨é¦¬ä¸€è¦§ï¼ˆç‚¹æ•°é †ï¼‰
      html += '<div style="margin-top: 1rem;">';
      html += '<h4 style="margin-bottom: 0.5rem;">ğŸ‡ å…¨é¦¬ä¸€è¦§ï¼ˆç‚¹æ•°é †ï¼‰</h4>';
      html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
      html += '<thead><tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">';
      html += '<th style="padding: 0.5rem; text-align: center;">é¦¬ç•ª</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">é¦¬å</th>';
      html += '<th style="padding: 0.5rem; text-align: center;">ç‚¹æ•°</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">æŒ¯ã‚Šåˆ†ã‘</th>';
      html += '</tr></thead><tbody>';

      data.horses.forEach(horse => {
        html += '<tr style="border-bottom: 1px solid var(--border-color);">';
        html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.number}</td>`;
        html += `<td style="padding: 0.5rem;">${horse.name}</td>`;
        html += `<td style="padding: 0.5rem; text-align: center;">${horse.totalScore}ç‚¹</td>`;
        html += `<td style="padding: 0.5rem;">${horse.assignment}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      html += '</div>';

      previewContent.innerHTML = html;

      const jsonData = {
        raceDate: date,
        lastUpdated: data.lastUpdated,
        track: venue,
        totalRaces: 1,
        races: [data],
      };

      jsonOutput.value = JSON.stringify(jsonData, null, 2);
      previewDiv.style.display = 'block';
    }

    // ãƒ¬ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateRaceStatus(raceNum, status) {
      const section = document.querySelector(`.race-section[data-race-number="${raceNum}"]`);
      const statusSpan = section.querySelector('.race-status');
      statusSpan.setAttribute('data-status', status);
      statusSpan.textContent = status;
    }

    // Gitä¿å­˜
    async function saveRaceToGit(raceNum, forceOverwrite = false) {
      if (!raceResults[raceNum]) {
        alert('å…ˆã«è§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById(`saveBtn${raceNum}`);
      const statusDiv = document.getElementById(`saveStatus${raceNum}`);

      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = forceOverwrite
        ? 'ğŸ”¥ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¸Šæ›¸ãä¸­...'
        : 'ğŸš€ keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ä¸­...';

      try {
        const { data, date, venue } = raceResults[raceNum];

        const response = await fetch('/.netlify/functions/save-predictions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            raceDate: date,
            track: venue,
            raceNumber: `${raceNum}R`,
            data: {
              raceDate: date,
              lastUpdated: data.lastUpdated,
              track: venue,
              totalRaces: 1,
              races: [data],
            },
            forceOverwrite: forceOverwrite
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${result.message || 'ä¿å­˜æˆåŠŸ'}<br>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${result.path}<br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> ${result.sha?.substring(0, 7) || '-'}
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
          updateRaceStatus(raceNum, 'ä¿å­˜æ¸ˆã¿');
        } else {
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
      }
    }

    // ===== æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ =====

    function extractPredictions(html) {
      const errors = [];
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const table = doc.querySelector('table.default.syutuba');
        if (!table) {
          errors.push('å‡ºé¦¬è¡¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return { success: false, horses: [], predictors: [], errors };
        }

        const headerRow = table.querySelector('thead tr');
        if (!headerRow) {
          errors.push('ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return { success: false, horses: [], predictors: [], errors };
        }

        const detectedPredictors = detectPredictors(headerRow);
        console.log('[extractPredictions] æ¤œå‡ºã—ãŸäºˆæƒ³è€…:', detectedPredictors);

        // è‘—ä½œæ¨©å¯¾å¿œ: äºˆæƒ³è€…åã‚’é€†é †ã§ã€Œå°4ã€ã€Œå°3ã€ã€Œå°2ã€ã€Œå°1ã€ã«åŒ¿ååŒ–
        // ä¾‹: ['å¤§æœ¨', 'å–„æ—', 'é«˜æ©‹', 'æœ¬ç´™'] â†’ ['å°4', 'å°3', 'å°2', 'å°1']
        const predictors = detectedPredictors.map((_, index) => `å°${detectedPredictors.length - index}`);
        console.log('[extractPredictions] åŒ¿ååŒ–å¾Œ:', predictors);

        const rows = table.querySelectorAll('tbody tr');
        const horses = [];

        rows.forEach(row => {
          const horse = extractHorseFromRow(row, detectedPredictors, predictors);
          if (horse) {
            horses.push(horse);
          }
        });

        console.log(`[extractPredictions] æŠ½å‡ºã—ãŸé¦¬æ•°: ${horses.length}`);

        return {
          success: true,
          horses,
          predictors,
          errors,
        };
      } catch (error) {
        errors.push(`æŠ½å‡ºã‚¨ãƒ©ãƒ¼: ${error}`);
        return { success: false, horses: [], predictors: [], errors };
      }
    }

    function detectPredictors(headerRow) {
      const headers = [];
      const ths = headerRow.querySelectorAll('th');

      // äºˆæƒ³å°ä»¥å¤–ã®åˆ—ã‚’é™¤å¤–
      const excludeList = [
        'æ ç•ª', 'é¦¬ç•ª', 'é¦¬å', 'é¸æŠ', 'æ€§é½¢', 'æ¸›é‡', 'é¨æ‰‹', 'æ–¤é‡',
        'å©èˆ', 'çŸ­è©•', 'å¢—æ¸›', 'å˜å‹', 'äººæ°—', 'ç€é †', 'é¦¬ä½“é‡',
        'ã‚ªãƒƒã‚º', 'ã‚¿ã‚¤ãƒ ', 'ç€å·®', 'ãƒšãƒ¼ã‚¹', 'ä¸Š3F', 'èª¿æ•™å¸«', 'é¦¬ä¸»'
      ];

      ths.forEach((th) => {
        const text = th.textContent?.trim() || '';

        // é™¤å¤–ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (excludeList.includes(text)) {
          return;
        }

        // Myå°ã‚’é™¤å¤–ï¼ˆè‘—ä½œæ¨©å¯¾å¿œï¼‰
        if (text.includes('My')) {
          return;
        }

        // äºˆæƒ³å°åˆ—ã‚’æ¤œå‡º
        if (
          text.includes('å°') ||       // â—‹â—‹å°ï¼ˆMyå°é™¤ãï¼‰
          text === 'CPU' ||           // CPU
          text === 'æœ¬ç´™' ||          // æœ¬ç´™
          (text.length >= 2 && text.length <= 3 && /^[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ ]+$/.test(text)) // 2-3æ–‡å­—ã®æ—¥æœ¬èªï¼ˆäºˆæƒ³è€…åï¼‰
        ) {
          headers.push(text);
        }
      });

      return headers;
    }

    function extractMarkFromElement(element) {
      const text = element.textContent?.trim() || '';

      if (element.querySelector('svg')) {
        return 'svg';
      }

      const markMap = {
        'â—': 'â—',
        'â—‹': 'â—‹',
        'â–²': 'â–²',
        'â–³': 'â–³',
        'Ã—': 'Ã—',
        'ç©´': 'ç©´',
        'æ³¨': 'æ³¨',
        'æ¶ˆ': 'æ¶ˆ',
        '-': '-',
        '': '-',
      };

      return markMap[text] || text;
    }

    function extractHorseFromRow(row, detectedPredictors, anonymizedPredictors) {
      const tds = Array.from(row.querySelectorAll('td'));

      let number = 0;
      let name = '';
      let umacd = undefined;
      const marks = {};
      let seirei = '';
      let kisyu = '';
      let kinryo = '';
      let kyusya = '';

      // é¦¬ç•ªï¼ˆumaban class ã¾ãŸã¯2åˆ—ç›®ï¼‰
      const umabanTd = tds.find(td => td.classList.contains('umaban'));
      if (umabanTd) {
        number = parseInt(umabanTd.textContent?.trim() || '0', 10);
      } else if (tds.length >= 2) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 2åˆ—ç›®ã‚’é¦¬ç•ªã¨ã—ã¦æ‰±ã†
        const secondCol = tds[1].textContent?.trim() || '';
        const parsed = parseInt(secondCol, 10);
        if (!isNaN(parsed)) {
          number = parsed;
        }
      }

      // é¦¬åï¼ˆbamei classå†…ã®ãƒªãƒ³ã‚¯ï¼‰
      const bameiTd = tds.find(td => td.classList.contains('bamei'));
      if (bameiTd) {
        const link = bameiTd.querySelector('a');
        if (link) {
          name = link.textContent?.trim() || '';
          const href = link.getAttribute('href') || '';
          const match = href.match(/\/uma\/(\d+)/);
          if (match) {
            umacd = match[1];
          }
        }
      }

      // ãƒ‡ãƒãƒƒã‚°: å…¨tdã®ã‚¯ãƒ©ã‚¹ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºï¼ˆæœ€åˆã®é¦¬ã®ã¿ï¼‰
      if (number === 1) {
        console.log('[DEBUG] 1ç•ªé¦¬ã®å…¨tdã®è©³ç´°:');
        tds.forEach((td, idx) => {
          const classes = Array.from(td.classList).join(', ') || '(ã‚¯ãƒ©ã‚¹ãªã—)';
          const text = td.textContent?.trim().substring(0, 30) || '';
          const html = td.innerHTML.substring(0, 100);
          console.log(`  td[${idx}]: classes="${classes}"`);
          console.log(`          text="${text}"`);
          console.log(`          html="${html}"`);
        });
      }

      // äºˆæƒ³å°ã‚’æŠ½å‡ºï¼ˆtmyoso classï¼‰
      const markTds = tds.filter(td => td.classList.contains('tmyoso'));
      console.log(`[extractHorseFromRow] é¦¬ç•ª${number}: markTds=${markTds.length}, predictors=${anonymizedPredictors.length}`);

      // tmyosoã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®å¯¾ç­–
      if (markTds.length === 0) {
        if (number === 1) {
          console.error('[ERROR] tmyosoã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
          console.error('[ERROR] ä»£æ›¿æ¡ˆ: ãƒ˜ãƒƒãƒ€ãƒ¼ã¨tdã®ä½ç½®ã§å°ã‚’ç‰¹å®šã—ã¾ã™');
        }

        // ä»£æ›¿æ¡ˆ: ãƒ˜ãƒƒãƒ€ãƒ¼ã®thä½ç½®ã‹ã‚‰å°ã®tdã‚’ç‰¹å®š
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®thã‚’å–å¾—
        const headerRow = row.closest('table')?.querySelector('thead tr');
        if (headerRow) {
          const ths = Array.from(headerRow.querySelectorAll('th'));
          const markIndices = [];

          // äºˆæƒ³è€…åã«è©²å½“ã™ã‚‹thã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨˜éŒ²
          ths.forEach((th, idx) => {
            const text = th.textContent?.trim() || '';
            // detectedPredictorsã«å«ã¾ã‚Œã‚‹äºˆæƒ³è€…åã‚’æ¢ã™
            detectedPredictors.forEach(predictor => {
              if (text.includes(predictor)) {
                markIndices.push(idx);
              }
            });
          });

          if (number === 1) {
            console.log('[DEBUG] å°ã®thã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', markIndices);
          }

          // ãã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œã™ã‚‹tdã‹ã‚‰å°ã‚’æŠ½å‡º
          markIndices.forEach((thIdx, predictorIdx) => {
            if (thIdx < tds.length && predictorIdx < anonymizedPredictors.length) {
              const td = tds[thIdx];
              const mark = extractMarkFromElement(td);
              marks[anonymizedPredictors[predictorIdx]] = mark;
              if (number === 1) {
                console.log(`  ${anonymizedPredictors[predictorIdx]} (th[${thIdx}]) = ${mark}`);
              }
            }
          });
        }
      } else {
        // tmyosoã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼ˆå¾“æ¥ã®å‡¦ç†ï¼‰
        markTds.forEach((td, index) => {
          if (index < anonymizedPredictors.length) {
            const mark = extractMarkFromElement(td);
            marks[anonymizedPredictors[index]] = mark;
            console.log(`  ${anonymizedPredictors[index]} = ${mark}`);
          }
        });
      }

      // æ€§é½¢ãƒ»é¨æ‰‹ãƒ»æ–¤é‡ãƒ»å©èˆæŠ½å‡º
      const seireiTd = tds.find(td => td.classList.contains('seirei'));
      if (seireiTd) {
        seirei = seireiTd.textContent?.trim() || '';
      }

      const kisyuTd = tds.find(td => td.classList.contains('kisyu'));
      if (kisyuTd) {
        kisyu = kisyuTd.textContent?.trim() || '';
      }

      const kinryoTd = tds.find(td => td.classList.contains('kinryo'));
      if (kinryoTd) {
        kinryo = kinryoTd.textContent?.trim() || '';
      }

      const kyusyaTd = tds.find(td => td.classList.contains('kyusya'));
      if (kyusyaTd) {
        kyusya = kyusyaTd.textContent?.trim() || '';
      }

      if (number === 0 || !name) {
        console.log(`[extractHorseFromRow] ã‚¹ã‚­ãƒƒãƒ—: number=${number}, name=${name}`);
        return null;
      }

      return {
        number,
        name,
        umacd,
        marks,
        seirei,
        kisyu,
        kinryo,
        kyusya,
      };
    }

    function extractRaceInfo(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const racenameDiv = doc.querySelector('div.racename');
      let date = '';
      let raceName = '';
      let raceType = '';
      let distance = '';
      let surface = '';

      if (racenameDiv) {
        const text = racenameDiv.textContent || '';
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);

        const dateMatch = text.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        if (dateMatch) {
          date = `${dateMatch[1]}å¹´${dateMatch[2]}æœˆ${dateMatch[3]}æ—¥`;
        }

        for (let line of lines) {
          if (line.match(/ç‰¹åˆ¥|è³|æ¯|ç›ƒ|[ï¼¡ï¼¢ï¼£][ï¼‘ï¼’ï¼“ï¼]/)) {
            raceName = line;
            break;
          }
        }

        for (let line of lines) {
          if (line.match(/[ï¼¡ï¼¢ï¼£][ï¼‘ï¼’ï¼“ï¼]/)) {
            raceType = line;
            break;
          }
        }

        const distanceMatch = text.match(/[ãƒ€èŠ][\s\u3000]*(\d{1}),?(\d{3})m/);
        if (distanceMatch) {
          distance = `${distanceMatch[1]}${distanceMatch[2]}`;
        }

        surface = text.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';
      }

      return { date, raceName, raceType, distance, surface };
    }

    function scoreAndAssign(result) {
      const markScores = {
        'â—': 5,
        'â—‹': 4,
        'â–²': 3,
        'svg': 2,
        'â–³': 1,
        '-': 0,
      };

      const horses = result.horses.map(horse => {
        let totalScore = 0;
        Object.values(horse.marks).forEach(mark => {
          totalScore += markScores[mark] || 0;
        });

        return {
          ...horse,
          totalScore,
        };
      });

      horses.sort((a, b) => b.totalScore - a.totalScore);

      const assignments = {
        main: null,
        sub: null,
        hole: null,
        connectTop: null,
        connect: [],
        reserve: [],
        none: [],
      };

      horses.forEach((horse, index) => {
        if (index === 0) {
          assignments.main = horse;
          horse.assignment = 'æœ¬å‘½';
        } else if (index === 1) {
          assignments.sub = horse;
          horse.assignment = 'å¯¾æŠ—';
        } else if (index === 2) {
          assignments.hole = horse;
          horse.assignment = 'å˜ç©´';
        } else if (index === 3) {
          assignments.connectTop = horse;
          horse.assignment = 'é€£ä¸‹æœ€ä¸Šä½';
        } else if (index >= 4 && index <= 8 && horse.totalScore > 0) {
          assignments.connect.push(horse);
          horse.assignment = 'é€£ä¸‹';
        } else if (horse.totalScore > 0) {
          assignments.reserve.push(horse);
          horse.assignment = 'è£œæ¬ ';
        } else {
          assignments.none.push(horse);
          horse.assignment = 'ç„¡';
        }
      });

      return {
        ...result,
        horses,
        assignments,
      };
    }
  </script>
</BaseLayout>
