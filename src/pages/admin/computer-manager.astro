---
// ã‚³ãƒ³ãƒ”æŒ‡æ•°ç®¡ç†ç”»é¢ï¼ˆå…¨ç«¶é¦¬å ´å¯¾å¿œï¼‰
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚³ãƒ³ãƒ”æŒ‡æ•°ç®¡ç† | keiba-data-shared-admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #1e293b;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.95;
    }

    .content {
      padding: 30px;
      background: #1e293b;
    }

    .form-section {
      background: #334155;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-section h2 {
      color: #e2e8f0;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
      font-size: 1.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #cbd5e1;
      font-size: 0.95rem;
    }

    input, select, textarea {
      padding: 12px;
      border: 1px solid #475569;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #1e293b;
      color: #e2e8f0;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    option {
      background: #1e293b;
      color: #e2e8f0;
    }

    textarea {
      resize: vertical;
      font-family: monospace;
      line-height: 1.6;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    button {
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .status-message {
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status-success {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .status-info {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .preview-section {
      background: #334155;
      border-radius: 15px;
      padding: 25px;
      margin-top: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 800px;
      overflow-y: auto;
    }

    .preview-section h3 {
      color: #e2e8f0;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #475569;
    }

    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 20px;
      border-radius: 10px;
      overflow-x: auto;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .helper-text {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 5px;
    }

    .category-info {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .category-info strong {
      color: #fbbf24;
    }

    .category-info span {
      color: #cbd5e1;
    }

    .race-input-area {
      margin-top: 20px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FF6B6B;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: #334155;
      color: #a5b4fc;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .back-link:hover {
      background: #475569;
      transform: translateX(-5px);
      border-color: #667eea;
    }

    /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€Œä¸Šã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ */
    .scroll-to-top-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
    }

    .scroll-to-top-btn.visible {
      opacity: 1;
      visibility: visible;
    }

    .scroll-to-top-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ã‚³ãƒ³ãƒ”æŒ‡æ•°ç®¡ç†</h1>
      <p>ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ãƒ»ä¿å­˜ï¼ˆå…¨ç«¶é¦¬å ´å¯¾å¿œï¼‰</p>
    </div>

    <div class="content">
      <a href="/" class="back-link">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>

      <div class="form-section">
        <h2>ğŸ“… åŸºæœ¬æƒ…å ±</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="raceDate">é–‹å‚¬æ—¥ *</label>
            <input type="date" id="raceDate" required>
            <span class="helper-text">ã‚³ãƒ³ãƒ”æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿æ—¥ä»˜</span>
          </div>

          <div class="form-group">
            <label for="venue">ç«¶é¦¬å ´ *</label>
            <select id="venue" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <optgroup label="ä¸­å¤®ç«¶é¦¬">
                <option value="æ±äº¬">æ±äº¬</option>
                <option value="ä¸­å±±">ä¸­å±±</option>
                <option value="é˜ªç¥">é˜ªç¥</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="ä¸­äº¬">ä¸­äº¬</option>
                <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
                <option value="å°å€‰">å°å€‰</option>
                <option value="æœ­å¹Œ">æœ­å¹Œ</option>
                <option value="å‡½é¤¨">å‡½é¤¨</option>
                <option value="ç¦å³¶">ç¦å³¶</option>
              </optgroup>
              <optgroup label="å—é–¢ç«¶é¦¬">
                <option value="å¤§äº•">å¤§äº•</option>
                <option value="å·å´">å·å´</option>
                <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
                <option value="æµ¦å’Œ">æµ¦å’Œ</option>
              </optgroup>
              <optgroup label="åœ°æ–¹ç«¶é¦¬">
                <option value="é–€åˆ¥">é–€åˆ¥</option>
                <option value="å¸¯åºƒ">å¸¯åºƒ</option>
                <option value="ç››å²¡">ç››å²¡</option>
                <option value="æ°´æ²¢">æ°´æ²¢</option>
                <option value="é‡‘æ²¢">é‡‘æ²¢</option>
                <option value="ç¬ æ¾">ç¬ æ¾</option>
                <option value="åå¤å±‹">åå¤å±‹</option>
                <option value="åœ’ç”°">åœ’ç”°</option>
                <option value="å§«è·¯">å§«è·¯</option>
                <option value="é«˜çŸ¥">é«˜çŸ¥</option>
                <option value="ä½è³€">ä½è³€</option>
              </optgroup>
            </select>
            <span class="helper-text">é–‹å‚¬ç«¶é¦¬å ´ã‚’é¸æŠï¼ˆãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘æ™‚ã«è‡ªå‹•æ¤œå‡ºï¼‰</span>
          </div>
        </div>

        <div class="category-info" id="categoryInfo" style="display: none;">
          <strong>ğŸ“ ä¿å­˜å…ˆ:</strong> <span id="categoryPath"></span>
        </div>
      </div>

      <div class="form-section">
        <h2>ğŸ‡ ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>

        <div class="form-group race-input-area">
          <label for="computerData">ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ *</label>
          <textarea
            id="computerData"
            rows="25"
            placeholder="ã“ã“ã«ã‚³ãƒ³ãƒ”æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...

ä¾‹:
1R
ï¼£ï¼“

å¤§äº•1R 10:55ç™ºèµ° / ãƒ€ãƒ¼ãƒˆ1200m (å³)

ä¸€èˆ¬ è³é‡‘:1ç€80ä¸‡å††ã€2ç€32ä¸‡å††ã€3ç€20ä¸‡å††ã€4ç€12ä¸‡å††ã€5ç€8ä¸‡å††
æ 
é¦¬ç•ª

é¦¬å

æŒ‡æ•°

äººæ°—
2
3

ãƒ­ãƒ¼ã‚¼ãƒ³ãƒŠã‚¤ãƒ„

88

1ä½
2
4

ã‚¸ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ãƒ—ãƒ©ãƒ

74

2ä½
..."></textarea>
          <span class="helper-text">ã‚³ãƒ³ãƒ”æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„</span>
        </div>

        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
          <button type="button" class="btn-primary" onclick="parseAndPreview()">ãƒ‘ãƒ¼ã‚¹ï¼†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <div class="loading" id="loadingIndicator">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #cbd5e1;">å‡¦ç†ä¸­...</p>
      </div>

      <div class="preview-section" id="previewSection" style="display: none;">
        <h3>ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä¿å­˜å‰ç¢ºèªï¼‰</h3>

        <!-- äººé–“ãŒèª­ã¿ã‚„ã™ã„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div id="previewContent" style="margin-bottom: 25px;"></div>

        <!-- JSONè¡¨ç¤ºï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
        <details style="margin-top: 20px;">
          <summary style="cursor: pointer; padding: 10px; background: #334155; border-radius: 8px; font-weight: 600; color: #cbd5e1; border: 1px solid rgba(255, 255, 255, 0.1);">
            ğŸ“„ JSONå½¢å¼ã§ç¢ºèªï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰
          </summary>
          <pre id="jsonPreview" style="margin-top: 15px;"></pre>
        </details>

        <div class="button-group" style="margin-top: 25px;">
          <button type="button" class="btn-secondary" onclick="scrollToTop()">â¬†ï¸ ä¸Šã«æˆ»ã‚‹</button>
          <button type="button" class="btn-secondary" onclick="hidePreview()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn-primary" onclick="confirmAndSave()">âœ… ã“ã®å†…å®¹ã§ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€Œä¸Šã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ -->
  <button class="scroll-to-top-btn" id="scrollToTopBtn" onclick="scrollToTop()" title="ä¸Šã«æˆ»ã‚‹">
    â¬†ï¸
  </button>

  <script is:inline>
    let parsedData = null;

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–ï¼šä¸€å®šä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰ãƒœã‚¿ãƒ³è¡¨ç¤º
    window.addEventListener('scroll', function() {
      const scrollBtn = document.getElementById('scrollToTopBtn');
      if (window.pageYOffset > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    });

    // ç«¶é¦¬å ´ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
    function getCategoryByVenue(venue) {
      const jra = ['æ±äº¬', 'ä¸­å±±', 'é˜ªç¥', 'äº¬éƒ½', 'ä¸­äº¬', 'æ–°æ½Ÿ', 'å°å€‰', 'æœ­å¹Œ', 'å‡½é¤¨', 'ç¦å³¶'];
      const nankan = ['å¤§äº•', 'å·å´', 'èˆ¹æ©‹', 'æµ¦å’Œ'];

      if (jra.includes(venue)) return 'jra';
      if (nankan.includes(venue)) return 'nankan';
      return 'local';
    }

    // ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰å–å¾—
    function getVenueCode(venue) {
      const codes = {
        // JRAä¸­å¤®ç«¶é¦¬
        'æ±äº¬': 'TOK', 'ä¸­å±±': 'NAK', 'é˜ªç¥': 'HAN', 'äº¬éƒ½': 'KYO',
        'ä¸­äº¬': 'CHU', 'æ–°æ½Ÿ': 'NII', 'å°å€‰': 'KOK', 'æœ­å¹Œ': 'SAP',
        'å‡½é¤¨': 'HKD', 'ç¦å³¶': 'FKS',
        // å—é–¢ç«¶é¦¬
        'å¤§äº•': 'OOI', 'å·å´': 'KAW', 'èˆ¹æ©‹': 'FUN', 'æµ¦å’Œ': 'URA',
        // åœ°æ–¹ç«¶é¦¬
        'é–€åˆ¥': 'MON', 'å¸¯åºƒ': 'OBI', 'ç››å²¡': 'MOR', 'æ°´æ²¢': 'MIZ', 'é‡‘æ²¢': 'KNZ',
        'ç¬ æ¾': 'KSM', 'åå¤å±‹': 'NGY', 'åœ’ç”°': 'SON', 'å§«è·¯': 'HIM',
        'é«˜çŸ¥': 'KOC', 'ä½è³€': 'SAG'
      };
      return codes[venue] || 'XXX';
    }

    // ä¿å­˜å…ˆãƒ‘ã‚¹æ›´æ–°
    function updateCategoryPath() {
      const venue = document.getElementById('venue').value;
      const raceDate = document.getElementById('raceDate').value;

      if (venue && raceDate) {
        const category = getCategoryByVenue(venue);
        const venueCode = getVenueCode(venue);
        const categoryInfo = document.getElementById('categoryInfo');
        const categoryPath = document.getElementById('categoryPath');

        const [year, month] = raceDate.split('-');
        categoryPath.textContent = `${category}/predictions/computer/${year}/${month}/${raceDate}-${venueCode}.json`;
        categoryInfo.style.display = 'block';
      } else if (venue) {
        const category = getCategoryByVenue(venue);
        const venueCode = getVenueCode(venue);
        const categoryInfo = document.getElementById('categoryInfo');
        const categoryPath = document.getElementById('categoryPath');

        categoryPath.textContent = `${category}/predictions/computer/YYYY/MM/YYYY-MM-DD-${venueCode}.json`;
        categoryInfo.style.display = 'block';
      } else {
        document.getElementById('categoryInfo').style.display = 'none';
      }
    }

    // ç«¶é¦¬å ´é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('venue').addEventListener('change', updateCategoryPath);

    // æ—¥ä»˜é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('raceDate').addEventListener('change', updateCategoryPath);

    // ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ—¥ä»˜ã‚’è‡ªå‹•æ¤œå‡ºï¼ˆä¾‹: "2026å¹´2æœˆ22æ—¥ é«˜çŸ¥"ï¼‰
    function detectDateFromData(text) {
      // ãƒ‘ã‚¿ãƒ¼ãƒ³1: "2026å¹´2æœˆ22æ—¥"
      const pattern1 = /(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/;
      const match1 = text.match(pattern1);
      if (match1) {
        const year = match1[1];
        const month = match1[2].padStart(2, '0');
        const day = match1[3].padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³2: "2026-02-22"ï¼ˆæ—¢ã«ãƒã‚¤ãƒ•ãƒ³å½¢å¼ã®å ´åˆï¼‰
      const pattern2 = /(\d{4})-(\d{2})-(\d{2})/;
      const match2 = text.match(pattern2);
      if (match2) {
        return match2[0];
      }

      return null;
    }

    // ã‚³ãƒ³ãƒ”æŒ‡æ•°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç«¶é¦¬å ´ã‚’è‡ªå‹•æ¤œå‡º
    function detectVenueFromData(text) {
      const venues = [
        // ä¸­å¤®ç«¶é¦¬
        'æ±äº¬', 'ä¸­å±±', 'é˜ªç¥', 'äº¬éƒ½', 'ä¸­äº¬', 'æ–°æ½Ÿ', 'å°å€‰', 'æœ­å¹Œ', 'å‡½é¤¨', 'ç¦å³¶',
        // å—é–¢ç«¶é¦¬
        'å¤§äº•', 'å·å´', 'èˆ¹æ©‹', 'æµ¦å’Œ',
        // åœ°æ–¹ç«¶é¦¬
        'é–€åˆ¥', 'å¸¯åºƒ', 'ç››å²¡', 'æ°´æ²¢', 'é‡‘æ²¢', 'ç¬ æ¾', 'åå¤å±‹', 'åœ’ç”°', 'å§«è·¯', 'é«˜çŸ¥', 'ä½è³€'
      ];

      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±è¡Œã‹ã‚‰ç«¶é¦¬å ´ã‚’æ¤œå‡ºï¼ˆä¾‹: "å¤§äº•1R 10:55ç™ºèµ°"ï¼‰
      for (const venue of venues) {
        const pattern = new RegExp(`${venue}\\d{1,2}R\\s+\\d{1,2}:\\d{2}ç™ºèµ°`);
        if (pattern.test(text)) {
          return venue;
        }
      }

      return null;
    }

    // è‡ªå‹•æ¤œå‡ºå‡¦ç†ï¼ˆå…±é€šé–¢æ•°ï¼‰
    function autoDetectFields() {
      const text = document.getElementById('computerData').value;
      const venueSelect = document.getElementById('venue');
      const dateInput = document.getElementById('raceDate');

      console.log('[Auto Detect] é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
      console.log('[Auto Detect] ãƒ‡ãƒ¼ã‚¿é•·:', text.length);
      console.log('[Auto Detect] ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®200æ–‡å­—:', text.substring(0, 200));

      // ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
      if (!text.trim()) {
        console.log('[Auto Detect] ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      // æ—¥ä»˜ã®è‡ªå‹•æ¤œå‡ºï¼ˆæ¯å›å®Ÿè¡Œã€ä¸Šæ›¸ãï¼‰
      const detectedDate = detectDateFromData(text);
      console.log('[Auto Detect] æ—¥ä»˜æ¤œå‡ºçµæœ:', detectedDate);
      if (detectedDate) {
        const previousDate = dateInput.value;
        dateInput.value = detectedDate;
        console.log(`[Auto Detect] æ—¥ä»˜ã‚’è‡ªå‹•æ¤œå‡º: ${previousDate || '(ç©º)'} â†’ ${detectedDate}`);
      } else {
        console.log('[Auto Detect] æ—¥ä»˜ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }

      // ç«¶é¦¬å ´ã®è‡ªå‹•æ¤œå‡ºï¼ˆæ¯å›å®Ÿè¡Œã€ä¸Šæ›¸ãï¼‰
      const detectedVenue = detectVenueFromData(text);
      console.log('[Auto Detect] ç«¶é¦¬å ´æ¤œå‡ºçµæœ:', detectedVenue);
      if (detectedVenue) {
        const previousVenue = venueSelect.value;
        venueSelect.value = detectedVenue;
        console.log(`[Auto Detect] ç«¶é¦¬å ´ã‚’è‡ªå‹•æ¤œå‡º: ${previousVenue || '(ç©º)'} â†’ ${detectedVenue}`);
      } else {
        console.log('[Auto Detect] ç«¶é¦¬å ´ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }

      // ä¸¡æ–¹æ¤œå‡ºã§ããŸã‚‰ä¿å­˜å…ˆãƒ‘ã‚¹ã‚’æ›´æ–°
      if (dateInput.value && venueSelect.value) {
        updateCategoryPath();
      }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘æ™‚ã®è‡ªå‹•æ¤œå‡ºï¼ˆinputã‚¤ãƒ™ãƒ³ãƒˆï¼‰
    document.getElementById('computerData').addEventListener('input', autoDetectFields);

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘æ™‚ã®è‡ªå‹•æ¤œå‡ºï¼ˆpasteã‚¤ãƒ™ãƒ³ãƒˆ - ã‚ˆã‚Šç¢ºå®Ÿï¼‰
    document.getElementById('computerData').addEventListener('paste', function(e) {
      // pasteã‚¤ãƒ™ãƒ³ãƒˆã¯å®Ÿéš›ã®ãƒ†ã‚­ã‚¹ãƒˆãŒåæ˜ ã•ã‚Œã‚‹å‰ã«ç™ºç«ã™ã‚‹ãŸã‚ã€å°‘ã—å¾…ã¤
      setTimeout(autoDetectFields, 100);
    });

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    function clearForm() {
      if (confirm('å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        document.getElementById('computerData').value = '';
        document.getElementById('raceDate').value = '';
        document.getElementById('venue').value = '';
        document.getElementById('categoryInfo').style.display = 'none';
        hidePreview();
        hideStatus();
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º
    function hidePreview() {
      document.getElementById('previewSection').style.display = 'none';
      parsedData = null;
    }

    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message status-' + type;
      statusEl.style.display = 'block';

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }
    }

    function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loadingIndicator').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    // ãƒ‘ãƒ¼ã‚¹ï¼†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
    async function parseAndPreview() {
      hideStatus();
      hidePreview();

      const raceDate = document.getElementById('raceDate').value;
      const venue = document.getElementById('venue').value;
      const computerData = document.getElementById('computerData').value.trim();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!raceDate || !venue || !computerData) {
        showStatus('âš ï¸ ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      showLoading();
      showStatus('ğŸ“Š ãƒ‘ãƒ¼ã‚¹å‡¦ç†ä¸­... ç«¶é¦¬ãƒ–ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¨ç…§åˆã—ã¾ã™', 'info');

      try {
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼APIã‚’å‘¼ã³å‡ºã—ï¼ˆç«¶é¦¬ãƒ–ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¨ã®è£œå®Œã‚’å«ã‚€ï¼‰
        const response = await fetch('/.netlify/functions/preview-computer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            raceDate,
            venue,
            computerData
          })
        });

        if (!response.ok) {
          throw new Error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.statusText);
        }

        parsedData = await response.json();

        // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
        console.log('[Preview] å–å¾—ãƒ‡ãƒ¼ã‚¿:', parsedData);
        console.log('[Preview] ãƒ¬ãƒ¼ã‚¹æ•°:', parsedData.races?.length);
        if (parsedData.races && parsedData.races[0]) {
          console.log('[Preview] 1Rã®é¦¬æ•°:', parsedData.races[0].horses?.length);
          console.log('[Preview] 1Rã®æœ€åˆã®é¦¬:', parsedData.races[0].horses?.[0]);
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const previewHTML = generatePreviewHTML(parsedData);

        // ãƒ‡ãƒãƒƒã‚°: ç”Ÿæˆã•ã‚ŒãŸHTMLã®ä¸€éƒ¨ã‚’ç¢ºèªï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰
        console.log('[ç”ŸæˆHTML] æœ€åˆã®500æ–‡å­—:', previewHTML.substring(0, 500));

        // 1Rã®ãƒ†ãƒ¼ãƒ–ãƒ«éƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ç¢ºèª
        const race1TableMatch = previewHTML.match(/ğŸ‡ 1R[\s\S]{0,800}/);
        if (race1TableMatch) {
          console.log('[ç”ŸæˆHTML] 1Rãƒ†ãƒ¼ãƒ–ãƒ«éƒ¨åˆ†:', race1TableMatch[0]);
        }

        document.getElementById('previewContent').innerHTML = previewHTML;
        document.getElementById('jsonPreview').textContent = JSON.stringify(parsedData, null, 2);
        document.getElementById('previewSection').style.display = 'block';

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

        // è£œå®Œã®æœ‰ç„¡ã‚’ç¢ºèª
        const hasEnrichedData = parsedData.enrichedAt ? true : false;
        const enrichedCount = parsedData.races.reduce((count, race) => {
          return count + race.horses.filter(h => h.enrichedFrom === 'keiba-book').length;
        }, 0);

        if (hasEnrichedData && enrichedCount > 0) {
          showStatus(`âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æˆåŠŸï¼${enrichedCount}é ­ã®å‡ºèµ°æƒ…å ±ã‚’è£œå®Œã—ã¾ã—ãŸ`, 'success');
        } else {
          showStatus('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æˆåŠŸï¼å†…å®¹ã‚’ç¢ºèªã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„', 'success');
        }

      } catch (error) {
        console.error('Error:', error);
        showStatus('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆ
    function generatePreviewHTML(data) {
      let html = `
        <div style="background: #1e293b; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <h3 style="margin-bottom: 15px; color: #e2e8f0;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; color: #cbd5e1;">
            <div>
              <strong style="color: #e2e8f0;">æ—¥ä»˜:</strong> ${data.date}
            </div>
            <div>
              <strong style="color: #e2e8f0;">ç«¶é¦¬å ´:</strong> ${data.venue}
            </div>
            <div>
              <strong style="color: #e2e8f0;">ã‚«ãƒ†ã‚´ãƒª:</strong> ${data.category}
            </div>
            <div>
              <strong style="color: #e2e8f0;">ãƒ¬ãƒ¼ã‚¹æ•°:</strong> ${data.races.length}R
            </div>
            <div>
              <strong style="color: #e2e8f0;">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</strong> ã‚³ãƒ³ãƒ”æŒ‡æ•°
            </div>
          </div>
        </div>
      `;

      // ãƒ¬ãƒ¼ã‚¹è©³ç´°
      data.races.forEach(race => {
        const hasEnrichedData = race.horses.some(h => h.jockey || h.trainer);

        html += `
          <div style="background: #1e293b; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="margin-bottom: 15px; color: #a5b4fc;">
              ğŸ‡ ${race.raceNumber}R ${race.raceName || ''}
              ${hasEnrichedData ? '<span style="background: rgba(16, 185, 129, 0.2); color: #6ee7b7; padding: 3px 8px; border-radius: 5px; font-size: 0.8rem; margin-left: 10px; border: 1px solid rgba(16, 185, 129, 0.3);">å‡ºèµ°æƒ…å ±è£œå®Œæ¸ˆã¿</span>' : ''}
            </h4>
            <div style="margin-bottom: 15px; color: #94a3b8; font-size: 0.9rem;">
              ${race.distance ? `${race.distance}m` : ''}
              ${race.surface || ''}
              ${race.track ? `(${race.track})` : ''}
              ${race.startTime ? `${race.startTime}ç™ºèµ°` : ''}
            </div>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #334155; border-bottom: 2px solid #475569;">
                  <th style="padding: 10px; text-align: center; color: #e2e8f0;">é¦¬ç•ª</th>
                  <th style="padding: 10px; text-align: left; color: #e2e8f0;">é¦¬å</th>
                  <th style="padding: 10px; text-align: center; color: #e2e8f0;">æŒ‡æ•°</th>
                  <th style="padding: 10px; text-align: center; color: #e2e8f0;">äººæ°—</th>
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: left; color: #e2e8f0;">é¨æ‰‹</th>' : ''}
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: left; color: #e2e8f0;">èª¿æ•™å¸«</th>' : ''}
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: center; color: #e2e8f0;">æ–¤é‡</th>' : ''}
                  ${hasEnrichedData ? '<th style="padding: 10px; text-align: center; color: #e2e8f0;">é¦¬é½¢æ€§</th>' : ''}
                </tr>
              </thead>
              <tbody>
        `;

        race.horses.forEach((horse, idx) => {
          // ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®é¦¬ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
          if (idx === 0) {
            console.log(`[HTMLç”Ÿæˆ] R${race.raceNumber} 1é ­ç›®:`, {
              number: horse.number,
              name: horse.name,
              computerIndex: horse.computerIndex,
              popularity: horse.popularity,
              jockey: horse.jockey,
              trainer: horse.trainer
            });
          }

          const computerIndexDisplay = (horse.computerIndex !== undefined && horse.computerIndex !== null) ? horse.computerIndex : '-';
          const popularityDisplay = horse.popularity ? (horse.popularity + 'ä½') : '-';
          const rowBgColor = idx % 2 === 0 ? '#1e293b' : '#334155';

          html += `
            <tr style="background: ${rowBgColor}; border-bottom: 1px solid #475569;">
              <td style="padding: 10px; text-align: center; font-weight: bold; color: #e2e8f0;">${horse.number || '-'}</td>
              <td style="padding: 10px; color: #e2e8f0;">${horse.name || '-'}</td>
              <td style="padding: 10px; text-align: center; font-weight: bold; color: #a5b4fc;">${computerIndexDisplay}</td>
              <td style="padding: 10px; text-align: center; color: #cbd5e1;">${popularityDisplay}</td>
              ${hasEnrichedData ? `<td style="padding: 10px; color: #cbd5e1;">${horse.jockey || '-'}</td>` : ''}
              ${hasEnrichedData ? `<td style="padding: 10px; font-size: 0.9rem; color: #cbd5e1;">${horse.trainer || '-'}</td>` : ''}
              ${hasEnrichedData ? `<td style="padding: 10px; text-align: center; color: #cbd5e1;">${horse.weight || '-'}</td>` : ''}
              ${hasEnrichedData ? `<td style="padding: 10px; text-align: center; color: #cbd5e1;">${horse.ageGender || '-'}</td>` : ''}
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;
      });

      return html;
    }

    // ä¿å­˜ç¢ºèªï¼†å®Ÿè¡Œ
    async function confirmAndSave() {
      if (!parsedData) {
        showStatus('âŒ ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      if (!confirm('ã“ã®å†…å®¹ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      showLoading();
      hideStatus();

      try {
        const response = await fetch('/.netlify/functions/save-computer', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(parsedData)
        });

        if (!response.ok) {
          throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.statusText);
        }

        const result = await response.json();

        showStatus('ğŸ‰ ä¿å­˜æˆåŠŸï¼ãƒ•ã‚¡ã‚¤ãƒ«: ' + result.filePath + ' - æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã§ãã¾ã™', 'success');

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢ï¼ˆæ¬¡ã®å…¥åŠ›ã«å‚™ãˆã‚‹ï¼‰
        setTimeout(() => {
          document.getElementById('computerData').value = '';
          document.getElementById('raceDate').value = '';
          document.getElementById('venue').value = '';
          document.getElementById('categoryInfo').style.display = 'none';
          hidePreview();
          console.log('[Auto Clear] ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
        }, 1500);

      } catch (error) {
        console.error('Error:', error);
        showStatus('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // åˆæœŸå€¤ã¯è¨­å®šã—ãªã„ï¼ˆè‡ªå‹•æ¤œå‡ºã«ä»»ã›ã‚‹ï¼‰
    // DOMContentLoadedæ™‚ã®å‡¦ç†ã¯ä¸è¦
  </script>
</body>
</html>
