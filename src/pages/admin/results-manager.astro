---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout
  title="çµæœç®¡ç†ç”»é¢"
  description="å—é–¢å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸçµæœã‚’è‡ªå‹•è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">ğŸ‡ å—é–¢ç«¶é¦¬ çµæœç®¡ç†</h1>
      <p class="page-description">
        å„ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥å…¥åŠ›ã§ãã¾ã™ã€‚<br>
        <strong>â€» ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«è²¼ã‚Šä»˜ã‘ã¦è§£æãƒ»ä¿å­˜ã—ã¦ãã ã•ã„</strong>
      </p>

      <!-- å…±é€šæƒ…å ±å…¥åŠ› -->
      <div class="card common-info-card">
        <h2>ğŸ“… é–‹å‚¬æƒ…å ±ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹å…±é€šï¼‰</h2>
        <div class="common-info-grid">
          <div class="form-group">
            <label for="commonDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="commonDate"
              class="form-input"
              value={new Date().toISOString().split('T')[0]}
            />
          </div>
          <div class="form-group">
            <label for="commonVenue">ç«¶é¦¬å ´</label>
            <select id="commonVenue" class="form-select">
              <option value="èˆ¹æ©‹">èˆ¹æ©‹</option>
              <option value="å¤§äº•">å¤§äº•</option>
              <option value="å·å´">å·å´</option>
              <option value="æµ¦å’Œ">æµ¦å’Œ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 12ãƒ¬ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="races-container">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(raceNum => (
          <details class="race-section card" data-race-number={raceNum}>
            <summary class="race-section-header">
              <span class="race-number-badge">ç¬¬{raceNum}R</span>
              <span class="race-status" data-status="æœªå…¥åŠ›">æœªå…¥åŠ›</span>
            </summary>

            <div class="race-section-content">
              <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div class="input-area">
                <label for={`raceInput${raceNum}`}>ç¬¬{raceNum}R ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                <textarea
                  id={`raceInput${raceNum}`}
                  class="race-textarea"
                  rows="15"
                  placeholder={`ç¬¬${raceNum}Rã®ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„

ä¾‹:
ç¬¬${raceNum}R
é¯›ãƒæµ¦ç‰¹åˆ¥ ï¼¡ï¼’ï¼¢ï¼‘(ä¸€)
ãƒ€ 1,800mï¼ˆå¤–ï¼‰ ï¼ˆ14é ­ï¼‰ ç™ºèµ°æ™‚åˆ»20:50
ç€    æ     é¦¬ç•ª    é¦¬å    æ€§é½¢    è² æ‹…    é¦¬ä½“é‡    å¢—æ¸›    é¨æ‰‹    èª¿æ•™å¸«    ã‚¿ã‚¤ãƒ     ç€å·®    ä¸ŠãŒã‚Š3F    ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †    äººæ°—
1    5    7    ãƒã‚­ã‚·ãƒãƒ ãƒ‘ãƒ¯ãƒ¼    ç‰¡4    55.0    500kg    -1    ç”ºç”°ç›´å¸Œ    æ—æ­£äºº    2:28.0    -    39.3    -    1
...
æ‰•æˆ»é‡‘
å˜å‹ è¤‡å‹ æ è¤‡ æ™®é€šé¦¬è¤‡ æ å˜ é¦¬å˜
...`}
                ></textarea>
                <button
                  type="button"
                  class="btn btn-primary w-full"
                  onclick={`parseRace(${raceNum})`}
                >
                  ğŸ” ç¬¬{raceNum}R ã‚’è§£æ
                </button>
              </div>

              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
              <div id={`preview${raceNum}`} class="preview-area" style="display: none;">
                <h3>âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id={`previewContent${raceNum}`} class="preview-content"></div>

                <!-- JSONè¡¨ç¤º -->
                <div class="json-display">
                  <h4>JSON ãƒ‡ãƒ¼ã‚¿</h4>
                  <textarea
                    id={`jsonOutput${raceNum}`}
                    class="json-textarea"
                    rows="10"
                    readonly
                  ></textarea>
                  <textarea
                    id={`archiveJsonOutput${raceNum}`}
                    class="json-textarea"
                    rows="10"
                    readonly
                    style="display: none;"
                  ></textarea>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <div class="action-buttons">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick={`navigator.clipboard.writeText(document.getElementById('jsonOutput${raceNum}').value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))`}
                  >
                    ğŸ“‹ JSONã‚³ãƒ”ãƒ¼
                  </button>
                  <button
                    type="button"
                    id={`saveBtn${raceNum}`}
                    class="btn btn-success"
                    onclick={`saveRaceToGit(${raceNum}, false)`}
                  >
                    ğŸš€ ä¿å­˜ã—ã¦Git Push
                  </button>
                  <button
                    type="button"
                    class="btn btn-warning"
                    onclick={`if(confirm('ã“ã®æ—¥ä»˜ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) saveRaceToGit(${raceNum}, true)`}
                    style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;"
                  >
                    ğŸ”¥ å®Œå…¨ä¸Šæ›¸ãä¿å­˜
                  </button>
                </div>
                <div id={`saveStatus${raceNum}`} class="save-status" style="display: none;"></div>
              </div>
            </div>
          </details>
        ))}
      </div>

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ğŸ“– ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´</strong>ã‚’ä¸Šéƒ¨ã§é¸æŠ</li>
          <li>å„ãƒ¬ãƒ¼ã‚¹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¬¬1Rã€œç¬¬12Rï¼‰ã‚’å±•é–‹</li>
          <li>å—é–¢å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰<strong>è©²å½“ãƒ¬ãƒ¼ã‚¹ã®ã¿ã‚³ãƒ”ãƒ¼</strong></li>
          <li>ã€Œè§£æã€ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</li>
          <li>ã€Œä¿å­˜ã—ã¦Git Pushã€ã§ keiba-data-shared ã«ä¿å­˜</li>
          <li>å…¨ãƒ¬ãƒ¼ã‚¹ä¿å­˜å¾Œã€è‡ªå‹•çš„ã« keiba-intelligence ã«åæ˜ ã•ã‚Œã¾ã™ ğŸ‰</li>
        </ol>

        <h3>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</h3>
        <ul>
          <li>ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥ã«è²¼ã‚Šä»˜ã‘ãƒ»ä¿å­˜ã§ãã¾ã™</li>
          <li>æ—¢å­˜ãƒ¬ãƒ¼ã‚¹ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ï¼‰</li>
          <li>äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•çš„ã«çš„ä¸­åˆ¤å®šã‚’è¡Œã„ã¾ã™</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .common-info-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-2xl);
    }

    .common-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input,
    .form-select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .races-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .race-section {
      border: 2px solid var(--border-color);
      transition: border-color 0.3s ease;
    }

    .race-section[open] {
      border-color: var(--primary-end);
    }

    .race-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      cursor: pointer;
      font-weight: 600;
      font-size: 1.25rem;
      user-select: none;
    }

    .race-section-header:hover {
      background: var(--bg-secondary);
    }

    .race-number-badge {
      color: var(--primary-end);
      font-size: 1.5rem;
    }

    .race-status {
      font-size: 0.875rem;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .race-status[data-status="æœªå…¥åŠ›"] {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-tertiary);
    }

    .race-status[data-status="è§£ææ¸ˆã¿"] {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .race-status[data-status="ä¿å­˜æ¸ˆã¿"] {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .race-section-content {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .input-area {
      margin-bottom: var(--spacing-xl);
    }

    .input-area label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }

    .race-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
      margin-bottom: var(--spacing-md);
    }

    .preview-area {
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    .preview-area h3 {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-lg);
      color: var(--success);
    }

    .preview-content {
      margin-bottom: var(--spacing-lg);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .info-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .hit-info {
      padding: var(--spacing-md);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-radius: var(--radius-md);
      border-left: 4px solid var(--success);
      margin-bottom: var(--spacing-lg);
    }

    .hit-info strong {
      color: var(--success);
    }

    .debug-section {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border: 1px dashed var(--border-color);
    }

    .debug-section summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
      user-select: none;
    }

    .debug-content {
      margin-top: var(--spacing-md);
      font-size: 0.875rem;
      line-height: 1.8;
    }

    .debug-content div {
      padding: var(--spacing-xs) 0;
    }

    .json-display {
      margin-top: var(--spacing-lg);
    }

    .json-display h4 {
      font-size: 1.125rem;
      margin-bottom: var(--spacing-sm);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .action-buttons .btn {
      flex: 1;
    }

    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
    }

    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-2xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .w-full {
      width: 100%;
    }

    @media (max-width: 768px) {
      .common-info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>

  <script is:inline>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆå„ãƒ¬ãƒ¼ã‚¹ã®ãƒ‘ãƒ¼ã‚¹çµæœã‚’ä¿å­˜ï¼‰
    const raceResults = {};

    // ãƒ¬ãƒ¼ã‚¹ãƒ‘ãƒ¼ã‚¹é–¢æ•°
    function parseRace(raceNum) {
      const textarea = document.getElementById(`raceInput${raceNum}`);
      const text = textarea.value;

      if (!text.trim()) {
        alert(`ç¬¬${raceNum}Rã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
        return;
      }

      try {
        // å…±é€šæƒ…å ±å–å¾—
        const date = document.getElementById('commonDate').value;
        const venue = document.getElementById('commonVenue').value;
        const venueCodeMap = { 'èˆ¹æ©‹': 'FU', 'å¤§äº•': 'OI', 'å·å´': 'KA', 'æµ¦å’Œ': 'UR' };
        const venueCode = venueCodeMap[venue];

        // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãƒ‘ãƒ¼ã‚¹
        const raceInfo = extractRaceInfo(text, raceNum);
        const results = extractResults(text);
        const payouts = extractPayouts(text);
        const timeData = extractTimeData(text);
        const cornerData = extractCornerData(text);

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        console.log(`[Race ${raceNum}] ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºçµæœ:`, timeData);
        console.log(`[Race ${raceNum}] ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †æŠ½å‡ºçµæœ:`, cornerData);

        const commentary = generateRaceCommentary({results, payouts, timeData, cornerData});

        const raceData = {
          raceNumber: raceNum,
          raceName: raceInfo.raceName,
          distance: raceInfo.distance,
          surface: raceInfo.surface,
          track: raceInfo.track,
          horses: raceInfo.horses,
          startTime: raceInfo.startTime,
          results,
          payouts,
          timeData,
          cornerData,
          commentary,
          enteredAt: new Date().toISOString(),
          enteredBy: 'staff-ui'
        };

        // çµæœJSONç”Ÿæˆ
        const resultsJSON = {
          date,
          venue,
          venueCode,
          races: [raceData],
          dataVersion: '1.0'
        };

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã¦çš„ä¸­åˆ¤å®š
        fetchPredictionData(date).then(predictionData => {
          const archiveResults = generateArchiveResults(resultsJSON, predictionData);

          // çµæœã‚’ä¿å­˜
          raceResults[raceNum] = {
            resultsJSON,
            archiveResults
          };

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
          displayPreview(raceNum, raceData, archiveResults);

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          updateRaceStatus(raceNum, 'è§£ææ¸ˆã¿');
        });

      } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error(error);
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function displayPreview(raceNum, raceData, archiveResults) {
      const previewDiv = document.getElementById(`preview${raceNum}`);
      const previewContent = document.getElementById(`previewContent${raceNum}`);
      const jsonOutput = document.getElementById(`jsonOutput${raceNum}`);
      const archiveJsonOutput = document.getElementById(`archiveJsonOutput${raceNum}`);

      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±HTMLç”Ÿæˆ
      let html = `
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">ãƒ¬ãƒ¼ã‚¹:</span>
            <span class="info-value">ç¬¬${raceData.raceNumber}R ${raceData.raceName || ''}</span>
          </div>
          <div class="info-item">
            <span class="info-label">è·é›¢:</span>
            <span class="info-value">${raceData.surface}${raceData.distance}m</span>
          </div>
          <div class="info-item">
            <span class="info-label">å‡ºèµ°é ­æ•°:</span>
            <span class="info-value">${raceData.horses}é ­</span>
          </div>
        </div>
      `;

      // å…¨ç€é †è¡¨ç¤º
      if (raceData.results && raceData.results.length > 0) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ‡ ç€é †</h4>';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
        html += '<thead><tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">';
        html += '<th style="padding: 0.5rem; text-align: center;">ç€é †</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">æ </th>';
        html += '<th style="padding: 0.5rem; text-align: center;">é¦¬ç•ª</th>';
        html += '<th style="padding: 0.5rem; text-align: left;">é¦¬å</th>';
        html += '<th style="padding: 0.5rem; text-align: left;">é¨æ‰‹</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">ã‚¿ã‚¤ãƒ </th>';
        html += '<th style="padding: 0.5rem; text-align: center;">ç€å·®</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">ä¸Š3F</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">äººæ°—</th>';
        html += '</tr></thead><tbody>';

        raceData.results.forEach(horse => {
          html += '<tr style="border-bottom: 1px solid var(--border-color);">';
          html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.rank}ç€</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.bracket}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.number}</td>`;
          html += `<td style="padding: 0.5rem;">${horse.name}</td>`;
          html += `<td style="padding: 0.5rem;">${horse.jockey}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.time}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.margin}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.lastFurlong}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.popularity}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        html += '</div>';
      }

      // ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ãƒ»ä¸ŠãŒã‚Šè¡¨ç¤º
      if (raceData.timeData) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">â±ï¸ ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿</h4>';
        html += '<div class="info-grid">';

        if (raceData.timeData.last3F) {
          html += `
            <div class="info-item">
              <span class="info-label">ä¸ŠãŒã‚Š3F:</span>
              <span class="info-value">${raceData.timeData.last3F}ç§’</span>
            </div>
          `;
        }

        if (raceData.timeData.last4F) {
          html += `
            <div class="info-item">
              <span class="info-label">ä¸ŠãŒã‚Š4F:</span>
              <span class="info-value">${raceData.timeData.last4F}ç§’</span>
            </div>
          `;
        }

        if (raceData.timeData.furlongTimes && raceData.timeData.furlongTimes.length > 0) {
          html += `
            <div class="info-item" style="grid-column: 1 / -1;">
              <span class="info-label">ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ :</span>
              <span class="info-value">${raceData.timeData.furlongTimes.join(' - ')}ç§’</span>
            </div>
          `;
        }

        html += '</div>';
        html += '</div>';
      }

      // ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †è¡¨ç¤º
      if (raceData.cornerData && raceData.cornerData.length > 0) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ“ ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †</h4>';
        html += '<div class="info-grid">';

        raceData.cornerData.forEach(corner => {
          html += `
            <div class="info-item" style="grid-column: 1 / -1;">
              <span class="info-label">${corner.corner}:</span>
              <span class="info-value">${corner.order.join(', ')}</span>
            </div>
          `;
        });

        html += '</div>';
        html += '</div>';
      }

      // æ‰•æˆ»æƒ…å ±ï¼ˆå…¨åˆ¸ç¨®å¯¾å¿œï¼‰
      if (raceData.payouts && Object.keys(raceData.payouts).length > 0) {
        html += '<div class="payouts-section">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ’° æ‰•æˆ»é‡‘</h4>';
        html += '<div class="info-grid">';

        const ticketNames = {
          tansho: 'å˜å‹',
          fukusho: 'è¤‡å‹',
          wakuren: 'æ è¤‡',
          umaren: 'é¦¬è¤‡',
          wakutan: 'æ å˜',
          umatan: 'é¦¬å˜',
          wide: 'ãƒ¯ã‚¤ãƒ‰',
          sanrenpuku: 'ä¸‰é€£è¤‡',
          sanrentan: 'ä¸‰é€£å˜'
        };

        for (const [key, name] of Object.entries(ticketNames)) {
          if (raceData.payouts[key] && Array.isArray(raceData.payouts[key])) {
            const items = raceData.payouts[key];
            items.forEach((item, idx) => {
              const numOrCombo = item.number || item.combination;
              html += `
                <div class="info-item">
                  <span class="info-label">${name}${items.length > 1 ? ` (${idx + 1})` : ''}:</span>
                  <span class="info-value">${numOrCombo} â†’ ${item.payout.toLocaleString()}å†† (${item.popularity}äººæ°—)</span>
                </div>
              `;
            });
          }
        }

        html += '</div>';
        html += '</div>';
      }

      // çš„ä¸­åˆ¤å®šæƒ…å ±
      if (archiveResults) {
        const year = Object.keys(archiveResults)[0];
        const month = Object.keys(archiveResults[year])[0];
        const day = Object.keys(archiveResults[year][month])[0];
        const dayData = archiveResults[year][month][day];
        const raceArchive = dayData.races.find(r => r.raceNumber === `${raceNum}R`);

        if (raceArchive) {
          // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®åˆ¤å®š
          const hasPrediction = raceArchive.debug?.hasPrediction;

          let hitIcon, hitClass;
          if (!hasPrediction) {
            hitIcon = 'ğŸ“ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãªã—';
            hitClass = 'info';
          } else if (raceArchive.hit) {
            hitIcon = raceArchive.hitType === 'main' ? 'ğŸ¯æœ¬ç·šçš„ä¸­' : 'âœ…æŠ‘ãˆçš„ä¸­';
            hitClass = raceArchive.hitType === 'main' ? 'success' : 'warning';
          } else {
            hitIcon = 'âŒä¸çš„ä¸­';
            hitClass = 'error';
          }

          html += `
            <div class="hit-info">
              <strong>${hitIcon}</strong>
              ${raceArchive.hit ? `<br>æ‰•æˆ»é‡‘: ${raceArchive.payout.toLocaleString()}å††` : ''}
            </div>
          `;

          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          if (raceArchive.debug) {
            html += `
              <details class="debug-section">
                <summary>ğŸ” çš„ä¸­åˆ¤å®šãƒ‡ãƒãƒƒã‚°</summary>
                <div class="debug-content">
                  <div><strong>äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š:</strong> ${raceArchive.debug.hasPrediction ? 'âœ…' : 'âŒ'}</div>
                  <div><strong>çµæœãƒ‡ãƒ¼ã‚¿ã‚ã‚Š:</strong> ${raceArchive.debug.hasResult ? 'âœ…' : 'âŒ'}</div>
                  <div><strong>äºˆæƒ³ï¼ˆæœ¬ç·šï¼‰:</strong> ${raceArchive.debug.predictionMain?.join(', ') || 'ãªã—'}</div>
                  <div><strong>äºˆæƒ³ï¼ˆæŠ‘ãˆï¼‰:</strong> ${raceArchive.debug.predictionSub?.join(', ') || 'ãªã—'}</div>
                  <div><strong>çµæœï¼ˆé¦¬å˜ï¼‰:</strong> ${raceArchive.debug.resultCombo || 'ãªã—'}</div>
                  <div><strong>æ‰•æˆ»é‡‘:</strong> ${(raceArchive.debug.resultPayout || 0).toLocaleString()}å††</div>
                </div>
              </details>
            `;
          }
        }
      }

      previewContent.innerHTML = html;
      jsonOutput.value = JSON.stringify(raceResults[raceNum].resultsJSON, null, 2);
      archiveJsonOutput.value = JSON.stringify(raceResults[raceNum].archiveResults, null, 2);
      previewDiv.style.display = 'block';
    }

    // ãƒ¬ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateRaceStatus(raceNum, status) {
      const section = document.querySelector(`.race-section[data-race-number="${raceNum}"]`);
      const statusSpan = section.querySelector('.race-status');
      statusSpan.setAttribute('data-status', status);
      statusSpan.textContent = status;
    }

    // Gitä¿å­˜
    async function saveRaceToGit(raceNum, forceOverwrite = false) {
      if (!raceResults[raceNum]) {
        alert('å…ˆã«è§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById(`saveBtn${raceNum}`);
      const statusDiv = document.getElementById(`saveStatus${raceNum}`);

      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = forceOverwrite
        ? 'ğŸ”¥ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¸Šæ›¸ãä¸­...'
        : 'ğŸš€ keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ä¸­...';

      try {
        const response = await fetch('/.netlify/functions/save-results', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            resultsJSON: JSON.stringify(raceResults[raceNum].resultsJSON),
            archiveResultsJSON: JSON.stringify(raceResults[raceNum].archiveResults),
            forceOverwrite: forceOverwrite
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${data.message}<br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> <a href="${data.commitUrl}" target="_blank" style="color: var(--success);">GitHubã§ç¢ºèª</a>
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
          updateRaceStatus(raceNum, 'ä¿å­˜æ¸ˆã¿');
        } else {
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
      }
    }

    // ãƒ‘ãƒ¼ã‚µãƒ¼é–¢æ•°ç¾¤ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç§»æ¤ï¼‰

    function extractRaceInfo(text, raceNumber) {
      let raceName = '';
      const lines = text.split('\n');

      // å„ªå…ˆé †ä½1: é‡è³ãƒ¬ãƒ¼ã‚¹åï¼ˆã€Œç¬¬â—‹å›ã€ã€Œï¼ˆï¼³Iã€ã€Œï¼ˆï¼³IIã€ã€Œï¼ˆï¼§Iã€ã€Œï¼ˆï¼§IIã€ã€Œï¼ˆï¼§IIIã€ã€Œï¼ˆï¼ªï½ï½Iã€ã‚’å«ã‚€ï¼‰
      for (let line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine.match(/ç¬¬\d+å›|[ï¼ˆ(][ï¼³ï¼§ï¼ª][ï¼©Iï½ï½]/)) {
          raceName = trimmedLine;
          break;
        }
      }

      // å„ªå…ˆé †ä½2: åœ°æ–¹ç«¶é¦¬ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆï¼¡ï¼‘ã€ï¼¢ï¼’ãªã©ï¼‰
      if (!raceName) {
        for (let line of lines) {
          const trimmedLine = line.trim();
          if (trimmedLine.match(/[ï¼¡ï¼¢ï¼£][ï¼‘ï¼’ï¼“ï¼]/)) {
            raceName = trimmedLine;
            break;
          }
        }
      }

      // å„ªå…ˆé †ä½3: ã€Œç‰¹åˆ¥ã€ã€Œè³ã€ã€Œæ¯ã€ã‚’å«ã‚€è¡Œï¼ˆå‰¯é¡Œã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
      if (!raceName) {
        for (let line of lines) {
          const trimmedLine = line.trim();
          if (trimmedLine.match(/ç‰¹åˆ¥|è³|æ¯/)) {
            raceName = trimmedLine;
            break;
          }
        }
      }

      const distanceMatch = text.match(/[ãƒ€èŠ][\s\u3000]*(\d{1}),?(\d{3})m/);
      const distance = distanceMatch ? parseInt(distanceMatch[1] + distanceMatch[2], 10) : null;

      const surface = text.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';

      const trackMatch = text.match(/ï¼ˆ(å¤–|å†…|å³|å·¦)ï¼‰/);
      const track = trackMatch ? trackMatch[1] : null;

      const horsesMatch = text.match(/ï¼ˆ(\d+)é ­ï¼‰/);
      const horses = horsesMatch ? parseInt(horsesMatch[1], 10) : null;

      const startTimeMatch = text.match(/ç™ºèµ°æ™‚åˆ»(\d{1,2}):(\d{2})/);
      const startTime = startTimeMatch ? `${startTimeMatch[1]}:${startTimeMatch[2]}` : null;

      return { raceNumber, raceName, distance, surface, track, horses, startTime };
    }

    function extractResults(text) {
      const results = [];
      const lines = text.split('\n');

      for (let line of lines) {
        const match = line.match(/^(\d+)[\s\u3000]+(\d+)[\s\u3000]+(\d+)[\s\u3000]+(.+?)[\s\u3000]+[ç‰¡ç‰ã‚»]\d+[\s\u3000]+([\d.]+)[\s\u3000]+(\d+)kg[\s\u3000]+([+-Â±ï¼‹ï¼]?\d*)[\s\u3000]+(.+?)[\s\u3000]+(.+?)[\s\u3000]+([\d:.]+)[\s\u3000]+(.*?)[\s\u3000]+([\d.]+)[\s\u3000]+(.*)[\s\u3000]+(\d+)\s*$/);

        if (match) {
          results.push({
            rank: parseInt(match[1], 10),
            bracket: parseInt(match[2], 10),
            number: parseInt(match[3], 10),
            name: match[4].trim(),
            jockey: match[8].trim(),
            trainer: match[9].trim(),
            time: match[10].trim(),
            margin: match[11].trim() || '-',
            lastFurlong: match[12].trim(),
            popularity: parseInt(match[14], 10)
          });
        }
      }

      if (results.length === 0) throw new Error('ç€é †ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return results;
    }

    function extractPayouts(text) {
      const payouts = {};

      const payoutMatch = text.match(/æ‰•æˆ»é‡‘[\s\S]*$/);
      if (!payoutMatch) return payouts;

      const payoutSection = payoutMatch[0];
      const lines = payoutSection.split('\n').filter(l => l.trim());

      // ãƒ†ãƒ¼ãƒ–ãƒ«1: å˜å‹/è¤‡å‹/æ è¤‡/é¦¬è¤‡/æ å˜/é¦¬å˜
      const table1HeaderIdx = lines.findIndex(l =>
        l.includes('å˜å‹') && l.includes('è¤‡å‹') && l.includes('é¦¬å˜')
      );

      if (table1HeaderIdx > -1) {
        const dataRows = [];
        for (let i = table1HeaderIdx + 1; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('çµ„ç•ª')) continue;
          if (line.includes('ãƒ¯ã‚¤ãƒ‰') || line.includes('ä¸‰é€£')) break;
          if (/^[\d-]/.test(line)) {
            dataRows.push(line);
          } else if (dataRows.length > 0) {
            break;
          }
        }

        // å„åˆ¸ç¨®ã®åˆ—ä½ç½®ï¼ˆçµ„ç•ª/é‡‘é¡/äººæ°— ãŒ3åˆ—1ã‚»ãƒƒãƒˆï¼‰
        // å˜å‹(0-2), è¤‡å‹(3-5), æ è¤‡(6-8), é¦¬è¤‡(9-11), æ å˜(12-14), é¦¬å˜(15-17)
        const ticketTypes = [
          { key: 'tansho', offset: 0, hasNumber: true },
          { key: 'fukusho', offset: 3, hasNumber: true },
          { key: 'wakuren', offset: 6, hasNumber: false },
          { key: 'umaren', offset: 9, hasNumber: false },
          { key: 'wakutan', offset: 12, hasNumber: false },
          { key: 'umatan', offset: 15, hasNumber: false }
        ];

        for (const type of ticketTypes) {
          const items = [];
          for (const row of dataRows) {
            const values = row.split(/[\s\u3000]+/).filter(v => v);
            const numOrCombo = values[type.offset];
            const payout = values[type.offset + 1];
            const popularity = values[type.offset + 2];

            if (numOrCombo && numOrCombo !== '-' && payout && payout !== '-' && popularity && popularity !== '-') {
              items.push({
                [type.hasNumber ? 'number' : 'combination']: numOrCombo,
                payout: parseInt(payout.replace(/,/g, ''), 10),
                popularity: parseInt(popularity, 10)
              });
            }
          }
          if (items.length > 0) {
            payouts[type.key] = items;
          }
        }
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«2: ãƒ¯ã‚¤ãƒ‰/ä¸‰é€£è¤‡/ä¸‰é€£å˜
      const table2HeaderIdx = lines.findIndex(l =>
        l.includes('ãƒ¯ã‚¤ãƒ‰') && l.includes('ä¸‰é€£')
      );

      if (table2HeaderIdx > -1) {
        const dataRows = [];
        for (let i = table2HeaderIdx + 1; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('çµ„ç•ª')) continue;
          if (line.includes('å‚™è€ƒ')) break;
          if (/^[\d-]/.test(line)) {
            dataRows.push(line);
          } else if (dataRows.length > 0) {
            break;
          }
        }

        // ãƒ¯ã‚¤ãƒ‰(0-2), ä¸‰é€£è¤‡(3-5), ä¸‰é€£å˜(6-8)
        const ticketTypes = [
          { key: 'wide', offset: 0 },
          { key: 'sanrenpuku', offset: 3 },
          { key: 'sanrentan', offset: 6 }
        ];

        for (const type of ticketTypes) {
          const items = [];
          for (const row of dataRows) {
            const values = row.split(/[\s\u3000]+/).filter(v => v);
            const combo = values[type.offset];
            const payout = values[type.offset + 1];
            const popularity = values[type.offset + 2];

            if (combo && combo !== '-' && payout && payout !== '-' && popularity && popularity !== '-') {
              items.push({
                combination: combo,
                payout: parseInt(payout.replace(/,/g, ''), 10),
                popularity: parseInt(popularity, 10)
              });
            }
          }
          if (items.length > 0) {
            payouts[type.key] = items;
          }
        }
      }

      return payouts;
    }

    function extractTimeData(text) {
      const timeData = {};

      console.log('[DEBUG extractTimeData] é–‹å§‹');
      console.log('[DEBUG extractTimeData] å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆé•·:', text.length);

      // ã‚ˆã‚Šå …ç‰¢ãªæŠ½å‡ºï¼šã€Œä¸ŠãŒã‚Š3Fã€ã€Œä¸ŠãŒã‚Š4Fã€ã€Œãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ã€ãŒåŒã˜è¡Œã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      const lines = text.split('\n').map(l => l.trim());

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™ï¼ˆ3ã¤ã™ã¹ã¦ãŒå«ã¾ã‚Œã‚‹è¡Œï¼‰
      const headerIdx = lines.findIndex(l =>
        l.includes('ä¸ŠãŒã‚Š3F') &&
        l.includes('ä¸ŠãŒã‚Š4F') &&
        l.includes('ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ')
      );

      console.log('[DEBUG extractTimeData] ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', headerIdx);

      if (headerIdx === -1) {
        console.log('[DEBUG extractTimeData] ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return null;
      }

      console.log('[DEBUG extractTimeData] ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ:', lines[headerIdx]);

      // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¬¡ã®è¡Œï¼‰
      if (!lines[headerIdx + 1]) {
        console.log('[DEBUG extractTimeData] ãƒ‡ãƒ¼ã‚¿è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return null;
      }

      const dataLine = lines[headerIdx + 1];
      console.log('[DEBUG extractTimeData] ãƒ‡ãƒ¼ã‚¿è¡Œ:', dataLine);

      // ã‚¿ãƒ–ã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
      const values = dataLine.split(/[\s\t]+/).filter(v => v);
      console.log('[DEBUG extractTimeData] ãƒ‡ãƒ¼ã‚¿å€¤:', values);

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ—é †ã‚’ç¢ºèª
      const headers = lines[headerIdx].split(/[\s\t]+/).filter(v => v);
      console.log('[DEBUG extractTimeData] ãƒ˜ãƒƒãƒ€ãƒ¼:', headers);

      const last3FIdx = headers.indexOf('ä¸ŠãŒã‚Š3F');
      const last4FIdx = headers.indexOf('ä¸ŠãŒã‚Š4F');
      const furlongIdx = headers.indexOf('ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ');

      console.log('[DEBUG extractTimeData] åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', { last3FIdx, last4FIdx, furlongIdx });

      // ä¸ŠãŒã‚Š3F
      if (last3FIdx > -1 && values[last3FIdx]) {
        timeData.last3F = parseFloat(values[last3FIdx]);
        console.log('[DEBUG extractTimeData] ä¸ŠãŒã‚Š3FæŠ½å‡ºæˆåŠŸ:', timeData.last3F);
      } else {
        console.log('[DEBUG extractTimeData] ä¸ŠãŒã‚Š3FæŠ½å‡ºå¤±æ•—');
      }

      // ä¸ŠãŒã‚Š4F
      if (last4FIdx > -1 && values[last4FIdx]) {
        timeData.last4F = parseFloat(values[last4FIdx]);
        console.log('[DEBUG extractTimeData] ä¸ŠãŒã‚Š4FæŠ½å‡ºæˆåŠŸ:', timeData.last4F);
      } else {
        console.log('[DEBUG extractTimeData] ä¸ŠãŒã‚Š4FæŠ½å‡ºå¤±æ•—');
      }

      // ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ 
      if (furlongIdx > -1 && values[furlongIdx]) {
        const furlongStr = values[furlongIdx];
        console.log('[DEBUG extractTimeData] ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ æ–‡å­—åˆ—:', furlongStr);
        const furlongs = furlongStr.split('-').map(f => parseFloat(f.trim())).filter(f => !isNaN(f));
        console.log('[DEBUG extractTimeData] ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ é…åˆ—:', furlongs);
        if (furlongs.length > 0) {
          timeData.furlongTimes = furlongs;
        }
      } else {
        console.log('[DEBUG extractTimeData] ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ æŠ½å‡ºå¤±æ•—');
      }

      const result = Object.keys(timeData).length > 0 ? timeData : null;
      console.log('[DEBUG extractTimeData] çµæœ:', result);

      return result;
    }

    function extractCornerData(text) {
      const corners = [];

      // ã¾ãšã€Œé€šéé †ã€ã¾ãŸã¯ã€Œã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
      const cornerSection = text.match(/(é€šéé †|ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †)[\s\S]*?(?=æ‰•æˆ»é‡‘|$)/);
      if (!cornerSection) {
        console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã‚»ã‚¯ã‚·ãƒ§ãƒ³: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return null;
      }

      const cornerSectionText = cornerSection[0];
      console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡ºæˆåŠŸ');

      // ç›´æ¥çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«æ¤œç´¢ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ”ãƒšå¯¾å¿œï¼‰
      // ã‚¿ãƒ–æ–‡å­—ã‚‚å«ã‚ãŸç©ºç™½æ–‡å­—ã«å¯¾å¿œ
      const cornerRegex = /([ï¼‘ï¼’]å‘¨)?([ï¼‘ï¼’ï¼“ï¼”])è§’[\s\t\u3000]+([\d,()]+)/g;

      let match;
      while ((match = cornerRegex.exec(cornerSectionText)) !== null) {
        const lapPrefix = match[1] || '';
        const cornerNumber = match[2];
        const orderStr = match[3];

        console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼ãƒãƒƒãƒ:', match[0]);
        console.log('[DEBUG] - lapPrefix:', lapPrefix, 'cornerNumber:', cornerNumber, 'orderStr:', orderStr);

        // æ‹¬å¼§ã‚’é™¤å»ã—ã¦é¦¬ç•ªã‚’æŠ½å‡ºï¼ˆä¾‹: "(4,14)" â†’ "4,14"ï¼‰
        const cleanedStr = orderStr.replace(/[()]/g, '');
        const order = cleanedStr.split(',').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));

        if (order.length > 0) {
          const cornerName = lapPrefix ? `${lapPrefix}${cornerNumber}è§’` : `${cornerNumber}è§’`;
          corners.push({
            corner: cornerName,
            order
          });
          console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼æŠ½å‡ºæˆåŠŸ:', cornerName, 'é ­æ•°:', order.length);
        }
      }

      console.log('[DEBUG] æŠ½å‡ºã•ã‚ŒãŸã‚³ãƒ¼ãƒŠãƒ¼æ•°:', corners.length);
      return corners.length > 0 ? corners : null;
    }

    function generateRaceCommentary(race) {
      if (!race.results || race.results.length === 0) return '';

      const winner = race.results[0];
      const second = race.results[1];
      const favorite = race.results.find(h => h.popularity === 1);

      let commentary = '';

      if (winner.popularity === 1) {
        commentary += `1ç•ªäººæ°—${winner.number}ç•ª${winner.name}ãŒ`;
        if (second) {
          commentary += `ç›´ç·šã§${second.number}ç•ª${second.name}ã‚’æ•ã‚‰ãˆã¦`;
        }
        commentary += `å„ªå‹ã€‚`;
        if (race.timeData?.last3F) {
          commentary += `ä¸ŠãŒã‚Š3ãƒãƒ­ãƒ³${race.timeData.last3F}ã®è„šã‚’ä½¿ã„ã€`;
        }
        commentary += `å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§å¿«å‹ã€‚`;
      } else {
        commentary += `${winner.popularity}ç•ªäººæ°—ã®${winner.number}ç•ª${winner.name}ãŒè¿½ã„è¾¼ã¿ã‹ã‚‰`;
        if (race.timeData?.last3F) {
          commentary += `ã€ä¸ŠãŒã‚Š3ãƒãƒ­ãƒ³${race.timeData.last3F}`;
        }
        commentary += ` å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}`;
        if (favorite && favorite.number !== winner.number) {
          commentary += `ã€1ç•ªäººæ°—${favorite.number}ç•ª${favorite.name}ã¯${favorite.rank}ç€`;
        }
        commentary += `ã€‚æ³¢ä¹±ã®æ±ºç€ã¨ãªã£ãŸã€‚`;
      }

      if (race.payouts?.sanrentan) {
        const payout = race.payouts.sanrentan.payout;
        if (payout >= 50000) {
          commentary += `ä¸‰é€£å˜ã®æ‰•ã„æˆ»ã—ã¯${payout.toLocaleString()}å††ã®è¶…é«˜é…å½“ï¼`;
        } else if (payout >= 10000) {
          commentary += `ä¸‰é€£å˜ã®æ‰•ã„æˆ»ã—ã¯${payout.toLocaleString()}å††ã®é«˜é…å½“ã€‚`;
        }
      }

      return commentary;
    }

    async function fetchPredictionData(date) {
      try {
        const [year, month] = date.split('-');
        const predUrl = `https://raw.githubusercontent.com/apol0510/keiba-data-shared/main/nankan/predictions/${year}/${month}/${date}.json`;
        const response = await fetch(predUrl);
        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        return null;
      }
    }

    function calculatePoints(horses) {
      if (!horses) return 10;
      if (horses <= 6) return 8;
      if (horses <= 9) return 9;
      if (horses <= 12) return 10;
      if (horses <= 14) return 11;
      if (horses <= 16) return 12;
      return 12;
    }

    function checkHit(prediction, result) {
      const debug = {
        hasPrediction: !!prediction,
        hasResult: !!result,
        predictionMain: prediction?.bettingLines?.umatan?.main || [],
        predictionSub: prediction?.bettingLines?.umatan?.sub || [],
        resultCombo: result?.payouts?.umatan?.combination || null,
        resultPayout: result?.payouts?.umatan?.payout || 0
      };

      if (!prediction || !result) {
        return { hit: false, hitType: null, payout: 0, debug };
      }

      const umatanCombo = result.payouts?.umatan?.combination;
      if (!umatanCombo) {
        return { hit: false, hitType: null, payout: 0, debug };
      }

      if (prediction.bettingLines?.umatan?.main?.includes(umatanCombo)) {
        return {
          hit: true,
          hitType: 'main',
          payout: result.payouts.umatan.payout || 0,
          debug
        };
      }

      if (prediction.bettingLines?.umatan?.sub?.includes(umatanCombo)) {
        return {
          hit: true,
          hitType: 'sub',
          payout: result.payouts.umatan.payout || 0,
          debug
        };
      }

      return { hit: false, hitType: null, payout: 0, debug };
    }

    function generateArchiveResults(parsedData, predictionData) {
      const [year, month, day] = parsedData.date.split('-');

      let totalRaces = 0;
      let hitRaces = 0;
      let totalPayout = 0;
      let totalPoints = 0;
      const races = [];

      parsedData.races.forEach(race => {
        totalRaces++;

        const prediction = predictionData?.races?.find(p => p.raceNumber === race.raceNumber);

        const betPoints = calculatePoints(race.horses);
        totalPoints += betPoints;

        const hitResult = checkHit(prediction, race);

        if (hitResult.hit) {
          hitRaces++;
          totalPayout += hitResult.payout;
        }

        races.push({
          raceNumber: `${race.raceNumber}R`,
          raceName: race.raceName || '-',
          betType: 'é¦¬å˜',
          betPoints: betPoints,
          hit: hitResult.hit,
          hitType: hitResult.hitType,
          payout: hitResult.payout,
          debug: hitResult.debug
        });
      });

      const purchaseAmount = totalPoints * 100;
      const recoveryRate = purchaseAmount > 0 ? Math.round((totalPayout / purchaseAmount) * 100) : 0;
      const perfectHit = totalRaces > 0 && hitRaces === totalRaces;

      return {
        [year]: {
          [month]: {
            [day]: {
              venue: parsedData.venue,
              totalRaces: totalRaces,
              hitRaces: hitRaces,
              perfectHit: perfectHit,
              totalPayout: totalPayout,
              recoveryRate: recoveryRate,
              races: races
            }
          }
        }
      };
    }
  </script>
</BaseLayout>
