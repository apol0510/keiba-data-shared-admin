---
/**
 * ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢
 * ã‚¹ãƒ†ãƒƒãƒ—1: äºˆæƒ³HTMLã‚’è²¼ã‚Šä»˜ã‘æŠ½å‡º
 * ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã¦è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
 * ä¿å­˜: GitHub API / Push
 *
 * è‘—ä½œæ¨©å¯¾å¿œ: è¨˜è€…åã‚’å°ç•ªå·åŒ–ï¼ˆå°3/å°2/å°1/å°0ï¼‰
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢">
  <div class="container">
    <h1>ğŸ‡ ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢</h1>
    <p class="subtitle">äºˆæƒ³HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦è‡ªå‹•æŠ½å‡ºãƒ»ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</p>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: HTMLè²¼ã‚Šä»˜ã‘ -->
    <section class="section">
      <h2>ğŸ“¥ ã‚¹ãƒ†ãƒƒãƒ—1: äºˆæƒ³HTMLè²¼ã‚Šä»˜ã‘</h2>
      <p class="description">
        å‡ºé¦¬è¡¨HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
      </p>
      <textarea
        id="htmlInput"
        rows="10"
        placeholder="<div class='racename'>...çœç•¥...</div>
<table class='default syutuba'>...çœç•¥...</table>"
      ></textarea>
      <button id="extractBtn" class="btn-primary">ğŸ” è‡ªå‹•æŠ½å‡ºå®Ÿè¡Œ</button>
    </section>

    <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ±è¡¨ç¤º -->
    <section class="section" id="raceInfoSection" style="display: none;">
      <h2>ğŸ“‹ ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h2>
      <div id="raceInfoDisplay" class="race-info-display"></div>
    </section>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: æŠ½å‡ºçµæœã¨ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° -->
    <section class="section" id="extractionResultSection" style="display: none;">
      <h2>âœ… ã‚¹ãƒ†ãƒƒãƒ—2: æŠ½å‡ºçµæœã¨ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</h2>
      <div id="extractionStatus"></div>

      <h3>ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°çµæœ</h3>
      <div class="scoring-legend">
        <p>â—=5ç‚¹ / â—‹=4ç‚¹ / â–²=3ç‚¹ / svgç”»=2ç‚¹ / â–³=1ç‚¹ / ç„¡=0ç‚¹</p>
      </div>

      <div class="sort-controls">
        <button id="sortByScoreBtn" class="sort-btn active">ç‚¹æ•°é †</button>
        <button id="sortByNumberBtn" class="sort-btn">é¦¬ç•ªé †</button>
      </div>

      <div class="table-wrapper">
        <table id="extractionTable" class="data-table">
          <thead>
            <tr>
              <th>é¦¬ç•ª</th>
              <th id="mark4Header">å°3</th>
              <th id="mark3Header">å°2</th>
              <th id="mark2Header">å°1</th>
              <th id="mark1Header">å°0</th>
              <th>é¦¬å</th>
              <th>æ€§é½¢</th>
              <th>é¨æ‰‹</th>
              <th>æ–¤é‡</th>
              <th>å©èˆ</th>
            </tr>
          </thead>
          <tbody id="extractionTableBody"></tbody>
        </table>
      </div>

      <h3>è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘çµæœ</h3>
      <div id="assignmentResult" class="assignment-result"></div>
    </section>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <section class="section" id="previewSection" style="display: none;">
      <h2>ğŸ‘ï¸ å‡ºåŠ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
      <div id="previewContent" class="preview-content"></div>
    </section>

    <!-- ä¿å­˜ -->
    <section class="section" id="saveSection" style="display: none;">
      <h2>ğŸ’¾ ä¿å­˜ï¼ˆGitHub API / Pushï¼‰</h2>
      <p class="description">
        å„äºˆæƒ³ã‚µã‚¤ãƒˆã§èª­ã¿è¾¼ã‚“ã§èª¿æ•´ã—ã¦ãã ã•ã„
      </p>
      <div id="saveStatus"></div>
      <button id="saveBtn" class="btn-success">ğŸš€ ä¿å­˜ã—ã¦Git Push</button>
    </section>
  </div>

  <style>
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      background: #ffffff;
      color: #000000;
      min-height: 100vh;
    }

    .container p,
    .container div,
    .container span,
    .container td,
    .container th,
    .container li {
      color: inherit;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      background: none;
      color: #000000;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }

    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #333333;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }

    .section h3 {
      font-size: 1.1rem;
      margin: 1.5rem 0 1rem 0;
      color: #444444;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }

    .description {
      color: #666666;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #dddddd;
      border-radius: 4px;
      font-size: 1rem;
      background: #ffffff;
      color: #000000;
      font-family: monospace;
      resize: vertical;
    }

    .btn-primary,
    .btn-success {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .race-info-display {
      background: #f0f9ff;
      padding: 1.5rem;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }

    .race-info-display h3 {
      font-size: 1.5rem;
      margin: 0 0 0.5rem 0;
      color: #1e40af;
    }

    .race-info-display p {
      margin: 0.25rem 0;
      color: #334155;
    }

    .scoring-legend {
      background: #fef3c7;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .scoring-legend p {
      margin: 0;
      font-weight: 600;
      color: #92400e;
    }

    .sort-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .sort-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      background: white;
      color: #6b7280;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sort-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .sort-btn.active {
      border-color: #3b82f6;
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #dddddd;
      padding: 0.5rem;
      text-align: left;
      background: #ffffff;
      color: #000000;
    }

    .data-table th {
      background: #f3f4f6;
      font-weight: 600;
      color: #000000;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    .data-table tbody tr:hover td {
      background: #f9fafb;
      color: #000000;
    }

    .assignment-result {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .assignment-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
    }

    .assignment-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .assignment-card-header {
      font-size: 1.1rem;
      font-weight: 600;
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
      border-bottom: 2px solid #e5e7eb;
      color: #1f2937;
    }

    .assignment-card-body {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .assignment-card-body li {
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: #f9fafb;
      border-radius: 4px;
      color: #374151;
      font-size: 0.9rem;
    }

    .assignment-card-body li:hover {
      background: #f3f4f6;
    }

    .assignment-card.main .assignment-card-header {
      color: #dc2626;
      border-bottom-color: #dc2626;
    }

    .assignment-card.sub .assignment-card-header {
      color: #ea580c;
      border-bottom-color: #ea580c;
    }

    .assignment-card.hole .assignment-card-header {
      color: #d97706;
      border-bottom-color: #d97706;
    }

    .assignment-card.connect-top .assignment-card-header {
      color: #059669;
      border-bottom-color: #059669;
    }

    .assignment-card.connect .assignment-card-header {
      color: #0891b2;
      border-bottom-color: #0891b2;
    }

    .assignment-card.reserve .assignment-card-header {
      color: #6366f1;
      border-bottom-color: #6366f1;
    }

    .assignment-card.none .assignment-card-header {
      color: #9ca3af;
      border-bottom-color: #9ca3af;
    }

    .preview-content {
      background: #f8fafc;
      color: #1e293b;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #e2e8f0;
    }

    .preview-content pre {
      margin: 0;
      font-family: monospace;
      font-size: 0.875rem;
      color: #1e293b;
    }

    #extractionStatus,
    #saveStatus {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let extractionResult = null;
    let raceInfo = null;
    let currentSortOrder = 'score'; // 'score' or 'number'
    let scoredData = null;

    // æŠ½å‡ºãƒœã‚¿ãƒ³
    document.getElementById("extractBtn").addEventListener("click", async () => {
      const html = document.getElementById("htmlInput").value;

      if (!html.trim()) {
        alert("HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
        return;
      }

      try {
        // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’æŠ½å‡º
        raceInfo = extractRaceInfo(html);
        showRaceInfo(raceInfo);

        // é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        const result = await extractPredictions(html);

        if (!result.success) {
          showExtractionStatus(false, result.errors.join("\n"));
          return;
        }

        extractionResult = result;

        // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã¨æŒ¯ã‚Šåˆ†ã‘
        scoredData = scoreAndAssign(result);

        showExtractionResult(scoredData);
        showAssignmentResult(scoredData);
        showExtractionStatus(true, `âœ… ${result.horses.length}é ­ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`);

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        document.getElementById("raceInfoSection").style.display = "block";
        document.getElementById("extractionResultSection").style.display = "block";
        document.getElementById("previewSection").style.display = "block";
        document.getElementById("saveSection").style.display = "block";

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        showPreview(raceInfo, scoredData);

      } catch (error) {
        showExtractionStatus(false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    });

    // ãƒ¬ãƒ¼ã‚¹æƒ…å ±æŠ½å‡º
    function extractRaceInfo(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const racename = doc.querySelector(".racename");
      if (!racename) {
        throw new Error("ãƒ¬ãƒ¼ã‚¹æƒ…å ±ï¼ˆ.racenameï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }

      const date = racename.querySelector("p")?.textContent.trim() || "";
      const track = racename.querySelector("h2")?.textContent.trim() || "";
      const raceNo = racename.querySelector(".raceno")?.textContent.trim() || "";
      const raceName = racename.querySelector(".h1block h1")?.textContent.trim() || "";
      const raceType = racename.querySelector(".h1block p:first-of-type")?.textContent.trim() || "";
      const distance = racename.querySelector(".racekyori")?.textContent.trim() || "";
      const surface = racename.querySelector(".raceshibada")?.textContent.trim() || "";
      const weather = racename.querySelector(".tenkibaba")?.textContent.trim() || "";

      return {
        date,
        track,
        raceNumber: raceNo + "R",
        raceName,
        raceType,
        distance,
        surface,
        weather,
        displayName: `${track}${raceNo}R`,
      };
    }

    // ãƒ¬ãƒ¼ã‚¹æƒ…å ±è¡¨ç¤º
    function showRaceInfo(info) {
      const display = document.getElementById("raceInfoDisplay");
      display.innerHTML = `
        <h3>${info.displayName}</h3>
        <p><strong>æ—¥ä»˜:</strong> ${info.date}</p>
        <p><strong>ãƒ¬ãƒ¼ã‚¹å:</strong> ${info.raceName}</p>
        <p><strong>ãƒ¬ãƒ¼ã‚¹ç¨®åˆ¥:</strong> ${info.raceType}</p>
        <p><strong>è·é›¢:</strong> ${info.distance} ${info.surface}</p>
      `;
    }

    // é¦¬ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
    async function extractPredictions(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const table = doc.querySelector("table.default.syutuba");
      if (!table) {
        return { success: false, errors: ["å‡ºé¦¬è¡¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"], horses: [], predictors: [] };
      }

      const headerRow = table.querySelector("thead tr");
      if (!headerRow) {
        return { success: false, errors: ["ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"], horses: [], predictors: [] };
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œå‡º
      const predictors = [];
      const predictorHeaders = [];
      let seireiIndex = -1;
      let kisyuIndex = -1;
      let kinryoIndex = -1;
      let kyusyaIndex = -1;

      headerRow.querySelectorAll("th").forEach((th, index) => {
        const text = th.textContent.trim();

        // äºˆæƒ³è€…åˆ—ã‚’æ¤œå‡ºï¼ˆMyå°ã¯é™¤å¤–ã€è‘—ä½œæ¨©å¯¾å¿œã§å°ç•ªå·åŒ–ï¼‰
        if ((th.classList.contains("tmyoso") || text.includes("å°")) && !text.includes("My")) {
          const markNumber = 3 - predictors.length; // å°3, å°2, å°1, å°0
          predictors.push(`å°${markNumber}`);
          predictorHeaders.push(index);
        }

        // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œå‡º
        if (text.includes("æ€§") && text.includes("é½¢")) seireiIndex = index;
        if (text.includes("é¨æ‰‹")) kisyuIndex = index;
        if (text.includes("æ–¤") && text.includes("é‡")) kinryoIndex = index;
        if (text.includes("å©èˆ")) kyusyaIndex = index;
      });

      // é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const horses = [];
      table.querySelectorAll("tbody tr").forEach(row => {
        const tds = Array.from(row.querySelectorAll("td"));

        const umabanTd = tds.find(td => td.classList.contains("umaban"));
        const bameiTd = tds.find(td => td.classList.contains("bamei"));

        if (!umabanTd || !bameiTd) return;

        const number = parseInt(umabanTd.textContent.trim(), 10);
        const link = bameiTd.querySelector("a");
        const name = link ? link.textContent.trim() : "";
        const href = link ? link.getAttribute("href") : "";
        const umacdMatch = href.match(/\/uma\/(\d+)/);
        const umacd = umacdMatch ? umacdMatch[1] : undefined;

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
        const seirei = seireiIndex >= 0 && tds[seireiIndex] ? tds[seireiIndex].textContent.trim() : "";
        const kisyu = kisyuIndex >= 0 && tds[kisyuIndex] ? tds[kisyuIndex].textContent.trim() : "";
        const kinryo = kinryoIndex >= 0 && tds[kinryoIndex] ? tds[kinryoIndex].textContent.trim() : "";

        // å©èˆï¼š(å¤§)æœˆå²¡ å½¢å¼ã«æ•´å½¢
        let kyusya = "";
        if (kyusyaIndex >= 0 && tds[kyusyaIndex]) {
          const kyusyaTd = tds[kyusyaIndex];
          const syozokuSpan = kyusyaTd.querySelector(".syozoku");
          if (syozokuSpan) {
            const syozoku = syozokuSpan.textContent.trim();
            const trainerName = kyusyaTd.textContent.replace(syozoku, "").trim();
            kyusya = `(${syozoku})${trainerName}`;
          } else {
            kyusya = kyusyaTd.textContent.trim();
          }
        }

        // äºˆæƒ³è€…åˆ—ã‹ã‚‰å°ã‚’æŠ½å‡ºï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ï¼‰
        const marks = {};
        predictorHeaders.forEach((headerIndex, i) => {
          if (tds[headerIndex]) {
            const td = tds[headerIndex];
            // svgç”»ã¯"svg"ã¨ã—ã¦ä¿å­˜ï¼ˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã§2ç‚¹ã¨ã—ã¦æ‰±ã†ï¼‰
            const mark = td.querySelector("svg") ? "svg" : td.textContent.trim();
            marks[predictors[i]] = mark || "-";
          }
        });

        horses.push({ number, name, umacd, marks, seirei, kisyu, kinryo, kyusya });
      });

      return {
        success: true,
        horses,
        predictors,
        errors: [],
      };
    }

    // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã¨æŒ¯ã‚Šåˆ†ã‘
    function scoreAndAssign(result) {
      const markScores = {
        "â—": 5,
        "â—‹": 4,
        "â–²": 3,
        "svg": 2,  // svgç”»ã¯2ç‚¹
        "â–³": 1,
        "ç©´": 1,
        "æ³¨": 1,
        "-": 0,
      };

      const horses = result.horses.map(horse => {
        let totalScore = 0;
        Object.values(horse.marks).forEach(mark => {
          totalScore += markScores[mark] || 0;
        });

        return {
          ...horse,
          totalScore,
        };
      });

      // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
      horses.sort((a, b) => b.totalScore - a.totalScore);

      // æŒ¯ã‚Šåˆ†ã‘
      const assignments = {
        main: null,        // æœ¬å‘½ 1é ­
        sub: null,         // å¯¾æŠ— 1é ­
        hole: null,        // å˜ç©´ 1é ­
        connectTop: null,  // é€£ä¸‹æœ€ä¸Šä½ 1é ­
        connect: [],       // é€£ä¸‹ 1~5é ­
        reserve: [],       // è£œæ¬ ï¼ˆ1ç‚¹ä»¥ä¸Šï¼‰
        none: [],          // ç„¡ï¼ˆ0ç‚¹ï¼‰
      };

      horses.forEach((horse, index) => {
        if (index === 0) {
          assignments.main = horse;
          horse.assignment = "æœ¬å‘½";
        } else if (index === 1) {
          assignments.sub = horse;
          horse.assignment = "å¯¾æŠ—";
        } else if (index === 2) {
          assignments.hole = horse;
          horse.assignment = "å˜ç©´";
        } else if (index === 3) {
          assignments.connectTop = horse;
          horse.assignment = "é€£ä¸‹æœ€ä¸Šä½";
        } else if (index >= 4 && index <= 8 && horse.totalScore > 0) {
          assignments.connect.push(horse);
          horse.assignment = "é€£ä¸‹";
        } else if (horse.totalScore > 0) {
          assignments.reserve.push(horse);
          horse.assignment = "è£œæ¬ ";
        } else {
          assignments.none.push(horse);
          horse.assignment = "ç„¡";
        }
      });

      return {
        ...result,
        horses,
        assignments,
      };
    }

    // æŠ½å‡ºçµæœè¡¨ç¤º
    function showExtractionResult(scored) {
      const tbody = document.getElementById("extractionTableBody");
      tbody.innerHTML = "";

      // å°ç•ªå·ã®ã¿è¡¨ç¤ºï¼ˆè‘—ä½œæ¨©å¯¾å¿œã§è¨˜è€…åå‰Šé™¤ï¼‰
      // predictors[0] = "å°3"
      // predictors[1] = "å°2"
      // predictors[2] = "å°1"
      // predictors[3] = "å°0"
      if (scored.predictors.length >= 1) {
        document.getElementById("mark4Header").textContent = scored.predictors[0];
      }
      if (scored.predictors.length >= 2) {
        document.getElementById("mark3Header").textContent = scored.predictors[1];
      }
      if (scored.predictors.length >= 3) {
        document.getElementById("mark2Header").textContent = scored.predictors[2];
      }
      if (scored.predictors.length >= 4) {
        document.getElementById("mark1Header").textContent = scored.predictors[3];
      }

      // ã‚½ãƒ¼ãƒˆé †ã«å¿œã˜ã¦è¡¨ç¤º
      const displayHorses = currentSortOrder === 'score'
        ? scored.horses
        : [...scored.horses].sort((a, b) => a.number - b.number);

      displayHorses.forEach((horse) => {
        const row = tbody.insertRow();

        // é¦¬ç•ª
        row.insertCell().textContent = horse.number;

        // å°3ï¼ˆpredictors[0]ï¼‰
        const mark4 = scored.predictors[0] ? horse.marks[scored.predictors[0]] || "-" : "-";
        row.insertCell().textContent = mark4;

        // å°2ï¼ˆpredictors[1]ï¼‰
        const mark3 = scored.predictors[1] ? horse.marks[scored.predictors[1]] || "-" : "-";
        row.insertCell().textContent = mark3;

        // å°1ï¼ˆpredictors[2]ï¼‰
        const mark2 = scored.predictors[2] ? horse.marks[scored.predictors[2]] || "-" : "-";
        row.insertCell().textContent = mark2;

        // å°0ï¼ˆpredictors[3]ï¼‰
        const mark1 = scored.predictors[3] ? horse.marks[scored.predictors[3]] || "-" : "-";
        row.insertCell().textContent = mark1;

        // é¦¬å
        row.insertCell().textContent = horse.name;

        // æ€§é½¢
        row.insertCell().textContent = horse.seirei || "-";

        // é¨æ‰‹
        row.insertCell().textContent = horse.kisyu || "-";

        // æ–¤é‡
        row.insertCell().textContent = horse.kinryo || "-";

        // å©èˆ
        row.insertCell().textContent = horse.kyusya || "-";
      });
    }

    function getAssignmentColor(assignment) {
      const colors = {
        "æœ¬å‘½": "#dc2626",
        "å¯¾æŠ—": "#ea580c",
        "å˜ç©´": "#d97706",
        "é€£ä¸‹æœ€ä¸Šä½": "#059669",
        "é€£ä¸‹": "#0891b2",
        "è£œæ¬ ": "#6366f1",
        "ç„¡": "#9ca3af",
      };
      return colors[assignment] || "#000000";
    }

    // æŒ¯ã‚Šåˆ†ã‘çµæœè¡¨ç¤ºï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰
    function showAssignmentResult(scored) {
      const display = document.getElementById("assignmentResult");
      const a = scored.assignments;

      const formatHorse = (horse) =>
        horse ? `${horse.number}ç•ª ${horse.name} (${horse.totalScore}ç‚¹)` : "ãªã—";

      const createCard = (className, title, horses) => {
        const horsesList = Array.isArray(horses)
          ? horses.map(h => `<li>${formatHorse(h)}</li>`).join("")
          : `<li>${formatHorse(horses)}</li>`;

        const isEmpty = (Array.isArray(horses) && horses.length === 0) || (!Array.isArray(horses) && !horses);
        const content = isEmpty ? "<li>ãªã—</li>" : horsesList;

        return `
          <div class="assignment-card ${className}">
            <div class="assignment-card-header">${title}</div>
            <ul class="assignment-card-body">${content}</ul>
          </div>
        `;
      };

      display.innerHTML = `
        ${createCard('main', 'â— æœ¬å‘½', a.main)}
        ${createCard('sub', 'â—‹ å¯¾æŠ—', a.sub)}
        ${createCard('hole', 'â–² å˜ç©´', a.hole)}
        ${createCard('connect-top', 'â–³ é€£ä¸‹æœ€ä¸Šä½', a.connectTop)}
        ${createCard('connect', 'â–³ é€£ä¸‹ (1~5é ­)', a.connect)}
        ${createCard('reserve', 'Ã— è£œæ¬  (1ç‚¹ä»¥ä¸Š)', a.reserve)}
        ${createCard('none', 'ç„¡ (0ç‚¹)', a.none)}
      `;
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function showPreview(raceInfo, scored) {
      const data = {
        version: "1.0.0",
        createdAt: new Date().toISOString(),
        lastUpdated: new Date().toISOString(),
        raceInfo: {
          date: raceInfo.date,
          track: raceInfo.track,
          raceNumber: raceInfo.raceNumber,
          raceName: raceInfo.raceName,
          raceType: raceInfo.raceType,
          distance: raceInfo.distance,
          surface: raceInfo.surface,
        },
        horses: scored.horses.map(h => ({
          number: h.number,
          name: h.name,
          umacd: h.umacd,
          marks: h.marks,
          seirei: h.seirei,
          kisyu: h.kisyu,
          kinryo: h.kinryo,
          kyusya: h.kyusya,
          totalScore: h.totalScore,
          assignment: h.assignment,
        })),
        predictors: scored.predictors,
        assignments: {
          main: scored.assignments.main?.number,
          sub: scored.assignments.sub?.number,
          hole: scored.assignments.hole?.number,
          connectTop: scored.assignments.connectTop?.number,
          connect: scored.assignments.connect.map(h => h.number),
          reserve: scored.assignments.reserve.map(h => h.number),
          none: scored.assignments.none.map(h => h.number),
        },
      };

      const content = document.getElementById("previewContent");
      content.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // æŠ½å‡ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showExtractionStatus(success, message) {
      const status = document.getElementById("extractionStatus");
      status.className = success ? "status-success" : "status-error";
      status.textContent = message;
    }

    // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
    document.getElementById("sortByScoreBtn").addEventListener("click", () => {
      if (currentSortOrder === 'score') return;
      currentSortOrder = 'score';
      document.getElementById("sortByScoreBtn").classList.add("active");
      document.getElementById("sortByNumberBtn").classList.remove("active");
      if (scoredData) {
        showExtractionResult(scoredData);
      }
    });

    document.getElementById("sortByNumberBtn").addEventListener("click", () => {
      if (currentSortOrder === 'number') return;
      currentSortOrder = 'number';
      document.getElementById("sortByNumberBtn").classList.add("active");
      document.getElementById("sortByScoreBtn").classList.remove("active");
      if (scoredData) {
        showExtractionResult(scoredData);
      }
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById("saveBtn").addEventListener("click", async () => {
      if (!raceInfo || !extractionResult) {
        showSaveStatus(false, "âŒ ãƒ‡ãƒ¼ã‚¿ãŒæŠ½å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }

      const scored = scoreAndAssign(extractionResult);

      const data = {
        version: "1.0.0",
        createdAt: new Date().toISOString(),
        lastUpdated: new Date().toISOString(),
        raceInfo: {
          date: raceInfo.date,
          track: raceInfo.track,
          raceNumber: raceInfo.raceNumber,
          raceName: raceInfo.raceName,
          raceType: raceInfo.raceType,
          distance: raceInfo.distance,
          surface: raceInfo.surface,
        },
        horses: scored.horses.map(h => ({
          number: h.number,
          name: h.name,
          umacd: h.umacd,
          marks: h.marks,
          seirei: h.seirei,
          kisyu: h.kisyu,
          kinryo: h.kinryo,
          kyusya: h.kyusya,
          totalScore: h.totalScore,
          assignment: h.assignment,
        })),
        predictors: scored.predictors,
        assignments: {
          main: scored.assignments.main?.number,
          sub: scored.assignments.sub?.number,
          hole: scored.assignments.hole?.number,
          connectTop: scored.assignments.connectTop?.number,
          connect: scored.assignments.connect.map(h => h.number),
          reserve: scored.assignments.reserve.map(h => h.number),
          none: scored.assignments.none.map(h => h.number),
        },
      };

      try {
        showSaveStatus(true, "ğŸ”„ ä¿å­˜ä¸­...");

        // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
        const dateMatch = raceInfo.date.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        const raceDate = dateMatch
          ? `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`
          : new Date().toISOString().split('T')[0];

        const response = await fetch("/.netlify/functions/save-predictions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            raceDate: raceDate,
            track: raceInfo.track,
            raceNumber: raceInfo.raceNumber,
            data: {
              raceDate: raceDate,
              lastUpdated: data.lastUpdated,
              track: raceInfo.track,
              totalRaces: 1,
              races: [data],
            },
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showSaveStatus(true, `âœ… ä¿å­˜æˆåŠŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«: ${result.path}\nã‚³ãƒŸãƒƒãƒˆ: ${result.sha.substring(0, 7)}\nURL: ${result.url}`);
        } else {
          showSaveStatus(false, `âŒ ä¿å­˜å¤±æ•—: ${result.error}\nè©³ç´°: ${result.details || ""}`);
        }
      } catch (error) {
        showSaveStatus(false, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    });

    function showSaveStatus(success, message) {
      const status = document.getElementById("saveStatus");
      status.className = success ? "status-success" : "status-error";
      status.textContent = message;
    }
  </script>
</BaseLayout>
