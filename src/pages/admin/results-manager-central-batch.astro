---
/**
 * ä¸­å¤®ç«¶é¦¬çµæœãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ï¼ˆ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬å…¥åŠ›ç‰ˆï¼‰
 * results-manager-centralã¨ã¯å®Œå…¨ã«åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«
 *
 * æ©Ÿèƒ½:
 * - 12ãƒ¬ãƒ¼ã‚¹åˆ†ã®çµæœHTMLã‚’ä¸€æ‹¬è²¼ã‚Šä»˜ã‘
 * - ãƒ¬ãƒ¼ã‚¹å¢ƒç•Œã‚’è‡ªå‹•æ¤œå‡ºã—ã¦åˆ†å‰²
 * - å„ãƒ¬ãƒ¼ã‚¹ã‚’å€‹åˆ¥ã«æŠ½å‡ºãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * - 12ãƒ¬ãƒ¼ã‚¹åˆ†ã‚’1ã¤ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
 */
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout
  title="ä¸­å¤®ç«¶é¦¬ çµæœç®¡ç†ç”»é¢ï¼ˆä¸€æ‹¬å…¥åŠ›ï¼‰"
  description="12ãƒ¬ãƒ¼ã‚¹åˆ†ã®çµæœHTMLã‚’ä¸€æ‹¬ã§è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">âš¡ ä¸­å¤®ç«¶é¦¬ çµæœç®¡ç†ï¼ˆ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ï¼‰</h1>
      <p class="page-description">
        <strong>12ãƒ¬ãƒ¼ã‚¹åˆ†ã®çµæœã‚’ä¸€åº¦ã«è²¼ã‚Šä»˜ã‘ã¦ä¸€æ‹¬å‡¦ç†ã§ãã¾ã™</strong><br>
        JRAå…¬å¼ã‚µã‚¤ãƒˆã®çµæœãƒšãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ï¼†è²¼ã‚Šä»˜ã‘ã™ã‚‹ã ã‘ï¼<br>
        â€» å€‹åˆ¥å…¥åŠ›ãŒå¿…è¦ãªå ´åˆã¯ <a href="/admin/results-manager-central" style="color: var(--primary-end); text-decoration: underline;">ä¸­å¤®ç«¶é¦¬ çµæœç®¡ç†ï¼ˆå€‹åˆ¥å…¥åŠ›ï¼‰</a> ã‚’ã”åˆ©ç”¨ãã ã•ã„
      </p>

      <!-- å…±é€šæƒ…å ±å…¥åŠ› -->
      <div class="card common-info-card">
        <h2>ğŸ“… é–‹å‚¬æƒ…å ±ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹å…±é€šï¼‰</h2>
        <div class="common-info-grid">
          <div class="form-group">
            <label for="commonDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="commonDate"
              class="form-input"
              value={new Date().toISOString().split('T')[0]}
            />
          </div>
          <div class="form-group">
            <label for="commonVenue">ç«¶é¦¬å ´</label>
            <select id="commonVenue" class="form-select">
              <option value="æ±äº¬">æ±äº¬</option>
              <option value="ä¸­å±±">ä¸­å±±</option>
              <option value="äº¬éƒ½">äº¬éƒ½</option>
              <option value="é˜ªç¥">é˜ªç¥</option>
              <option value="ä¸­äº¬">ä¸­äº¬</option>
              <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
              <option value="ç¦å³¶">ç¦å³¶</option>
              <option value="å°å€‰">å°å€‰</option>
              <option value="æœ­å¹Œ">æœ­å¹Œ</option>
              <option value="å‡½é¤¨">å‡½é¤¨</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ä¸€æ‹¬å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="card input-card">
        <h2>ğŸ“‹ 12ãƒ¬ãƒ¼ã‚¹åˆ†ã®çµæœãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šä»˜ã‘</h2>
        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
          JRAå…¬å¼ã‚µã‚¤ãƒˆã®çµæœãƒšãƒ¼ã‚¸ã§<strong>ç¬¬1Rã€œç¬¬12R</strong>ã¾ã§ã®è¡¨ç¤ºå†…å®¹ã‚’å…¨ã¦é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
          è‡ªå‹•çš„ã«ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«åˆ†å‰²ãƒ»è§£æã—ã¾ã™ã€‚ï¼ˆHTMLã‚¿ã‚°ã¯ä¸è¦ã§ã™ï¼‰
        </p>

        <textarea
          id="batchInput"
          class="batch-textarea"
          rows="20"
          placeholder="12ãƒ¬ãƒ¼ã‚¹åˆ†ã®çµæœãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„

â€» JRAå…¬å¼ã‚µã‚¤ãƒˆã®çµæœãƒšãƒ¼ã‚¸ã§ã€ç¬¬1Rã€œç¬¬12Rã¾ã§ã®
  è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å†…å®¹ã‚’å…¨ã¦é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ï¼†è²¼ã‚Šä»˜ã‘ã—ã¦ãã ã•ã„ã€‚

ä¾‹:
1ãƒ¬ãƒ¼ã‚¹
2026å¹´2æœˆ1æ—¥ äº¬éƒ½ç«¶é¦¬ ç¬¬1æ—¥
3æ­³æœªå‹åˆ©
ã‚³ãƒ¼ã‚¹ï¼š1,800ãƒ¡ãƒ¼ãƒˆãƒ«ï¼ˆãƒ€ãƒ¼ãƒˆãƒ»å³ï¼‰ï¼ˆ13é ­ï¼‰
ç™ºèµ°æ™‚åˆ»ï¼š09:50
å¤©å€™ï¼šæ™´
é¦¬å ´ï¼šè‰¯
ç€    æ     é¦¬ç•ª    é¦¬å...
1    1    1    ã‚°ãƒ©ã‚·ã‚¢ãƒ ãƒ˜ãƒ¼ãƒ«...
...
æ‰•æˆ»é‡‘
å˜å‹    è¤‡å‹...

2ãƒ¬ãƒ¼ã‚¹
2026å¹´2æœˆ1æ—¥ äº¬éƒ½ç«¶é¦¬ ç¬¬1æ—¥
...
(ç¬¬12ãƒ¬ãƒ¼ã‚¹ã¾ã§)"
        ></textarea>

        <div class="action-buttons" style="margin-top: var(--spacing-lg);">
          <button
            type="button"
            class="btn btn-primary btn-large"
            onclick="parseBatchRaces()"
          >
            ğŸ” 12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬è§£æ
          </button>
        </div>

        <div id="parseStatus" class="parse-status" style="display: none;"></div>
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
      <div id="previewSection" class="preview-section" style="display: none;">
        <div class="card">
          <h2>âœ… è§£æçµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
          <div id="raceSummary" class="race-summary"></div>

          <!-- å„ãƒ¬ãƒ¼ã‚¹ã®è©³ç´°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
          <div id="raceDetails" class="race-details"></div>

          <!-- ä¸€æ‹¬ä¿å­˜ãƒœã‚¿ãƒ³ -->
          <div class="action-buttons" style="margin-top: var(--spacing-2xl);">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="copyAllJSON()"
            >
              ğŸ“‹ JSONå…¨ã‚³ãƒ”ãƒ¼
            </button>
            <button
              type="button"
              id="saveAllBtn"
              class="btn btn-success btn-large"
              onclick="saveAllRacesToGit(false)"
            >
              ğŸš€ 12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ä¿å­˜ã—ã¦Git Push
            </button>
            <button
              type="button"
              class="btn btn-warning"
              onclick="if(confirm('ã“ã®æ—¥ä»˜ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) saveAllRacesToGit(true)"
            >
              ğŸ”¥ å®Œå…¨ä¸Šæ›¸ãä¿å­˜
            </button>
          </div>
          <div id="saveStatus" class="save-status" style="display: none;"></div>
        </div>
      </div>

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ğŸ“– ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´</strong>ã‚’ä¸Šéƒ¨ã§é¸æŠ</li>
          <li>JRAå…¬å¼ã‚µã‚¤ãƒˆã®çµæœãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
          <li><strong>ç¬¬1ãƒ¬ãƒ¼ã‚¹ã€œç¬¬12ãƒ¬ãƒ¼ã‚¹å…¨ã¦ã®è¡¨ç¤ºå†…å®¹</strong>ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼
            <ul style="margin-top: 0.5rem; font-size: 0.9rem;">
              <li>ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’é¸æŠï¼ˆCtrl+A / Cmd+Aï¼‰</li>
              <li>ã¾ãŸã¯ã€1ãƒ¬ãƒ¼ã‚¹ã®ã€Œ1ãƒ¬ãƒ¼ã‚¹ã€ã‹ã‚‰12ãƒ¬ãƒ¼ã‚¹ã®æ‰•æˆ»é‡‘ã¾ã§é¸æŠ</li>
            </ul>
          </li>
          <li>ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ï¼ˆCtrl+V / Cmd+Vï¼‰</li>
          <li>ã€Œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬è§£æã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å„ãƒ¬ãƒ¼ã‚¹ã®æŠ½å‡ºçµæœã‚’ç¢ºèª</li>
          <li>ã€Œ12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ä¿å­˜ã—ã¦Git Pushã€ã§ keiba-data-shared ã«ä¿å­˜</li>
          <li>è‡ªå‹•çš„ã«å„ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ ğŸ‰</li>
        </ol>

        <h3>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</h3>
        <ul>
          <li>12ãƒ¬ãƒ¼ã‚¹åˆ†ã‚’ä¸€åº¦ã«å‡¦ç†ã§ãã¾ã™ï¼ˆåŠ¹ç‡é‡è¦–ï¼‰</li>
          <li>HTMLã‚¿ã‚°ã¯ä¸è¦ã§ã™ï¼ˆè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼‰</li>
          <li>ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸãƒ¬ãƒ¼ã‚¹ã¯èµ¤è‰²ã§è¡¨ç¤ºã•ã‚Œã¾ã™</li>
          <li>æ…é‡ã«ç¢ºèªã—ãŸã„å ´åˆã¯ <a href="/admin/results-manager-central" style="color: var(--primary-end);">å€‹åˆ¥å…¥åŠ›</a> ã‚’ã”åˆ©ç”¨ãã ã•ã„</li>
          <li>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ï¼‰</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
      line-height: 1.6;
    }

    .common-info-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-2xl);
    }

    .common-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input,
    .form-select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .input-card {
      max-width: 1200px;
      margin: 0 auto var(--spacing-2xl);
    }

    .batch-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
      min-height: 400px;
    }

    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }

    .btn-large {
      flex: 1;
      min-width: 200px;
    }

    .parse-status,
    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
      display: none;
    }

    .parse-status.success,
    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .parse-status.error,
    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .parse-status.loading,
    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }

    .preview-section {
      max-width: 1200px;
      margin: 0 auto var(--spacing-2xl);
    }

    .race-summary {
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    .race-details {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .race-detail-card {
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .race-detail-card.success {
      border-color: var(--success);
    }

    .race-detail-card.error {
      border-color: var(--error);
    }

    .race-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      cursor: pointer;
      font-weight: 600;
      font-size: 1.25rem;
      user-select: none;
      background: var(--bg-secondary);
    }

    .race-detail-header:hover {
      background: var(--bg-tertiary);
    }

    .race-number-badge {
      color: var(--primary-end);
      font-size: 1.5rem;
    }

    .race-status-badge {
      font-size: 0.875rem;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .race-status-badge.success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .race-status-badge.error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .race-detail-content {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-2xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    @media (max-width: 768px) {
      .common-info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-large {
        width: 100%;
      }
    }
  </style>

  <script is:inline>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let batchResults = [];

    // ä¸€æ‹¬è§£æãƒ¡ã‚¤ãƒ³é–¢æ•°
    function parseBatchRaces() {
      const textarea = document.getElementById('batchInput');
      const html = textarea.value;

      if (!html.trim()) {
        alert('12ãƒ¬ãƒ¼ã‚¹åˆ†ã®çµæœHTMLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const statusDiv = document.getElementById('parseStatus');
      statusDiv.style.display = 'block';
      statusDiv.className = 'parse-status loading';
      statusDiv.textContent = 'ğŸ” 12ãƒ¬ãƒ¼ã‚¹åˆ†ã‚’è§£æä¸­...';

      try {
        // ãƒ¬ãƒ¼ã‚¹å¢ƒç•Œã§åˆ†å‰²
        const raceHTMLs = splitRacesHTML(html);
        console.log(`[parseBatchRaces] æ¤œå‡ºã—ãŸãƒ¬ãƒ¼ã‚¹æ•°: ${raceHTMLs.length}`);

        if (raceHTMLs.length === 0) {
          statusDiv.className = 'parse-status error';
          statusDiv.textContent = 'âŒ ãƒ¬ãƒ¼ã‚¹ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚HTMLã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          return;
        }

        // å…±é€šæƒ…å ±å–å¾—
        const date = document.getElementById('commonDate').value;
        const venue = document.getElementById('commonVenue').value;

        // å„ãƒ¬ãƒ¼ã‚¹ã‚’è§£æ
        batchResults = [];
        let successCount = 0;
        let errorCount = 0;

        raceHTMLs.forEach((raceHTML, index) => {
          const raceNum = index + 1;
          try {
            // ãƒ¬ãƒ¼ã‚¹æƒ…å ±æŠ½å‡º
            const raceInfo = extractRaceInfo(raceHTML, raceNum);

            // çµæœãƒ‡ãƒ¼ã‚¿æŠ½å‡º
            const results = extractResults(raceHTML);
            const payouts = extractPayouts(raceHTML);
            const timeData = extractTimeData(raceHTML);
            const cornerData = extractCornerData(raceHTML);

            // ãƒ¬ãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ï¼ˆgenerateRaceCommentaryç”¨ï¼‰
            const race = {
              raceNumber: raceNum,
              raceName: raceInfo.raceName,
              surface: raceInfo.surface,
              distance: raceInfo.distance,
              horses: results.length,
              results: results,
              payouts: payouts,
              cornerData: cornerData,
              timeData: timeData
            };

            const comment = generateRaceCommentary(race, date, venue);

            const data = {
              date: date,
              venue: venue,
              raceNumber: raceNum,
              raceName: raceInfo.raceName,
              raceSubtitle: raceInfo.raceSubtitle,
              raceType: raceInfo.raceType,
              distance: raceInfo.distance,
              surface: raceInfo.surface,
              startTime: raceInfo.startTime,
              weather: raceInfo.weather,
              trackCondition: raceInfo.trackCondition,
              results: results,
              payouts: payouts,
              timeData: timeData,
              cornerData: cornerData,
              comment: comment,
            };

            batchResults.push({
              raceNumber: raceNum,
              success: true,
              data,
              date,
              venue,
            });
            successCount++;

          } catch (error) {
            console.error(`ç¬¬${raceNum}Rè§£æã‚¨ãƒ©ãƒ¼:`, error);
            batchResults.push({
              raceNumber: raceNum,
              success: false,
              errors: [error.message],
            });
            errorCount++;
          }
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        statusDiv.className = errorCount > 0 ? 'parse-status error' : 'parse-status success';
        statusDiv.innerHTML = `
          âœ… è§£æå®Œäº†: æˆåŠŸ ${successCount}ãƒ¬ãƒ¼ã‚¹ / ã‚¨ãƒ©ãƒ¼ ${errorCount}ãƒ¬ãƒ¼ã‚¹<br>
          ${errorCount > 0 ? 'âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸãƒ¬ãƒ¼ã‚¹ã¯ä¸‹ã§ç¢ºèªã—ã¦ãã ã•ã„' : ''}
        `;

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        displayBatchPreview(batchResults, date, venue);

      } catch (error) {
        statusDiv.className = 'parse-status error';
        statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        console.error(error);
      }
    }

    // ãƒ¬ãƒ¼ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²ï¼ˆçµæœç”¨ãƒ»ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œï¼‰
    function splitRacesHTML(text) {
      const races = [];

      console.log(`[splitRacesHTML] å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆé•·: ${text.length}æ–‡å­—`);
      console.log(`[splitRacesHTML] æœ€åˆã®500æ–‡å­—:`, text.substring(0, 500));

      // ä¸­å¤®ç«¶é¦¬ã®çµæœã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼ˆHTMLã‚¿ã‚°ãªã—ï¼‰
      // ãƒ‘ã‚¿ãƒ¼ãƒ³: ã€Œ1ãƒ¬ãƒ¼ã‚¹ã€ã€Œ2ãƒ¬ãƒ¼ã‚¹ã€...ã€Œ12ãƒ¬ãƒ¼ã‚¹ã€ã®ã‚ˆã†ãªå½¢å¼
      const racePattern = /(\d{1,2})ãƒ¬ãƒ¼ã‚¹/g;

      const raceMatches = [];
      let match;

      while ((match = racePattern.exec(text)) !== null) {
        raceMatches.push({
          index: match.index,
          raceNum: parseInt(match[1], 10),
          fullMatch: match[0]
        });
      }

      console.log(`[splitRacesHTML] â—‹ãƒ¬ãƒ¼ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºæ•°: ${raceMatches.length}å€‹`);

      if (raceMatches.length > 0) {
        // å„ãƒ¬ãƒ¼ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        for (let i = 0; i < raceMatches.length; i++) {
          const startIndex = raceMatches[i].index;
          const endIndex = i < raceMatches.length - 1 ? raceMatches[i + 1].index : text.length;
          const raceText = text.substring(startIndex, endIndex);

          if (raceText.length > 100) {
            races.push(raceText);
            console.log(`[splitRacesHTML] ç¬¬${raceMatches[i].raceNum}ãƒ¬ãƒ¼ã‚¹: ${raceText.length}æ–‡å­—`);
            console.log(`[splitRacesHTML] ç¬¬${raceMatches[i].raceNum}ãƒ¬ãƒ¼ã‚¹ æœ€åˆã®200æ–‡å­—:`, raceText.substring(0, 200));
          } else {
            console.warn(`[splitRacesHTML] ç¬¬${raceMatches[i].raceNum}ãƒ¬ãƒ¼ã‚¹: ãƒ‡ãƒ¼ã‚¿ãŒçŸ­ã™ãã‚‹ï¼ˆ${raceText.length}æ–‡å­—ï¼‰`);
          }
        }
      } else {
        console.error('[splitRacesHTML] ãƒ¬ãƒ¼ã‚¹å¢ƒç•Œã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
        console.log('[splitRacesHTML] ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰:', text.substring(0, 1000));
      }

      console.log(`[splitRacesHTML] æœ€çµ‚çš„ã«æ¤œå‡ºã—ãŸãƒ¬ãƒ¼ã‚¹æ•°: ${races.length}`);
      return races;
    }

    // ===== results-manager-central.astroã‹ã‚‰çµ±åˆã—ãŸæŠ½å‡ºé–¢æ•° =====
    // TODO: ä¸­å¤®ç«¶é¦¬ç‰¹æœ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œãŒå¿…è¦ãªå ´åˆã¯å€‹åˆ¥ã«èª¿æ•´

    function extractRaceInfo(text, raceNumber) {
      let raceName = '';
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);

      console.log('[extractRaceInfo] ãƒ¬ãƒ¼ã‚¹ç•ªå·:', raceNumber);
      console.log('[extractRaceInfo] ãƒ†ã‚­ã‚¹ãƒˆè¡Œæ•°:', lines.length);

      // æ‰•æˆ»é‡‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚ˆã‚Šå‰ã®è¡Œã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹ï¼ˆè³é‡‘ãƒ‡ãƒ¼ã‚¿ã®æ··å…¥ã‚’é˜²æ­¢ï¼‰
      const payoutStartIdx = lines.findIndex(l => l.includes('æ‰•æˆ»é‡‘'));
      const targetLines = payoutStartIdx !== -1 ? lines.slice(0, payoutStartIdx) : lines;

      console.log('[extractRaceInfo] æ‰•æˆ»é‡‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹:', payoutStartIdx);
      console.log('[extractRaceInfo] ãƒ¬ãƒ¼ã‚¹åæ¤œç´¢å¯¾è±¡è¡Œæ•°:', targetLines.length);

      // å„ªå…ˆé †ä½1: é‡è³ãƒ¬ãƒ¼ã‚¹å
      for (let line of targetLines) {
        const trimmedLine = line.trim();
        const hasKaisuu = trimmedLine.match(/ç¬¬\d+å›/);
        const isDateOrVenue = trimmedLine.match(/ç«¶é¦¬|æœˆ|æ—¥|å¹´/);
        const hasGrade = trimmedLine.match(/[ï¼ˆ(][ï¼³ï¼§ï¼ª][ï¼©Iï½ï½]/);

        if ((hasKaisuu && !isDateOrVenue) || hasGrade) {
          raceName = trimmedLine;
          console.log('[extractRaceInfo] é‡è³ãƒ¬ãƒ¼ã‚¹åæŠ½å‡º:', raceName);
          break;
        }
      }

      // å„ªå…ˆé †ä½2: åœ°æ–¹ç«¶é¦¬ã‚°ãƒ¬ãƒ¼ãƒ‰
      if (!raceName) {
        for (let line of targetLines) {
          const trimmedLine = line.trim();
          if (trimmedLine.match(/[ï¼¡ï¼¢ï¼£][ï¼‘ï¼’ï¼“ï¼]/)) {
            raceName = trimmedLine;
            console.log('[extractRaceInfo] ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ã‚¹åæŠ½å‡º:', raceName);
            break;
          }
        }
      }

      // å„ªå…ˆé †ä½3: ã€Œç‰¹åˆ¥ã€ã€Œè³ã€ã€Œæ¯ã€
      // âš ï¸ æ‰•æˆ»é‡‘ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã€Œå˜å‹ã€ã€Œè¤‡å‹ã€ã€Œé¦¬é€£ã€ãªã©ï¼‰ã¨è³é‡‘ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é™¤å¤–
      if (!raceName) {
        for (let line of targetLines) {
          const trimmedLine = line.trim();
          // æ‰•æˆ»é‡‘ãƒ»è³é‡‘é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          const isPayoutRelated = trimmedLine.match(/å˜å‹|è¤‡å‹|é¦¬é€£|é¦¬å˜|æ é€£|æ å˜|ãƒ¯ã‚¤ãƒ‰|ä¸‰é€£|çµ„ç•ª|æ‰•æˆ»|äººæ°—|å††|è³é‡‘|ç•ªçµ„ãƒã‚¤ãƒ³ãƒˆ/);
          if (isPayoutRelated) {
            continue; // ã“ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          }

          if (trimmedLine.match(/ç‰¹åˆ¥|è³|æ¯|ç›ƒ/)) {
            raceName = trimmedLine;
            console.log('[extractRaceInfo] ä¸€èˆ¬ãƒ¬ãƒ¼ã‚¹åæŠ½å‡º:', raceName);
            break;
          }
        }
      }

      // å„ªå…ˆé †ä½4: ã‚¯ãƒ©ã‚¹åï¼ˆã€Œï¼“æ­³ã€ã€Œï¼’æ­³ã€ãªã©ï¼‰
      // ç‰¹åˆ¥åãŒãªã„ä¸€èˆ¬ãƒ¬ãƒ¼ã‚¹ã®å ´åˆ
      if (!raceName) {
        for (let line of targetLines) {
          const trimmedLine = line.trim();
          // æ‰•æˆ»é‡‘ãƒ»è³é‡‘é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          const isPayoutRelated = trimmedLine.match(/å˜å‹|è¤‡å‹|é¦¬é€£|é¦¬å˜|æ é€£|æ å˜|ãƒ¯ã‚¤ãƒ‰|ä¸‰é€£|çµ„ç•ª|æ‰•æˆ»|äººæ°—|å††|è³é‡‘|ç•ªçµ„ãƒã‚¤ãƒ³ãƒˆ|ã‚µãƒ©ãƒ–ãƒ¬ãƒƒãƒ‰ç³»|ã‚¢ãƒ©ãƒ–ç³»|æ™®é€šç«¶èµ°/);
          if (isPayoutRelated) {
            continue; // ã“ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          }

          // ï¼“æ­³(ä¸‰)ã€ï¼’æ­³ã€ï¼”æ­³ä»¥ä¸Š ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
          if (trimmedLine.match(/^[ï¼’ï¼“ï¼”]æ­³(\(.*\))?$/) || trimmedLine.match(/^\dæ­³ä»¥ä¸Š/)) {
            raceName = trimmedLine;
            console.log('[extractRaceInfo] ã‚¯ãƒ©ã‚¹åæŠ½å‡º:', raceName);
            break;
          }
        }
      }

      // è·é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³: "ãƒ€1,800m" ã¾ãŸã¯ "ãƒ€900m" ã®ä¸¡æ–¹ã«å¯¾å¿œ
      const distanceMatch = text.match(/[ãƒ€èŠ][\s\u3000]*(?:(\d{1}),?(\d{3})|(\d{3}))m/);
      let distance = null;
      if (distanceMatch) {
        if (distanceMatch[1] && distanceMatch[2]) {
          // 1,800å½¢å¼ï¼ˆ1æ¡+ã‚«ãƒ³ãƒ+3æ¡ï¼‰
          distance = parseInt(distanceMatch[1] + distanceMatch[2], 10);
        } else if (distanceMatch[3]) {
          // 900å½¢å¼ï¼ˆ3æ¡ã®ã¿ï¼‰
          distance = parseInt(distanceMatch[3], 10);
        }
      }

      console.log('[extractRaceInfo] è·é›¢æŠ½å‡º:', distance, 'from:', distanceMatch);

      const surface = text.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';

      const track = null;

      const horsesMatch = text.match(/ï¼ˆ(\d+)é ­ï¼‰/);
      const horses = horsesMatch ? parseInt(horsesMatch[1], 10) : null;

      const startTimeMatch = text.match(/ç™ºèµ°æ™‚åˆ»(\d{1,2}):(\d{2})/);
      const startTime = startTimeMatch ? `${startTimeMatch[1]}:${startTimeMatch[2]}` : null;

      // å¤©å€™æŠ½å‡ºï¼ˆæ”¹å–„ç‰ˆï¼‰
      const weatherMatch = text.match(/å¤©å€™[:ï¼š]\s*([^\s\n]+)/);
      const weather = weatherMatch ? weatherMatch[1] : null;

      // é¦¬å ´çŠ¶æ…‹æŠ½å‡ºï¼ˆæ”¹å–„ç‰ˆï¼‰
      const trackConditionMatch = text.match(/é¦¬å ´[:ï¼š]\s*(?:ãƒ€ãƒ¼ãƒˆ|èŠ)?\s*([^\s\n]+)/);
      const trackCondition = trackConditionMatch ? trackConditionMatch[1] : null;

      console.log('[extractRaceInfo] å¤©å€™:', weather);
      console.log('[extractRaceInfo] é¦¬å ´çŠ¶æ…‹:', trackCondition);

      return { raceNumber, raceName, distance, surface, track, horses, startTime, weather, trackCondition };
    }

    function extractResults(text) {
      const results = [];
      const lines = text.split('\n');

      console.log('[extractResults] ãƒ†ã‚­ã‚¹ãƒˆè¡Œæ•°:', lines.length);

      // ç€é †ãƒ‡ãƒ¼ã‚¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†ã‚’ç¤ºã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
      const sectionEndKeywords = [
        'ã‚¿ã‚¤ãƒ ',
        'ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ',
        'ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½',
        'æ‰•æˆ»é‡‘',
        'ä¸Šã‚Š',
        '4F',
        '3F'
      ];

      // ä¸­å¤®ç«¶é¦¬ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¤‡æ•°è¡Œã«åˆ†ã‹ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§çµåˆï¼‰
      let currentLine = '';
      let inResultSection = false;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue; // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†åˆ¤å®š
        const isEndOfSection = sectionEndKeywords.some(keyword => line.includes(keyword));
        if (isEndOfSection) {
          if (currentLine) {
            console.log('[extractResults] ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰:', line);
            // ç¾åœ¨ã®è¡Œã‚’å‡¦ç†ã—ã¦çµ‚äº†
            processLine(currentLine, results);
            currentLine = '';
          }
          inResultSection = false;
          continue;
        }

        // ç€é †ãƒ‡ãƒ¼ã‚¿ã®é–‹å§‹ã‚’æ¤œå‡ºï¼ˆä¸­å¤®ç«¶é¦¬ã¯å¿…ãšã€Œæ ã€ã¨ã„ã†æ–‡å­—ã‚’å«ã‚€ï¼‰
        // ä¾‹: "1     æ 10ç™½     10     ã‚±ãƒ–ãƒ©ãƒ³ãƒª..."
        const isStartOfResult = /^\d+[\s\u3000]+æ \d+/.test(line);

        if (isStartOfResult) {
          // æ–°ã—ã„ç€é †è¡ŒãŒå§‹ã¾ã£ãŸ
          if (currentLine) {
            // å‰ã®è¡Œã‚’å‡¦ç†
            console.log('[extractResults] æ–°ã—ã„ç€é †è¡Œæ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰');
            processLine(currentLine, results);
          }
          // æ–°ã—ã„è¡Œã‚’é–‹å§‹
          currentLine = line;
          inResultSection = true;
          console.log('[extractResults] ç€é †è¡Œé–‹å§‹:', line.substring(0, 80));
        } else if (inResultSection && currentLine) {
          // ç¶™ç¶šè¡Œã®åˆ¤å®šï¼šç€é †ãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã¨æ€ã‚ã‚Œã‚‹å ´åˆã®ã¿çµåˆ
          // ãŸã ã—ã€æ˜ã‚‰ã‹ã«åˆ¥ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¯çµåˆã—ãªã„

          // æ è‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ"æ 8æ¡ƒ"ãªã©ï¼‰ãŒæ¥ãŸã‚‰ã€åˆ¥ã®é¦¬ã®ãƒ‡ãƒ¼ã‚¿ãªã®ã§å‰ã®è¡Œã‚’å‡¦ç†
          const hasWakuIro = /æ \d+[æ¡ƒæ©™é’èµ¤ç·‘é»„é»’ç™½]/.test(line);
          if (hasWakuIro) {
            console.log('[extractResults] æ è‰²æ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰:', line);
            processLine(currentLine, results);
            currentLine = '';
            inResultSection = false;
            continue;
          }

          // ç‰¹è¨˜äº‹é …è¡Œï¼ˆãƒ–ãƒªãƒ³ã‚«ãƒ¼ç€ç”¨ãªã©ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
          const isRemark = line.includes('ãƒ–ãƒªãƒ³ã‚«ãƒ¼ç€ç”¨') ||
                          line.includes('ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ­ãƒ¼ãƒ«ç€ç”¨') ||
                          line.includes('ãƒ¡ãƒ³ã‚³ç€ç”¨') ||
                          line.includes('ãƒ‘ã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ç€ç”¨') ||
                          line.includes('ç€ç”¨');
          if (isRemark) {
            console.log('[extractResults] ç‰¹è¨˜äº‹é …è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—:', line);
            continue;
          }

          // ç¶™ç¶šè¡Œã¨ã—ã¦çµåˆã™ã¹ãã‹ã©ã†ã‹ã‚’åˆ¤å®š
          const shouldMerge = !isStartOfResult &&
                             !isEndOfSection &&
                             line.length > 0 &&
                             !line.startsWith('ã‚¿ã‚¤ãƒ ') &&
                             !line.startsWith('ãƒãƒ­ãƒ³') &&
                             !line.startsWith('ã‚³ãƒ¼ãƒŠãƒ¼') &&
                             !line.startsWith('æ‰•æˆ»');

          if (shouldMerge) {
            // ç¶™ç¶šè¡Œã‚’çµåˆï¼ˆãŸã ã—ã€æ€§é½¢ãŒ2å›ç›®ã«å‡ºç¾ã—ãŸã‚‰åˆ‡ã‚‹ï¼‰
            const currentSexAgeCount = (currentLine.match(/[ç‰¡ç‰ã‚»]\d+/g) || []).length;
            const lineSexAgeCount = (line.match(/[ç‰¡ç‰ã‚»]\d+/g) || []).length;

            if (currentSexAgeCount > 0 && lineSexAgeCount > 0) {
              // æ€§é½¢ãŒæ—¢ã«currentLineã«ã‚ã‚Šã€æ–°ã—ã„è¡Œã«ã‚‚ã‚ã‚‹å ´åˆã€åˆ¥ã®é¦¬ã®ãƒ‡ãƒ¼ã‚¿
              console.log('[extractResults] æ€§é½¢é‡è¤‡æ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰');
              processLine(currentLine, results);
              currentLine = '';
              inResultSection = false;
            } else {
              // ç¶™ç¶šè¡Œã‚’çµåˆ
              currentLine += ' ' + line;
              console.log('[extractResults] ç¶™ç¶šè¡Œçµåˆ:', line.substring(0, 50));
            }
          }
        }
      }

      // æœ€å¾Œã®è¡Œã‚’å‡¦ç†
      if (currentLine) {
        processLine(currentLine, results);
      }

      console.log('[extractResults] æŠ½å‡ºã•ã‚ŒãŸç€é †æ•°:', results.length);

      if (results.length === 0) throw new Error('ç€é †ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return results;
    }

    function processLine(line, results) {
      // ä¸­å¤®ç«¶é¦¬ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
      // ç€é † æ  é¦¬ç•ª é¦¬å æ€§é½¢ è² æ‹…é‡é‡ é¨æ‰‹å ã‚¿ã‚¤ãƒ  ç€å·® ã‚³ãƒ¼ãƒŠãƒ¼é€šé æ¨å®šä¸Šã‚Š é¦¬ä½“é‡ èª¿æ•™å¸«å å˜å‹äººæ°—
      // ä¾‹: 1    10    ã‚±ãƒ–ãƒ©ãƒ³ãƒª    ç‰¡3    57.0    C.ãƒ«ãƒ¡ãƒ¼ãƒ«    1:25.4        â€¢    1 â€¢    1    37.2    500(-2)    åŠ è—¤ å£«æ´¥å…«    1

      const parts = line.split(/[\s\u3000]+/).filter(p => p && p !== 'â€¢');

      console.log('[processLine] parts:', parts.slice(0, 20)); // æœ€åˆã®20å€‹ã®ã¿è¡¨ç¤º

      if (parts.length < 8) {
        console.log('[processLine] ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      let idx = 0;

      // ç€é †
      const rank = parseInt(parts[idx++], 10);
      if (isNaN(rank)) {
        console.log('[processLine] ç€é †ãŒæ•°å­—ã§ãªã„ã€ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      // æ ï¼ˆä¸­å¤®ç«¶é¦¬ã¯ "æ 8æ¡ƒ" å½¢å¼ã€å—é–¢ã¯ "8" å½¢å¼ï¼‰
      let bracket = 0;
      const bracketPart = parts[idx++];
      const wakuMatch = bracketPart.match(/^æ (\d+)[æ¡ƒæ©™é’èµ¤ç·‘é»„é»’ç™½]$/);
      if (wakuMatch) {
        bracket = parseInt(wakuMatch[1], 10);
        console.log('[processLine] æ è‰²æ¤œå‡º:', bracketPart, 'â†’', bracket);
      } else {
        bracket = parseInt(bracketPart, 10);
      }

      // é¦¬ç•ª
      const number = parseInt(parts[idx++], 10);

      // é¦¬åï¼ˆã‚«ã‚¿ã‚«ãƒŠã¾ãŸã¯è‹±å­—ã‚’å«ã‚€åå‰ã‚’æ¢ã™ï¼‰
      // æ€§é½¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç‰¡3ãªã©ï¼‰ã‚„è² æ‹…é‡é‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ57.0ãªã©ï¼‰ãŒæ¥ã‚‹ã¾ã§æ¢ã™
      let name = '';
      while (idx < parts.length && idx < 10) { // æœ€å¤§10å€‹ã¾ã§æ¢ã™
        const part = parts[idx];
        // æ€§é½¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç‰¡3ã€ç‰3ã€ã‚»3ãªã©ï¼‰ãŒæ¥ãŸã‚‰é¦¬åçµ‚äº†
        if (/^[ç‰¡ç‰ã‚»]\d+$/.test(part)) {
          break;
        }
        // è² æ‹…é‡é‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ57.0ãªã©ï¼‰ãŒæ¥ãŸã‚‰é¦¬åçµ‚äº†
        if (/^\d+\.\d+$/.test(part)) {
          break;
        }
        // ã‚«ã‚¿ã‚«ãƒŠã€ã²ã‚‰ãŒãªã€è‹±å­—ã‚’å«ã‚€å ´åˆã¯é¦¬åã®ä¸€éƒ¨
        if (/[ã‚¡-ãƒ´ã-ã‚“a-zA-Z]/.test(part)) {
          name = part;
          idx++;
          break;
        }
        // æ•°å­—ã ã‘ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé¦¬åã§ã¯ãªã„ï¼‰
        if (/^\d+$/.test(part)) {
          idx++;
          continue;
        }
        // ãã®ä»–ã®æ–‡å­—åˆ—ã¯é¦¬åå€™è£œ
        name = part;
        idx++;
        break;
      }

      if (!name) {
        console.log('[processLine] é¦¬åãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      // æ€§é½¢ã‚’æŠ½å‡ºï¼ˆç‰¡3ãªã©ï¼‰
      let sexAge = '';
      if (idx < parts.length && /^[ç‰¡ç‰ã‚»]\d+$/.test(parts[idx])) {
        sexAge = parts[idx++];
      }

      // è² æ‹…é‡é‡ã‚’æŠ½å‡ºï¼ˆ57.0ãªã©ï¼‰
      let weight = '';
      if (idx < parts.length && /^\d+\.\d+$/.test(parts[idx])) {
        weight = parts[idx++];
      }

      // é¨æ‰‹åï¼ˆæ¬¡ã®é …ç›®ãŒã‚¿ã‚¤ãƒ å½¢å¼ "1:25.4" ã«ãªã‚‹ã¾ã§ã€ã¾ãŸã¯æœ€å¤§3ãƒ‘ãƒ¼ãƒ„ã¾ã§ï¼‰
      let jockey = '';
      let jockeyPartCount = 0;
      const startIdx = idx;
      while (idx < parts.length && jockeyPartCount < 3) {
        // ã‚¿ã‚¤ãƒ å½¢å¼ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        if (/^\d+:\d+\.\d+$/.test(parts[idx])) {
          break;
        }
        // ä¸é©åˆ‡ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆé¦¬ä½“é‡ã‚„èª¿æ•™å¸«ã‚¨ãƒªã‚¢ï¼‰ãŒæ¥ãŸã‚‰æŠœã‘ã‚‹
        if (/^\d+\([+-]?\d+\)$/.test(parts[idx])) {
          break;
        }
        // "ã‚¿ã‚¤ãƒ "ãªã©ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ¥ãŸã‚‰æŠœã‘ã‚‹
        if (parts[idx] === 'ã‚¿ã‚¤ãƒ ' || parts[idx] === 'ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ' || parts[idx] === 'ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½') {
          break;
        }
        jockey += (jockey ? ' ' : '') + parts[idx];
        idx++;
        jockeyPartCount++;
      }

      // ã‚¿ã‚¤ãƒ ï¼ˆ"1:25.4" å½¢å¼ï¼‰
      let time = '';
      if (idx < parts.length && /^\d+:\d+\.\d+$/.test(parts[idx])) {
        time = parts[idx++];
      }

      // ç€å·®ï¼ˆ1ç€ã¯"-"ã€ãã‚Œä»¥å¤–ã¯æ•°å­—+å˜ä½ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      let margin = '-';
      if (idx < parts.length) {
        const part = parts[idx];
        // ç€å·®ã®ãƒ‘ã‚¿ãƒ¼ãƒ³: "ï¼‘", "ï¼’", "ï¼“"ãªã©ã®å…¨è§’æ•°å­—ã€ã¾ãŸã¯ "-"
        // åŠè§’æ•°å­—ã ã‘ã®å ´åˆã¯ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ãªã®ã§å«ã‚ãªã„
        if (!/^\d+$/.test(part) && !/^\d+\.\d+$/.test(part) && !/^\d+\(/.test(part)) {
          margin = parts[idx++];
          // ç€å·®ãŒè¤‡æ•°ãƒ‘ãƒ¼ãƒ„ã®å ´åˆï¼ˆä¾‹: "ï¼‘ 1/2", "ï¼’ 1/4"ï¼‰
          // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å«ã‚€å ´åˆã®ã¿ç€å·®ã¨ã—ã¦æ‰±ã†ï¼ˆåŠè§’æ•°å­—ã ã‘ã¯ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ï¼‰
          if (idx < parts.length && /^[\d/]+$/.test(parts[idx]) && parts[idx].includes('/')) {
            margin += ' ' + parts[idx++];
          }
        }
      }

      // ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸­å¤®ç«¶é¦¬ã¯4å€‹ï¼š1C, 2C, 3C, 4Cï¼‰
      let cornerSkipped = 0;
      while (idx < parts.length && /^\d+$/.test(parts[idx]) && cornerSkipped < 4) {
        idx++;
        cornerSkipped++;
      }

      // æ¨å®šä¸Šã‚Šï¼ˆä¸Š3F: "37.2" ã®ã‚ˆã†ãªå°æ•°ï¼‰
      let lastFurlong = '';
      if (idx < parts.length && /^\d+\.\d+$/.test(parts[idx])) {
        lastFurlong = parts[idx++];
      }

      // é¦¬ä½“é‡ï¼ˆå¢—æ¸›ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ"500(-2)" å½¢å¼ï¼‰
      if (idx < parts.length && /^\d+\([+-]?\d+\)$/.test(parts[idx])) {
        idx++;
      }

      // èª¿æ•™å¸«åï¼ˆæœ€å¾Œã‹ã‚‰2ç•ªç›®ã¾ã§ã€æœ€å¾Œã®1å€‹ã¯å˜å‹äººæ°—ï¼‰
      let trainer = '';
      // parts.length - 1 ãŒæœ€å¾Œã®è¦ç´ ï¼ˆå˜å‹äººæ°—ï¼‰ãªã®ã§ã€ãã‚Œã‚ˆã‚Šå‰ã‚’å…¨ã¦çµåˆ
      const endIdx = parts.length - 1;
      while (idx < endIdx) {
        trainer += (trainer ? ' ' : '') + parts[idx];
        idx++;
      }

      // å˜å‹äººæ°—ï¼ˆæœ€å¾Œã®æ•°å­—ï¼‰
      const popularity = parseInt(parts[idx], 10) || 0;

      console.log('[processLine] æŠ½å‡ºçµæœ:', { rank, bracket, number, name, sexAge, weight, jockey, time, margin, lastFurlong, trainer, popularity });

      if (!isNaN(rank) && !isNaN(bracket) && !isNaN(number) && name) {
        results.push({
          rank,
          bracket,
          number,
          name,
          sexAge,
          weight,
          jockey,
          trainer,
          time,
          margin: margin || '-',
          lastFurlong,
          popularity
        });
      }
    }

    function extractPayouts(text) {
      const payouts = {};

      const payoutMatch = text.match(/æ‰•æˆ»é‡‘[\s\S]*$/);
      if (!payoutMatch) return payouts;

      const payoutSection = payoutMatch[0];
      const lines = payoutSection.split('\n').filter(l => l.trim());

      // ãƒ†ãƒ¼ãƒ–ãƒ«1
      const table1HeaderIdx = lines.findIndex(l =>
        l.includes('å˜å‹') && l.includes('è¤‡å‹') && l.includes('é¦¬å˜')
      );

      if (table1HeaderIdx > -1) {
        const dataRows = [];
        for (let i = table1HeaderIdx + 1; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('çµ„ç•ª')) continue;
          if (line.includes('ãƒ¯ã‚¤ãƒ‰') || line.includes('ä¸‰é€£')) break;
          if (/^[\d-]/.test(line)) {
            dataRows.push(line);
          } else if (dataRows.length > 0) {
            break;
          }
        }

        const ticketTypes = [
          { key: 'tansho', offset: 0, hasNumber: true, maxEntries: 1 },
          { key: 'fukusho', offset: 3, hasNumber: true, maxEntries: 3 }, // è¤‡å‹ã¯2-3ç€ã¾ã§
          { key: 'wakuren', offset: 6, hasNumber: false, maxEntries: 1 },
          { key: 'umaren', offset: 9, hasNumber: false, maxEntries: 1 },
          { key: 'wakutan', offset: 12, hasNumber: false, maxEntries: 1 },
          { key: 'umatan', offset: 15, hasNumber: false, maxEntries: 1 }
        ];

        for (const type of ticketTypes) {
          const items = [];
          for (const row of dataRows) {
            const values = row.split(/[\s\u3000]+/).filter(v => v);

            // è¤‡å‹ã®å ´åˆã¯2-3ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’æŠ½å‡º
            if (type.key === 'fukusho') {
              // è¤‡å‹ã¯åŒä¸€è¡Œã«2-3å€‹ä¸¦ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
              // offset 3,4,5 / 6,7,8 / 9,10,11 ã®ã‚ˆã†ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹
              const fukushoOffsets = [3]; // æœ€åˆã®è¤‡å‹ã¯ offset 3

              // 2ã¤ç›®ã®è¤‡å‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ¬¡ã®ç©ºç™½åŒºåˆ‡ã‚Šã§3ã¤å…ˆï¼‰
              if (values[3] && values[4] && values[5] &&
                  values[3] !== '-' && values[4] !== '-' && values[5] !== '-') {
                // 1ã¤ç›®ã®è¤‡å‹
                items.push({
                  number: values[3],
                  payout: parseInt(values[4].replace(/,/g, ''), 10),
                  popularity: parseInt(values[5], 10)
                });
              }

              // 2ã¤ç›®ã¨3ã¤ç›®ã®è¤‡å‹ã‚’æ¢ã™ï¼ˆdataRowsã®ä¸­ã®æ¬¡ã®è¡Œã«åˆ†ã‹ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚è€ƒæ…®ï¼‰
              // ãŸã ã—ã€é€šå¸¸ã¯åŒã˜è¡Œã«ä¸¦ã‚“ã§ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯åˆ¥è¡Œã‚’ç¢ºèª
            } else {
              const numOrCombo = values[type.offset];
              const payout = values[type.offset + 1];
              const popularity = values[type.offset + 2];

              if (numOrCombo && numOrCombo !== '-' && payout && payout !== '-' && popularity && popularity !== '-') {
                items.push({
                  [type.hasNumber ? 'number' : 'combination']: numOrCombo,
                  payout: parseInt(payout.replace(/,/g, ''), 10),
                  popularity: parseInt(popularity, 10)
                });
              }
            }
          }

          // è¤‡å‹ã®å ´åˆã€dataRowsã‹ã‚‰è¤‡æ•°è¡Œå–å¾—ï¼ˆ1è¡Œç›®=1ç€ã€2è¡Œç›®=2ç€ã€3è¡Œç›®=3ç€ï¼‰
          if (type.key === 'fukusho') {
            items.length = 0; // ä¸€æ—¦ã‚¯ãƒªã‚¢
            for (let i = 0; i < Math.min(dataRows.length, 3); i++) {
              const values = dataRows[i].split(/[\s\u3000]+/).filter(v => v);
              const numOrCombo = values[type.offset];
              const payout = values[type.offset + 1];
              const popularity = values[type.offset + 2];

              if (numOrCombo && numOrCombo !== '-' && payout && payout !== '-' && popularity && popularity !== '-') {
                items.push({
                  number: numOrCombo,
                  payout: parseInt(payout.replace(/,/g, ''), 10),
                  popularity: parseInt(popularity, 10)
                });
              }
            }
          }

          if (items.length > 0) {
            payouts[type.key] = items;
          }
        }
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«2
      const table2HeaderIdx = lines.findIndex(l =>
        l.includes('ãƒ¯ã‚¤ãƒ‰') && l.includes('ä¸‰é€£')
      );

      if (table2HeaderIdx > -1) {
        const dataRows = [];
        for (let i = table2HeaderIdx + 1; i < lines.length; i++) {
          const line = lines[i];
          if (line.includes('çµ„ç•ª')) continue;
          if (line.includes('å‚™è€ƒ')) break;
          if (/^[\d-]/.test(line)) {
            dataRows.push(line);
          } else if (dataRows.length > 0) {
            break;
          }
        }

        const ticketTypes = [
          { key: 'wide', offset: 0 },
          { key: 'sanrenpuku', offset: 3 },
          { key: 'sanrentan', offset: 6 }
        ];

        for (const type of ticketTypes) {
          const items = [];
          for (const row of dataRows) {
            const values = row.split(/[\s\u3000]+/).filter(v => v);
            const combo = values[type.offset];
            const payout = values[type.offset + 1];
            const popularity = values[type.offset + 2];

            if (combo && combo !== '-' && payout && payout !== '-' && popularity && popularity !== '-') {
              items.push({
                combination: combo,
                payout: parseInt(payout.replace(/,/g, ''), 10),
                popularity: parseInt(popularity, 10)
              });
            }
          }
          if (items.length > 0) {
            payouts[type.key] = items;
          }
        }
      }

      return payouts;
    }

    function extractTimeData(text) {
      const timeData = {};

      const lines = text.split('\n').map(l => l.trim());

      const headerIdx = lines.findIndex(l =>
        l.includes('ä¸ŠãŒã‚Š3F') &&
        l.includes('ä¸ŠãŒã‚Š4F') &&
        l.includes('ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ')
      );

      if (headerIdx === -1) {
        return null;
      }

      if (!lines[headerIdx + 1]) {
        return null;
      }

      const dataLine = lines[headerIdx + 1];
      const values = dataLine.split(/[\s\t]+/).filter(v => v);
      const headers = lines[headerIdx].split(/[\s\t]+/).filter(v => v);

      const last3FIdx = headers.indexOf('ä¸ŠãŒã‚Š3F');
      const last4FIdx = headers.indexOf('ä¸ŠãŒã‚Š4F');
      const furlongIdx = headers.indexOf('ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ');

      if (last3FIdx > -1 && values[last3FIdx]) {
        timeData.last3F = parseFloat(values[last3FIdx]);
      }

      if (last4FIdx > -1 && values[last4FIdx]) {
        timeData.last4F = parseFloat(values[last4FIdx]);
      }

      if (furlongIdx > -1 && values[furlongIdx]) {
        const furlongStr = values[furlongIdx];
        const furlongs = furlongStr.split('-').map(f => parseFloat(f.trim())).filter(f => !isNaN(f));
        if (furlongs.length > 0) {
          timeData.furlongTimes = furlongs;
        }
      }

      return Object.keys(timeData).length > 0 ? timeData : null;
    }

    function extractCornerData(text) {
      const corners = [];

      const cornerSection = text.match(/(é€šéé †|ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †)[\s\S]*?(?=æ‰•æˆ»é‡‘|$)/);
      if (!cornerSection) {
        return null;
      }

      const cornerSectionText = cornerSection[0];

      const cornerRegex = /([ï¼‘ï¼’]å‘¨)?([ï¼‘ï¼’ï¼“ï¼”])è§’[\s\t\u3000]+([\d,()]+)/g;

      let match;
      let hasFirstLap = false;

      while ((match = cornerRegex.exec(cornerSectionText)) !== null) {
        let lapPrefix = match[1] || '';
        const cornerNumber = match[2];
        const orderStr = match[3];

        if (!lapPrefix) {
          if (hasFirstLap) {
            lapPrefix = 'ï¼’å‘¨';
          }
        } else if (lapPrefix === 'ï¼‘å‘¨') {
          hasFirstLap = true;
        }

        const cleanedStr = orderStr.replace(/[()]/g, '');
        const order = cleanedStr.split(',').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));

        if (order.length > 0) {
          const cornerName = lapPrefix ? `${lapPrefix}${cornerNumber}è§’` : `${cornerNumber}è§’`;
          corners.push({
            corner: cornerName,
            order
          });
        }
      }

      return corners.length > 0 ? corners : null;
    }

    function generateRaceCommentary(race, date, venue) {
      if (!race.results || race.results.length === 0) return '';

      const winner = race.results[0];
      const second = race.results[1];
      const third = race.results[2];
      const fourth = race.results[3];
      const favorite = race.results.find(h => h.popularity === 1);

      // é€ƒã’é¦¬ã‚’ç‰¹å®šï¼ˆæœ€åˆã®ã‚³ãƒ¼ãƒŠãƒ¼ã§å…ˆé ­ã«ã„ãŸé¦¬ï¼‰
      let pacemaker = null;
      if (race.cornerData && race.cornerData.length > 0) {
        const firstCorner = race.cornerData[0];
        const leadHorseNum = firstCorner.order[0];
        pacemaker = race.results.find(h => h.number === leadHorseNum);
      }

      // å„é¦¬ã®ä½ç½®å–ã‚Šã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ï¼ˆåºç›¤ãƒ»ä¸­ç›¤ãƒ»çµ‚ç›¤ï¼‰
      const getPosition = (horseNum, timing = 'last') => {
        if (!race.cornerData || race.cornerData.length === 0) return null;

        let corner;
        if (timing === 'early') {
          // åºç›¤ï¼šæœ€åˆã®ã‚³ãƒ¼ãƒŠãƒ¼
          corner = race.cornerData[0];
        } else if (timing === 'mid') {
          // ä¸­ç›¤ï¼šä¸­é–“ã®ã‚³ãƒ¼ãƒŠãƒ¼
          const midIndex = Math.floor(race.cornerData.length / 2);
          corner = race.cornerData[midIndex];
        } else {
          // çµ‚ç›¤ï¼šæœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼
          corner = race.cornerData[race.cornerData.length - 1];
        }

        const position = corner.order.indexOf(horseNum) + 1;
        if (position === 1) return { pos: position, label: 'å…ˆé ­' };
        if (position === 2) return { pos: position, label: '2ç•ªæ‰‹' };
        if (position === 3) return { pos: position, label: '3ç•ªæ‰‹' };
        if (position <= 5) return { pos: position, label: `${position}ç•ªæ‰‹` };
        if (position <= 8) return { pos: position, label: 'ä¸­å›£' };
        return { pos: position, label: 'å¾Œæ–¹' };
      };

      // å…¨ã‚³ãƒ¼ãƒŠãƒ¼ã§ã®å¹³å‡ä½ç½®ã¨ä¸€è²«æ€§ã‚’å–å¾—
      const getPositionConsistency = (horseNum) => {
        if (!race.cornerData || race.cornerData.length === 0) return null;

        const positions = [];
        for (const corner of race.cornerData) {
          const pos = corner.order.indexOf(horseNum) + 1;
          if (pos > 0) positions.push(pos);
        }

        if (positions.length === 0) return null;

        const avg = positions.reduce((a, b) => a + b, 0) / positions.length;
        const maxPos = Math.max(...positions);
        const minPos = Math.min(...positions);
        const range = maxPos - minPos;

        return {
          avgPos: avg,
          minPos: minPos,
          maxPos: maxPos,
          range: range,
          isConsistent: range <= 1 // ä½ç½®ã®ã°ã‚‰ã¤ããŒ1ä»¥ä¸‹ãªã‚‰ä¸€è²«
        };
      };

      const winnerPosEarly = getPosition(winner.number, 'early');
      const winnerPosMid = getPosition(winner.number, 'mid');
      const winnerPosLast = getPosition(winner.number, 'last');
      const secondPosEarly = second ? getPosition(second.number, 'early') : null;
      const secondPosMid = second ? getPosition(second.number, 'mid') : null;
      const secondPosLast = second ? getPosition(second.number, 'last') : null;
      const thirdPosLast = third ? getPosition(third.number, 'last') : null;

      let commentary = '';

      // å†’é ­ï¼šæ—¥ä»˜ãƒ»ç«¶é¦¬å ´ãƒ»ãƒ¬ãƒ¼ã‚¹ç•ªå·ãƒ»æ¡ä»¶ï¼ˆSEOå¯¾ç­–ï¼‰
      if (date && venue) {
        const [year, month, day] = date.split('-');
        const formattedDate = `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
        const surfaceLabel = race.surface === 'ãƒ€ãƒ¼ãƒˆ' ? 'ãƒ€' : 'èŠ';
        commentary += `${formattedDate}${venue}ç«¶é¦¬${race.raceNumber}ãƒ¬ãƒ¼ã‚¹ï¼ˆ${race.raceName || 'C3'} ${surfaceLabel}${race.distance}mãƒ»${race.horses}é ­ç«‹ï¼‰ã¯ã€`;
      }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³1: é€ƒã’åˆ‡ã‚Šå‹ã¡
      if (pacemaker && pacemaker.number === winner.number) {
        // å‹ã¡é¦¬ã®é€ƒã’
        commentary += `${winner.number}ç•ª${winner.name}ï¼ˆ`;
        if (winner.popularity === 1) {
          commentary += `1ç•ªäººæ°—`;
        } else {
          commentary += `${winner.popularity}ç•ªäººæ°—`;
        }
        commentary += `ï¼‰ãŒ`;
        commentary += `ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰ãƒãƒŠã‚’åˆ‡ã£ã¦ä¸»å°æ¨©ã‚’æ¡ã‚‹å±•é–‹ã€‚`;

        // ç›´ç·šã§ã®ç²˜ã‚Š
        commentary += `ç›´ç·šã§ã‚‚ç²˜ã‚Šå¼·ãè„šã‚’ä½¿ã„ã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã€‚`;

        // 2ç€é¦¬
        if (second && secondPosLast) {
          commentary += `2ç€ã«ã¯${secondPosLast.label}ã‹ã‚‰è¿½ã„è¾¼ã‚“ã ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
        } else if (second) {
          commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
        }

        // 3ç€é¦¬
        if (third) {
          commentary += `3ç€ã«ã¯${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
        }

        // ä¸‰é€£å˜é…å½“æƒ…å ±ã‚’è¿½åŠ ï¼ˆSEOå¯¾ç­–ï¼‰
        if (race.payouts?.sanrentan && race.payouts.sanrentan.length > 0) {
          const sanrentanPayout = race.payouts.sanrentan[0].payout;
          const sanrentanPop = race.payouts.sanrentan[0].popularity;
          const sanrentanCombo = race.payouts.sanrentan[0].combination;
          commentary += `ä¸‰é€£å˜${sanrentanCombo}ã¯${sanrentanPayout.toLocaleString()}å††ï¼ˆ${sanrentanPop}ç•ªäººæ°—ï¼‰ã§æ±ºç€ã—ãŸã€‚`;
        }

        // é¨æ‰‹ãƒ»å©èˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆç°¡æ½”ã«ã€å¿…ãšå¥ç‚¹ã§é–‰ã˜ã‚‹ï¼‰
        commentary += `éä¸Šã¯${winner.jockey}é¨æ‰‹ã¨${winner.trainer}å©èˆã®ã‚³ãƒ³ãƒ“ã ã£ãŸã€‚`;
      }
      // ãƒ‘ã‚¿ãƒ¼ãƒ³2: é€ƒã’é¦¬ãŒã„ã¦ã€å·®ã—åˆ‡ã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³
      else if (pacemaker && pacemaker.number !== winner.number) {
        // é€ƒã’é¦¬ã®å‹•ãï¼ˆäººæ°—ã‚‚è¡¨ç¤ºï¼‰
        commentary += `${pacemaker.number}ç•ª${pacemaker.name}ï¼ˆ${pacemaker.popularity}ç•ªäººæ°—ï¼‰ãŒãƒãƒŠã‚’åˆ‡ã‚‹å±•é–‹ã®ä¸­ã€`;

        // å‹ã¡é¦¬ã®è¿½ã„è¾¼ã¿
        commentary += `${winner.number}ç•ª${winner.name}ï¼ˆ`;
        if (winner.popularity === 1) {
          commentary += `1ç•ªäººæ°—`;
        } else {
          commentary += `${winner.popularity}ç•ªäººæ°—`;
        }
        commentary += `ï¼‰ãŒ`;

        // å…¨ã‚³ãƒ¼ãƒŠãƒ¼ã§ã®ä½ç½®å–ã‚Šã‚’åˆ†æ
        const winnerConsistency = getPositionConsistency(winner.number);
        if (winnerConsistency) {
          const avgPos = winnerConsistency.avgPos;
          const isConsistent = winnerConsistency.isConsistent;
          const earlyPos = winnerPosEarly ? winnerPosEarly.pos : null;
          const lastPos = winnerPosLast ? winnerPosLast.pos : null;

          // åºç›¤ã¨çµ‚ç›¤ã§ä½ç½®ãŒå¤‰åŒ–ã—ãŸã‹åˆ¤å®š
          if (earlyPos && lastPos && earlyPos >= 4 && lastPos <= 2) {
            // åºç›¤4ç•ªæ‰‹ä»¥é™ â†’ çµ‚ç›¤2ç•ªæ‰‹ä»¥å†… = å…ˆè¡Œ
            commentary += `å…ˆè¡Œã—ã¦è„šã‚’æºœã‚`;
          } else if (isConsistent && avgPos <= 2.5) {
            // ä¸€è²«ã—ã¦2ç•ªæ‰‹ä»¥å†…
            if (Math.round(avgPos) === 2) {
              commentary += `2ç•ªæ‰‹ã§æŠ˜ã‚Šåˆã„`;
            } else {
              commentary += `é€ƒã’é¦¬ã®ç›´å¾Œã§æŠ˜ã‚Šåˆã„`;
            }
          } else if (avgPos >= 2 && avgPos <= 5) {
            // 2ç•ªæ‰‹ã€œ5ç•ªæ‰‹ï¼ˆå¤‰å‹•ã‚ã‚Šï¼‰
            commentary += `å¥½ä½ã§è„šã‚’æºœã‚`;
          } else if (avgPos > 5 && avgPos <= 8) {
            // ä¸­å›£
            commentary += `ä¸­å›£ã§è„šã‚’æºœã‚`;
          } else {
            // å¾Œæ–¹
            commentary += `å¾Œæ–¹ã§è¿½èµ°å¾…æ©Ÿã—`;
          }
        } else if (winnerPosLast) {
          // ã‚³ãƒ¼ãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼
          if (winnerPosLast.pos >= 2 && winnerPosLast.pos <= 5) {
            commentary += `å¥½ä½ã§è„šã‚’æºœã‚`;
          } else {
            commentary += `${winnerPosLast.label}ã‚’è¿½èµ°ã—`;
          }
        }

        // æœ«è„šã¨æ±ºç€æ–¹æ³•ï¼ˆ4è§’ä½ç½®ã§åˆ¤æ–­ï¼‰
        // 4è§’ä½ç½®ã§é©åˆ‡ãªå‹•è©ã‚’é¸æŠ
        if (winnerPosLast && winnerPosLast.pos <= 2) {
          // 4è§’1ã€œ2ä½ï¼šæŠœã‘å‡ºã—
          commentary += `ç›´ç·šã§æŠœã‘å‡ºã—ã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã¨ãªã£ãŸ`;
        } else if (winnerPosLast && winnerPosLast.pos <= 5) {
          // 4è§’3ã€œ5ä½ï¼šå·®ã—åˆ‡ã‚Šï¼ˆå‹•ä½œã¯æœ€å¤§2ã¤ï¼‰
          commentary += `ç›´ç·šã§ã¯`;
          if (winner.lastFurlong && parseFloat(winner.lastFurlong) < 39.5) {
            // ä¸ŠãŒã‚Š39.5ç§’æœªæº€ï¼šä¸ŠãŒã‚Šã‚’ãƒãƒ¼ã‚¯
            commentary += `ä¸ŠãŒã‚Š${winner.lastFurlong}ç§’ã‚’ãƒãƒ¼ã‚¯ã—ã¦`;
          } else if (winner.lastFurlong) {
            // ä¸ŠãŒã‚Š39.5ç§’ä»¥ä¸Šï¼šç²˜ã‚Šå¼·ã
            commentary += `ã—ã¶ã¨ã`;
          }
          commentary += `å·®ã—åˆ‡ã‚Šã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã¨ãªã£ãŸ`;
        } else {
          // 4è§’6ä½ä»¥ä¸‹ï¼šè¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Šï¼ˆå‹•ä½œã¯æœ€å¤§2ã¤ï¼‰
          commentary += `ç›´ç·šã§ã¯`;
          if (winner.lastFurlong && parseFloat(winner.lastFurlong) < 39.5) {
            // ä¸ŠãŒã‚Š39.5ç§’æœªæº€ï¼šä¸ŠãŒã‚Šã‚’ãƒãƒ¼ã‚¯ï¼ˆã€Œè¿½ã„è¾¼ã‚“ã§ã€ã¯çœç•¥ã—ã¦2é€£é–ã«æŠ‘ãˆã‚‹ï¼‰
            commentary += `ä¸ŠãŒã‚Š${winner.lastFurlong}ç§’ã‚’ãƒãƒ¼ã‚¯ã—ã¦å·®ã—åˆ‡ã‚Š`;
          } else if (winner.lastFurlong) {
            // ä¸ŠãŒã‚Šã‚ã‚‹ãŒé…ã„ï¼šè¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š
            commentary += `è¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š`;
          } else {
            // ä¸ŠãŒã‚Šãƒ‡ãƒ¼ã‚¿ãªã—ï¼šè¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š
            commentary += `è¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š`;
          }
          commentary += `ã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã¨ãªã£ãŸ`;
        }

        // é¨æ‰‹ãƒ»å©èˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆç°¡æ½”ã«ã€å¿…ãšå¥ç‚¹ã§é–‰ã˜ã‚‹ï¼‰
        commentary += `ã€‚éä¸Šã¯${winner.jockey}é¨æ‰‹ã¨${winner.trainer}å©èˆã®ã‚³ãƒ³ãƒ“ã€‚`;

        // 2ç€ãƒ»3ç€
        if (second && third) {
          // 2ç€é¦¬ã®è¡¨ç¾ï¼šé€ƒã’é¦¬ã‹ã©ã†ã‹ã§å¤‰æ›´
          if (pacemaker && second.number === pacemaker.number) {
            // é€ƒã’é¦¬ãŒ2ç€ã«ç²˜ã£ãŸå ´åˆ
            commentary += `2ç€ã«ã¯ç²˜ã‚Šè¾¼ã‚“ã ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          } else if (secondPosLast && secondPosLast.pos === 1) {
            // ãã®ä»–ã®å…ˆè¡Œé¦¬ãŒ2ç€
            commentary += `2ç€ã«ã¯å…ˆè¡Œã—ãŸ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          } else if (secondPosLast) {
            // ãã®ä»–ï¼ˆä½ç½®å–ã‚Šã‚ã‚Šï¼‰
            commentary += `2ç€ã«ã¯${secondPosLast.label}ã‹ã‚‰ä¼¸ã³ãŸ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          } else {
            // ä½ç½®å–ã‚Šãªã—
            commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          }

          // 3ç€é¦¬ã®è¡¨ç¾ï¼šé€ƒã’é¦¬ã‹ã©ã†ã‹ã§å¤‰æ›´
          if (pacemaker && third.number === pacemaker.number) {
            commentary += `3ç€ã«ã¯é€ƒã’ãŸ${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
          } else {
            commentary += `3ç€ã«ã¯${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
          }
        } else if (second) {
          if (pacemaker && second.number === pacemaker.number) {
            commentary += `2ç€ã«ã¯ç²˜ã‚Šè¾¼ã‚“ã ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
          } else if (secondPosLast && secondPosLast.pos === 1) {
            commentary += `2ç€ã«ã¯å…ˆè¡Œã—ãŸ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
          } else {
            commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
          }
        }

        // ä¸‰é€£å˜é…å½“æƒ…å ±ã‚’è¿½åŠ ï¼ˆSEOå¯¾ç­–ï¼‰
        if (race.payouts?.sanrentan && race.payouts.sanrentan.length > 0) {
          const sanrentanPayout = race.payouts.sanrentan[0].payout;
          const sanrentanPop = race.payouts.sanrentan[0].popularity;
          const sanrentanCombo = race.payouts.sanrentan[0].combination;
          commentary += `ä¸‰é€£å˜${sanrentanCombo}ã¯${sanrentanPayout.toLocaleString()}å††ï¼ˆ${sanrentanPop}ç•ªäººæ°—ï¼‰ã§æ±ºç€ã—ãŸã€‚`;
        }
      }
      // ãƒ‘ã‚¿ãƒ¼ãƒ³3: é€ƒã’é¦¬æƒ…å ±ãªã—
      else {
        // å‹ã¡é¦¬
        commentary += `${winner.number}ç•ª${winner.name}ï¼ˆ`;
        if (winner.popularity === 1) {
          commentary += `1ç•ªäººæ°—`;
        } else {
          commentary += `${winner.popularity}ç•ªäººæ°—`;
        }
        commentary += `ï¼‰ãŒ`;

        if (winnerPosLast) {
          commentary += `${winnerPosLast.label}ã‹ã‚‰æŠœã‘å‡ºã—ã€`;
        }

        if (winner.lastFurlong) {
          commentary += `ä¸ŠãŒã‚Š${winner.lastFurlong}ç§’ã®æœ«è„šã§`;
        }
        commentary += `å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€`;

        // é¨æ‰‹ãƒ»å©èˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆç°¡æ½”ã«ã€å¿…ãšå¥ç‚¹ã§é–‰ã˜ã‚‹ï¼‰
        commentary += `ã€‚éä¸Šã¯${winner.jockey}é¨æ‰‹ã¨${winner.trainer}å©èˆã®ã‚³ãƒ³ãƒ“ã€‚`;

        if (second && third) {
          commentary += `2ç€ã«${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€3ç€ã«${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
        } else if (second) {
          commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
        }

        // ä¸‰é€£å˜é…å½“æƒ…å ±ã‚’è¿½åŠ ï¼ˆSEOå¯¾ç­–ï¼‰
        if (race.payouts?.sanrentan && race.payouts.sanrentan.length > 0) {
          const sanrentanPayout = race.payouts.sanrentan[0].payout;
          const sanrentanPop = race.payouts.sanrentan[0].popularity;
          const sanrentanCombo = race.payouts.sanrentan[0].combination;
          commentary += `ä¸‰é€£å˜${sanrentanCombo}ã¯${sanrentanPayout.toLocaleString()}å††ï¼ˆ${sanrentanPop}ç•ªäººæ°—ï¼‰ã§æ±ºç€ã—ãŸã€‚`;
        }
      }

      // é«˜é…å½“ã®å ´åˆã¯é¦¬å˜ã‚‚è¿½åŠ 
      if (race.payouts?.umatan && race.payouts.umatan.length > 0) {
        const umatanPayout = race.payouts.umatan[0].payout;
        if (umatanPayout >= 10000) {
          commentary += `é¦¬å˜ã¯${umatanPayout.toLocaleString()}å††ã®é«˜é…å½“ã¨ãªã£ãŸã€‚`;
        }
      }

      // 250æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯ãƒˆãƒªãƒŸãƒ³ã‚°ï¼ˆæœ€å¾Œã®å¥ç‚¹ã§åˆ‡ã‚‹ï¼‰
      if (commentary.length > 260) {
        const trimmed = commentary.substring(0, 250);
        const lastPeriod = trimmed.lastIndexOf('ã€‚');
        if (lastPeriod > 200) {
          commentary = trimmed.substring(0, lastPeriod + 1);
        }
      }

      return commentary;
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function displayBatchPreview(results, date, venue) {
      const previewSection = document.getElementById('previewSection');
      const raceSummary = document.getElementById('raceSummary');
      const raceDetails = document.getElementById('raceDetails');

      const successResults = results.filter(r => r.success);
      const errorResults = results.filter(r => !r.success);

      // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      raceSummary.innerHTML = `
        <h3 style="margin-bottom: var(--spacing-md);">ğŸ“Š è§£æã‚µãƒãƒªãƒ¼</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
          <div style="padding: var(--spacing-md); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${successResults.length}</div>
            <div style="color: var(--text-secondary);">æˆåŠŸ</div>
          </div>
          <div style="padding: var(--spacing-md); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--error);">${errorResults.length}</div>
            <div style="color: var(--text-secondary);">ã‚¨ãƒ©ãƒ¼</div>
          </div>
          <div style="padding: var(--spacing-md); background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-md);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-end);">${results.length}</div>
            <div style="color: var(--text-secondary);">åˆè¨ˆ</div>
          </div>
        </div>
      `;

      // å„ãƒ¬ãƒ¼ã‚¹ã®è©³ç´°
      let detailsHTML = '';
      results.forEach(result => {
        const statusClass = result.success ? 'success' : 'error';
        const statusText = result.success ? 'âœ… æˆåŠŸ' : 'âŒ ã‚¨ãƒ©ãƒ¼';

        detailsHTML += `
          <details class="race-detail-card ${statusClass}">
            <summary class="race-detail-header">
              <span class="race-number-badge">ç¬¬${result.raceNumber}R</span>
              <span class="race-status-badge ${statusClass}">${statusText}</span>
            </summary>
            <div class="race-detail-content">
              ${result.success ? generateRacePreviewHTML(result) : generateErrorHTML(result)}
            </div>
          </details>
        `;
      });

      raceDetails.innerHTML = detailsHTML;
      previewSection.style.display = 'block';
    }

    // ãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLç”Ÿæˆï¼ˆè©³ç´°ç‰ˆï¼‰
    function generateRacePreviewHTML(result) {
      const { data } = result;

      let html = `
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
          <h4 style="margin-bottom: 0.5rem;">ğŸ“‹ ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h4>
          <p><strong>ç™ºèµ°:</strong> ${data.startTime || '-'}</p>
          <p><strong>ãƒ¬ãƒ¼ã‚¹å:</strong> ${data.raceName || '-'}</p>
          <p><strong>è·é›¢:</strong> ${data.surface}${data.distance}m</p>
          <p><strong>å‡ºèµ°é ­æ•°:</strong> ${data.results?.length || 0}é ­</p>
          ${data.weather ? `<p><strong>å¤©å€™:</strong> ${data.weather}</p>` : ''}
          ${data.trackCondition ? `<p><strong>é¦¬å ´:</strong> ${data.trackCondition}</p>` : ''}
        </div>
      `;

      // ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ¡ãƒ³ãƒˆ
      if (data.comment) {
        html += `
          <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-left: 4px solid var(--primary-end); border-radius: 8px;">
            <h4 style="margin-bottom: 0.5rem;">ğŸ“ ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
            <p style="line-height: 1.8;">${data.comment}</p>
          </div>
        `;
      }

      // ç€é †ãƒ†ãƒ¼ãƒ–ãƒ«
      if (data.results && data.results.length > 0) {
        html += '<div style="margin-bottom: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem;">ğŸ‡ ç€é †</h4>';
        html += '<div style="overflow-x: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
        html += '<thead><tr style="background: var(--bg-tertiary);">';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">ç€é †</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">æ </th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">é¦¬ç•ª</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">é¦¬å</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">é¨æ‰‹</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">èª¿æ•™å¸«</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">ã‚¿ã‚¤ãƒ </th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">ç€å·®</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">ä¸Š3F</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid var(--border-color);">äººæ°—</th>';
        html += '</tr></thead><tbody>';

        data.results.forEach(r => {
          html += '<tr>';
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center; font-weight: 600;">${r.rank}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${r.bracket}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${r.number}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color);">${r.name}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color);">${r.jockey}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color);">${r.trainer || '-'}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${r.time}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${r.margin}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${r.lastFurlong}</td>`;
          html += `<td style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: center;">${r.popularity}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        html += '</div>';
        html += '</div>';
      }

      // æ‰•æˆ»é‡‘
      if (data.payouts && Object.keys(data.payouts).length > 0) {
        html += '<div style="margin-bottom: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem;">ğŸ’° æ‰•æˆ»é‡‘</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.875rem;">';

        const payoutLabels = {
          tansho: 'å˜å‹',
          fukusho: 'è¤‡å‹',
          wakuren: 'æ é€£',
          umaren: 'é¦¬é€£',
          wakutan: 'æ å˜',
          umatan: 'é¦¬å˜',
          wide: 'ãƒ¯ã‚¤ãƒ‰',
          sanrenpuku: 'ä¸‰é€£è¤‡',
          sanrentan: 'ä¸‰é€£å˜'
        };

        Object.entries(data.payouts).forEach(([key, items]) => {
          if (items && items.length > 0) {
            // è¤‡å‹ã¯è¤‡æ•°è¡¨ç¤ºã€ãã®ä»–ã¯æœ€åˆã®1ã¤ã®ã¿
            if (key === 'fukusho') {
              // è¤‡å‹ï¼š2-3ç€ã¾ã§å…¨ã¦è¡¨ç¤º
              items.forEach((item, idx) => {
                html += `<div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px;">`;
                html += `<div style="font-weight: 600; color: var(--primary-end);">${payoutLabels[key]}${idx > 0 ? ` (${idx + 1}ç€)` : ''}</div>`;
                html += `<div>${item.number}ç•ª</div>`;
                html += `<div style="font-size: 1.1rem; font-weight: 700;">${item.payout.toLocaleString()}å††</div>`;
                html += `<div style="color: var(--text-secondary);">${item.popularity}ç•ªäººæ°—</div>`;
                html += `</div>`;
              });
            } else {
              // ãã®ä»–ã®åˆ¸ç¨®ï¼šæœ€åˆã®1ã¤ã®ã¿
              const firstItem = items[0];
              html += `<div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px;">`;
              html += `<div style="font-weight: 600; color: var(--primary-end);">${payoutLabels[key]}</div>`;
              html += `<div>${firstItem.combination || firstItem.number}</div>`;
              html += `<div style="font-size: 1.1rem; font-weight: 700;">${firstItem.payout.toLocaleString()}å††</div>`;
              html += `<div style="color: var(--text-secondary);">${firstItem.popularity}ç•ªäººæ°—</div>`;
              html += `</div>`;
            }
          }
        });

        html += '</div>';
        html += '</div>';
      }

      // ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿
      if (data.timeData) {
        html += '<div style="margin-bottom: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem;">â±ï¸ ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿</h4>';
        html += '<div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.875rem;">';

        if (data.timeData.last3F) {
          html += `<div style="padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: 4px;"><strong>ä¸ŠãŒã‚Š3F:</strong> ${data.timeData.last3F}ç§’</div>`;
        }
        if (data.timeData.last4F) {
          html += `<div style="padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: 4px;"><strong>ä¸ŠãŒã‚Š4F:</strong> ${data.timeData.last4F}ç§’</div>`;
        }
        if (data.timeData.furlongTimes) {
          html += `<div style="padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: 4px;"><strong>ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ :</strong> ${data.timeData.furlongTimes.join(' - ')}</div>`;
        }

        html += '</div>';
        html += '</div>';
      }

      // ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †
      if (data.cornerData && data.cornerData.length > 0) {
        html += '<div style="margin-bottom: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem;">ğŸ”„ ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.875rem;">';

        data.cornerData.forEach(c => {
          html += `<div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px;">`;
          html += `<div style="font-weight: 600; margin-bottom: 0.25rem;">${c.corner}</div>`;
          html += `<div>${c.order.join(', ')}</div>`;
          html += `</div>`;
        });

        html += '</div>';
        html += '</div>';
      }

      return html;
    }

    // ã‚¨ãƒ©ãƒ¼HTMLç”Ÿæˆ
    function generateErrorHTML(result) {
      return `
        <div style="color: var(--error);">
          <h4>âŒ ã‚¨ãƒ©ãƒ¼å†…å®¹</h4>
          <ul style="margin-left: var(--spacing-lg);">
            ${result.errors.map(err => `<li>${err}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    // JSONå…¨ã‚³ãƒ”ãƒ¼
    function copyAllJSON() {
      const successResults = batchResults.filter(r => r.success);
      if (successResults.length === 0) {
        alert('ã‚³ãƒ”ãƒ¼ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const date = successResults[0].date;
      const venue = successResults[0].venue;

      const jsonData = {
        raceDate: date,
        lastUpdated: new Date().toISOString(),
        track: venue,
        totalRaces: successResults.length,
        races: successResults.map(r => r.data),
      };

      navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2)).then(() => {
        alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    }

    // ä¸€æ‹¬ä¿å­˜
    async function saveAllRacesToGit(forceOverwrite = false) {
      const successResults = batchResults.filter(r => r.success);
      if (successResults.length === 0) {
        alert('ä¿å­˜ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const btn = document.getElementById('saveAllBtn');
      const statusDiv = document.getElementById('saveStatus');

      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = forceOverwrite
        ? `ğŸ”¥ ${successResults.length}ãƒ¬ãƒ¼ã‚¹åˆ†ã‚’å®Œå…¨ä¸Šæ›¸ãä¸­...`
        : `ğŸš€ ${successResults.length}ãƒ¬ãƒ¼ã‚¹åˆ†ã‚’ä¿å­˜ä¸­...`;

      try {
        const date = successResults[0].date;
        const venue = successResults[0].venue;

        // ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¸­å¤®ç«¶é¦¬10å ´ï¼‰
        const venueCodeMap = {
          'æ±äº¬': 'TKY',
          'ä¸­å±±': 'NAK',
          'äº¬éƒ½': 'KYO',
          'é˜ªç¥': 'HAN',
          'ä¸­äº¬': 'CHU',
          'æ–°æ½Ÿ': 'NII',
          'ç¦å³¶': 'FKU',
          'å°å€‰': 'KKU',
          'æœ­å¹Œ': 'SAP',
          'å‡½é¤¨': 'HKD'
        };

        const jsonData = {
          date: date,  // âœ… æ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
          venue: venue,  // âœ… æ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
          venueCode: venueCodeMap[venue] || 'TKY',  // âœ… ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰è¿½åŠ 
          races: successResults.map(r => r.data),
        };

        const response = await fetch('/.netlify/functions/save-results-central', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            raceDate: date,
            track: venue,
            data: jsonData,
            forceOverwrite: forceOverwrite
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${successResults.length}ãƒ¬ãƒ¼ã‚¹åˆ†ã®ä¿å­˜æˆåŠŸï¼<br>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${result.path}<br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> ${result.sha?.substring(0, 7) || '-'}
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
        } else {
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ 12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ 12ãƒ¬ãƒ¼ã‚¹ä¸€æ‹¬ä¿å­˜ã—ã¦Git Push';
      }
    }
  </script>
</BaseLayout>
