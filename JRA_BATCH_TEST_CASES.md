# JRA結果一括入力 テストケース

## 目的
JRA結果一括入力機能の再発防止と品質保証のため、主要なエッジケースをドキュメント化する。

## テストケース一覧

### 1. レース番号検出
| ケース | 入力例 | 期待動作 | 対策 |
|--------|--------|----------|------|
| 11Rの誤検出 | "メイン 第11レース" | 正しく11を抽出 | ✅ 単語境界チェック + 重複除去 |
| 1-12R範囲外 | "13レース" | スキップまたは警告 | ⚠️ 未実装（将来対応） |
| レース番号重複 | "11レース...1レース" | 最初のものだけ採用 | ✅ Set使用で重複除去 |
| 「第」なし | "1レース" | 正しく1を抽出 | ✅ (?:第)? パターン |
| 「第」あり | "第1レース" | 正しく1を抽出 | ✅ (?:第)? パターン |

### 2. 競馬場検出
| ケース | 入力例 | 期待動作 | 対策 |
|--------|--------|----------|------|
| 複数会場 | "小倉...東京..." | 最初の競馬場を採用 | ✅ 最初のレースで確定 |
| 検出失敗 | 競馬場情報なし | フォールバック選択肢を使用 | ✅ fallbackVenue |
| 混在データ | 1R=小倉, 2R=東京 | 警告を表示 | ✅ 不一致検出ログ |

### 3. データ抽出エラー
| ケース | 入力例 | 期待動作 | 対策 |
|--------|--------|----------|------|
| 着順データなし | 払戻金のみ | エラー（必須） | ✅ throw Error |
| 払戻金なし | 着順のみ | 警告のみ（続行） | ✅ 空オブジェクト |
| タイムデータなし | 着順のみ | 警告のみ（続行） | ✅ 空オブジェクト |
| コーナー通過順なし | 着順のみ | 警告のみ（続行） | ✅ 空配列 |

### 4. プレビュー表示
| ケース | 入力例 | 期待動作 | 対策 |
|--------|--------|----------|------|
| 全データあり | 通常 | 完全表示 | ✅ 実装済み |
| データ部分欠損 | 着順のみ | 利用可能なデータのみ表示 | ✅ 条件分岐 |
| データ全欠損 | 抽出失敗 | 警告メッセージ表示 | ✅ 警告メッセージ実装 |

### 5. 出走頭数
| ケース | 頭数 | 期待動作 | 対策 |
|--------|------|----------|------|
| 少頭数 | 5頭 | 正常処理 | ✅ 実装済み |
| 標準 | 12-16頭 | 正常処理 | ✅ 実装済み |
| 最大 | 18頭 | 正常処理 | ✅ 実装済み |

### 6. 特殊レース
| ケース | 例 | 期待動作 | 対策 |
|--------|---|----------|------|
| 障害レース | 3000m以上 | 正常処理 | ✅ 実装済み |
| 重賞レース | グレード表記 | 正常処理 | ✅ 実装済み |
| 取消・除外あり | 出走頭数不一致 | 正常処理（実際の出走馬のみ） | ✅ 実装済み |

## 既知の制約
1. **12レース固定**: 13レース以上は非対応（将来拡張可能）
2. **同一会場前提**: 複数会場の混在データは警告のみ（エラーにしない）
3. **HTML形式依存**: JRA公式サイトのHTML変更時は修正が必要

## 再発防止策
1. ✅ **レース番号検出の堅牢性**: 単語境界 + 重複除去
2. ✅ **エラーハンドリング**: 部分的エラーでも続行（着順以外）
3. ✅ **デバッグログ充実**: ブラウザコンソールで詳細確認可能
4. ✅ **プレビュー警告**: データ欠損時に警告メッセージ

## 運用ガイド
### エラーが出た場合の確認手順
1. ブラウザの開発者ツール（F12）を開く
2. Consoleタブで `[Batch]` または `[splitRacesHTML]` のログを確認
3. どのレースでエラーが出ているか特定
4. 該当レースのHTMLを個別入力画面で確認

### データが欠けている場合
- 着順データ: **必須**（エラーで停止）
- 払戻金・タイム・コーナー: **オプショナル**（警告のみ）
- 欠損データは手動で追加可能（個別入力画面を使用）

## テスト実施記録
| 日付 | テストケース | 結果 | 備考 |
|------|--------------|------|------|
| 2026-02-15 | 11R誤検出 | ✅ 修正完了 | 重複除去 + 単語境界 |
| 2026-02-15 | プレビュー空白 | ✅ 修正完了 | 警告メッセージ追加 |

## 関連ファイル
- `src/pages/admin/results-manager-jra-batch.astro`
- `netlify/functions/save-results-jra.mjs`
- `CLAUDE.md` (バグ修正履歴セクション)
