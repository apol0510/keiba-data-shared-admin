---
/**
 * ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢
 * æ ¸ï¼ˆCoreï¼‰: è¤‡æ•°ã‚µã‚¤ãƒˆã§å…±é€šåˆ©ç”¨ã™ã‚‹åŸºç›¤ãƒ‡ãƒ¼ã‚¿
 * æ‹¡å¼µï¼ˆExtensionï¼‰: ã‚µã‚¤ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªé ˜åŸŸ
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢">
  <div class="container">
    <h1>ğŸ‡ ç«¶é¦¬äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢</h1>
    <p class="subtitle">
      è¤‡æ•°ã‚µã‚¤ãƒˆã§è‡ªå‹•èª¿æ•´å¯èƒ½ãªäºˆæƒ³å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ ¸ï¼‰
    </p>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯1: ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
    <section class="section">
      <h2>ğŸ“‹ [1] ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h2>
      <div class="race-info-form">
        <div class="form-row">
          <div class="form-group">
            <label for="raceDate">æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰</label>
            <input type="date" id="raceDate" required />
          </div>
          <div class="form-group">
            <label for="track">ç«¶é¦¬å ´</label>
            <select id="track" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="å¤§äº•ç«¶é¦¬">å¤§äº•ç«¶é¦¬</option>
              <option value="èˆ¹æ©‹ç«¶é¦¬">èˆ¹æ©‹ç«¶é¦¬</option>
              <option value="å·å´ç«¶é¦¬">å·å´ç«¶é¦¬</option>
              <option value="æµ¦å’Œç«¶é¦¬">æµ¦å’Œç«¶é¦¬</option>
              <option value="ä¸­å±±ç«¶é¦¬">ä¸­å±±ç«¶é¦¬</option>
              <option value="æ±äº¬ç«¶é¦¬">æ±äº¬ç«¶é¦¬</option>
              <option value="é˜ªç¥ç«¶é¦¬">é˜ªç¥ç«¶é¦¬</option>
              <option value="äº¬éƒ½ç«¶é¦¬">äº¬éƒ½ç«¶é¦¬</option>
            </select>
          </div>
          <div class="form-group">
            <label for="raceNumber">ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
            <input
              type="text"
              id="raceNumber"
              placeholder="11R"
              required
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="raceName">ãƒ¬ãƒ¼ã‚¹å</label>
            <input
              type="text"
              id="raceName"
              placeholder="æ±äº¬è¨˜å¿µ"
              required
            />
          </div>
          <div class="form-group">
            <label for="distance">è·é›¢</label>
            <input
              type="text"
              id="distance"
              placeholder="ãƒ€2,400m"
              required
            />
          </div>
          <div class="form-group">
            <label for="horseCount">é ­æ•°</label>
            <input type="number" id="horseCount" min="1" max="18" required />
          </div>
          <div class="form-group">
            <label for="startTime">ç™ºèµ°æ™‚åˆ»</label>
            <input type="time" id="startTime" required />
          </div>
        </div>
      </div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯2: HTMLå…¥åŠ› -->
    <section class="section">
      <h2>ğŸ“¥ [2] ç«¶é¦¬ãƒ–ãƒƒã‚¯HTMLè²¼ã‚Šä»˜ã‘</h2>
      <p class="description">
        ç«¶é¦¬ãƒ–ãƒƒã‚¯ã®å‡ºé¦¬è¡¨HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆ<code>&lt;table&gt;...&lt;/table&gt;</code>ã‚’å«ã‚€å…¨ä½“ï¼‰
      </p>
      <textarea
        id="htmlInput"
        rows="10"
        placeholder="<table class='default syutuba'>...çœç•¥...</table>"
      ></textarea>
      <button id="extractBtn" class="btn-primary">ğŸ” è‡ªå‹•æŠ½å‡ºå®Ÿè¡Œ</button>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯3: æŠ½å‡ºçµæœ -->
    <section class="section" id="extractionResultSection" style="display: none;">
      <h2>âœ… [3] æŠ½å‡ºçµæœ</h2>
      <div id="extractionStatus"></div>
      <div class="table-wrapper">
        <table id="extractionTable" class="data-table">
          <thead>
            <tr>
              <th>é¦¬ç•ª</th>
              <th>é¦¬å</th>
              <th>umacd</th>
              <th id="predictorHeaders"></th>
              <th>ã‚ªãƒƒã‚º</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="extractionTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯4: å°ã®ç¢ºå®š -->
    <section class="section" id="marksConfirmSection" style="display: none;">
      <h2>âœ¨ [4] å°ã®ç¢ºå®šï¼ˆè‡ªå‹•ææ¡ˆï¼‹æ‰‹å‹•ç¢ºå®šï¼‰</h2>
      <div id="marksProposal" class="proposal"></div>
      <div class="marks-form">
        <div class="form-row">
          <div class="form-group">
            <label for="mainHorse">æœ¬å‘½â—</label>
            <select id="mainHorse" required></select>
          </div>
          <div class="form-group">
            <label for="subHorse">å¯¾æŠ—â—‹</label>
            <select id="subHorse" required></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="hole1Horse">å˜ç©´â–²ï¼ˆ1é ­ç›®ï¼‰</label>
            <select id="hole1Horse"></select>
          </div>
          <div class="form-group">
            <label for="hole2Horse">å˜ç©´â–²ï¼ˆ2é ­ç›®ï¼‰</label>
            <select id="hole2Horse"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="connectHorses">é€£ä¸‹â–³ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <select id="connectHorses" multiple size="5"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label for="reserveHorses">æŠ¼ã•ãˆÃ—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <select id="reserveHorses" multiple size="5"></select>
          </div>
        </div>
      </div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯5: ã‚µã‚¤ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼‹æ‹¡å¼µãƒ‘ãƒãƒ« -->
    <section class="section" id="extensionSection" style="display: none;">
      <h2>ğŸ¨ [5] æ‹¡å¼µãƒ‘ãƒãƒ«ï¼ˆã‚µã‚¤ãƒˆåˆ¥ï¼‰</h2>
      <div class="form-group">
        <label for="siteProfile">ã‚µã‚¤ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</label>
        <select id="siteProfile">
          <option value="nankan-analytics">å—é–¢ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ï¼ˆãƒ•ãƒ«è£…å‚™ï¼‰</option>
          <option value="central-keiba">ä¸­å¤®ç«¶é¦¬ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰</option>
          <option value="minimal">ãƒŸãƒ‹ãƒãƒ«ï¼ˆå°ã®ã¿ï¼‰</option>
        </select>
      </div>
      <div id="extensionPanel" class="extension-panel"></div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯6: å‡ºåŠ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <section class="section" id="previewSection" style="display: none;">
      <h2>ğŸ‘ï¸ [6] å‡ºåŠ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
      <div class="tabs" id="previewTabs"></div>
      <div id="previewContent" class="preview-content"></div>
    </section>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯7: ä¿å­˜ -->
    <section class="section" id="saveSection" style="display: none;">
      <h2>ğŸ’¾ [7] ä¿å­˜ï¼ˆGitHub API / Pushï¼‰</h2>
      <div id="saveStatus"></div>
      <button id="saveBtn" class="btn-success">ğŸš€ ä¿å­˜ã—ã¦Git Push</button>
    </section>
  </div>

  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #333;
    }

    .description {
      color: #666;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    input,
    select,
    textarea {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    textarea {
      width: 100%;
      font-family: monospace;
      resize: vertical;
    }

    select[multiple] {
      padding: 0.5rem;
    }

    .btn-primary,
    .btn-success {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }

    .data-table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    .proposal {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .extension-panel {
      margin-top: 1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
      font-weight: 600;
    }

    .preview-content {
      background: #1f2937;
      color: #f3f4f6;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
    }

    .preview-content pre {
      margin: 0;
      font-family: monospace;
      font-size: 0.875rem;
    }

    code {
      background: #f3f4f6;
      padding: 0.125rem 0.25rem;
      border-radius: 2px;
      font-family: monospace;
    }

    #extractionStatus,
    #saveStatus {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
  </style>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let extractionResult = null;
    let coreData = null;
    let extensionsData = {};

    // å‹å®šç¾©ï¼ˆTypeScriptã‹ã‚‰ç§»æ¤ï¼‰
    const SITE_PROFILES = {
      "nankan-analytics": {
        id: "nankan-analytics",
        name: "å—é–¢ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹",
        extensionFields: {
          horses: [
            { key: "score", label: "ç´¯ç©ã‚¹ã‚³ã‚¢", type: "number", unit: "pt", min: 0, max: 100 },
            { key: "stability", label: "å®‰å®šæ€§", type: "number", unit: "%", min: 0, max: 100 },
            { key: "abilityRank", label: "èƒ½åŠ›ä¸Šä½æ€§", type: "number", unit: "%", min: 0, max: 100 },
            { key: "paceAdvantage", label: "å±•é–‹åˆ©", type: "number", unit: "%", min: 0, max: 100 },
          ],
          strategies: [
            { key: "safe_bets", label: "å°‘ç‚¹æ•°çš„ä¸­å‹: è²·ã„ç›®", type: "string" },
            { key: "safe_hitRate", label: "å°‘ç‚¹æ•°çš„ä¸­å‹: çš„ä¸­ç‡", type: "number", unit: "%" },
            { key: "balance_bets", label: "ãƒãƒ©ãƒ³ã‚¹å‹: è²·ã„ç›®", type: "string" },
            { key: "balance_hitRate", label: "ãƒãƒ©ãƒ³ã‚¹å‹: çš„ä¸­ç‡", type: "number", unit: "%" },
            { key: "aggressive_bets", label: "é«˜é…å½“è¿½æ±‚å‹: è²·ã„ç›®", type: "string" },
            { key: "aggressive_hitRate", label: "é«˜é…å½“è¿½æ±‚å‹: çš„ä¸­ç‡", type: "number", unit: "%" },
          ],
        },
      },
      "central-keiba": {
        id: "central-keiba",
        name: "ä¸­å¤®ç«¶é¦¬",
        extensionFields: {
          horses: [
            { key: "score", label: "ç·åˆã‚¹ã‚³ã‚¢", type: "number", unit: "pt", min: 0, max: 100 },
          ],
          strategies: [],
        },
      },
      "minimal": {
        id: "minimal",
        name: "ãƒŸãƒ‹ãƒãƒ«",
        extensionFields: {
          horses: [],
          strategies: [],
        },
      },
    };

    // ãƒ–ãƒ­ãƒƒã‚¯2: HTMLæŠ½å‡º
    document.getElementById("extractBtn").addEventListener("click", async () => {
      const html = document.getElementById("htmlInput").value;

      if (!html.trim()) {
        alert("HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
        return;
      }

      try {
        // æŠ½å‡ºå‡¦ç†ï¼ˆextractor.tsã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
        const result = await extractPredictions(html);

        if (!result.success) {
          showExtractionStatus(false, result.errors.join("\n"));
          return;
        }

        extractionResult = result;
        showExtractionResult(result);
        showExtractionStatus(true, `âœ… ${result.horses.length}é ­ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`);

        // ãƒ–ãƒ­ãƒƒã‚¯3, 4ã‚’è¡¨ç¤º
        document.getElementById("extractionResultSection").style.display = "block";
        document.getElementById("marksConfirmSection").style.display = "block";

        // å°ã®è‡ªå‹•ææ¡ˆã‚’è¡¨ç¤º
        showMarksProposal(result.suggestedMarks);
        populateMarksSelects(result.horses, result.suggestedMarks);

      } catch (error) {
        showExtractionStatus(false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    });

    // æŠ½å‡ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showExtractionStatus(success, message) {
      const status = document.getElementById("extractionStatus");
      status.className = success ? "status-success" : "status-error";
      status.textContent = message;
    }

    // æŠ½å‡ºçµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
    function showExtractionResult(result) {
      const tbody = document.getElementById("extractionTableBody");
      tbody.innerHTML = "";

      const headers = document.getElementById("predictorHeaders");
      headers.innerHTML = result.predictors.map(p => `<th>${p}</th>`).join("");

      result.horses.forEach((horse) => {
        const row = tbody.insertRow();
        row.insertCell().textContent = horse.number;
        row.insertCell().textContent = horse.name;
        row.insertCell().textContent = horse.umacd || "-";

        result.predictors.forEach(predictor => {
          row.insertCell().textContent = horse.marks[predictor] || "-";
        });

        row.insertCell().textContent = horse.odds ? horse.odds.toFixed(1) : "-";
        row.insertCell().innerHTML = `<button class="btn-small">ä¿®æ­£</button>`;
      });
    }

    // å°ã®è‡ªå‹•ææ¡ˆã‚’è¡¨ç¤º
    function showMarksProposal(suggested) {
      const proposal = document.getElementById("marksProposal");
      proposal.innerHTML = `
        <strong>ğŸ¤– AIè‡ªå‹•ææ¡ˆ:</strong><br>
        æœ¬å‘½â— â†’ ${suggested.main.slice(0, 3).join(", ")}ç•ª<br>
        å¯¾æŠ—â—‹ â†’ ${suggested.sub.slice(0, 3).join(", ")}ç•ª<br>
        å˜ç©´â–² â†’ ${suggested.hole.slice(0, 5).join(", ")}ç•ª
      `;
    }

    // å°é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
    function populateMarksSelects(horses, suggested) {
      const selects = ["mainHorse", "subHorse", "hole1Horse", "hole2Horse", "connectHorses", "reserveHorses"];

      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = horses.map(h =>
          `<option value="${h.number}">${h.number}ç•ª ${h.name}</option>`
        ).join("");
      });

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      if (suggested.main[0]) document.getElementById("mainHorse").value = suggested.main[0];
      if (suggested.main[1]) document.getElementById("subHorse").value = suggested.main[1];
      if (suggested.main[2]) document.getElementById("hole1Horse").value = suggested.main[2];
      if (suggested.sub[0]) document.getElementById("hole2Horse").value = suggested.sub[0];
    }

    // HTMLæŠ½å‡ºé–¢æ•°ï¼ˆextractor.tsã®æ©Ÿèƒ½ã‚’ç§»æ¤ï¼‰
    async function extractPredictions(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const table = doc.querySelector("table.default.syutuba");
      if (!table) {
        return { success: false, errors: ["å‡ºé¦¬è¡¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"], horses: [], predictors: [] };
      }

      const headerRow = table.querySelector("thead tr");
      if (!headerRow) {
        return { success: false, errors: ["ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"], horses: [], predictors: [] };
      }

      // äºˆæƒ³è€…åˆ—ã‚’æ¤œå‡º
      const predictors = [];
      headerRow.querySelectorAll("th").forEach(th => {
        const text = th.textContent.trim();
        if (text.includes("My") || text === "CPU" || (text.length <= 3 && text.length > 0)) {
          predictors.push(text);
        }
      });

      // é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const horses = [];
      table.querySelectorAll("tbody tr").forEach(row => {
        const tds = Array.from(row.querySelectorAll("td"));

        const umabanTd = tds.find(td => td.classList.contains("umaban"));
        const bameiTd = tds.find(td => td.classList.contains("bamei"));
        const markTds = tds.filter(td => td.classList.contains("tmyoso"));
        const oddsTd = tds.find(td => td.classList.contains("odds5"));

        if (!umabanTd || !bameiTd) return;

        const number = parseInt(umabanTd.textContent.trim(), 10);
        const link = bameiTd.querySelector("a");
        const name = link ? link.textContent.trim() : "";
        const href = link ? link.getAttribute("href") : "";
        const umacdMatch = href.match(/\/uma\/(\d+)/);
        const umacd = umacdMatch ? umacdMatch[1] : undefined;

        const marks = {};
        markTds.forEach((td, index) => {
          if (index < predictors.length) {
            const mark = td.querySelector("svg") ? "â–²" : td.textContent.trim();
            marks[predictors[index]] = mark || "-";
          }
        });

        let odds = undefined;
        if (oddsTd) {
          const oddsText = oddsTd.textContent.trim();
          odds = oddsText === "â˜†" ? 999.9 : parseFloat(oddsText);
        }

        horses.push({ number, name, umacd, marks, odds });
      });

      // å°ã®é›†è¨ˆï¼ˆè‡ªå‹•ææ¡ˆï¼‰
      const scores = {};
      const markScores = { "â—": 5, "â—‹": 4, "â–²": 3, "â–³": 2, "ç©´": 2, "æ³¨": 1 };

      horses.forEach(horse => {
        let score = 0;
        Object.values(horse.marks).forEach(mark => {
          score += markScores[mark] || 0;
        });
        scores[horse.number] = score;
      });

      const sorted = Object.entries(scores)
        .sort(([, a], [, b]) => b - a)
        .map(([num]) => parseInt(num, 10));

      const suggestedMarks = {
        main: sorted.slice(0, 3),
        sub: sorted.slice(3, 6),
        hole: sorted.slice(6, 10),
      };

      return {
        success: true,
        horses,
        predictors,
        errors: [],
        suggestedMarks,
      };
    }

    // ãƒ–ãƒ­ãƒƒã‚¯4: å°ç¢ºå®šå¾Œã€æ‹¡å¼µãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
    document.getElementById("mainHorse").addEventListener("change", showExtensionPanel);
    document.getElementById("subHorse").addEventListener("change", showExtensionPanel);

    function showExtensionPanel() {
      const mainHorse = document.getElementById("mainHorse").value;
      const subHorse = document.getElementById("subHorse").value;

      if (mainHorse && subHorse) {
        document.getElementById("extensionSection").style.display = "block";
        document.getElementById("previewSection").style.display = "block";
        document.getElementById("saveSection").style.display = "block";

        renderExtensionPanel();
        updatePreview();
      }
    }

    // ãƒ–ãƒ­ãƒƒã‚¯5: æ‹¡å¼µãƒ‘ãƒãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    document.getElementById("siteProfile").addEventListener("change", () => {
      renderExtensionPanel();
      updatePreview();
    });

    function renderExtensionPanel() {
      const profileId = document.getElementById("siteProfile").value;
      const profile = SITE_PROFILES[profileId];
      const panel = document.getElementById("extensionPanel");

      if (!profile) return;

      let html = "";

      // é¦¬ã”ã¨ã®æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      if (profile.extensionFields.horses && profile.extensionFields.horses.length > 0) {
        const mainHorse = parseInt(document.getElementById("mainHorse").value);
        const subHorse = parseInt(document.getElementById("subHorse").value);

        [mainHorse, subHorse].forEach((horseNum, idx) => {
          if (!horseNum) return;

          const horse = extractionResult.horses.find(h => h.number === horseNum);
          const label = idx === 0 ? "æœ¬å‘½â—" : "å¯¾æŠ—â—‹";

          html += `<div class="extension-horse">`;
          html += `<h3>${label} ${horseNum}ç•ª ${horse?.name}</h3>`;

          profile.extensionFields.horses.forEach(field => {
            html += `
              <div class="form-group">
                <label for="ext_${horseNum}_${field.key}">${field.label}</label>
                <input
                  type="${field.type === 'number' ? 'number' : 'text'}"
                  id="ext_${horseNum}_${field.key}"
                  ${field.unit ? `placeholder="${field.unit}"` : ""}
                  ${field.min !== undefined ? `min="${field.min}"` : ""}
                  ${field.max !== undefined ? `max="${field.max}"` : ""}
                  onchange="updateExtensionsData()"
                />
              </div>
            `;
          });

          html += `</div>`;
        });
      }

      // è²·ã„ç›®æˆ¦ç•¥ã®æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      if (profile.extensionFields.strategies && profile.extensionFields.strategies.length > 0) {
        html += `<div class="extension-strategies">`;
        html += `<h3>è²·ã„ç›®æˆ¦ç•¥</h3>`;

        profile.extensionFields.strategies.forEach(field => {
          html += `
            <div class="form-group">
              <label for="ext_strategy_${field.key}">${field.label}</label>
              ${field.type === 'string' ?
                `<textarea id="ext_strategy_${field.key}" rows="2" onchange="updateExtensionsData()"></textarea>` :
                `<input type="number" id="ext_strategy_${field.key}" ${field.unit ? `placeholder="${field.unit}"` : ""} onchange="updateExtensionsData()" />`
              }
            </div>
          `;
        });

        html += `</div>`;
      }

      if (!html) {
        html = `<p class="description">ã“ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå°ã®ã¿ï¼‰</p>`;
      }

      panel.innerHTML = html;
    }

    // æ‹¡å¼µãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    window.updateExtensionsData = function() {
      const profileId = document.getElementById("siteProfile").value;
      const profile = SITE_PROFILES[profileId];

      extensionsData = {
        horses: {},
        strategies: {},
      };

      // é¦¬ã”ã¨ã®æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const mainHorse = parseInt(document.getElementById("mainHorse").value);
      const subHorse = parseInt(document.getElementById("subHorse").value);

      [mainHorse, subHorse].forEach(horseNum => {
        if (!horseNum || !profile.extensionFields.horses) return;

        extensionsData.horses[horseNum] = {};

        profile.extensionFields.horses.forEach(field => {
          const input = document.getElementById(`ext_${horseNum}_${field.key}`);
          if (input) {
            extensionsData.horses[horseNum][field.key] = field.type === 'number' ?
              parseFloat(input.value) || 0 : input.value;
          }
        });
      });

      // è²·ã„ç›®æˆ¦ç•¥
      if (profile.extensionFields.strategies) {
        profile.extensionFields.strategies.forEach(field => {
          const input = document.getElementById(`ext_strategy_${field.key}`);
          if (input) {
            const value = field.type === 'number' ? parseFloat(input.value) || 0 : input.value;
            extensionsData.strategies[field.key] = value;
          }
        });
      }

      updatePreview();
    };

    // ãƒ–ãƒ­ãƒƒã‚¯6: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    function updatePreview() {
      const coreData = generateCoreData();
      const profileId = document.getElementById("siteProfile").value;

      const tabs = document.getElementById("previewTabs");
      tabs.innerHTML = `
        <button class="tab active" data-tab="core">æ ¸ãƒ‡ãƒ¼ã‚¿ï¼ˆCoreï¼‰</button>
        <button class="tab" data-tab="export">å‡ºåŠ›JSONï¼ˆ${profileId}ï¼‰</button>
      `;

      tabs.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", (e) => {
          tabs.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          e.target.classList.add("active");

          const tabName = e.target.dataset.tab;
          if (tabName === "core") {
            showPreviewCore(coreData);
          } else {
            showPreviewExport(coreData, extensionsData, profileId);
          }
        });
      });

      showPreviewCore(coreData);
    }

    function showPreviewCore(coreData) {
      const content = document.getElementById("previewContent");
      content.innerHTML = `<pre>${JSON.stringify(coreData, null, 2)}</pre>`;
    }

    function showPreviewExport(coreData, extensions, profileId) {
      const exported = exportToNankanV1(coreData, extensions);
      const content = document.getElementById("previewContent");
      content.innerHTML = `<pre>${JSON.stringify(exported, null, 2)}</pre>`;
    }

    // æ ¸ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
    function generateCoreData() {
      const raceInfo = {
        raceDate: document.getElementById("raceDate").value,
        track: document.getElementById("track").value,
        raceNumber: document.getElementById("raceNumber").value,
        raceName: document.getElementById("raceName").value,
        distance: document.getElementById("distance").value,
        horseCount: parseInt(document.getElementById("horseCount").value),
        startTime: document.getElementById("startTime").value,
      };

      const finalMarks = {
        main: parseInt(document.getElementById("mainHorse").value),
        sub: parseInt(document.getElementById("subHorse").value),
        hole1: parseInt(document.getElementById("hole1Horse").value) || undefined,
        hole2: parseInt(document.getElementById("hole2Horse").value) || undefined,
        connect: Array.from(document.getElementById("connectHorses").selectedOptions).map(o => parseInt(o.value)),
        reserve: Array.from(document.getElementById("reserveHorses").selectedOptions).map(o => parseInt(o.value)),
      };

      const now = new Date().toISOString();

      return {
        version: "1.0.0",
        createdAt: now,
        lastUpdated: now,
        raceInfo,
        rawHtml: document.getElementById("htmlInput").value,
        horses: extractionResult.horses,
        finalMarks,
        predictors: extractionResult.predictors,
      };
    }

    // nankan-v1ã‚¹ã‚­ãƒ¼ãƒã¸ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
    function exportToNankanV1(core, extensions) {
      const { raceInfo, finalMarks, horses } = core;

      const getHorse = (num) => horses.find(h => h.number === num);

      const formatHorse = (num, mark, type) => {
        if (!num) return null;
        const horse = getHorse(num);
        if (!horse) return null;

        const ext = extensions.horses?.[num] || {};

        return {
          number: num,
          name: horse.name,
          mark,
          type,
          factors: [
            { icon: "â˜…", text: "ç·åˆè©•ä¾¡:â˜…â˜…â˜…" },
            { icon: "â˜…", text: `ç´¯ç©ã‚¹ã‚³ã‚¢: ${ext.score || 0}pt` },
          ],
          importance: (mark === "â—" || mark === "â—‹") ? [
            { label: "å®‰å®šæ€§", value: (ext.stability || 0) / 100 },
            { label: "èƒ½åŠ›ä¸Šä½æ€§", value: (ext.abilityRank || 0) / 100 },
            { label: "å±•é–‹åˆ©", value: (ext.paceAdvantage || 0) / 100 },
          ] : [],
        };
      };

      return {
        raceDate: raceInfo.raceDate,
        lastUpdated: core.lastUpdated,
        track: raceInfo.track,
        totalRaces: 1,
        races: [{
          raceNumber: raceInfo.raceNumber,
          raceName: raceInfo.raceName,
          tier: "standard",
          isMainRace: false,
          displayOrder: parseInt(raceInfo.raceNumber.replace("R", ""), 10),
          raceInfo: {
            title: `${raceInfo.track}${raceInfo.raceNumber} ${raceInfo.raceName}`,
            date: raceInfo.raceDate,
            track: raceInfo.track,
            raceNumber: raceInfo.raceNumber,
            raceName: raceInfo.raceName,
            distance: raceInfo.distance,
            horseCount: raceInfo.horseCount,
            startTime: raceInfo.startTime,
          },
          horses: {
            main: formatHorse(finalMarks.main, "â—", "æœ¬å‘½"),
            sub: formatHorse(finalMarks.sub, "â—‹", "å¯¾æŠ—"),
            hole1: formatHorse(finalMarks.hole1, "â–²", "å˜ç©´"),
            hole2: formatHorse(finalMarks.hole2, "â–²", "å˜ç©´"),
            connect: finalMarks.connect.map(num => formatHorse(num, "â–³", "é€£ä¸‹")).filter(h => h),
            reserve: finalMarks.reserve.map(num => formatHorse(num, "Ã—", "æŠ¼ã•ãˆ")).filter(h => h),
          },
          strategies: {
            safe: {
              title: "ğŸ¯ å°‘ç‚¹æ•°çš„ä¸­å‹ãƒ¢ãƒ‡ãƒ«",
              bets: extensions.strategies?.safe_bets ? [{ type: "é¦¬å˜", numbers: extensions.strategies.safe_bets, odds: "3-8å€" }] : [],
              hitRate: extensions.strategies?.safe_hitRate?.toString() || "0",
              confidence: extensions.strategies?.safe_hitRate || 0,
              risk: "ä½ãƒªã‚¹ã‚¯",
            },
            balance: {
              title: "âš–ï¸ ãƒãƒ©ãƒ³ã‚¹å‹ãƒ¢ãƒ‡ãƒ«",
              bets: extensions.strategies?.balance_bets ? [{ type: "é¦¬å˜", numbers: extensions.strategies.balance_bets, odds: "6-12å€" }] : [],
              hitRate: extensions.strategies?.balance_hitRate?.toString() || "0",
              confidence: extensions.strategies?.balance_hitRate || 0,
              risk: "ä¸­ãƒªã‚¹ã‚¯",
            },
            aggressive: {
              title: "ğŸš€ é«˜é…å½“è¿½æ±‚å‹ãƒ¢ãƒ‡ãƒ«",
              bets: extensions.strategies?.aggressive_bets ? [{ type: "é¦¬å˜", numbers: extensions.strategies.aggressive_bets, odds: "10-30å€" }] : [],
              hitRate: extensions.strategies?.aggressive_hitRate?.toString() || "0",
              confidence: extensions.strategies?.aggressive_hitRate || 0,
              risk: "é«˜ãƒªã‚¹ã‚¯",
            },
          },
        }],
      };
    }

    // ãƒ–ãƒ­ãƒƒã‚¯7: ä¿å­˜
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const coreData = generateCoreData();
      const profileId = document.getElementById("siteProfile").value;
      const exported = exportToNankanV1(coreData, extensionsData);

      try {
        const response = await fetch("/.netlify/functions/save-predictions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            raceDate: coreData.raceInfo.raceDate,
            track: coreData.raceInfo.track,
            raceNumber: coreData.raceInfo.raceNumber,
            data: exported,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showSaveStatus(true, `âœ… ä¿å­˜æˆåŠŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«: ${result.path}\nã‚³ãƒŸãƒƒãƒˆ: ${result.sha.substring(0, 7)}`);
        } else {
          showSaveStatus(false, `âŒ ä¿å­˜å¤±æ•—: ${result.error}`);
        }
      } catch (error) {
        showSaveStatus(false, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    });

    function showSaveStatus(success, message) {
      const status = document.getElementById("saveStatus");
      status.className = success ? "status-success" : "status-error";
      status.textContent = message;
    }

    // åˆæœŸåŒ–: ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("raceDate").value = today;
    });
  </script>

  <style>
    .extension-horse,
    .extension-strategies {
      background: #f9fafb;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .extension-horse h3,
    .extension-strategies h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: #1f2937;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      background: #e5e7eb;
      border: none;
      border-radius: 2px;
      cursor: pointer;
    }

    .btn-small:hover {
      background: #d1d5db;
    }
  </style>
</BaseLayout>
