---
/**
 * JRAäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ï¼ˆ12ãƒ¬ãƒ¼ã‚¹å¯¾å¿œç‰ˆï¼‰
 * results-managerã¨åŒã˜æ§‹é€ ã§å„ãƒ¬ãƒ¼ã‚¹å€‹åˆ¥å…¥åŠ›
 *
 * JRAï¼ˆä¸­å¤®ç«¶é¦¬ï¼‰ã®äºˆæƒ³HTMLè§£æå°‚ç”¨
 */
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout
  title="JRA äºˆæƒ³ç®¡ç†ç”»é¢"
  description="JRAã®äºˆæƒ³HTMLã‚’è‡ªå‹•è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">ğŸ¯ JRA äºˆæƒ³ç®¡ç†</h1>
      <p class="page-description">
        å„ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥å…¥åŠ›ã§ãã¾ã™ã€‚<br>
        <strong>â€» ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«è²¼ã‚Šä»˜ã‘ã¦è§£æãƒ»ä¿å­˜ã—ã¦ãã ã•ã„</strong>
      </p>

      <!-- å…±é€šæƒ…å ±å…¥åŠ› -->
      <div class="card common-info-card">
        <h2>ğŸ“… é–‹å‚¬æƒ…å ±ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹å…±é€šï¼‰</h2>
        <div class="common-info-grid">
          <div class="form-group">
            <label for="commonDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="commonDate"
              class="form-input"
              value={new Date().toISOString().split('T')[0]}
            />
          </div>
          <div class="form-group">
            <label for="commonVenue">ç«¶é¦¬å ´</label>
            <select id="commonVenue" class="form-select">
              <option value="" selected>è‡ªå‹•</option>
              <option value="æ±äº¬">æ±äº¬</option>
              <option value="ä¸­å±±">ä¸­å±±</option>
              <option value="äº¬éƒ½">äº¬éƒ½</option>
              <option value="é˜ªç¥">é˜ªç¥</option>
              <option value="ä¸­äº¬">ä¸­äº¬</option>
              <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
              <option value="ç¦å³¶">ç¦å³¶</option>
              <option value="å°å€‰">å°å€‰</option>
              <option value="æœ­å¹Œ">æœ­å¹Œ</option>
              <option value="å‡½é¤¨">å‡½é¤¨</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 12ãƒ¬ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="races-container">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(raceNum => (
          <details class="race-section card" data-race-number={raceNum}>
            <summary class="race-section-header">
              <span class="race-number-badge">ç¬¬{raceNum}R</span>
              <span class="race-status" data-status="æœªå…¥åŠ›">æœªå…¥åŠ›</span>
            </summary>

            <div class="race-section-content">
              <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div class="input-area">
                <label for={`raceInput${raceNum}`}>ç¬¬{raceNum}R äºˆæƒ³HTMLè²¼ã‚Šä»˜ã‘</label>
                <textarea
                  id={`raceInput${raceNum}`}
                  class="race-textarea"
                  rows="15"
                  placeholder={`ç¬¬${raceNum}Rã®äºˆæƒ³HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„

ã€é‡è¦ã€‘ä»¥ä¸‹ã®ç¯„å›²ã‚’å…¨ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š
1. <div class="racename"> ã‹ã‚‰å§‹ã¾ã‚‹éƒ¨åˆ†ï¼ˆãƒ¬ãƒ¼ã‚¹åã€è·é›¢ã€é¦¬å ´æƒ…å ±ï¼‰
2. <table class="default syutuba"> ã®ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“

ä¾‹:
<div class="racename">
  <div class="racenameleft">
    <p>2026å¹´2æœˆ8æ—¥</p>
    <h2>1å›å°å€‰6æ—¥ç›®</h2>
    <h1>å°å€‰æ—¥çµŒè³</h1>
  </div>
  <div class="racenameright">
    <p class="racekyori"><button>2000m</button></p>
    <p class="raceshibada">(èŠï¼¡ãƒ»å³)</p>
  </div>
</div>
<table class="default syutuba">...</table>

â€» div.racenameãŒãªã„ã¨ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãŒæŠ½å‡ºã§ãã¾ã›ã‚“`}
                ></textarea>
                <button
                  type="button"
                  class="btn btn-primary w-full"
                  onclick={`parseRace(${raceNum})`}
                >
                  ğŸ” ç¬¬{raceNum}R ã‚’è§£æ
                </button>
              </div>

              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
              <div id={`preview${raceNum}`} class="preview-area" style="display: none;">
                <h3>âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id={`previewContent${raceNum}`} class="preview-content"></div>

                <!-- JSONè¡¨ç¤º -->
                <div class="json-display">
                  <h4>JSON ãƒ‡ãƒ¼ã‚¿</h4>
                  <textarea
                    id={`jsonOutput${raceNum}`}
                    class="json-textarea"
                    rows="10"
                    readonly
                  ></textarea>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <div class="action-buttons">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick={`navigator.clipboard.writeText(document.getElementById('jsonOutput${raceNum}').value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))`}
                  >
                    ğŸ“‹ JSONã‚³ãƒ”ãƒ¼
                  </button>
                  <button
                    type="button"
                    id={`saveBtn${raceNum}`}
                    class="btn btn-success"
                    onclick={`saveRaceToGit(${raceNum}, false)`}
                  >
                    ğŸš€ ä¿å­˜ã—ã¦Git Push
                  </button>
                  <button
                    type="button"
                    class="btn btn-warning"
                    onclick={`if(confirm('ã“ã®æ—¥ä»˜ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) saveRaceToGit(${raceNum}, true)`}
                  >
                    ğŸ”¥ å®Œå…¨ä¸Šæ›¸ãä¿å­˜
                  </button>
                </div>
                <div id={`saveStatus${raceNum}`} class="save-status" style="display: none;"></div>
              </div>
            </div>
          </details>
        ))}
      </div>

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ğŸ“– ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´</strong>ã‚’ä¸Šéƒ¨ã§é¸æŠ</li>
          <li>å„ãƒ¬ãƒ¼ã‚¹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¬¬1Rã€œç¬¬12Rï¼‰ã‚’å±•é–‹</li>
          <li>äºˆæƒ³ã‚µã‚¤ãƒˆã‹ã‚‰<strong>ä»¥ä¸‹ã®ç¯„å›²ã‚’å…¨ã¦ã‚³ãƒ”ãƒ¼</strong>
            <ul style="margin-top: 0.5rem;">
              <li>âœ… <code>&lt;div class="racename"&gt;</code> ã‹ã‚‰å§‹ã¾ã‚‹ãƒ¬ãƒ¼ã‚¹æƒ…å ±éƒ¨åˆ†</li>
              <li>âœ… <code>&lt;table class="default syutuba"&gt;</code> ã®ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“</li>
              <li>âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ã ã‘ã‚³ãƒ”ãƒ¼ã™ã‚‹ã¨ã€ãƒ¬ãƒ¼ã‚¹åãƒ»è·é›¢ãƒ»é¦¬å ´ãŒæŠ½å‡ºã§ãã¾ã›ã‚“</li>
            </ul>
          </li>
          <li>ã€Œè§£æã€ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</li>
          <li>ã€Œä¿å­˜ã—ã¦Git Pushã€ã§ keiba-data-shared ã«ä¿å­˜</li>
          <li>å…¨ãƒ¬ãƒ¼ã‚¹ä¿å­˜å¾Œã€è‡ªå‹•çš„ã«å„äºˆæƒ³ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ ğŸ‰</li>
        </ol>

        <h3>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</h3>
        <ul>
          <li>ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥ã«è²¼ã‚Šä»˜ã‘ãƒ»ä¿å­˜ã§ãã¾ã™</li>
          <li>æ—¢å­˜ãƒ¬ãƒ¼ã‚¹ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ï¼‰</li>
          <li>å®Œå…¨ä¸Šæ›¸ãä¿å­˜ã‚’ä½¿ã†ã¨ã€ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¦æ–°è¦ä¿å­˜ã—ã¾ã™</li>
          <li><strong>âš ï¸ å¿…ãš<code>&lt;div class="racename"&gt;</code>ã‚’å«ã‚ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„</strong></li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .common-info-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-2xl);
    }

    .common-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input,
    .form-select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .races-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .race-section {
      border: 2px solid var(--border-color);
      transition: border-color 0.3s ease;
    }

    .race-section[open] {
      border-color: var(--primary-end);
    }

    .race-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      cursor: pointer;
      font-weight: 600;
      font-size: 1.25rem;
      user-select: none;
    }

    .race-section-header:hover {
      background: var(--bg-secondary);
    }

    .race-number-badge {
      color: var(--primary-end);
      font-size: 1.5rem;
    }

    .race-status {
      font-size: 0.875rem;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .race-status[data-status="æœªå…¥åŠ›"] {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-tertiary);
    }

    .race-status[data-status="è§£ææ¸ˆã¿"] {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .race-status[data-status="ä¿å­˜æ¸ˆã¿"] {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .race-section-content {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .input-area {
      margin-bottom: var(--spacing-xl);
    }

    .input-area label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }

    .race-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
      margin-bottom: var(--spacing-md);
    }

    .preview-area {
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    .preview-area h3 {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-lg);
      color: var(--success);
    }

    .preview-content {
      margin-bottom: var(--spacing-lg);
    }

    .json-display {
      margin-top: var(--spacing-lg);
    }

    .json-display h4 {
      font-size: 1.125rem;
      margin-bottom: var(--spacing-sm);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .action-buttons .btn {
      flex: 1;
    }

    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
    }

    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-2xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .info-card code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--primary-end);
    }

    .w-full {
      width: 100%;
    }

    /* ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒˆã‚°ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .sort-toggle-btn {
      padding: 0.375rem 0.875rem;
      font-size: 0.813rem;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      color: #6b7280;
      white-space: nowrap;
    }

    .sort-toggle-btn.active {
      background: #3b82f6;
      color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .sort-toggle-btn:not(.active):hover {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    @media (max-width: 768px) {
      .common-info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>

  <script is:inline>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆå„ãƒ¬ãƒ¼ã‚¹ã®ãƒ‘ãƒ¼ã‚¹çµæœã‚’ä¿å­˜ï¼‰
    const raceResults = {};

    // ãƒ¬ãƒ¼ã‚¹ãƒ‘ãƒ¼ã‚¹é–¢æ•°
    function parseRace(raceNum) {
      const textarea = document.getElementById(`raceInput${raceNum}`);
      const html = textarea.value;

      if (!html.trim()) {
        alert(`ç¬¬${raceNum}Rã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
        return;
      }

      try {
        // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å…ˆã«æŠ½å‡ºï¼ˆç«¶é¦¬å ´è‡ªå‹•æŠ½å‡ºã®ãŸã‚ï¼‰
        const raceInfo = extractRaceInfo(html);

        // ç«¶é¦¬å ´ï¼šè‡ªå‹•æŠ½å‡ºã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ‰‹å‹•é¸æŠã‚’ä½¿ç”¨
        let venue = raceInfo.venue || document.getElementById('commonVenue').value;

        // è‡ªå‹•æŠ½å‡ºã—ãŸç«¶é¦¬å ´ã‚’selectè¦ç´ ã«åæ˜ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
        if (raceInfo.venue) {
          document.getElementById('commonVenue').value = raceInfo.venue;
          console.log(`[parseRace] ğŸ¯ ç«¶é¦¬å ´ã‚’è‡ªå‹•æŠ½å‡º: ${raceInfo.venue}`);
        }

        // å…±é€šæƒ…å ±å–å¾—
        const date = document.getElementById('commonDate').value;

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        const extracted = extractPredictions(html);
        if (!extracted.success) {
          alert(`æŠ½å‡ºå¤±æ•—: ${extracted.errors.join(', ')}`);
          return;
        }

        const scored = scoreAndAssign(extracted);

        // ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
        const data = {
          version: "1.0.0",
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          raceInfo: {
            date: raceInfo.date,
            track: venue,
            raceNumber: raceInfo.raceNo || `${raceNum}R`,
            raceName: raceInfo.raceName,
            raceType: raceInfo.raceType,
            distance: raceInfo.distance,
            surface: raceInfo.surface,
            kaisaiInfo: raceInfo.kaisaiInfo,
            hassoTime: raceInfo.hassoTime,
            courseInfo: raceInfo.courseInfo,
            tenkiBaba: raceInfo.tenkiBaba,
            recordTime: raceInfo.recordTime,
            estimatedTime: raceInfo.estimatedTime,
            prizes: raceInfo.prizes,
          },
          horses: scored.horses.map(h => ({
            number: h.number,
            name: h.name,
            umacd: h.umacd,
            marks: h.marks,
            seirei: h.seirei,
            kisyu: h.kisyu,
            kinryo: h.kinryo,
            kyusya: h.kyusya,
            totalScore: h.totalScore,
            assignment: h.assignment,
          })),
          predictors: scored.predictors,
          assignments: {
            main: scored.assignments.main?.number,
            sub: scored.assignments.sub?.number,
            hole: scored.assignments.hole?.number,
            connectTop: scored.assignments.connectTop?.number,
            connect: scored.assignments.connect.map(h => h.number),
            reserve: scored.assignments.reserve.map(h => h.number),
            none: scored.assignments.none.map(h => h.number),
          },
        };

        // çµæœã‚’ä¿å­˜
        raceResults[raceNum] = {
          data,
          date,
          venue
        };

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        displayPreview(raceNum, data, date, venue);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        updateRaceStatus(raceNum, 'è§£ææ¸ˆã¿');

      } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error(error);
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function displayPreview(raceNum, data, date, venue) {
      const previewDiv = document.getElementById(`preview${raceNum}`);
      const previewContent = document.getElementById(`previewContent${raceNum}`);
      const jsonOutput = document.getElementById(`jsonOutput${raceNum}`);

      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±HTMLç”Ÿæˆ
      const raceInfo = data.raceInfo;
      let html = `
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
          <h4 style="margin-bottom: 0.75rem;">ğŸ“‹ ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
            <p><strong>æ—¥ä»˜:</strong> ${raceInfo.date || date}</p>
            <p><strong>é–‹å‚¬:</strong> ${raceInfo.kaisaiInfo || '-'}</p>
            <p><strong>ãƒ¬ãƒ¼ã‚¹ç•ªå·:</strong> ${raceInfo.raceNumber || `${raceNum}R`}</p>
            <p><strong>ç™ºèµ°æ™‚åˆ»:</strong> ${raceInfo.hassoTime || '-'}</p>
            <p><strong>ãƒ¬ãƒ¼ã‚¹å:</strong> ${raceInfo.raceName || '-'}</p>
            <p><strong>ç«¶é¦¬å ´:</strong> ${venue}</p>
            <p><strong>è·é›¢:</strong> ${raceInfo.surface || '-'}${raceInfo.distance || '-'}m</p>
            <p><strong>ã‚³ãƒ¼ã‚¹:</strong> ${raceInfo.courseInfo || '-'}</p>
            <p><strong>å¤©å€™ãƒ»é¦¬å ´:</strong> ${raceInfo.tenkiBaba || '-'}</p>
            <p><strong>æ¡ä»¶:</strong> ${raceInfo.raceType || '-'}</p>
          </div>
          ${raceInfo.recordTime ? `<p style="margin-top: 0.5rem; font-size: 0.875rem;"><strong>ãƒ¬ã‚³ãƒ¼ãƒ‰:</strong> ${raceInfo.recordTime}</p>` : ''}
          ${raceInfo.estimatedTime ? `<p style="font-size: 0.875rem;"><strong>æ¨å®šã‚¿ã‚¤ãƒ :</strong> ${raceInfo.estimatedTime}</p>` : ''}
          ${raceInfo.prizes && raceInfo.prizes.length > 0 ? `
            <div style="margin-top: 0.75rem;">
              <strong>è³é‡‘:</strong>
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.25rem; font-size: 0.875rem;">
                ${raceInfo.prizes.map(p => `<span>${p}</span>`).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;

      // æŒ¯ã‚Šåˆ†ã‘çµæœï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ãƒ»7ç¨®é¡å…¨è¡¨ç¤ºï¼‰
      html += '<div style="margin-bottom: 1.5rem;">';
      html += '<h4 style="margin-bottom: 0.75rem;">ğŸ¯ è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘çµæœ</h4>';
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem;">';

      const formatHorse = (horse) => horse ? `${horse.number}ç•ª ${horse.name} (${horse.totalScore}ç‚¹)` : "ãªã—";

      const createCard = (bgColor, borderColor, title, horses) => {
        const horsesList = Array.isArray(horses)
          ? horses.map(h => `<li style="margin: 0.25rem 0;">${formatHorse(h)}</li>`).join("")
          : `<li style="margin: 0.25rem 0;">${formatHorse(horses)}</li>`;

        const isEmpty = (Array.isArray(horses) && horses.length === 0) || (!Array.isArray(horses) && !horses);
        const content = isEmpty ? "<li>ãªã—</li>" : horsesList;

        return `
          <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 4px; padding: 0.75rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: ${borderColor};">${title}</div>
            <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem;">${content}</ul>
          </div>
        `;
      };

      html += createCard('rgba(239, 68, 68, 0.1)', '#ef4444', 'â— æœ¬å‘½', data.horses.find(h => h.number === data.assignments.main));
      html += createCard('rgba(59, 130, 246, 0.1)', '#3b82f6', 'â—‹ å¯¾æŠ—', data.horses.find(h => h.number === data.assignments.sub));
      html += createCard('rgba(245, 158, 11, 0.1)', '#f59e0b', 'â–² å˜ç©´', data.horses.find(h => h.number === data.assignments.hole));
      html += createCard('rgba(16, 185, 129, 0.1)', '#10b981', 'â–³ é€£ä¸‹æœ€ä¸Šä½', data.horses.find(h => h.number === data.assignments.connectTop));
      html += createCard('rgba(139, 92, 246, 0.1)', '#8b5cf6', 'â–³ é€£ä¸‹ (1~3é ­)', data.assignments.connect.map(num => data.horses.find(h => h.number === num)));
      html += createCard('rgba(100, 116, 139, 0.1)', '#64748b', 'Ã— è£œæ¬  (1ç‚¹ä»¥ä¸Š)', data.assignments.reserve.map(num => data.horses.find(h => h.number === num)));
      html += createCard('rgba(156, 163, 175, 0.1)', '#9ca3af', 'ç„¡ (0ç‚¹)', data.assignments.none.map(num => data.horses.find(h => h.number === num)));

      html += '</div>';
      html += '</div>';

      // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
      html += '<div style="margin-bottom: 1rem;">';
      html += '<h4 style="margin-bottom: 0.5rem;">ğŸ‡ æŠ½å‡ºçµæœ</h4>';
      html += '<div style="display: inline-flex; gap: 0.25rem; margin-bottom: 0.75rem; background: #f3f4f6; border-radius: 6px; padding: 3px;">';
      html += `<button onclick="toggleSort(${raceNum}, 'score')" id="sortByScore${raceNum}" class="sort-toggle-btn">ç‚¹æ•°é †</button>`;
      html += `<button onclick="toggleSort(${raceNum}, 'number')" id="sortByNumber${raceNum}" class="sort-toggle-btn">é¦¬ç•ªé †</button>`;
      html += '</div>';
      html += `<div id="horseTable${raceNum}" style="overflow-x: auto;"></div>`;
      html += '</div>';

      previewContent.innerHTML = html;

      // åˆæœŸè¡¨ç¤ºï¼ˆé¦¬ç•ªé †ï¼‰
      renderHorseTable(raceNum, data, 'number');

      const jsonData = {
        raceDate: date,
        lastUpdated: data.lastUpdated,
        track: venue,
        totalRaces: 1,
        races: [data],
      };

      jsonOutput.value = JSON.stringify(jsonData, null, 2);
      previewDiv.style.display = 'block';
    }

    // é¦¬ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderHorseTable(raceNum, data, sortOrder) {
      const tableDiv = document.getElementById(`horseTable${raceNum}`);

      // ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      const scoreBtn = document.getElementById(`sortByScore${raceNum}`);
      const numberBtn = document.getElementById(`sortByNumber${raceNum}`);

      if (sortOrder === 'score') {
        scoreBtn.classList.add('active');
        numberBtn.classList.remove('active');
      } else {
        scoreBtn.classList.remove('active');
        numberBtn.classList.add('active');
      }

      // é¦¬ã‚’ã‚½ãƒ¼ãƒˆ
      const horses = sortOrder === 'score'
        ? [...data.horses].sort((a, b) => b.totalScore - a.totalScore)
        : [...data.horses].sort((a, b) => a.number - b.number);

      // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
      let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem; white-space: nowrap;">';
      html += '<thead><tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">';
      html += '<th style="padding: 0.5rem; text-align: center;">é¦¬ç•ª</th>';

      // äºˆæƒ³è€…åˆ—
      data.predictors.forEach(predictor => {
        html += `<th style="padding: 0.5rem; text-align: center;">${predictor}</th>`;
      });

      html += '<th style="padding: 0.5rem; text-align: left;">é¦¬å</th>';
      html += '<th style="padding: 0.5rem; text-align: center;">æ€§é½¢</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">é¨æ‰‹</th>';
      html += '<th style="padding: 0.5rem; text-align: center;">æ–¤é‡</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">å©èˆ</th>';
      html += '<th style="padding: 0.5rem; text-align: center;">ç‚¹æ•°</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">æŒ¯ã‚Šåˆ†ã‘</th>';
      html += '</tr></thead><tbody>';

      horses.forEach(horse => {
        html += '<tr style="border-bottom: 1px solid var(--border-color);">';
        html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.number}</td>`;

        // å„äºˆæƒ³è€…ã®å°
        data.predictors.forEach(predictor => {
          const mark = horse.marks[predictor] || '-';
          html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${mark}</td>`;
        });

        html += `<td style="padding: 0.5rem;">${horse.name}</td>`;
        html += `<td style="padding: 0.5rem; text-align: center;">${horse.seirei || '-'}</td>`;
        html += `<td style="padding: 0.5rem;">${horse.kisyu || '-'}</td>`;
        html += `<td style="padding: 0.5rem; text-align: center;">${horse.kinryo || '-'}</td>`;
        html += `<td style="padding: 0.5rem;">${horse.kyusya || '-'}</td>`;
        html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.totalScore}ç‚¹</td>`;
        html += `<td style="padding: 0.5rem;">${horse.assignment}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      tableDiv.innerHTML = html;
    }

    // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
    window.toggleSort = function(raceNum, sortOrder) {
      if (!raceResults[raceNum]) return;
      renderHorseTable(raceNum, raceResults[raceNum].data, sortOrder);
    };

    // ãƒ¬ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateRaceStatus(raceNum, status) {
      const section = document.querySelector(`.race-section[data-race-number="${raceNum}"]`);
      const statusSpan = section.querySelector('.race-status');
      statusSpan.setAttribute('data-status', status);
      statusSpan.textContent = status;
    }

    // Gitä¿å­˜ï¼ˆä¸­å¤®ç«¶é¦¬ç‰ˆï¼‰
    async function saveRaceToGit(raceNum, forceOverwrite = false) {
      if (!raceResults[raceNum]) {
        alert('å…ˆã«è§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById(`saveBtn${raceNum}`);
      const statusDiv = document.getElementById(`saveStatus${raceNum}`);

      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = forceOverwrite
        ? 'ğŸ”¥ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¸Šæ›¸ãä¸­...'
        : 'ğŸš€ keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ä¸­...';

      try {
        const { data, date, venue } = raceResults[raceNum];

        const response = await fetch('/.netlify/functions/save-predictions-jra', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            raceDate: date,
            track: venue,
            raceNumber: `${raceNum}R`,
            data: {
              raceDate: date,
              lastUpdated: data.lastUpdated,
              track: venue,
              totalRaces: 1,
              races: [data],
            },
            forceOverwrite: forceOverwrite
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${result.message || 'ä¿å­˜æˆåŠŸ'}<br>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${result.path}<br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> ${result.sha?.substring(0, 7) || '-'}
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
          updateRaceStatus(raceNum, 'ä¿å­˜æ¸ˆã¿');
        } else {
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
      }
    }

    // ===== æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¸­å¤®ç«¶é¦¬å¯¾å¿œï¼‰ =====

    function extractPredictions(html) {
      const errors = [];
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const table = doc.querySelector('table.default.syutuba');
        if (!table) {
          errors.push('å‡ºé¦¬è¡¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return { success: false, horses: [], predictors: [], errors };
        }

        const headerRow = table.querySelector('thead tr');
        if (!headerRow) {
          errors.push('ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return { success: false, horses: [], predictors: [], errors };
        }

        const detectedPredictors = detectPredictors(headerRow);
        console.log('[extractPredictions] æ¤œå‡ºã—ãŸäºˆæƒ³è€…:', detectedPredictors);

        // è‘—ä½œæ¨©å¯¾å¿œ: äºˆæƒ³è€…åã‚’å°ç•ªå·åŒ–ï¼ˆå°5/å°4/å°3/å°2/å°1ï¼‰
        // ä¾‹: CPU, é’æœ¨è¡Œ, ä¿¡æ ¹éš†, æ©‹æœ¬ç¯¤, æœ¬ç´™ â†’ å°5, å°4, å°3, å°2, å°1
        const predictors = detectedPredictors.map((_, index) =>
          `å°${detectedPredictors.length - index}`
        );
        console.log('[extractPredictions] æ¤œå‡ºã—ãŸäºˆæƒ³è€…:', detectedPredictors);
        console.log('[extractPredictions] äºˆæƒ³è€…ãƒªã‚¹ãƒˆï¼ˆå°ç•ªå·åŒ–ï¼‰:', predictors);

        const rows = table.querySelectorAll('tbody tr');
        const horses = [];

        rows.forEach(row => {
          const horse = extractHorseFromRow(row, detectedPredictors, predictors);
          if (horse) {
            horses.push(horse);
          }
        });

        console.log(`[extractPredictions] æŠ½å‡ºã—ãŸé¦¬æ•°: ${horses.length}`);

        return {
          success: true,
          horses,
          predictors,
          errors,
        };
      } catch (error) {
        errors.push(`æŠ½å‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
        return { success: false, horses: [], predictors: [], errors };
      }
    }

    function detectPredictors(headerRow) {
      const headers = [];
      const ths = headerRow.querySelectorAll('th');

      // äºˆæƒ³å°ä»¥å¤–ã®åˆ—ã‚’é™¤å¤–
      const excludeList = [
        'æ ç•ª', 'æ ', 'é¦¬ç•ª', 'é¦¬å', 'é¸æŠ', 'æ€§é½¢', 'æ¸›é‡', 'é¨æ‰‹', 'æ–¤é‡', 'é‡é‡',
        'å©èˆ', 'çŸ­è©•', 'å¢—æ¸›', 'å˜å‹', 'äººæ°—', 'ç€é †', 'é¦¬ä½“é‡', 'ãƒ–ãƒªãƒ³ã‚«',
        'ã‚ªãƒƒã‚º', 'ã‚¿ã‚¤ãƒ ', 'ç€å·®', 'ãƒšãƒ¼ã‚¹', 'ä¸Š3F', 'èª¿æ•™å¸«', 'é¦¬ä¸»', 'ãƒ¬ã‚¤ãƒ†ã‚£ãƒ³ã‚°', 'èª¿æ•™å‹•ç”»'
      ];

      ths.forEach((th) => {
        const text = th.textContent?.trim() || '';

        // é™¤å¤–ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (excludeList.some(keyword => text.includes(keyword))) {
          return;
        }

        // Myå°ã‚’é™¤å¤–
        if (text.includes('My') || text.includes('M') && text.includes('y')) {
          return;
        }

        // äºˆæƒ³å°åˆ—ã‚’æ¤œå‡º
        if (
          text === 'CPU' ||           // CPU
          text === 'æœ¬ç´™' ||          // æœ¬ç´™
          (text.length >= 2 && text.length <= 4 && /^[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ ]+$/.test(text)) // 2-4æ–‡å­—ã®æ—¥æœ¬èªï¼ˆäºˆæƒ³è€…åï¼‰
        ) {
          headers.push(text);
        }
      });

      return headers;
    }

    function extractMarkFromElement(element) {
      const text = element.textContent?.trim() || '';

      if (element.querySelector('svg')) {
        return 'svg';
      }

      const markMap = {
        'â—': 'â—',
        'â—‹': 'â—‹',
        'â–²': 'â–²',
        'â–³': 'â–³',
        'Ã—': 'Ã—',
        'ç©´': 'ç©´',
        'æ³¨': 'æ³¨',
        'æ¶ˆ': 'æ¶ˆ',
        '-': '-',
        '': '-',
      };

      return markMap[text] || text;
    }

    function extractHorseFromRow(row, detectedPredictors, anonymizedPredictors) {
      const tds = Array.from(row.querySelectorAll('td'));

      let number = 0;
      let name = '';
      let umacd = undefined;
      const marks = {};
      let seirei = '';
      let kisyu = '';
      let kinryo = '';
      let kyusya = '';

      // é¦¬ç•ªï¼ˆumaban class ã¾ãŸã¯2åˆ—ç›®ï¼‰
      const umabanTd = tds.find(td => td.classList.contains('umaban'));
      if (umabanTd) {
        number = parseInt(umabanTd.textContent?.trim() || '0', 10);
      } else if (tds.length >= 2) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 2åˆ—ç›®ã‚’é¦¬ç•ªã¨ã—ã¦æ‰±ã†
        const secondCol = tds[1].textContent?.trim() || '';
        const parsed = parseInt(secondCol, 10);
        if (!isNaN(parsed)) {
          number = parsed;
        }
      }

      // é¦¬åï¼ˆbamei classå†…ã®ãƒªãƒ³ã‚¯ï¼‰
      const bameiTd = tds.find(td => td.classList.contains('bamei'));
      if (bameiTd) {
        const link = bameiTd.querySelector('a');
        if (link) {
          name = link.textContent?.trim() || '';
          const href = link.getAttribute('href') || '';
          const match = href.match(/\/uma\/(\d+)/);
          if (match) {
            umacd = match[1];
          }
        }
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®thã‚’å–å¾—ã—ã¦ã€äºˆæƒ³è€…åã«è©²å½“ã™ã‚‹thã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
      const headerRow = row.closest('table')?.querySelector('thead tr');
      if (headerRow) {
        const ths = Array.from(headerRow.querySelectorAll('th'));
        const markIndices = [];

        // å®Ÿéš›ã®äºˆæƒ³è€…åï¼ˆdetectedPredictorsï¼‰ã§HTMLæ¤œç´¢
        ths.forEach((th, idx) => {
          const text = th.textContent?.trim() || '';
          detectedPredictors.forEach(predictor => {
            if (text === predictor || text.includes(predictor)) {
              markIndices.push(idx);
            }
          });
        });

        // å°ç•ªå·åŒ–ã—ãŸåå‰ï¼ˆanonymizedPredictorsï¼‰ã§markså‡ºåŠ›
        markIndices.forEach((thIdx, predictorIdx) => {
          if (thIdx < tds.length && predictorIdx < anonymizedPredictors.length) {
            const td = tds[thIdx];
            const mark = extractMarkFromElement(td);
            marks[anonymizedPredictors[predictorIdx]] = mark;
          }
        });

        // ãƒ‡ãƒãƒƒã‚°: 1ç•ªé¦¬ã®thã‚’å…¨ã¦è¡¨ç¤º
        if (number === 1) {
          console.log('[DEBUG] 1ç•ªé¦¬ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ:');
          ths.forEach((th, idx) => {
            console.log(`  th[${idx}]: "${th.textContent?.trim()}"`);
          });
        }

        // æ€§é½¢ãƒ»é¨æ‰‹ãƒ»æ–¤é‡ãƒ»å©èˆã‚‚thä½ç½®ã‹ã‚‰ç‰¹å®š
        const fieldMap = {
          'æ€§é½¢': 'seirei',
          'é¨æ‰‹': 'kisyu',
          'æ–¤é‡': 'kinryo',
          'é‡é‡': 'kinryo',
          'å©èˆ': 'kyusya',
          'èª¿æ•™å¸«': 'kyusya',
        };

        ths.forEach((th, idx) => {
          const text = th.textContent?.trim() || '';
          // JRAã®HTMLã¯ã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šï¼ˆä¾‹: "é¨ æ‰‹"ï¼‰ãªã®ã§ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¦æ¯”è¼ƒ
          const textNoSpace = text.replace(/\s+/g, '');
          Object.entries(fieldMap).forEach(([keyword, fieldName]) => {
            if (textNoSpace.includes(keyword)) {
              if (idx < tds.length) {
                const td = tds[idx];

                if (number === 1) {
                  console.log(`[DEBUG] ãƒãƒƒãƒ: th="${text}" â†’ fieldName="${fieldName}", td="${td.textContent?.trim().substring(0, 30)}"`);
                }

                if (fieldName === 'kyusya') {
                  // å©èˆã®å ´åˆã€<span class="syozoku">ã‚’æ‹¬å¼§ã§å›²ã‚€
                  const syozokuSpan = td.querySelector('.syozoku');
                  if (syozokuSpan) {
                    const syozoku = syozokuSpan.textContent?.trim() || '';
                    const trainerName = td.textContent?.trim().replace(syozoku, '') || '';
                    kyusya = `(${syozoku})${trainerName}`;
                  } else {
                    kyusya = td.textContent?.trim() || '';
                  }
                } else {
                  const value = td.textContent?.trim() || '';
                  if (fieldName === 'seirei') seirei = value;
                  else if (fieldName === 'kisyu') kisyu = value;
                  else if (fieldName === 'kinryo') kinryo = value;
                }
              }
            }
          });
        });
      }

      if (number === 0 || !name) {
        console.log(`[extractHorseFromRow] ã‚¹ã‚­ãƒƒãƒ—: number=${number}, name=${name}`);
        return null;
      }

      return {
        number,
        name,
        umacd,
        marks,
        seirei,
        kisyu,
        kinryo,
        kyusya,
      };
    }

    function extractRaceInfo(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const racenameDiv = doc.querySelector('div.racename');
      let date = '';
      let raceName = '';
      let raceType = '';
      let distance = '';
      let surface = '';
      let raceNo = '';
      let hassoTime = '';
      let kaisaiInfo = '';
      let tenkiBaba = '';
      let recordTime = '';
      let estimatedTime = '';
      let prizes = [];
      let courseInfo = '';
      let venue = '';

      if (racenameDiv) {
        const text = racenameDiv.textContent || '';
        console.log('[extractRaceInfo] racenameDiv ãƒ†ã‚­ã‚¹ãƒˆ:', text);

        // æ—¥ä»˜æŠ½å‡º
        const dateMatch = text.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        if (dateMatch) {
          date = `${dateMatch[1]}å¹´${dateMatch[2]}æœˆ${dateMatch[3]}æ—¥`;
        }

        // é–‹å‚¬æƒ…å ±ï¼ˆ<h2>ã‹ã‚‰ï¼‰
        const h2 = racenameDiv.querySelector('h2');
        if (h2) {
          kaisaiInfo = h2.textContent?.trim() || '';
        }

        // ãƒ¬ãƒ¼ã‚¹ç•ªå·ï¼ˆ<p class="raceno">ã‹ã‚‰ï¼‰
        const racenoP = racenameDiv.querySelector('p.raceno');
        if (racenoP) {
          raceNo = racenoP.textContent?.trim() || '';
        }

        // ç™ºèµ°æ™‚åˆ»ï¼ˆ<p class="hassotime">ã‹ã‚‰ï¼‰
        const hassotimeP = racenameDiv.querySelector('p.hassotime');
        if (hassotimeP) {
          hassoTime = hassotimeP.textContent?.trim() || '';
        }

        // ãƒ¬ãƒ¼ã‚¹åæŠ½å‡ºï¼ˆ<h1>ã‚¿ã‚°ã‹ã‚‰ï¼‰
        const h1 = racenameDiv.querySelector('h1');
        if (h1) {
          raceName = h1.textContent?.trim() || '';
        }

        // ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—æŠ½å‡ºï¼ˆ<div class="h1block">å†…ã®<p>ã‹ã‚‰ï¼‰
        const h1block = racenameDiv.querySelector('div.h1block');
        if (h1block) {
          const pTags = h1block.querySelectorAll('p');
          if (pTags.length > 0) {
            raceType = pTags[0].textContent?.trim() || '';
          }
        }

        // è·é›¢æŠ½å‡ºï¼ˆ<p class="racekyori">å†…ã®<button>ã‹ã‚‰ï¼‰
        const racekyoriP = racenameDiv.querySelector('p.racekyori');
        if (racekyoriP) {
          const button = racekyoriP.querySelector('button');
          if (button) {
            const buttonText = button.textContent?.trim() || '';
            // "2000m" â†’ "2000"
            const distanceMatch = buttonText.match(/(\d{3,4})m?/);
            if (distanceMatch) {
              distance = distanceMatch[1];
            }
          }
        }

        // é¦¬å ´ç¨®åˆ¥ï¼ˆ<p class="raceshibada">ã‹ã‚‰ï¼‰
        const raceshibadaP = racenameDiv.querySelector('p.raceshibada');
        if (raceshibadaP) {
          const shibadaText = raceshibadaP.textContent?.trim() || '';
          courseInfo = shibadaText;
          if (shibadaText.includes('èŠ')) {
            surface = 'èŠ';
          } else if (shibadaText.includes('ãƒ€ãƒ¼ãƒˆ')) {
            surface = 'ãƒ€ãƒ¼ãƒˆ';
          }
        }

        // å¤©å€™ãƒ»é¦¬å ´ï¼ˆ<p class="tenkibaba">ã‹ã‚‰ï¼‰
        const tenkibabaP = racenameDiv.querySelector('p.tenkibaba');
        if (tenkibabaP) {
          tenkiBaba = tenkibabaP.textContent?.trim() || '';
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ãƒ»æ¨å®šã‚¿ã‚¤ãƒ ï¼ˆ<div class="racenametime">ã‹ã‚‰ï¼‰
        const racenametimeDiv = racenameDiv.querySelector('div.racenametime');
        if (racenametimeDiv) {
          const pTags = racenametimeDiv.querySelectorAll('p');
          pTags.forEach(p => {
            const pText = p.textContent?.trim() || '';
            if (pText.startsWith('ãƒ¬ã‚³ãƒ¼ãƒ‰')) {
              recordTime = pText;
            } else if (pText.startsWith('è‰¯') || pText.startsWith('é‡') || pText.startsWith('ç¨') || pText.startsWith('ä¸')) {
              estimatedTime += (estimatedTime ? ' / ' : '') + pText;
            }
          });
        }

        // è³é‡‘ï¼ˆ<div class="racesyoukin">ã‹ã‚‰ï¼‰
        const racesyoukinDiv = racenameDiv.querySelector('div.racesyoukin');
        if (racesyoukinDiv) {
          const liTags = racesyoukinDiv.querySelectorAll('li');
          liTags.forEach((li, index) => {
            const span = li.querySelector('span');
            if (span) {
              prizes.push(`${index + 1}ç€: ${span.textContent?.trim() || ''}`);
            }
          });
        }

        // ç«¶é¦¬å ´è‡ªå‹•æŠ½å‡ºï¼ˆkaisaiInfoã‹ã‚‰ï¼‰
        // ä¾‹: "1å›å°å€‰6æ—¥ç›®" â†’ "å°å€‰"
        const venueList = ['æ±äº¬', 'ä¸­å±±', 'äº¬éƒ½', 'é˜ªç¥', 'ä¸­äº¬', 'æ–°æ½Ÿ', 'ç¦å³¶', 'å°å€‰', 'æœ­å¹Œ', 'å‡½é¤¨'];
        for (const v of venueList) {
          if (kaisaiInfo.includes(v)) {
            venue = v;
            break;
          }
        }

        console.log('[extractRaceInfo] æŠ½å‡ºçµæœ:', {
          date, kaisaiInfo, venue, raceNo, hassoTime, raceName, raceType,
          distance, surface, courseInfo, tenkiBaba, recordTime, estimatedTime, prizes
        });
      } else {
        console.error('[extractRaceInfo] âŒ div.racename ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('[extractRaceInfo] ğŸ“‹ è²¼ã‚Šä»˜ã‘ãŸHTMLã« <div class="racename"> ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        console.error('[extractRaceInfo] ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒ¬ãƒ¼ã‚¹åã®éƒ¨åˆ†ã‹ã‚‰ <table class="default syutuba"> ã¾ã§å…¨ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„');

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è­¦å‘Šã‚’è¡¨ç¤º
        alert('âš ï¸ ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n\n<div class="racename">ã‹ã‚‰å§‹ã¾ã‚‹éƒ¨åˆ†ã‚’å«ã‚ã¦ã€HTMLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚\n\nãƒ†ãƒ¼ãƒ–ãƒ«éƒ¨åˆ†ã ã‘ã§ã¯ã€ãƒ¬ãƒ¼ã‚¹åãƒ»è·é›¢ãƒ»é¦¬å ´æƒ…å ±ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã€‚');
      }

      return {
        date, kaisaiInfo, venue, raceNo, hassoTime, raceName, raceType,
        distance, surface, courseInfo, tenkiBaba, recordTime, estimatedTime, prizes
      };
    }

    function scoreAndAssign(result) {
      const markScores = {
        'â—': 5,
        'â—‹': 4,
        'â–²': 3,
        'svg': 2,
        'ç©´': 2,  // svgã¨åŒã˜2ç‚¹
        'â–³': 1,
        '-': 0,
      };

      const horses = result.horses.map(horse => {
        let totalScore = 0;
        Object.values(horse.marks).forEach(mark => {
          totalScore += markScores[mark] || 0;
        });

        return {
          ...horse,
          totalScore,
        };
      });

      horses.sort((a, b) => b.totalScore - a.totalScore);

      const assignments = {
        main: null,
        sub: null,
        hole: null,
        connectTop: null,
        connect: [],
        reserve: [],
        none: [],
      };

      horses.forEach((horse, index) => {
        if (index === 0) {
          assignments.main = horse;
          horse.assignment = 'æœ¬å‘½';
        } else if (index === 1) {
          assignments.sub = horse;
          horse.assignment = 'å¯¾æŠ—';
        } else if (index === 2) {
          assignments.hole = horse;
          horse.assignment = 'å˜ç©´';
        } else if (index === 3) {
          assignments.connectTop = horse;
          horse.assignment = 'é€£ä¸‹æœ€ä¸Šä½';
        } else if (index >= 4 && index <= 6 && horse.totalScore > 0) {
          assignments.connect.push(horse);
          horse.assignment = 'é€£ä¸‹';
        } else if (horse.totalScore > 0) {
          assignments.reserve.push(horse);
          horse.assignment = 'è£œæ¬ ';
        } else {
          assignments.none.push(horse);
          horse.assignment = 'ç„¡';
        }
      });

      return {
        ...result,
        horses,
        assignments,
      };
    }
  </script>
</BaseLayout>
