---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout
  title="JRA çµæœç®¡ç†ç”»é¢"
  description="ä¸­å¤®ç«¶é¦¬å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸçµæœã‚’è‡ªå‹•è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">ğŸ‡ JRA çµæœç®¡ç†</h1>
      <p class="page-description">
        å„ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥å…¥åŠ›ã§ãã¾ã™ã€‚<br>
        <strong>â€» ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«è²¼ã‚Šä»˜ã‘ã¦è§£æãƒ»ä¿å­˜ã—ã¦ãã ã•ã„</strong>
      </p>

      <!-- å…±é€šæƒ…å ±å…¥åŠ› -->
      <div class="card common-info-card">
        <h2>ğŸ“… é–‹å‚¬æƒ…å ±ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹å…±é€šï¼‰</h2>
        <div class="common-info-grid">
          <div class="form-group">
            <label for="commonDate">é–‹å‚¬æ—¥</label>
            <input
              type="date"
              id="commonDate"
              class="form-input"
              value={new Date().toISOString().split('T')[0]}
            />
          </div>
          <div class="form-group">
            <label for="commonVenue">ç«¶é¦¬å ´</label>
            <select id="commonVenue" class="form-select">
              <option value="æ±äº¬">æ±äº¬</option>
              <option value="ä¸­å±±">ä¸­å±±</option>
              <option value="äº¬éƒ½">äº¬éƒ½</option>
              <option value="é˜ªç¥">é˜ªç¥</option>
              <option value="ä¸­äº¬">ä¸­äº¬</option>
              <option value="æ–°æ½Ÿ">æ–°æ½Ÿ</option>
              <option value="ç¦å³¶">ç¦å³¶</option>
              <option value="å°å€‰">å°å€‰</option>
              <option value="æœ­å¹Œ">æœ­å¹Œ</option>
              <option value="å‡½é¤¨">å‡½é¤¨</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 12ãƒ¬ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="races-container">
        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(raceNum => (
          <details class="race-section card" data-race-number={raceNum}>
            <summary class="race-section-header">
              <span class="race-number-badge">ç¬¬{raceNum}R</span>
              <span class="race-status" data-status="æœªå…¥åŠ›">æœªå…¥åŠ›</span>
            </summary>

            <div class="race-section-content">
              <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div class="input-area">
                <label for={`raceInput${raceNum}`}>ç¬¬{raceNum}R ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                <textarea
                  id={`raceInput${raceNum}`}
                  class="race-textarea"
                  rows="15"
                  placeholder={`ç¬¬${raceNum}Rã®ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„

ä¾‹:
ç¬¬${raceNum}R
æ±äº¬æ–°èæ¯ï¼ˆGIIï¼‰
èŠ 1,600mï¼ˆå·¦ï¼‰ ï¼ˆ16é ­ï¼‰ ç™ºèµ°æ™‚åˆ»15:40
ç€    æ     é¦¬ç•ª    é¦¬å    æ€§é½¢    è² æ‹…    é¦¬ä½“é‡    å¢—æ¸›    é¨æ‰‹    èª¿æ•™å¸«    ã‚¿ã‚¤ãƒ     ç€å·®    ä¸ŠãŒã‚Š3F    ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †    äººæ°—
1    5    7    ãƒ‰ã‚¦ãƒ‡ãƒ¥ãƒ¼ã‚¹    ç‰¡4    58.0    480kg    -2    ç¦æ°¸ç¥ä¸€    å‹é“åº·å¤«    1:32.8    -    33.5    -    1
...
æ‰•æˆ»é‡‘
å˜å‹ è¤‡å‹ æ è¤‡ æ™®é€šé¦¬è¤‡ æ å˜ é¦¬å˜
...`}
                ></textarea>
                <button
                  type="button"
                  class="btn btn-primary w-full"
                  onclick={`parseRace(${raceNum})`}
                >
                  ğŸ” ç¬¬{raceNum}R ã‚’è§£æ
                </button>
              </div>

              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
              <div id={`preview${raceNum}`} class="preview-area" style="display: none;">
                <h3>âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div id={`previewContent${raceNum}`} class="preview-content"></div>

                <!-- JSONè¡¨ç¤º -->
                <div class="json-display">
                  <h4>JSON ãƒ‡ãƒ¼ã‚¿</h4>
                  <textarea
                    id={`jsonOutput${raceNum}`}
                    class="json-textarea"
                    rows="10"
                    readonly
                  ></textarea>
                  <textarea
                    id={`archiveJsonOutput${raceNum}`}
                    class="json-textarea"
                    rows="10"
                    readonly
                    style="display: none;"
                  ></textarea>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <div class="action-buttons">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick={`navigator.clipboard.writeText(document.getElementById('jsonOutput${raceNum}').value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))`}
                  >
                    ğŸ“‹ JSONã‚³ãƒ”ãƒ¼
                  </button>
                  <button
                    type="button"
                    id={`saveBtn${raceNum}`}
                    class="btn btn-success"
                    onclick={`saveRaceToGit(${raceNum}, false)`}
                  >
                    ğŸš€ ä¿å­˜ã—ã¦Git Push
                  </button>
                  <button
                    type="button"
                    class="btn btn-warning"
                    onclick={`if(confirm('ã“ã®æ—¥ä»˜ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) saveRaceToGit(${raceNum}, true)`}
                    style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;"
                  >
                    ğŸ”¥ å®Œå…¨ä¸Šæ›¸ãä¿å­˜
                  </button>
                </div>
                <div id={`saveStatus${raceNum}`} class="save-status" style="display: none;"></div>
              </div>
            </div>
          </details>
        ))}
      </div>

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ğŸ“– ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>é–‹å‚¬æ—¥ãƒ»ç«¶é¦¬å ´</strong>ã‚’ä¸Šéƒ¨ã§é¸æŠ</li>
          <li>å„ãƒ¬ãƒ¼ã‚¹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¬¬1Rã€œç¬¬12Rï¼‰ã‚’å±•é–‹</li>
          <li>ä¸­å¤®ç«¶é¦¬å…¬å¼ã‚µã‚¤ãƒˆã¾ãŸã¯JRA-VANã‹ã‚‰<strong>è©²å½“ãƒ¬ãƒ¼ã‚¹ã®ã¿ã‚³ãƒ”ãƒ¼</strong></li>
          <li>ã€Œè§£æã€ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</li>
          <li>ã€Œä¿å­˜ã—ã¦Git Pushã€ã§ keiba-data-shared ã«ä¿å­˜</li>
          <li>å…¨ãƒ¬ãƒ¼ã‚¹ä¿å­˜å¾Œã€è‡ªå‹•çš„ã«å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ ğŸ‰</li>
        </ol>

        <h3>ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ</h3>
        <ul>
          <li>ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹åˆ¥ã«è²¼ã‚Šä»˜ã‘ãƒ»ä¿å­˜ã§ãã¾ã™</li>
          <li>æ—¢å­˜ãƒ¬ãƒ¼ã‚¹ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ï¼‰</li>
          <li>äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•çš„ã«çš„ä¸­åˆ¤å®šã‚’è¡Œã„ã¾ã™</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .common-info-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-2xl);
    }

    .common-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input,
    .form-select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .races-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .race-section {
      border: 2px solid var(--border-color);
      transition: border-color 0.3s ease;
    }

    .race-section[open] {
      border-color: var(--primary-end);
    }

    .race-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      cursor: pointer;
      font-weight: 600;
      font-size: 1.25rem;
      user-select: none;
    }

    .race-section-header:hover {
      background: var(--bg-secondary);
    }

    .race-number-badge {
      color: var(--primary-end);
      font-size: 1.5rem;
    }

    .race-status {
      font-size: 0.875rem;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .race-status[data-status="æœªå…¥åŠ›"] {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-tertiary);
    }

    .race-status[data-status="è§£ææ¸ˆã¿"] {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .race-status[data-status="ä¿å­˜æ¸ˆã¿"] {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .race-section-content {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .input-area {
      margin-bottom: var(--spacing-xl);
    }

    .input-area label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }

    .race-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
      margin-bottom: var(--spacing-md);
    }

    .preview-area {
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    .preview-area h3 {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-lg);
      color: var(--success);
    }

    .preview-content {
      margin-bottom: var(--spacing-lg);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .info-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .hit-info {
      padding: var(--spacing-md);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-radius: var(--radius-md);
      border-left: 4px solid var(--success);
      margin-bottom: var(--spacing-lg);
    }

    .hit-info strong {
      color: var(--success);
    }

    .debug-section {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border: 1px dashed var(--border-color);
    }

    .debug-section summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
      user-select: none;
    }

    .debug-content {
      margin-top: var(--spacing-md);
      font-size: 0.875rem;
      line-height: 1.8;
    }

    .debug-content div {
      padding: var(--spacing-xs) 0;
    }

    .json-display {
      margin-top: var(--spacing-lg);
    }

    .json-display h4 {
      font-size: 1.125rem;
      margin-bottom: var(--spacing-sm);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .action-buttons {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .action-buttons .btn {
      flex: 1;
    }

    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
    }

    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-2xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .w-full {
      width: 100%;
    }

    @media (max-width: 768px) {
      .common-info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>

  <script is:inline>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆå„ãƒ¬ãƒ¼ã‚¹ã®ãƒ‘ãƒ¼ã‚¹çµæœã‚’ä¿å­˜ï¼‰
    const raceResults = {};

    // ãƒ¬ãƒ¼ã‚¹ãƒ‘ãƒ¼ã‚¹é–¢æ•°
    function parseRace(raceNum) {
      const textarea = document.getElementById(`raceInput${raceNum}`);
      const text = textarea.value;

      if (!text.trim()) {
        alert(`ç¬¬${raceNum}Rã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
        return;
      }

      try {
        // å…±é€šæƒ…å ±å–å¾—
        const date = document.getElementById('commonDate').value;
        const venue = document.getElementById('commonVenue').value;
        const venueCodeMap = {
          'æ±äº¬': 'TKY', 'ä¸­å±±': 'NAK', 'äº¬éƒ½': 'KYO', 'é˜ªç¥': 'HAN',
          'ä¸­äº¬': 'CHU', 'æ–°æ½Ÿ': 'NII', 'ç¦å³¶': 'FKU', 'å°å€‰': 'KKU',
          'æœ­å¹Œ': 'SAP', 'å‡½é¤¨': 'HKD'
        };
        const venueCode = venueCodeMap[venue];

        // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãƒ‘ãƒ¼ã‚¹
        const raceInfo = extractRaceInfo(text, raceNum);
        const results = extractResults(text);
        const payouts = extractPayouts(text);
        const timeData = extractTimeData(text);
        const cornerData = extractCornerData(text);

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        console.log(`[Race ${raceNum}] ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºçµæœ:`, timeData);
        console.log(`[Race ${raceNum}] ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †æŠ½å‡ºçµæœ:`, cornerData);

        // raceDataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€æ—¦ä½œæˆ
        const raceData = {
          raceNumber: raceNum,
          raceName: raceInfo.raceName,
          distance: raceInfo.distance,
          surface: raceInfo.surface,
          track: raceInfo.track,
          horses: raceInfo.horses || results.length,  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æŠ½å‡ºã§ããªã‘ã‚Œã°å®Ÿéš›ã®ç€é †æ•°
          startTime: raceInfo.startTime,
          weather: raceInfo.weather,
          trackCondition: raceInfo.trackCondition,
          results,
          payouts,
          timeData,
          cornerData,
          enteredAt: new Date().toISOString(),
          enteredBy: 'staff-ui'
        };

        // commentã‚’ç”Ÿæˆã—ã¦raceDataã«è¿½åŠ 
        const comment = generateRaceCommentary(raceData, date, venue);
        raceData.comment = comment;

        // çµæœJSONç”Ÿæˆ
        const resultsJSON = {
          date,
          venue,
          venueCode,
          races: [raceData],
          dataVersion: '1.0'
        };

        // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã¦çš„ä¸­åˆ¤å®š
        fetchPredictionData(date).then(predictionData => {
          const archiveResults = generateArchiveResults(resultsJSON, predictionData);

          // çµæœã‚’ä¿å­˜
          raceResults[raceNum] = {
            resultsJSON,
            archiveResults
          };

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
          displayPreview(raceNum, raceData, archiveResults, date, venue);

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          updateRaceStatus(raceNum, 'è§£ææ¸ˆã¿');
        });

      } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error(error);
      }
    }

    // å¤©å€™ã«å¯¾å¿œã™ã‚‹çµµæ–‡å­—ã‚’è¿”ã™
    function getWeatherEmoji(weather) {
      const weatherEmojis = {
        'æ™´': 'â˜€ï¸',
        'æ›‡': 'â˜ï¸',
        'é›¨': 'â˜”',
        'é›ª': 'â„ï¸',
        'å°é›¨': 'ğŸŒ§ï¸',
        'å°é›ª': 'ğŸŒ¨ï¸'
      };
      return weatherEmojis[weather] || '';
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function displayPreview(raceNum, raceData, archiveResults, date, venue) {
      const previewDiv = document.getElementById(`preview${raceNum}`);
      const previewContent = document.getElementById(`previewContent${raceNum}`);
      const jsonOutput = document.getElementById(`jsonOutput${raceNum}`);
      const archiveJsonOutput = document.getElementById(`archiveJsonOutput${raceNum}`);

      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±HTMLç”Ÿæˆ
      let html = `
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">ãƒ¬ãƒ¼ã‚¹:</span>
            <span class="info-value">ç¬¬${raceData.raceNumber}R ${date} ${venue}ç«¶é¦¬ ${raceData.raceName || ''}</span>
          </div>
          <div class="info-item">
            <span class="info-label">è·é›¢:</span>
            <span class="info-value">${raceData.surface}${raceData.distance}m</span>
          </div>
          <div class="info-item">
            <span class="info-label">å‡ºèµ°é ­æ•°:</span>
            <span class="info-value">${raceData.horses}é ­</span>
          </div>
          ${raceData.startTime ? `
          <div class="info-item">
            <span class="info-label">ç™ºèµ°æ™‚åˆ»:</span>
            <span class="info-value">${raceData.startTime}</span>
          </div>
          ` : ''}
          ${raceData.weather ? `
          <div class="info-item">
            <span class="info-label">å¤©å€™:</span>
            <span class="info-value">${raceData.weather}${getWeatherEmoji(raceData.weather)}</span>
          </div>
          ` : ''}
          ${raceData.trackCondition ? `
          <div class="info-item">
            <span class="info-label">é¦¬å ´çŠ¶æ…‹:</span>
            <span class="info-value">${raceData.trackCondition}</span>
          </div>
          ` : ''}
        </div>
      `;

      // å…¨ç€é †è¡¨ç¤º
      if (raceData.results && raceData.results.length > 0) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ‡ ç€é †</h4>';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
        html += '<thead><tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">';
        html += '<th style="padding: 0.5rem; text-align: center;">ç€é †</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">æ </th>';
        html += '<th style="padding: 0.5rem; text-align: center;">é¦¬ç•ª</th>';
        html += '<th style="padding: 0.5rem; text-align: left;">é¦¬å</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">æ€§é½¢</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">æ–¤é‡</th>';
        html += '<th style="padding: 0.5rem; text-align: left;">é¨æ‰‹</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">ã‚¿ã‚¤ãƒ </th>';
        html += '<th style="padding: 0.5rem; text-align: center;">ç€å·®</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">ä¸Š3F</th>';
        html += '<th style="padding: 0.5rem; text-align: left;">èª¿æ•™å¸«</th>';
        html += '<th style="padding: 0.5rem; text-align: center;">äººæ°—</th>';
        html += '</tr></thead><tbody>';

        raceData.results.forEach(horse => {
          html += '<tr style="border-bottom: 1px solid var(--border-color);">';
          html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.rank}ç€</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.bracket}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center; font-weight: 600;">${horse.number}</td>`;
          html += `<td style="padding: 0.5rem;">${horse.name}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.sexAge || ''}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.weight || ''}</td>`;
          html += `<td style="padding: 0.5rem;">${horse.jockey}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.time}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.margin}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.lastFurlong}</td>`;
          html += `<td style="padding: 0.5rem;">${horse.trainer || ''}</td>`;
          html += `<td style="padding: 0.5rem; text-align: center;">${horse.popularity}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        html += '</div>';
      }

      // ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ãƒ»ä¸ŠãŒã‚Šè¡¨ç¤º
      if (raceData.timeData) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">â±ï¸ ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿</h4>';
        html += '<div class="info-grid">';

        if (raceData.timeData.last3F) {
          html += `
            <div class="info-item">
              <span class="info-label">ä¸ŠãŒã‚Š3F:</span>
              <span class="info-value">${raceData.timeData.last3F}ç§’</span>
            </div>
          `;
        }

        if (raceData.timeData.last4F) {
          html += `
            <div class="info-item">
              <span class="info-label">ä¸ŠãŒã‚Š4F:</span>
              <span class="info-value">${raceData.timeData.last4F}ç§’</span>
            </div>
          `;
        }

        if (raceData.timeData.furlongTimes && raceData.timeData.furlongTimes.length > 0) {
          html += `
            <div class="info-item" style="grid-column: 1 / -1;">
              <span class="info-label">ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ :</span>
              <span class="info-value">${raceData.timeData.furlongTimes.join(' - ')}ç§’</span>
            </div>
          `;
        }

        html += '</div>';
        html += '</div>';
      }

      // ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †è¡¨ç¤º
      if (raceData.cornerData && raceData.cornerData.length > 0) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ“ ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †</h4>';
        html += '<div class="info-grid">';

        raceData.cornerData.forEach(corner => {
          html += `
            <div class="info-item" style="grid-column: 1 / -1;">
              <span class="info-label">${corner.corner}:</span>
              <span class="info-value">${corner.orderString || corner.order.join(', ')}</span>
            </div>
          `;
        });

        html += '</div>';
        html += '</div>';
      }

      // æ‰•æˆ»æƒ…å ±ï¼ˆå…¨åˆ¸ç¨®å¯¾å¿œï¼‰
      if (raceData.payouts && Object.keys(raceData.payouts).length > 0) {
        html += '<div class="payouts-section">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ’° æ‰•æˆ»é‡‘</h4>';
        html += '<div class="info-grid">';

        const ticketNames = {
          tansho: 'å˜å‹',
          fukusho: 'è¤‡å‹',
          wakuren: 'æ è¤‡',
          umaren: 'é¦¬è¤‡',
          wakutan: 'æ å˜',
          umatan: 'é¦¬å˜',
          wide: 'ãƒ¯ã‚¤ãƒ‰',
          sanrenpuku: 'ä¸‰é€£è¤‡',
          sanrentan: 'ä¸‰é€£å˜'
        };

        for (const [key, name] of Object.entries(ticketNames)) {
          if (raceData.payouts[key] && Array.isArray(raceData.payouts[key])) {
            const items = raceData.payouts[key];
            items.forEach((item, idx) => {
              const numOrCombo = item.number || item.combination;
              html += `
                <div class="info-item">
                  <span class="info-label">${name}${items.length > 1 ? ` (${idx + 1})` : ''}:</span>
                  <span class="info-value">${numOrCombo} â†’ ${item.payout.toLocaleString()}å†† (${item.popularity}äººæ°—)</span>
                </div>
              `;
            });
          }
        }

        html += '</div>';
        html += '</div>';
      }

      // ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
      if (raceData.comment) {
        html += '<div style="margin-top: 1rem;">';
        html += '<h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">ğŸ“ ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆSEOæœ€é©åŒ–ï¼‰</h4>';
        html += '<div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-color);">';
        html += `<p style="line-height: 1.8; color: var(--text-primary); margin: 0;">${raceData.comment}</p>`;
        html += `<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">æ–‡å­—æ•°: ${raceData.comment.length}æ–‡å­—</p>`;
        html += '</div>';
        html += '</div>';
      }

      // çš„ä¸­åˆ¤å®šæƒ…å ±
      if (archiveResults) {
        const year = Object.keys(archiveResults)[0];
        const month = Object.keys(archiveResults[year])[0];
        const day = Object.keys(archiveResults[year][month])[0];
        const dayData = archiveResults[year][month][day];
        const raceArchive = dayData.races.find(r => r.raceNumber === `${raceNum}R`);

        if (raceArchive) {
          // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®åˆ¤å®š
          const hasPrediction = raceArchive.debug?.hasPrediction;

          let hitIcon, hitClass;
          if (!hasPrediction) {
            hitIcon = 'ğŸ“ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãªã—';
            hitClass = 'info';
          } else if (raceArchive.hit) {
            hitIcon = raceArchive.hitType === 'main' ? 'ğŸ¯æœ¬ç·šçš„ä¸­' : 'âœ…æŠ‘ãˆçš„ä¸­';
            hitClass = raceArchive.hitType === 'main' ? 'success' : 'warning';
          } else {
            hitIcon = 'âŒä¸çš„ä¸­';
            hitClass = 'error';
          }

          html += `
            <div class="hit-info">
              <strong>${hitIcon}</strong>
              ${raceArchive.hit ? `<br>æ‰•æˆ»é‡‘: ${raceArchive.payout.toLocaleString()}å††` : ''}
            </div>
          `;

          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          if (raceArchive.debug) {
            html += `
              <details class="debug-section">
                <summary>ğŸ” çš„ä¸­åˆ¤å®šãƒ‡ãƒãƒƒã‚°</summary>
                <div class="debug-content">
                  <div><strong>äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š:</strong> ${raceArchive.debug.hasPrediction ? 'âœ…' : 'âŒ'}</div>
                  <div><strong>çµæœãƒ‡ãƒ¼ã‚¿ã‚ã‚Š:</strong> ${raceArchive.debug.hasResult ? 'âœ…' : 'âŒ'}</div>
                  <div><strong>äºˆæƒ³ï¼ˆæœ¬ç·šï¼‰:</strong> ${raceArchive.debug.predictionMain?.join(', ') || 'ãªã—'}</div>
                  <div><strong>äºˆæƒ³ï¼ˆæŠ‘ãˆï¼‰:</strong> ${raceArchive.debug.predictionSub?.join(', ') || 'ãªã—'}</div>
                  <div><strong>çµæœï¼ˆé¦¬å˜ï¼‰:</strong> ${raceArchive.debug.resultCombo || 'ãªã—'}</div>
                  <div><strong>æ‰•æˆ»é‡‘:</strong> ${(raceArchive.debug.resultPayout || 0).toLocaleString()}å††</div>
                </div>
              </details>
            `;
          }
        }
      }

      previewContent.innerHTML = html;
      jsonOutput.value = JSON.stringify(raceResults[raceNum].resultsJSON, null, 2);
      archiveJsonOutput.value = JSON.stringify(raceResults[raceNum].archiveResults, null, 2);
      previewDiv.style.display = 'block';
    }

    // ãƒ¬ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateRaceStatus(raceNum, status) {
      const section = document.querySelector(`.race-section[data-race-number="${raceNum}"]`);
      const statusSpan = section.querySelector('.race-status');
      statusSpan.setAttribute('data-status', status);
      statusSpan.textContent = status;
    }

    // Gitä¿å­˜
    async function saveRaceToGit(raceNum, forceOverwrite = false) {
      if (!raceResults[raceNum]) {
        alert('å…ˆã«è§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
        return;
      }

      const btn = document.getElementById(`saveBtn${raceNum}`);
      const statusDiv = document.getElementById(`saveStatus${raceNum}`);

      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = forceOverwrite
        ? 'ğŸ”¥ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¸Šæ›¸ãä¸­...'
        : 'ğŸš€ keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ä¸­...';

      try {
        const response = await fetch('/.netlify/functions/save-results-jra', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            resultsJSON: JSON.stringify(raceResults[raceNum].resultsJSON),
            archiveResultsJSON: JSON.stringify(raceResults[raceNum].archiveResults),
            forceOverwrite: forceOverwrite
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${data.message}<br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> <a href="${data.commitUrl}" target="_blank" style="color: var(--success);">GitHubã§ç¢ºèª</a>
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
          updateRaceStatus(raceNum, 'ä¿å­˜æ¸ˆã¿');
        } else {
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
      }
    }

    // ãƒ‘ãƒ¼ã‚µãƒ¼é–¢æ•°ç¾¤ï¼ˆä¸­å¤®ç«¶é¦¬ç”¨ã«èª¿æ•´ï¼‰

    function extractRaceInfo(text, raceNumber) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);

      console.log('[DEBUG extractRaceInfo] ãƒ¬ãƒ¼ã‚¹ç•ªå·:', raceNumber);
      console.log('[DEBUG extractRaceInfo] ãƒ†ã‚­ã‚¹ãƒˆè¡Œæ•°:', lines.length);

      // ãƒ¬ãƒ¼ã‚¹åå€™è£œã‚’è©•ä¾¡ã™ã‚‹é–¢æ•°ï¼ˆã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©é©åˆ‡ï¼‰
      const evaluateRaceNameCandidate = (line) => {
        let score = 0;

        // çµ¶å¯¾NGï¼ˆã‚¹ã‚³ã‚¢: -1000ï¼‰
        if (
          line.includes('è³é‡‘') ||
          line.includes('ç•ªçµ„ãƒã‚¤ãƒ³ãƒˆ') ||
          line.includes('ã‚µãƒ©ãƒ–ãƒ¬ãƒƒãƒ‰ç³»') ||
          line.includes('æ™®é€šç«¶èµ°') ||
          line.includes('ã‚¢ãƒ©ãƒ–ç³»') ||
          line.includes('ç™ºèµ°æ™‚åˆ»') ||
          line.includes('å¤©å€™:') ||
          line.includes('å¤©å€™') ||
          line.includes('é¦¬å ´:') ||
          line.includes('é¦¬å ´') ||
          line.includes('æœ¬è³é‡‘') ||
          line.includes('ã‚ªãƒƒã‚º') ||
          line.includes('ã‚³ãƒ¼ã‚¹ï¼š') ||
          line.includes('ã‚³ãƒ¼ã‚¹:') ||
          line.includes('ãƒ¡ãƒ¼ãƒˆãƒ«') ||
          line.includes('å°åˆ·ç”¨') ||
          line.includes('ãƒ¬ãƒ¼ã‚¹æ˜ åƒ') ||
          line.includes('ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«') ||
          line.includes('ç€') && line.includes('æ ') && line.includes('é¦¬ç•ª') ||  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
          line.includes('ç•ª') && line.includes('é¦¬å') && line.includes('æ€§é½¢') ||  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
          line.includes('é‡é‡') && line.includes('é¨æ‰‹') ||  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
          /^\d+[\s\u3000]+\d+[\s\u3000]+\d+/.test(line) ||  // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆç€é †ãƒ‡ãƒ¼ã‚¿ï¼‰
          line.length > 40 ||  // é•·ã™ãã‚‹è¡Œã¯ä¸é©åˆ‡
          line.length < 2      // çŸ­ã™ãã‚‹è¡Œã‚‚ä¸é©åˆ‡
        ) {
          return -1000;
        }

        // é‡è³ãƒ¬ãƒ¼ã‚¹ï¼ˆã‚¹ã‚³ã‚¢: +100ï¼‰
        if (line.match(/ç¬¬\d+å›/) && !line.match(/ç«¶é¦¬|æœˆ|æ—¥|å¹´/)) {
          score += 100;
        }

        // ä¸­å¤®ç«¶é¦¬ã®é‡è³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆGI/GII/GIIIï¼‰ï¼ˆã‚¹ã‚³ã‚¢: +150ï¼‰
        if (line.match(/[ï¼ˆ(]G[Iâ… â…¡â…¢]+[ï¼‰)]/)) {
          score += 150;
        }

        // ä¸­å¤®ç«¶é¦¬ã®ä¸€èˆ¬ãƒ¬ãƒ¼ã‚¹åï¼ˆã‚¹ã‚³ã‚¢: +120ï¼‰
        if (line.match(/[1-4]æ­³|æ–°é¦¬|æœªå‹åˆ©|1å‹ã‚¯ãƒ©ã‚¹|2å‹ã‚¯ãƒ©ã‚¹|3å‹ã‚¯ãƒ©ã‚¹|ã‚ªãƒ¼ãƒ—ãƒ³/)) {
          score += 120;
        }
        if (line.match(/\d+ä¸‡ä¸‹/)) {
          score += 120;
        }

        // åœ°æ–¹ç«¶é¦¬ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚³ã‚¢: +80ï¼‰
        if (line.match(/[ï¼¡ï¼¢ï¼£][ï¼‘ï¼’ï¼“ï¼]/)) {
          score += 80;
        }
        if (line.match(/[ABC][0-3]/)) {
          score += 80;
        }

        // ç‰¹åˆ¥ãƒ¬ãƒ¼ã‚¹åï¼ˆã‚¹ã‚³ã‚¢: +60ï¼‰
        if (line.includes('ç‰¹åˆ¥') && !line.includes('è³é‡‘')) {
          score += 60;
        }

        // æ¯ãƒ»ç›ƒã‚’å«ã‚€ï¼ˆã‚¹ã‚³ã‚¢: +50ï¼‰
        if (line.match(/æ¯|ç›ƒ/) && !line.includes('è³é‡‘')) {
          score += 50;
        }

        // è¨˜å¿µã‚’å«ã‚€ï¼ˆã‚¹ã‚³ã‚¢: +50ï¼‰
        if (line.includes('è¨˜å¿µ') && !line.includes('è³é‡‘')) {
          score += 50;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¯ã‚¹ã‚’å«ã‚€ï¼ˆã‚¹ã‚³ã‚¢: +50ï¼‰
        if (line.includes('ã‚¹ãƒ†ãƒ¼ã‚¯ã‚¹') || line.includes('ï¼³')) {
          score += 50;
        }

        // é©åˆ‡ãªæ–‡å­—æ•°ï¼ˆ10-30æ–‡å­—ï¼‰ã«ãƒœãƒ¼ãƒŠã‚¹ï¼ˆã‚¹ã‚³ã‚¢: +20ï¼‰
        if (line.length >= 10 && line.length <= 30) {
          score += 20;
        }

        // ã‚«ã‚¿ã‚«ãƒŠã‚’å«ã‚€ï¼ˆç«¶èµ°é¦¬åé¢¨ï¼‰ï¼ˆã‚¹ã‚³ã‚¢: +10ï¼‰
        if (line.match(/[ã‚¡-ãƒ´]/)) {
          score += 10;
        }

        // æ•°å­—ãŒå¤šã™ãã‚‹è¡Œã¯ãƒã‚¤ãƒŠã‚¹ï¼ˆã‚¹ã‚³ã‚¢: -50ï¼‰
        const digitCount = (line.match(/\d/g) || []).length;
        if (digitCount > 5) {
          score -= 50;
        }

        return score;
      };

      // å…¨è¡Œã‚’è©•ä¾¡ã—ã¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
      const candidates = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const score = evaluateRaceNameCandidate(line);

        if (score > 0) {
          candidates.push({ line, score, index: i });
          console.log(`[DEBUG extractRaceInfo] å€™è£œ: "${line}" (ã‚¹ã‚³ã‚¢: ${score})`);
        }
      }

      // ã‚¹ã‚³ã‚¢ãŒæœ€ã‚‚é«˜ã„å€™è£œã‚’é¸æŠ
      let raceName = '';
      if (candidates.length > 0) {
        candidates.sort((a, b) => b.score - a.score);
        raceName = candidates[0].line;
        console.log(`[DEBUG extractRaceInfo] ãƒ¬ãƒ¼ã‚¹åæ±ºå®š: "${raceName}" (ã‚¹ã‚³ã‚¢: ${candidates[0].score})`);
      } else {
        console.log('[DEBUG extractRaceInfo] ãƒ¬ãƒ¼ã‚¹åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('[DEBUG extractRaceInfo] æœ€åˆã®10è¡Œ:', lines.slice(0, 10));
      }

      // è·é›¢æŠ½å‡ºï¼ˆä¸­å¤®ç«¶é¦¬: ã€Œ1,400ãƒ¡ãƒ¼ãƒˆãƒ«ã€ã®ã‚ˆã†ã«ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
      const distanceMatch = text.match(/ã‚³ãƒ¼ã‚¹[ï¼š:]\s*(\d{1}),?(\d{3})ãƒ¡ãƒ¼ãƒˆãƒ«/) ||
                           text.match(/[ãƒ€èŠ][\s\u3000]*(\d{1}),?(\d{3})m/);
      const distance = distanceMatch ? parseInt(distanceMatch[1] + distanceMatch[2], 10) : null;

      const surface = text.includes('ãƒ€ãƒ¼ãƒˆ') || text.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';

      const trackMatch = text.match(/ï¼ˆ(å¤–|å†…|å³|å·¦)ï¼‰/);
      const track = trackMatch ? trackMatch[1] : null;

      // å‡ºèµ°é ­æ•°ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
      const horsesMatch = text.match(/ï¼ˆ(\d+)é ­ï¼‰/) ||
                         text.match(/(\d+)é ­ç«‹/) ||
                         text.match(/å‡ºèµ°é ­æ•°[ï¼š:]\s*(\d+)/) ||
                         text.match(/å‡ºèµ°[ï¼š:]\s*(\d+)é ­/);
      const horses = horsesMatch ? parseInt(horsesMatch[1], 10) : null;

      // ç™ºèµ°æ™‚åˆ»ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
      const startTimeMatch = text.match(/ç™ºèµ°æ™‚åˆ»[ï¼š:]\s*(\d{1,2})[:ï¼šæ™‚](\d{2})/) ||
                            text.match(/ç™ºèµ°[ï¼š:]\s*(\d{1,2})[:ï¼šæ™‚](\d{2})/) ||
                            text.match(/(\d{1,2})[:ï¼š](\d{2})\s*ç™ºèµ°/);
      const startTime = startTimeMatch ? `${startTimeMatch[1]}:${startTimeMatch[2]}` : null;

      // å¤©å€™æŠ½å‡ºï¼ˆä¸­å¤®ç«¶é¦¬: ã€Œ* å¤©å€™æ™´ã€ã®ã‚ˆã†ãªå½¢å¼ï¼‰
      const weatherMatch = text.match(/å¤©å€™\s*([^\sã€€\n*]+)/) || text.match(/å¤©å€™:\s*([^\sã€€]+)/);
      const weather = weatherMatch ? weatherMatch[1] : null;

      // é¦¬å ´çŠ¶æ…‹æŠ½å‡ºï¼ˆä¸­å¤®ç«¶é¦¬: ã€Œ* ãƒ€ãƒ¼ãƒˆè‰¯ã€ã®ã‚ˆã†ãªå½¢å¼ï¼‰
      const trackConditionMatch = text.match(/(?:ãƒ€ãƒ¼ãƒˆ|èŠ)\s*([^\sã€€\n*]+)/) ||
                                 text.match(/é¦¬å ´:\s*(?:ãƒ€ãƒ¼ãƒˆ|èŠ)\s+([^\sã€€]+)/);
      const trackCondition = trackConditionMatch ? trackConditionMatch[1] : null;

      console.log('[DEBUG extractRaceInfo] å¤©å€™:', weather);
      console.log('[DEBUG extractRaceInfo] é¦¬å ´çŠ¶æ…‹:', trackCondition);

      return { raceNumber, raceName, distance, surface, track, horses, startTime, weather, trackCondition };
    }

    function extractResults(text) {
      const results = [];
      const lines = text.split('\n');

      console.log('[DEBUG extractResults] ç·è¡Œæ•°:', lines.length);

      // ç€é †ãƒ‡ãƒ¼ã‚¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†ã‚’ç¤ºã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
      const sectionEndKeywords = [
        'ã‚¿ã‚¤ãƒ ',
        'ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ',
        'ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½',
        'æ‰•æˆ»é‡‘',
        'ä¸Šã‚Š',
        '4F',
        '3F'
      ];

      // ä¸­å¤®ç«¶é¦¬ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¤‡æ•°è¡Œã«åˆ†ã‹ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§çµåˆï¼‰
      let currentLine = '';
      let inResultSection = false;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue; // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†åˆ¤å®š
        const isEndOfSection = sectionEndKeywords.some(keyword => line.includes(keyword));
        if (isEndOfSection) {
          if (currentLine) {
            console.log('[DEBUG extractResults] ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰:', line);
            // ç¾åœ¨ã®è¡Œã‚’å‡¦ç†ã—ã¦çµ‚äº†
            processLine(currentLine, results);
            currentLine = '';
          }
          inResultSection = false;
          continue;
        }

        // ç€é †ãƒ‡ãƒ¼ã‚¿ã®é–‹å§‹ã‚’æ¤œå‡ºï¼ˆä¸­å¤®ç«¶é¦¬ã¯å¿…ãšã€Œæ ã€ã¨ã„ã†æ–‡å­—ã‚’å«ã‚€ï¼‰
        // ä¾‹: "1     æ 10ç™½     10     ã‚±ãƒ–ãƒ©ãƒ³ãƒª..."
        const isStartOfResult = /^\d+[\s\u3000]+æ \d+/.test(line);

        if (isStartOfResult) {
          // æ–°ã—ã„ç€é †è¡ŒãŒå§‹ã¾ã£ãŸ
          if (currentLine) {
            // å‰ã®è¡Œã‚’å‡¦ç†
            console.log('[DEBUG extractResults] æ–°ã—ã„ç€é †è¡Œæ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰');
            processLine(currentLine, results);
          }
          // æ–°ã—ã„è¡Œã‚’é–‹å§‹
          currentLine = line;
          inResultSection = true;
          console.log('[DEBUG extractResults] ç€é †è¡Œé–‹å§‹:', line.substring(0, 80));
        } else if (inResultSection && currentLine) {
          // ç¶™ç¶šè¡Œã®åˆ¤å®šï¼šç€é †ãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã¨æ€ã‚ã‚Œã‚‹å ´åˆã®ã¿çµåˆ
          // ãŸã ã—ã€æ˜ã‚‰ã‹ã«åˆ¥ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¯çµåˆã—ãªã„

          // æ è‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ"æ 8æ¡ƒ"ãªã©ï¼‰ãŒæ¥ãŸã‚‰ã€åˆ¥ã®é¦¬ã®ãƒ‡ãƒ¼ã‚¿ãªã®ã§å‰ã®è¡Œã‚’å‡¦ç†
          const hasWakuIro = /æ \d+[æ¡ƒæ©™é’èµ¤ç·‘é»„é»’ç™½]/.test(line);
          if (hasWakuIro) {
            console.log('[DEBUG extractResults] æ è‰²æ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰:', line);
            processLine(currentLine, results);
            currentLine = '';
            inResultSection = false;
            continue;
          }

          // ç‰¹è¨˜äº‹é …è¡Œï¼ˆãƒ–ãƒªãƒ³ã‚«ãƒ¼ç€ç”¨ãªã©ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
          const isRemark = line.includes('ãƒ–ãƒªãƒ³ã‚«ãƒ¼ç€ç”¨') ||
                          line.includes('ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ­ãƒ¼ãƒ«ç€ç”¨') ||
                          line.includes('ãƒ¡ãƒ³ã‚³ç€ç”¨') ||
                          line.includes('ãƒ‘ã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ç€ç”¨') ||
                          line.includes('ç€ç”¨');
          if (isRemark) {
            console.log('[DEBUG extractResults] ç‰¹è¨˜äº‹é …è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—:', line);
            continue;
          }

          // ç¶™ç¶šè¡Œã¨ã—ã¦çµåˆã™ã¹ãã‹ã©ã†ã‹ã‚’åˆ¤å®š
          const shouldMerge = !isStartOfResult &&
                             !isEndOfSection &&
                             line.length > 0 &&
                             !line.startsWith('ã‚¿ã‚¤ãƒ ') &&
                             !line.startsWith('ãƒãƒ­ãƒ³') &&
                             !line.startsWith('ã‚³ãƒ¼ãƒŠãƒ¼') &&
                             !line.startsWith('æ‰•æˆ»');

          if (shouldMerge) {
            // ç¶™ç¶šè¡Œã‚’çµåˆï¼ˆãŸã ã—ã€æ€§é½¢ãŒ2å›ç›®ã«å‡ºç¾ã—ãŸã‚‰åˆ‡ã‚‹ï¼‰
            const currentSexAgeCount = (currentLine.match(/[ç‰¡ç‰ã‚»]\d+/g) || []).length;
            const lineSexAgeCount = (line.match(/[ç‰¡ç‰ã‚»]\d+/g) || []).length;

            if (currentSexAgeCount > 0 && lineSexAgeCount > 0) {
              // æ€§é½¢ãŒæ—¢ã«currentLineã«ã‚ã‚Šã€æ–°ã—ã„è¡Œã«ã‚‚ã‚ã‚‹å ´åˆã€åˆ¥ã®é¦¬ã®ãƒ‡ãƒ¼ã‚¿
              console.log('[DEBUG extractResults] æ€§é½¢é‡è¤‡æ¤œå‡ºï¼ˆå‰ã®è¡Œã‚’å‡¦ç†ï¼‰');
              processLine(currentLine, results);
              currentLine = '';
              inResultSection = false;
            } else {
              // ç¶™ç¶šè¡Œã‚’çµåˆ
              currentLine += ' ' + line;
              console.log('[DEBUG extractResults] ç¶™ç¶šè¡Œçµåˆ:', line.substring(0, 50));
            }
          }
        }
      }

      // æœ€å¾Œã®è¡Œã‚’å‡¦ç†
      if (currentLine) {
        processLine(currentLine, results);
      }

      console.log('[DEBUG extractResults] æŠ½å‡ºã•ã‚ŒãŸç€é †æ•°:', results.length);

      if (results.length === 0) throw new Error('ç€é †ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return results;
    }

    function processLine(line, results) {
      // ä¸­å¤®ç«¶é¦¬ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
      // ç€é † æ  é¦¬ç•ª é¦¬å æ€§é½¢ è² æ‹…é‡é‡ é¨æ‰‹å ã‚¿ã‚¤ãƒ  ç€å·® ã‚³ãƒ¼ãƒŠãƒ¼é€šé æ¨å®šä¸Šã‚Š é¦¬ä½“é‡ èª¿æ•™å¸«å å˜å‹äººæ°—
      // ä¾‹: 1    10    ã‚±ãƒ–ãƒ©ãƒ³ãƒª    ç‰¡3    57.0    C.ãƒ«ãƒ¡ãƒ¼ãƒ«    1:25.4        â€¢    1 â€¢    1    37.2    500(-2)    åŠ è—¤ å£«æ´¥å…«    1

      const parts = line.split(/[\s\u3000]+/).filter(p => p && p !== 'â€¢');

      console.log('[DEBUG processLine] parts:', parts.slice(0, 20)); // æœ€åˆã®20å€‹ã®ã¿è¡¨ç¤º

      if (parts.length < 8) {
        console.log('[DEBUG processLine] ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      let idx = 0;

      // ç€é †
      const rank = parseInt(parts[idx++], 10);
      if (isNaN(rank)) {
        console.log('[DEBUG processLine] ç€é †ãŒæ•°å­—ã§ãªã„ã€ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      // æ ï¼ˆä¸­å¤®ç«¶é¦¬ã¯ "æ 8æ¡ƒ" å½¢å¼ã€å—é–¢ã¯ "8" å½¢å¼ï¼‰
      let bracket = 0;
      const bracketPart = parts[idx++];
      const wakuMatch = bracketPart.match(/^æ (\d+)[æ¡ƒæ©™é’èµ¤ç·‘é»„é»’ç™½]$/);
      if (wakuMatch) {
        bracket = parseInt(wakuMatch[1], 10);
        console.log('[DEBUG processLine] æ è‰²æ¤œå‡º:', bracketPart, 'â†’', bracket);
      } else {
        bracket = parseInt(bracketPart, 10);
      }

      // é¦¬ç•ª
      const number = parseInt(parts[idx++], 10);

      // é¦¬åï¼ˆã‚«ã‚¿ã‚«ãƒŠã¾ãŸã¯è‹±å­—ã‚’å«ã‚€åå‰ã‚’æ¢ã™ï¼‰
      // æ€§é½¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç‰¡3ã€ã›ã‚“5ãªã©ï¼‰ã‚„è² æ‹…é‡é‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ57.0ãªã©ï¼‰ãŒæ¥ã‚‹ã¾ã§æ¢ã™
      let name = '';
      while (idx < parts.length && idx < 10) { // æœ€å¤§10å€‹ã¾ã§æ¢ã™
        const part = parts[idx];
        // æ€§é½¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç‰¡3ã€ç‰3ã€ã‚»3ã€ã›ã‚“5ãªã©ï¼‰ãŒæ¥ãŸã‚‰é¦¬åçµ‚äº†
        if (/^([ç‰¡ç‰ã‚»]|ã›ã‚“)\d+$/.test(part)) {
          break;
        }
        // è² æ‹…é‡é‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ57.0ãªã©ï¼‰ãŒæ¥ãŸã‚‰é¦¬åçµ‚äº†
        if (/^\d+\.\d+$/.test(part)) {
          break;
        }
        // ã‚«ã‚¿ã‚«ãƒŠã€ã²ã‚‰ãŒãªã€è‹±å­—ã‚’å«ã‚€å ´åˆã¯é¦¬åã®ä¸€éƒ¨
        if (/[ã‚¡-ãƒ´ã-ã‚“a-zA-Z]/.test(part)) {
          name = part;
          idx++;
          break;
        }
        // æ•°å­—ã ã‘ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé¦¬åã§ã¯ãªã„ï¼‰
        if (/^\d+$/.test(part)) {
          idx++;
          continue;
        }
        // ãã®ä»–ã®æ–‡å­—åˆ—ã¯é¦¬åå€™è£œ
        name = part;
        idx++;
        break;
      }

      if (!name) {
        console.log('[DEBUG processLine] é¦¬åãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      // æ€§é½¢ã‚’æŠ½å‡ºï¼ˆç‰¡3ã€ç‰3ã€ã‚»3ã€ã›ã‚“5ãªã©ï¼‰
      let sexAge = '';
      if (idx < parts.length && /^([ç‰¡ç‰ã‚»]|ã›ã‚“)\d+$/.test(parts[idx])) {
        sexAge = parts[idx++];
        console.log('[DEBUG processLine] æ€§é½¢æ¤œå‡º:', sexAge);
      }

      // è² æ‹…é‡é‡ã‚’æŠ½å‡ºï¼ˆ57.0ãªã©ï¼‰
      let weight = '';
      if (idx < parts.length && /^\d+\.\d+$/.test(parts[idx])) {
        weight = parts[idx++];
        console.log('[DEBUG processLine] è² æ‹…é‡é‡æ¤œå‡º:', weight);
      }

      // é¨æ‰‹åï¼ˆæ¬¡ã®é …ç›®ãŒã‚¿ã‚¤ãƒ å½¢å¼ "1:25.4" ã«ãªã‚‹ã¾ã§ã€ã¾ãŸã¯æœ€å¤§3ãƒ‘ãƒ¼ãƒ„ã¾ã§ï¼‰
      let jockey = '';
      let jockeyPartCount = 0;
      const startIdx = idx;
      while (idx < parts.length && jockeyPartCount < 3) {
        // ã‚¿ã‚¤ãƒ å½¢å¼ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        if (/^\d+:\d+\.\d+$/.test(parts[idx])) {
          break;
        }
        // ä¸é©åˆ‡ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆé¦¬ä½“é‡ã‚„èª¿æ•™å¸«ã‚¨ãƒªã‚¢ï¼‰ãŒæ¥ãŸã‚‰æŠœã‘ã‚‹
        if (/^\d+\([+-]?\d+\)$/.test(parts[idx])) {
          break;
        }
        // "ã‚¿ã‚¤ãƒ "ãªã©ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ¥ãŸã‚‰æŠœã‘ã‚‹
        if (parts[idx] === 'ã‚¿ã‚¤ãƒ ' || parts[idx] === 'ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ' || parts[idx] === 'ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½') {
          break;
        }
        jockey += (jockey ? ' ' : '') + parts[idx];
        idx++;
        jockeyPartCount++;
      }

      // ã‚¿ã‚¤ãƒ ï¼ˆ"1:25.4" å½¢å¼ï¼‰
      let time = '';
      if (idx < parts.length && /^\d+:\d+\.\d+$/.test(parts[idx])) {
        time = parts[idx++];
      }

      // ç€å·®ï¼ˆ1ç€ã¯"-"ã€ãã‚Œä»¥å¤–ã¯æ•°å­—+å˜ä½ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      let margin = '-';
      if (idx < parts.length) {
        const part = parts[idx];
        // ç€å·®ã®ãƒ‘ã‚¿ãƒ¼ãƒ³: "ï¼‘", "ï¼’", "ï¼“"ãªã©ã®å…¨è§’æ•°å­—ã€ã¾ãŸã¯ "-"
        // åŠè§’æ•°å­—ã ã‘ã®å ´åˆã¯ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ãªã®ã§å«ã‚ãªã„
        if (!/^\d+$/.test(part) && !/^\d+\.\d+$/.test(part) && !/^\d+\(/.test(part)) {
          margin = parts[idx++];
          // ç€å·®ãŒè¤‡æ•°ãƒ‘ãƒ¼ãƒ„ã®å ´åˆï¼ˆä¾‹: "ï¼‘ 1/2", "ï¼’ 1/4"ï¼‰
          // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å«ã‚€å ´åˆã®ã¿ç€å·®ã¨ã—ã¦æ‰±ã†ï¼ˆåŠè§’æ•°å­—ã ã‘ã¯ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ï¼‰
          if (idx < parts.length && /^[\d/]+$/.test(parts[idx]) && parts[idx].includes('/')) {
            margin += ' ' + parts[idx++];
          }
        }
      }

      // ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸­å¤®ç«¶é¦¬ã¯4å€‹ï¼š1C, 2C, 3C, 4Cï¼‰
      let cornerSkipped = 0;
      while (idx < parts.length && /^\d+$/.test(parts[idx]) && cornerSkipped < 4) {
        idx++;
        cornerSkipped++;
      }

      // æ¨å®šä¸Šã‚Šï¼ˆä¸Š3F: "37.2" ã®ã‚ˆã†ãªå°æ•°ï¼‰
      let lastFurlong = '';
      if (idx < parts.length && /^\d+\.\d+$/.test(parts[idx])) {
        lastFurlong = parts[idx++];
      }

      // é¦¬ä½“é‡ï¼ˆå¢—æ¸›ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ"500(-2)" å½¢å¼ï¼‰
      if (idx < parts.length && /^\d+\([+-]?\d+\)$/.test(parts[idx])) {
        idx++;
      }

      // èª¿æ•™å¸«åï¼ˆæœ€å¾Œã‹ã‚‰2ç•ªç›®ã¾ã§ã€æœ€å¾Œã®1å€‹ã¯å˜å‹äººæ°—ï¼‰
      let trainer = '';
      // parts.length - 1 ãŒæœ€å¾Œã®è¦ç´ ï¼ˆå˜å‹äººæ°—ï¼‰ãªã®ã§ã€ãã‚Œã‚ˆã‚Šå‰ã‚’å…¨ã¦çµåˆ
      const endIdx = parts.length - 1;
      while (idx < endIdx) {
        trainer += (trainer ? ' ' : '') + parts[idx];
        idx++;
      }

      // å˜å‹äººæ°—ï¼ˆæœ€å¾Œã®æ•°å­—ï¼‰
      const popularity = parseInt(parts[idx], 10) || 0;

      console.log('[DEBUG processLine] æŠ½å‡ºçµæœ:', { rank, bracket, number, name, sexAge, weight, jockey, time, margin, lastFurlong, trainer, popularity });

      if (!isNaN(rank) && !isNaN(bracket) && !isNaN(number) && name) {
        results.push({
          rank,
          bracket,
          number,
          name,
          sexAge,
          weight,
          jockey,
          trainer,
          time,
          margin: margin || '-',
          lastFurlong,
          popularity
        });
      }
    }

    function extractPayouts(text) {
      const payouts = {};

      const payoutMatch = text.match(/æ‰•æˆ»é‡‘[\s\S]*$/);
      if (!payoutMatch) return payouts;

      const payoutSection = payoutMatch[0];
      const lines = payoutSection.split('\n').filter(l => l.trim());

      // å˜å‹: 10 210å†† 1ç•ªäººæ°— ã¾ãŸã¯ 1 â†’ 650å†† (3äººæ°—)
      const tanshoMatch = payoutSection.match(/å˜å‹[ï¼š:\s]+(\d+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (tanshoMatch) {
        payouts.tansho = [{
          number: tanshoMatch[1],
          payout: parseInt(tanshoMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(tanshoMatch[3], 10)
        }];
      }

      // è¤‡å‹: 10 120å†† 1ç•ªäººæ°—  9 210å†† 5ç•ªäººæ°—  6 150å†† 3ç•ªäººæ°—
      // ä¸­å¤®ç«¶é¦¬å½¢å¼: 1 â†’ 120å†† (1ç•ªäººæ°—) ã¾ãŸã¯ 1 120å†† 1ç•ªäººæ°—
      const fukushoMatches = [...payoutSection.matchAll(/(\d+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/g)];
      if (fukushoMatches.length > 0) {
        // ã€Œè¤‡å‹ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¾Œã®ãƒãƒƒãƒã®ã¿ã‚’æŠ½å‡º
        const fukushoStartIndex = payoutSection.indexOf('è¤‡å‹');
        const fukushoEndIndex = payoutSection.indexOf('æ ', fukushoStartIndex) !== -1
          ? payoutSection.indexOf('æ ', fukushoStartIndex)
          : payoutSection.indexOf('é¦¬', fukushoStartIndex);
        const fukushoSection = payoutSection.substring(fukushoStartIndex, fukushoEndIndex);

        const fukushoOnlyMatches = [...fukushoSection.matchAll(/(\d+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/g)];
        if (fukushoOnlyMatches.length > 0) {
          payouts.fukusho = fukushoOnlyMatches.map(m => ({
            number: m[1],
            payout: parseInt(m[2].replace(/,/g, ''), 10),
            popularity: parseInt(m[3], 10)
          }));
        }
      }

      // æ é€£: 5-5 1,270å†† 6ç•ªäººæ°— ã¾ãŸã¯ 1-8 â†’ 1,580å†† (6äººæ°—)
      const wakurenMatch = payoutSection.match(/æ é€£[ï¼š:\s]+([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (wakurenMatch) {
        payouts.wakuren = [{
          combination: wakurenMatch[1],
          payout: parseInt(wakurenMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(wakurenMatch[3], 10)
        }];
      }

      // æ å˜: 1-2 â†’ 340å†† (2äººæ°—)
      const wakutanMatch = payoutSection.match(/æ å˜[ï¼š:\s]+([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (wakutanMatch) {
        payouts.wakutan = [{
          combination: wakutanMatch[1],
          payout: parseInt(wakutanMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(wakutanMatch[3], 10)
        }];
      }

      // ãƒ¯ã‚¤ãƒ‰: 9-10 380å†† 3ç•ªäººæ°—  6-10 330å†† 2ç•ªäººæ°—  6-9 740å†† 10ç•ªäººæ°—
      // ä¸­å¤®ç«¶é¦¬å½¢å¼: 1-2 â†’ 380å†† (3ç•ªäººæ°—) ã¾ãŸã¯ 1-2 380å†† 3ç•ªäººæ°—
      const wideMatches = [...payoutSection.matchAll(/([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/g)];
      if (wideMatches.length > 0) {
        // ã€Œãƒ¯ã‚¤ãƒ‰ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¾Œã®ãƒãƒƒãƒã®ã¿ã‚’æŠ½å‡º
        const wideStartIndex = payoutSection.indexOf('ãƒ¯ã‚¤ãƒ‰');
        if (wideStartIndex !== -1) {
          const wideEndIndex = payoutSection.indexOf('é¦¬é€£', wideStartIndex) !== -1
            ? payoutSection.indexOf('é¦¬é€£', wideStartIndex)
            : payoutSection.indexOf('é¦¬å˜', wideStartIndex);
          const wideSection = payoutSection.substring(wideStartIndex, wideEndIndex);

          const wideOnlyMatches = [...wideSection.matchAll(/([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/g)];
          if (wideOnlyMatches.length > 0) {
            payouts.wide = wideOnlyMatches.map(m => ({
              combination: m[1],
              payout: parseInt(m[2].replace(/,/g, ''), 10),
              popularity: parseInt(m[3], 10)
            }));
          }
        }
      }

      // é¦¬é€£: 9-10 1,010å†† 3ç•ªäººæ°— ã¾ãŸã¯ 1-12 â†’ 2,550å†† (9äººæ°—)
      const umarenMatch = payoutSection.match(/é¦¬[é€£è¤‡][ï¼š:\s]+([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (umarenMatch) {
        payouts.umaren = [{
          combination: umarenMatch[1],
          payout: parseInt(umarenMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(umarenMatch[3], 10)
        }];
      }

      // é¦¬å˜: 10-9 1,380å†† 3ç•ªäººæ°— ã¾ãŸã¯ 1-12 â†’ 5,530å†† (18äººæ°—)
      const umatanMatch = payoutSection.match(/é¦¬å˜[ï¼š:\s]+([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (umatanMatch) {
        payouts.umatan = [{
          combination: umatanMatch[1],
          payout: parseInt(umatanMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(umatanMatch[3], 10)
        }];
      }

      // 3é€£è¤‡: 6-9-10 1,730å†† 4ç•ªäººæ°— ã¾ãŸã¯ 1-10-12 â†’ 3,750å†† (12äººæ°—)
      const sanrenpukuMatch = payoutSection.match(/[ä¸‰3]é€£è¤‡[ï¼š:\s]+([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (sanrenpukuMatch) {
        payouts.sanrenpuku = [{
          combination: sanrenpukuMatch[1],
          payout: parseInt(sanrenpukuMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(sanrenpukuMatch[3], 10)
        }];
      }

      // 3é€£å˜: 10-9-6 6,940å†† 12ç•ªäººæ°— ã¾ãŸã¯ 1-12-10 â†’ 23,020å†† (69äººæ°—)
      const sanrentanMatch = payoutSection.match(/[ä¸‰3]é€£å˜[ï¼š:\s]+([\d-]+)\s*(?:â†’)?\s*([\d,]+)å††\s*[\(ï¼ˆ]?(\d+)ç•ª?äººæ°—[\)ï¼‰]?/);
      if (sanrentanMatch) {
        payouts.sanrentan = [{
          combination: sanrentanMatch[1],
          payout: parseInt(sanrentanMatch[2].replace(/,/g, ''), 10),
          popularity: parseInt(sanrentanMatch[3], 10)
        }];
      }

      return payouts;
    }

    function extractTimeData(text) {
      const timeData = {};

      console.log('[DEBUG extractTimeData] é–‹å§‹');
      console.log('[DEBUG extractTimeData] å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆé•·:', text.length);

      // ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ : 12.7 - 11.1 - 12.0 - 12.4 - 12.6 - 12.2 - 12.4
      const furlongMatch = text.match(/ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ \s+([\d.\s-]+)/);
      if (furlongMatch) {
        const furlongStr = furlongMatch[1].trim();
        console.log('[DEBUG extractTimeData] ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ æ–‡å­—åˆ—:', furlongStr);
        const furlongs = furlongStr.split(/\s*-\s*/).map(f => parseFloat(f.trim())).filter(f => !isNaN(f));
        console.log('[DEBUG extractTimeData] ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ é…åˆ—:', furlongs);
        if (furlongs.length > 0) {
          timeData.furlongTimes = furlongs;
        }
      }

      // ä¸Šã‚Š: 4F 49.6 - 3F 37.2
      const last3FMatch = text.match(/3F\s+([\d.]+)/);
      if (last3FMatch) {
        timeData.last3F = parseFloat(last3FMatch[1]);
        console.log('[DEBUG extractTimeData] ä¸ŠãŒã‚Š3FæŠ½å‡ºæˆåŠŸ:', timeData.last3F);
      }

      const last4FMatch = text.match(/4F\s+([\d.]+)/);
      if (last4FMatch) {
        timeData.last4F = parseFloat(last4FMatch[1]);
        console.log('[DEBUG extractTimeData] ä¸ŠãŒã‚Š4FæŠ½å‡ºæˆåŠŸ:', timeData.last4F);
      }

      const result = Object.keys(timeData).length > 0 ? timeData : null;
      console.log('[DEBUG extractTimeData] çµæœ:', result);

      return result;
    }

    function extractCornerData(text) {
      const corners = [];

      // ä¸­å¤®ç«¶é¦¬: ã€Œ3ã‚³ãƒ¼ãƒŠãƒ¼ã€ã€Œ4ã‚³ãƒ¼ãƒŠãƒ¼ã€ã®ã‚ˆã†ãªå½¢å¼
      const cornerSection = text.match(/ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½[\s\S]*?(?=æ‰•æˆ»é‡‘|$)/);
      if (!cornerSection) {
        console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã‚»ã‚¯ã‚·ãƒ§ãƒ³: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return null;
      }

      const cornerSectionText = cornerSection[0];
      console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡ºæˆåŠŸ');

      // ä¸­å¤®ç«¶é¦¬ã®ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †: æ”¹è¡Œã§åˆ†å‰²ã—ã¦å„ã‚³ãƒ¼ãƒŠãƒ¼ã‚’å€‹åˆ¥ã«å‡¦ç†
      // ä¾‹:
      // 1ã‚³ãƒ¼ãƒŠãƒ¼     7,10(5,12,11)(3,4,6)9(1,13)8-2
      // 2ã‚³ãƒ¼ãƒŠãƒ¼     7,10(5,11)12(3,4,6)9(1,13)8-2
      const lines = cornerSectionText.split('\n');

      for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;

        // ã‚³ãƒ¼ãƒŠãƒ¼ç•ªå·ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆå…¨è§’ãƒ»åŠè§’å¯¾å¿œï¼‰
        const match = trimmedLine.match(/([ï¼‘ï¼’ï¼“ï¼”1234])ã‚³ãƒ¼ãƒŠãƒ¼\s+(.*)/);
        if (!match) continue;

        const cornerNumber = match[1].replace(/[ï¼‘]/g, '1').replace(/[ï¼’]/g, '2').replace(/[ï¼“]/g, '3').replace(/[ï¼”]/g, '4');
        const orderStr = match[2].trim();

        console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼ãƒãƒƒãƒ:', cornerNumber, 'ã‚³ãƒ¼ãƒŠãƒ¼');
        console.log('[DEBUG] - orderStr:', orderStr);

        // æ‹¬å¼§ã‚„ãƒã‚¤ãƒ•ãƒ³ã§åˆ†å‰²ã—ã¦é¦¬ç•ªã‚’æŠ½å‡º
        // ä¾‹: (1,*10)(8,11,15)(9,14)3,12(2,5,6)-16,4-7-13 â†’ 1,10,8,11,15,9,14,3,12,2,5,6,16,4,7,13
        const cleanedStr = orderStr.replace(/[*()\[\]]/g, ' ');  // æ‹¬å¼§ã¨ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã‚’ç©ºç™½ã«
        const parts = cleanedStr.split(/[\s\u3000-]+/).filter(p => p);  // ç©ºç™½ã¨ãƒã‚¤ãƒ•ãƒ³ã§åˆ†å‰²
        const order = [];
        for (const part of parts) {
          const nums = part.split(',').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));
          order.push(...nums);
        }

        if (order.length > 0) {
          const cornerName = `${cornerNumber}ã‚³ãƒ¼ãƒŠãƒ¼`;
          corners.push({
            corner: cornerName,
            order,
            orderString: orderStr  // å…ƒã®æ–‡å­—åˆ—ã‚’ä¿å­˜ï¼ˆæ‹¬å¼§ã‚„ãƒã‚¤ãƒ•ãƒ³ã‚’å«ã‚€ï¼‰
          });
          console.log('[DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼æŠ½å‡ºæˆåŠŸ:', cornerName, 'é ­æ•°:', order.length);
        }
      }

      console.log('[DEBUG] æŠ½å‡ºã•ã‚ŒãŸã‚³ãƒ¼ãƒŠãƒ¼æ•°:', corners.length);
      return corners.length > 0 ? corners : null;
    }

    function generateRaceCommentary(race, date, venue) {
      if (!race.results || race.results.length === 0) return '';

      const winner = race.results[0];
      const second = race.results[1];
      const third = race.results[2];
      const fourth = race.results[3];
      const favorite = race.results.find(h => h.popularity === 1);

      // ãƒ‡ãƒãƒƒã‚°ï¼š1ç•ªäººæ°—ã®ç¢ºèª
      console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—:', favorite ? `${favorite.number}ç•ª${favorite.name}` : 'è¦‹ã¤ã‹ã‚‰ãªã„');
      console.log('[COMMENTARY DEBUG] å‹ã¡é¦¬:', winner ? `${winner.number}ç•ª${winner.name}ï¼ˆ${winner.popularity}ç•ªäººæ°—ï¼‰` : 'ãªã—');
      console.log('[COMMENTARY DEBUG] 2ç€é¦¬:', second ? `${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰` : 'ãªã—');
      console.log('[COMMENTARY DEBUG] 3ç€é¦¬:', third ? `${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰` : 'ãªã—');
      if (favorite) {
        const favoriteRank = race.results.findIndex(h => h.number === favorite.number) + 1;
        console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ç€é †:', favoriteRank, 'ç€');
        const isOutOfMoney = favorite.number !== winner.number &&
            (!second || favorite.number !== second.number) &&
            (!third || favorite.number !== third.number);
        console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—é¦¬åˆ¸å¤–:', isOutOfMoney);
      }

      // ãƒ‡ãƒãƒƒã‚°ï¼šã‚³ãƒ¼ãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ç¢ºèª
      console.log('[COMMENTARY DEBUG] race.cornerData:', race.cornerData);
      console.log('[COMMENTARY DEBUG] cornerData length:', race.cornerData ? race.cornerData.length : 0);
      if (race.cornerData && race.cornerData.length > 0) {
        console.log('[COMMENTARY DEBUG] 1ã‚³ãƒ¼ãƒŠãƒ¼å…ˆé ­é¦¬:', race.cornerData[0].order[0]);
      }

      // é€ƒã’é¦¬ã‚’ç‰¹å®šï¼ˆæœ€åˆã®ã‚³ãƒ¼ãƒŠãƒ¼ã§å…ˆé ­ã«ã„ãŸé¦¬ï¼‰
      let pacemaker = null;
      if (race.cornerData && race.cornerData.length > 0) {
        const firstCorner = race.cornerData[0];
        const leadHorseNum = firstCorner.order[0];
        pacemaker = race.results.find(h => h.number === leadHorseNum);
        console.log('[COMMENTARY DEBUG] é€ƒã’é¦¬ç‰¹å®š:', pacemaker ? `${pacemaker.number}ç•ª${pacemaker.name}` : 'ãªã—');
      } else {
        console.log('[COMMENTARY DEBUG] ã‚³ãƒ¼ãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã— - ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼ˆæ¨™æº–ï¼‰ã§ç”Ÿæˆ');
      }

      // å„é¦¬ã®ä½ç½®å–ã‚Šã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ï¼ˆåºç›¤ãƒ»ä¸­ç›¤ãƒ»çµ‚ç›¤ï¼‰
      const getPosition = (horseNum, timing = 'last') => {
        if (!race.cornerData || race.cornerData.length === 0) return null;

        let corner;
        if (timing === 'early') {
          // åºç›¤ï¼šæœ€åˆã®ã‚³ãƒ¼ãƒŠãƒ¼
          corner = race.cornerData[0];
        } else if (timing === 'mid') {
          // ä¸­ç›¤ï¼šä¸­é–“ã®ã‚³ãƒ¼ãƒŠãƒ¼
          const midIndex = Math.floor(race.cornerData.length / 2);
          corner = race.cornerData[midIndex];
        } else {
          // çµ‚ç›¤ï¼šæœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼
          corner = race.cornerData[race.cornerData.length - 1];
        }

        const position = corner.order.indexOf(horseNum) + 1;
        if (position === 1) return { pos: position, label: 'å…ˆé ­' };
        if (position === 2) return { pos: position, label: '2ç•ªæ‰‹' };
        if (position === 3) return { pos: position, label: '3ç•ªæ‰‹' };
        if (position <= 5) return { pos: position, label: `${position}ç•ªæ‰‹` };
        if (position <= 8) return { pos: position, label: 'ä¸­å›£' };
        return { pos: position, label: 'å¾Œæ–¹' };
      };

      // å…¨ã‚³ãƒ¼ãƒŠãƒ¼ã§ã®å¹³å‡ä½ç½®ã¨ä¸€è²«æ€§ã‚’å–å¾—
      const getPositionConsistency = (horseNum) => {
        if (!race.cornerData || race.cornerData.length === 0) return null;

        const positions = [];
        for (const corner of race.cornerData) {
          const pos = corner.order.indexOf(horseNum) + 1;
          if (pos > 0) positions.push(pos);
        }

        if (positions.length === 0) return null;

        const avg = positions.reduce((a, b) => a + b, 0) / positions.length;
        const maxPos = Math.max(...positions);
        const minPos = Math.min(...positions);
        const range = maxPos - minPos;

        return {
          avgPos: avg,
          minPos: minPos,
          maxPos: maxPos,
          range: range,
          isConsistent: range <= 1 // ä½ç½®ã®ã°ã‚‰ã¤ããŒ1ä»¥ä¸‹ãªã‚‰ä¸€è²«
        };
      };

      const winnerPosEarly = getPosition(winner.number, 'early');
      const winnerPosMid = getPosition(winner.number, 'mid');
      const winnerPosLast = getPosition(winner.number, 'last');
      const secondPosEarly = second ? getPosition(second.number, 'early') : null;
      const secondPosMid = second ? getPosition(second.number, 'mid') : null;
      const secondPosLast = second ? getPosition(second.number, 'last') : null;
      const thirdPosLast = third ? getPosition(third.number, 'last') : null;

      let commentary = '';

      // å†’é ­ï¼šæ—¥ä»˜ãƒ»ç«¶é¦¬å ´ãƒ»ãƒ¬ãƒ¼ã‚¹ç•ªå·ãƒ»æ¡ä»¶ï¼ˆSEOå¯¾ç­–ï¼‰
      if (date && venue) {
        const [year, month, day] = date.split('-');
        const formattedDate = `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
        const surfaceLabel = race.surface === 'ãƒ€ãƒ¼ãƒˆ' ? 'ãƒ€' : 'èŠ';

        // ãƒ¬ãƒ¼ã‚¹åã®æ¤œè¨¼ï¼ˆå³æ ¼ï¼‰
        let displayRaceName = race.raceName || '';

        // ä¸é©åˆ‡ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚€å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«ã™ã‚‹
        const invalidPatterns = [
          'è³é‡‘',
          'ç•ªçµ„ãƒã‚¤ãƒ³ãƒˆ',
          'ã‚µãƒ©ãƒ–ãƒ¬ãƒƒãƒ‰ç³»',
          'æ™®é€šç«¶èµ°',
          'ã‚¢ãƒ©ãƒ–ç³»',
          'ç™ºèµ°æ™‚åˆ»',
          'å¤©å€™:',
          'é¦¬å ´:'
        ];

        for (const pattern of invalidPatterns) {
          if (displayRaceName.includes(pattern)) {
            console.log(`[WARNING] ãƒ¬ãƒ¼ã‚¹åã«ä¸é©åˆ‡ãªãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º: "${pattern}" â†’ ç©ºæ–‡å­—åˆ—ã«ç½®æ›`);
            displayRaceName = '';
            break;
          }
        }

        // æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆ2-40æ–‡å­—ãŒå¦¥å½“ï¼‰
        if (displayRaceName.length < 2 || displayRaceName.length > 40) {
          console.log(`[WARNING] ãƒ¬ãƒ¼ã‚¹åã®æ–‡å­—æ•°ãŒä¸é©åˆ‡: ${displayRaceName.length}æ–‡å­— â†’ ç©ºæ–‡å­—åˆ—ã«ç½®æ›`);
          displayRaceName = '';
        }

        // æ•°å­—ãŒå¤šã™ãã‚‹ï¼ˆ5å€‹ä»¥ä¸Šï¼‰å ´åˆã¯ä¸é©åˆ‡
        const digitCount = (displayRaceName.match(/\d/g) || []).length;
        if (digitCount > 5) {
          console.log(`[WARNING] ãƒ¬ãƒ¼ã‚¹åã«æ•°å­—ãŒå¤šã™ãã‚‹: ${digitCount}å€‹ â†’ ç©ºæ–‡å­—åˆ—ã«ç½®æ›`);
          displayRaceName = '';
        }

        // ãƒ¬ãƒ¼ã‚¹åãŒç©ºã®å ´åˆã¯çœç•¥
        const raceNamePart = displayRaceName ? `${displayRaceName} ` : '';
        commentary += `${formattedDate}${venue}ç«¶é¦¬${race.raceNumber}ãƒ¬ãƒ¼ã‚¹ï¼ˆ${raceNamePart}${surfaceLabel}${race.distance}mãƒ»${race.horses}é ­ç«‹ï¼‰ã¯ã€`;
      }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³1: é€ƒã’åˆ‡ã‚Šå‹ã¡
      if (pacemaker && pacemaker.number === winner.number) {
        console.log('[COMMENTARY DEBUG] ãƒ‘ã‚¿ãƒ¼ãƒ³1: é€ƒã’åˆ‡ã‚Šå‹ã¡');
        // å‹ã¡é¦¬ã®é€ƒã’
        commentary += `${winner.number}ç•ª${winner.name}ï¼ˆ`;
        if (winner.popularity === 1) {
          commentary += `1ç•ªäººæ°—`;
        } else {
          commentary += `${winner.popularity}ç•ªäººæ°—`;
        }
        commentary += `ï¼‰ãŒ`;
        commentary += `ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰ãƒãƒŠã‚’åˆ‡ã£ã¦ä¸»å°æ¨©ã‚’æ¡ã‚‹å±•é–‹ã€‚`;

        // ç›´ç·šã§ã®ç²˜ã‚Š
        commentary += `ç›´ç·šã§ã‚‚ç²˜ã‚Šå¼·ãè„šã‚’ä½¿ã„ã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã€`;

        // é¨æ‰‹ãƒ»å©èˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆç°¡æ½”ã«ï¼‰
        commentary += `éä¸Šã¯${winner.jockey}é¨æ‰‹ã¨${winner.trainer}å©èˆã®ã‚³ãƒ³ãƒ“ã§ã—ãŸã€‚`;

        // 2ç€é¦¬
        if (second && secondPosLast) {
          commentary += `2ç€ã«ã¯${secondPosLast.label}ã‹ã‚‰è¿½ã„è¾¼ã‚“ã ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
        } else if (second) {
          commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
        }

        // 3ç€é¦¬
        if (third) {
          commentary += `3ç€ã«ã¯${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
        }

        // ä¸‰é€£å˜é…å½“æƒ…å ±ã‚’è¿½åŠ ï¼ˆSEOå¯¾ç­–ï¼‰
        if (race.payouts?.sanrentan && race.payouts.sanrentan.length > 0) {
          const sanrentanPayout = race.payouts.sanrentan[0].payout;
          const sanrentanPop = race.payouts.sanrentan[0].popularity;
          const sanrentanCombo = race.payouts.sanrentan[0].combination;
          commentary += `ä¸‰é€£å˜${sanrentanCombo}ã¯${sanrentanPayout.toLocaleString()}å††ï¼ˆ${sanrentanPop}ç•ªäººæ°—ï¼‰ã§æ±ºç€ã—ãŸã€‚`;
        }

        // 1ç•ªäººæ°—ãŒé¦¬åˆ¸å¤–ã®å ´åˆã€æ•—é€€æƒ…å ±ã‚’è¿½åŠ 
        console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—æ•—é€€ãƒã‚§ãƒƒã‚¯é–‹å§‹');
        if (favorite && favorite.number !== winner.number &&
            (!second || favorite.number !== second.number) &&
            (!third || favorite.number !== third.number)) {
          const favoriteRank = race.results.findIndex(h => h.number === favorite.number) + 1;
          console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ã¯', favoriteRank, 'ç€ â†’ æ•—é€€æƒ…å ±è¿½åŠ ');
          if (favoriteRank === 4) {
            commentary += `1ç•ªäººæ°—ã®${favorite.number}ç•ª${favorite.name}ã¯4ç€ã«æ•—ã‚ŒãŸã€‚`;
          } else if (favoriteRank >= 5) {
            commentary += `1ç•ªäººæ°—ã®${favorite.number}ç•ª${favorite.name}ã¯${favoriteRank}ç€ã«æ•—ã‚ŒãŸã€‚`;
          }
        } else {
          console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ã¯3ç€ä»¥å†… â†’ æ•—é€€æƒ…å ±ãªã—');
        }
      }
      // ãƒ‘ã‚¿ãƒ¼ãƒ³2: é€ƒã’é¦¬ãŒã„ã¦ã€å·®ã—åˆ‡ã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³
      else if (pacemaker && pacemaker.number !== winner.number) {
        console.log('[COMMENTARY DEBUG] ãƒ‘ã‚¿ãƒ¼ãƒ³2: å·®ã—åˆ‡ã‚Šï¼ˆé€ƒã’é¦¬:', pacemaker.number, 'ç•ª, å‹ã¡é¦¬:', winner.number, 'ç•ªï¼‰');
        // é€ƒã’é¦¬ã®å‹•ãï¼ˆäººæ°—ã‚‚è¡¨ç¤ºï¼‰
        commentary += `${pacemaker.number}ç•ª${pacemaker.name}ï¼ˆ${pacemaker.popularity}ç•ªäººæ°—ï¼‰ãŒãƒãƒŠã‚’åˆ‡ã‚‹å±•é–‹ã®ä¸­ã€`;

        // å‹ã¡é¦¬ã®è¿½ã„è¾¼ã¿
        commentary += `${winner.number}ç•ª${winner.name}ï¼ˆ`;
        if (winner.popularity === 1) {
          commentary += `1ç•ªäººæ°—`;
        } else {
          commentary += `${winner.popularity}ç•ªäººæ°—`;
        }
        commentary += `ï¼‰ãŒ`;

        // å…¨ã‚³ãƒ¼ãƒŠãƒ¼ã§ã®ä½ç½®å–ã‚Šã‚’åˆ†æ
        const winnerConsistency = getPositionConsistency(winner.number);
        if (winnerConsistency) {
          const avgPos = winnerConsistency.avgPos;
          const isConsistent = winnerConsistency.isConsistent;
          const earlyPos = winnerPosEarly ? winnerPosEarly.pos : null;
          const lastPos = winnerPosLast ? winnerPosLast.pos : null;

          // åºç›¤ã¨çµ‚ç›¤ã§ä½ç½®ãŒå¤‰åŒ–ã—ãŸã‹åˆ¤å®š
          if (earlyPos && lastPos && earlyPos >= 4 && lastPos <= 2) {
            // åºç›¤4ç•ªæ‰‹ä»¥é™ â†’ çµ‚ç›¤2ç•ªæ‰‹ä»¥å†… = å…ˆè¡Œ
            commentary += `å…ˆè¡Œã—ã¦è„šã‚’æºœã‚`;
          } else if (isConsistent && avgPos <= 2.5) {
            // ä¸€è²«ã—ã¦2ç•ªæ‰‹ä»¥å†…
            if (Math.round(avgPos) === 2) {
              commentary += `2ç•ªæ‰‹ã§æŠ˜ã‚Šåˆã„`;
            } else {
              commentary += `é€ƒã’é¦¬ã®ç›´å¾Œã§æŠ˜ã‚Šåˆã„`;
            }
          } else if (avgPos >= 2 && avgPos <= 5) {
            // 2ç•ªæ‰‹ã€œ5ç•ªæ‰‹ï¼ˆå¤‰å‹•ã‚ã‚Šï¼‰
            commentary += `å¥½ä½ã§è„šã‚’æºœã‚`;
          } else if (avgPos > 5 && avgPos <= 8) {
            // ä¸­å›£
            commentary += `ä¸­å›£ã§è„šã‚’æºœã‚`;
          } else {
            // å¾Œæ–¹
            commentary += `å¾Œæ–¹ã§è¿½èµ°å¾…æ©Ÿã—`;
          }
        } else if (winnerPosLast) {
          // ã‚³ãƒ¼ãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼
          if (winnerPosLast.pos >= 2 && winnerPosLast.pos <= 5) {
            commentary += `å¥½ä½ã§è„šã‚’æºœã‚`;
          } else {
            commentary += `${winnerPosLast.label}ã‚’è¿½èµ°ã—`;
          }
        }

        // æœ«è„šã¨æ±ºç€æ–¹æ³•ï¼ˆ4è§’ä½ç½®ã§åˆ¤æ–­ï¼‰
        // 4è§’ä½ç½®ã§é©åˆ‡ãªå‹•è©ã‚’é¸æŠ
        if (winnerPosLast && winnerPosLast.pos <= 2) {
          // 4è§’1ã€œ2ä½ï¼šæŠœã‘å‡ºã—
          commentary += `ç›´ç·šã§æŠœã‘å‡ºã—ã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã¨ãªã£ãŸ`;
        } else if (winnerPosLast && winnerPosLast.pos <= 5) {
          // 4è§’3ã€œ5ä½ï¼šå·®ã—åˆ‡ã‚Šï¼ˆå‹•ä½œã¯æœ€å¤§2ã¤ï¼‰
          commentary += `ç›´ç·šã§ã¯`;
          if (winner.lastFurlong && parseFloat(winner.lastFurlong) < 39.5) {
            // ä¸ŠãŒã‚Š39.5ç§’æœªæº€ï¼šä¸ŠãŒã‚Šã‚’ãƒãƒ¼ã‚¯
            commentary += `ä¸ŠãŒã‚Š${winner.lastFurlong}ç§’ã‚’ãƒãƒ¼ã‚¯ã—ã¦`;
          } else if (winner.lastFurlong) {
            // ä¸ŠãŒã‚Š39.5ç§’ä»¥ä¸Šï¼šç²˜ã‚Šå¼·ã
            commentary += `ã—ã¶ã¨ã`;
          }
          commentary += `å·®ã—åˆ‡ã‚Šã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã¨ãªã£ãŸ`;
        } else {
          // 4è§’6ä½ä»¥ä¸‹ï¼šè¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Šï¼ˆå‹•ä½œã¯æœ€å¤§2ã¤ï¼‰
          commentary += `ç›´ç·šã§ã¯`;
          if (winner.lastFurlong && parseFloat(winner.lastFurlong) < 39.5) {
            // ä¸ŠãŒã‚Š39.5ç§’æœªæº€ï¼šä¸ŠãŒã‚Šã‚’ãƒãƒ¼ã‚¯ï¼ˆã€Œè¿½ã„è¾¼ã‚“ã§ã€ã¯çœç•¥ã—ã¦2é€£é–ã«æŠ‘ãˆã‚‹ï¼‰
            commentary += `ä¸ŠãŒã‚Š${winner.lastFurlong}ç§’ã‚’ãƒãƒ¼ã‚¯ã—ã¦å·®ã—åˆ‡ã‚Š`;
          } else if (winner.lastFurlong) {
            // ä¸ŠãŒã‚Šã‚ã‚‹ãŒé…ã„ï¼šè¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š
            commentary += `è¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š`;
          } else {
            // ä¸ŠãŒã‚Šãƒ‡ãƒ¼ã‚¿ãªã—ï¼šè¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š
            commentary += `è¿½ã„è¾¼ã‚“ã§å·®ã—åˆ‡ã‚Š`;
          }
          commentary += `ã€å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€ã¨ãªã£ãŸ`;
        }

        // é¨æ‰‹ãƒ»å©èˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆç°¡æ½”ã«ã€å¿…ãšå¥ç‚¹ã§é–‰ã˜ã‚‹ï¼‰
        commentary += `ã€‚éä¸Šã¯${winner.jockey}é¨æ‰‹ã¨${winner.trainer}å©èˆã®ã‚³ãƒ³ãƒ“ã€‚`;

        // 2ç€ãƒ»3ç€
        if (second && third) {
          // 2ç€é¦¬ã®è¡¨ç¾ï¼šé€ƒã’é¦¬ã‹ã©ã†ã‹ã§å¤‰æ›´
          if (pacemaker && second.number === pacemaker.number) {
            // é€ƒã’é¦¬ãŒ2ç€ã«ç²˜ã£ãŸå ´åˆ
            commentary += `2ç€ã«ã¯ç²˜ã‚Šè¾¼ã‚“ã ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          } else if (secondPosLast && secondPosLast.pos === 1) {
            // ãã®ä»–ã®å…ˆè¡Œé¦¬ãŒ2ç€
            commentary += `2ç€ã«ã¯å…ˆè¡Œã—ãŸ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          } else if (secondPosLast) {
            // ãã®ä»–ï¼ˆä½ç½®å–ã‚Šã‚ã‚Šï¼‰
            commentary += `2ç€ã«ã¯${secondPosLast.label}ã‹ã‚‰ä¼¸ã³ãŸ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          } else {
            // ä½ç½®å–ã‚Šãªã—
            commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€`;
          }

          // 3ç€é¦¬ã®è¡¨ç¾ï¼šé€ƒã’é¦¬ã‹ã©ã†ã‹ã§å¤‰æ›´
          if (pacemaker && third.number === pacemaker.number) {
            commentary += `3ç€ã«ã¯é€ƒã’ãŸ${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
          } else {
            commentary += `3ç€ã«ã¯${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
          }
        } else if (second) {
          if (pacemaker && second.number === pacemaker.number) {
            commentary += `2ç€ã«ã¯ç²˜ã‚Šè¾¼ã‚“ã ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
          } else if (secondPosLast && secondPosLast.pos === 1) {
            commentary += `2ç€ã«ã¯å…ˆè¡Œã—ãŸ${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
          } else {
            commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
          }
        }

        // ä¸‰é€£å˜é…å½“æƒ…å ±ã‚’è¿½åŠ ï¼ˆSEOå¯¾ç­–ï¼‰
        if (race.payouts?.sanrentan && race.payouts.sanrentan.length > 0) {
          const sanrentanPayout = race.payouts.sanrentan[0].payout;
          const sanrentanPop = race.payouts.sanrentan[0].popularity;
          const sanrentanCombo = race.payouts.sanrentan[0].combination;
          commentary += `ä¸‰é€£å˜${sanrentanCombo}ã¯${sanrentanPayout.toLocaleString()}å††ï¼ˆ${sanrentanPop}ç•ªäººæ°—ï¼‰ã§æ±ºç€ã—ãŸã€‚`;
        }

        // 1ç•ªäººæ°—ãŒé¦¬åˆ¸å¤–ã®å ´åˆã€æ•—é€€æƒ…å ±ã‚’è¿½åŠ 
        console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—æ•—é€€ãƒã‚§ãƒƒã‚¯é–‹å§‹');
        if (favorite && favorite.number !== winner.number &&
            (!second || favorite.number !== second.number) &&
            (!third || favorite.number !== third.number)) {
          const favoriteRank = race.results.findIndex(h => h.number === favorite.number) + 1;
          console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ã¯', favoriteRank, 'ç€ â†’ æ•—é€€æƒ…å ±è¿½åŠ ');
          if (favoriteRank === 4) {
            commentary += `1ç•ªäººæ°—ã®${favorite.number}ç•ª${favorite.name}ã¯4ç€ã«æ•—ã‚ŒãŸã€‚`;
          } else if (favoriteRank >= 5) {
            commentary += `1ç•ªäººæ°—ã®${favorite.number}ç•ª${favorite.name}ã¯${favoriteRank}ç€ã«æ•—ã‚ŒãŸã€‚`;
          }
        } else {
          console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ã¯3ç€ä»¥å†… â†’ æ•—é€€æƒ…å ±ãªã—');
        }
      }
      // ãƒ‘ã‚¿ãƒ¼ãƒ³3: é€ƒã’é¦¬æƒ…å ±ãªã—
      else {
        console.log('[COMMENTARY DEBUG] ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ¨™æº–ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰');
        // å‹ã¡é¦¬
        commentary += `${winner.number}ç•ª${winner.name}ï¼ˆ`;
        if (winner.popularity === 1) {
          commentary += `1ç•ªäººæ°—`;
        } else {
          commentary += `${winner.popularity}ç•ªäººæ°—`;
        }
        commentary += `ï¼‰ãŒ`;

        if (winnerPosLast) {
          commentary += `${winnerPosLast.label}ã‹ã‚‰æŠœã‘å‡ºã—ã€`;
        }

        if (winner.lastFurlong) {
          commentary += `ä¸ŠãŒã‚Š${winner.lastFurlong}ç§’ã®æœ«è„šã§`;
        }
        commentary += `å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§1ç€`;

        // é¨æ‰‹ãƒ»å©èˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆç°¡æ½”ã«ã€å¿…ãšå¥ç‚¹ã§é–‰ã˜ã‚‹ï¼‰
        commentary += `ã€‚éä¸Šã¯${winner.jockey}é¨æ‰‹ã¨${winner.trainer}å©èˆã®ã‚³ãƒ³ãƒ“ã€‚`;

        if (second && third) {
          commentary += `2ç€ã«${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ã€3ç€ã«${third.number}ç•ª${third.name}ï¼ˆ${third.popularity}ç•ªäººæ°—ï¼‰ãŒå…¥ç·šã€‚`;
        } else if (second) {
          commentary += `2ç€ã«ã¯${second.number}ç•ª${second.name}ï¼ˆ${second.popularity}ç•ªäººæ°—ï¼‰ãŒç¶šã„ãŸã€‚`;
        }

        // ä¸‰é€£å˜é…å½“æƒ…å ±ã‚’è¿½åŠ ï¼ˆSEOå¯¾ç­–ï¼‰
        if (race.payouts?.sanrentan && race.payouts.sanrentan.length > 0) {
          const sanrentanPayout = race.payouts.sanrentan[0].payout;
          const sanrentanPop = race.payouts.sanrentan[0].popularity;
          const sanrentanCombo = race.payouts.sanrentan[0].combination;
          commentary += `ä¸‰é€£å˜${sanrentanCombo}ã¯${sanrentanPayout.toLocaleString()}å††ï¼ˆ${sanrentanPop}ç•ªäººæ°—ï¼‰ã§æ±ºç€ã—ãŸã€‚`;
        }

        // 1ç•ªäººæ°—ãŒé¦¬åˆ¸å¤–ã®å ´åˆã€æ•—é€€æƒ…å ±ã‚’è¿½åŠ 
        console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—æ•—é€€ãƒã‚§ãƒƒã‚¯é–‹å§‹');
        if (favorite && favorite.number !== winner.number &&
            (!second || favorite.number !== second.number) &&
            (!third || favorite.number !== third.number)) {
          const favoriteRank = race.results.findIndex(h => h.number === favorite.number) + 1;
          console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ã¯', favoriteRank, 'ç€ â†’ æ•—é€€æƒ…å ±è¿½åŠ ');
          if (favoriteRank === 4) {
            commentary += `1ç•ªäººæ°—ã®${favorite.number}ç•ª${favorite.name}ã¯4ç€ã«æ•—ã‚ŒãŸã€‚`;
          } else if (favoriteRank >= 5) {
            commentary += `1ç•ªäººæ°—ã®${favorite.number}ç•ª${favorite.name}ã¯${favoriteRank}ç€ã«æ•—ã‚ŒãŸã€‚`;
          }
        } else {
          console.log('[COMMENTARY DEBUG] 1ç•ªäººæ°—ã¯3ç€ä»¥å†… â†’ æ•—é€€æƒ…å ±ãªã—');
        }
      }

      // é«˜é…å½“ã®å ´åˆã¯é¦¬å˜ã‚‚è¿½åŠ 
      if (race.payouts?.umatan && race.payouts.umatan.length > 0) {
        const umatanPayout = race.payouts.umatan[0].payout;
        if (umatanPayout >= 10000) {
          commentary += `é¦¬å˜ã¯${umatanPayout.toLocaleString()}å††ã®é«˜é…å½“ã¨ãªã£ãŸã€‚`;
        }
      }

      // 280æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯ãƒˆãƒªãƒŸãƒ³ã‚°ï¼ˆæœ€å¾Œã®å¥ç‚¹ã§åˆ‡ã‚‹ï¼‰
      // 1ç•ªäººæ°—æ•—é€€æƒ…å ±ã‚’å«ã‚ã‚‹ãŸã‚ã€é–¾å€¤ã‚’280æ–‡å­—ã«æ‹¡å¤§
      if (commentary.length > 280) {
        console.log('[COMMENTARY DEBUG] æ–‡å­—æ•°ã‚ªãƒ¼ãƒãƒ¼:', commentary.length, 'æ–‡å­— â†’ ãƒˆãƒªãƒŸãƒ³ã‚°å®Ÿè¡Œ');
        const trimmed = commentary.substring(0, 270);
        const lastPeriod = trimmed.lastIndexOf('ã€‚');
        if (lastPeriod > 230) {
          commentary = trimmed.substring(0, lastPeriod + 1);
        }
      }

      console.log('[COMMENTARY DEBUG] æœ€çµ‚æ–‡å­—æ•°:', commentary.length, 'æ–‡å­—');
      console.log('[COMMENTARY DEBUG] ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆ:', commentary);
      return commentary;
    }

    async function fetchPredictionData(date) {
      try {
        const [year, month] = date.split('-');
        const predUrl = `https://raw.githubusercontent.com/apol0510/keiba-data-shared/main/central/predictions/${year}/${month}/${date}.json`;
        const response = await fetch(predUrl);
        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        return null;
      }
    }

    function calculatePoints(horses) {
      if (!horses) return 10;
      if (horses <= 6) return 8;
      if (horses <= 9) return 9;
      if (horses <= 12) return 10;
      if (horses <= 14) return 11;
      if (horses <= 16) return 12;
      if (horses <= 18) return 13;
      return 13;
    }

    function checkHit(prediction, result) {
      const debug = {
        hasPrediction: !!prediction,
        hasResult: !!result,
        predictionMain: prediction?.bettingLines?.umatan?.main || [],
        predictionSub: prediction?.bettingLines?.umatan?.sub || [],
        resultCombo: result?.payouts?.umatan?.[0]?.combination || null,
        resultPayout: result?.payouts?.umatan?.[0]?.payout || 0
      };

      if (!prediction || !result) {
        return { hit: false, hitType: null, payout: 0, debug };
      }

      const umatanCombo = result.payouts?.umatan?.[0]?.combination;
      if (!umatanCombo) {
        return { hit: false, hitType: null, payout: 0, debug };
      }

      if (prediction.bettingLines?.umatan?.main?.includes(umatanCombo)) {
        return {
          hit: true,
          hitType: 'main',
          payout: result.payouts.umatan[0].payout || 0,
          debug
        };
      }

      if (prediction.bettingLines?.umatan?.sub?.includes(umatanCombo)) {
        return {
          hit: true,
          hitType: 'sub',
          payout: result.payouts.umatan[0].payout || 0,
          debug
        };
      }

      return { hit: false, hitType: null, payout: 0, debug };
    }

    function generateArchiveResults(parsedData, predictionData) {
      const [year, month, day] = parsedData.date.split('-');

      let totalRaces = 0;
      let hitRaces = 0;
      let totalPayout = 0;
      let totalPoints = 0;
      const races = [];

      parsedData.races.forEach(race => {
        totalRaces++;

        const prediction = predictionData?.races?.find(p => p.raceNumber === race.raceNumber);

        const betPoints = calculatePoints(race.horses);
        totalPoints += betPoints;

        const hitResult = checkHit(prediction, race);

        if (hitResult.hit) {
          hitRaces++;
          totalPayout += hitResult.payout;
        }

        races.push({
          raceNumber: `${race.raceNumber}R`,
          raceName: race.raceName || '-',
          betType: 'é¦¬å˜',
          betPoints: betPoints,
          hit: hitResult.hit,
          hitType: hitResult.hitType,
          payout: hitResult.payout,
          debug: hitResult.debug
        });
      });

      const purchaseAmount = totalPoints * 100;
      const recoveryRate = purchaseAmount > 0 ? Math.round((totalPayout / purchaseAmount) * 100) : 0;
      const perfectHit = totalRaces > 0 && hitRaces === totalRaces;

      return {
        [year]: {
          [month]: {
            [day]: {
              venue: parsedData.venue,
              totalRaces: totalRaces,
              hitRaces: hitRaces,
              perfectHit: perfectHit,
              totalPayout: totalPayout,
              recoveryRate: recoveryRate,
              races: races
            }
          }
        }
      };
    }
  </script>
</BaseLayout>
