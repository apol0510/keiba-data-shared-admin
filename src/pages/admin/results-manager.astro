---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

let result = null;
let errorMessage = null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const copiedText = formData.get('copiedText');

    if (!copiedText) {
      throw new Error('ã‚³ãƒ”ãƒšãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
    }

    // ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ç›´æ¥å®Ÿè£…ï¼ˆparse-nankan-results.jsã‹ã‚‰ç§»æ¤ï¼‰
    const parsedData = parseNankanResults(copiedText);

    // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—
    const predictionData = await fetchPredictionData(parsedData.date);

    // archiveResultsç”Ÿæˆï¼ˆçš„ä¸­åˆ¤å®šå«ã‚€ï¼‰
    const archiveResults = generateArchiveResults(parsedData, predictionData);

    result = {
      parsedData,
      json: JSON.stringify(parsedData, null, 2),
      predictionData,
      archiveResults,
      archiveJson: JSON.stringify(archiveResults, null, 2)
    };

  } catch (error) {
    errorMessage = error.message;
  }
}

// ãƒ‘ãƒ¼ã‚µãƒ¼é–¢æ•°ï¼ˆparse-nankan-results.jsã‹ã‚‰ç§»æ¤ï¼‰
function parseNankanResults(text) {
  if (!text || typeof text !== 'string') {
    throw new Error('ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™');
  }

  // å…¨ä½“ã‹ã‚‰æ—¥ä»˜ã¨ä¼šå ´ã‚’æŠ½å‡º
  const globalInfo = extractGlobalInfo(text);

  // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ¬ãƒ¼ã‚¹å˜ä½ã«åˆ†å‰²
  const raceTexts = splitRaceTexts(text);

  // å„ãƒ¬ãƒ¼ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
  const races = raceTexts.map(raceText => {
    const raceInfo = extractRaceInfo(raceText, globalInfo);
    const results = extractResults(raceText);
    const payouts = extractPayouts(raceText);
    const timeData = extractTimeData(raceText);
    const cornerData = extractCornerData(raceText);

    // ãƒ¬ãƒ¼ã‚¹è§£èª¬ã‚’è‡ªå‹•ç”Ÿæˆ
    const commentary = generateRaceCommentary({
      results,
      payouts,
      timeData,
      cornerData
    });

    return {
      raceNumber: raceInfo.raceNumber,
      raceName: raceInfo.raceName,
      distance: raceInfo.distance,
      surface: raceInfo.surface,
      track: raceInfo.track,
      horses: raceInfo.horses,
      startTime: raceInfo.startTime,
      results,
      payouts,
      timeData,
      cornerData,
      commentary,
      enteredAt: new Date().toISOString(),
      enteredBy: 'staff-ui'
    };
  });

  return {
    date: globalInfo.date,
    venue: globalInfo.venue,
    venueCode: globalInfo.venueCode,
    races: races,
    dataVersion: '1.0'
  };
}

// å…¨ä½“æƒ…å ±ï¼ˆæ—¥ä»˜ãƒ»ä¼šå ´ï¼‰ã‚’æŠ½å‡º
function extractGlobalInfo(text) {
  const dateMatch = text.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if (!dateMatch) throw new Error('æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

  const year = dateMatch[1];
  const month = dateMatch[2].padStart(2, '0');
  const day = dateMatch[3].padStart(2, '0');
  const date = `${year}-${month}-${day}`;

  const venueMatch = text.match(/(èˆ¹æ©‹|å¤§äº•|å·å´|æµ¦å’Œ)ç«¶é¦¬/);
  if (!venueMatch) throw new Error('ç«¶é¦¬å ´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

  const venue = venueMatch[1];
  const venueCodeMap = { 'èˆ¹æ©‹': 'FU', 'å¤§äº•': 'OI', 'å·å´': 'KA', 'æµ¦å’Œ': 'UR' };
  const venueCode = venueCodeMap[venue];

  return { date, venue, venueCode };
}

// ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ¬ãƒ¼ã‚¹å˜ä½ã«åˆ†å‰²
function splitRaceTexts(text) {
  // ã€Œç¬¬NRã€ã¾ãŸã¯ã€Œç™ºèµ°æ™‚åˆ»ã€ã§åˆ†å‰²
  // ä¾‹: "ç¬¬1R", "ç¬¬2R", "ç¬¬11R"
  const lines = text.split('\n');
  const raceTexts = [];
  let currentRaceLines = [];
  let foundFirstRace = false;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // ã€Œç¬¬NRã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆç¬¬1Rã€ç¬¬2Rã€...ç¬¬12Rï¼‰
    // ã¾ãŸã¯ã€Œç™ºèµ°æ™‚åˆ»ã€ã‚’å«ã‚€è¡Œã®å‰å¾Œã‚’æ¤œå‡º
    const isRaceStart = line.match(/ç¬¬(\d+)R/) ||
                       (line.match(/ç™ºèµ°æ™‚åˆ»/) && i > 0 && lines[i-1].match(/ç¬¬(\d+)R/));

    if (isRaceStart && foundFirstRace && currentRaceLines.length > 0) {
      // æ–°ã—ã„ãƒ¬ãƒ¼ã‚¹ã®é–‹å§‹ = å‰ã®ãƒ¬ãƒ¼ã‚¹ã‚’ä¿å­˜
      raceTexts.push(currentRaceLines.join('\n'));
      currentRaceLines = [line];
    } else {
      if (isRaceStart) {
        foundFirstRace = true;
      }
      currentRaceLines.push(line);
    }
  }

  // æœ€å¾Œã®ãƒ¬ãƒ¼ã‚¹ã‚’è¿½åŠ 
  if (currentRaceLines.length > 0) {
    raceTexts.push(currentRaceLines.join('\n'));
  }

  // æœ‰åŠ¹ãªãƒ¬ãƒ¼ã‚¹ã®ã¿è¿”ã™ï¼ˆæœ€ä½é™ã®æƒ…å ±ãŒã‚ã‚‹ã‚‚ã®ï¼‰
  return raceTexts.filter(raceText =>
    raceText.match(/ç¬¬\d+R/) && raceText.match(/ç™ºèµ°æ™‚åˆ»/)
  );
}

function extractRaceInfo(text, globalInfo) {
  // ãƒ¬ãƒ¼ã‚¹ç•ªå·: ç¬¬1Rã€ç¬¬2Rã€ç¬¬11Rãªã©
  const raceNumberMatch = text.match(/ç¬¬(\d+)R/);
  const raceNumber = raceNumberMatch ? parseInt(raceNumberMatch[1], 10) : 1;

  // ãƒ¬ãƒ¼ã‚¹å: ã‚¯ãƒ©ã‚¹è¡¨è¨˜ï¼ˆï¼¡ï¼’ï¼¢ï¼‘ãªã©ï¼‰ã‚’å«ã‚€è¡Œå…¨ä½“ã‚’å–å¾—
  // ä¾‹: "é¯›ãƒæµ¦ç‰¹åˆ¥ ï¼¡ï¼’ï¼¢ï¼‘(ä¸€)" â†’ "é¯›ãƒæµ¦ç‰¹åˆ¥ ï¼¡ï¼’ï¼¢ï¼‘(ä¸€)"
  let raceName = '';
  const lines = text.split('\n');
  for (let line of lines) {
    const trimmedLine = line.trim();
    // ã‚¯ãƒ©ã‚¹è¡¨è¨˜ï¼ˆï¼¡ã€ï¼¢ã€ï¼£ + æ•°å­—ï¼‰ã‚’å«ã‚€è¡Œã‚’æ¢ã™
    if (trimmedLine.match(/[ï¼¡ï¼¢ï¼£][ï¼‘ï¼’ï¼“ï¼]/)) {
      raceName = trimmedLine;
      break;
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã€Œç‰¹åˆ¥ã€ã€Œè³ã€ã€Œæ¯ã€ã‚’å«ã‚€è¡Œ
  if (!raceName) {
    for (let line of lines) {
      const trimmedLine = line.trim();
      if (trimmedLine.match(/ç‰¹åˆ¥|è³|æ¯/)) {
        raceName = trimmedLine;
        break;
      }
    }
  }

  const distanceMatch = text.match(/[ãƒ€èŠ][\s\u3000]*(\d{1}),?(\d{3})m/);
  const distance = distanceMatch ? parseInt(distanceMatch[1] + distanceMatch[2], 10) : null;

  const surface = text.includes('ãƒ€') ? 'ãƒ€ãƒ¼ãƒˆ' : 'èŠ';

  const trackMatch = text.match(/ï¼ˆ(å¤–|å†…|å³|å·¦)ï¼‰/);
  const track = trackMatch ? trackMatch[1] : null;

  const horsesMatch = text.match(/ï¼ˆ(\d+)é ­ï¼‰/);
  const horses = horsesMatch ? parseInt(horsesMatch[1], 10) : null;

  const startTimeMatch = text.match(/ç™ºèµ°æ™‚åˆ»(\d{1,2}):(\d{2})/);
  const startTime = startTimeMatch ? `${startTimeMatch[1]}:${startTimeMatch[2]}` : null;

  return { raceNumber, raceName, distance, surface, track, horses, startTime };
}

function extractResults(text) {
  const results = [];
  const lines = text.split('\n');

  for (let line of lines) {
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ç€ æ  é¦¬ç•ª é¦¬å æ€§é½¢ è² æ‹… é¦¬ä½“é‡ å¢—æ¸› é¨æ‰‹ èª¿æ•™å¸« ã‚¿ã‚¤ãƒ  ç€å·® ä¸ŠãŒã‚Š3F ã‚³ãƒ¼ãƒŠãƒ¼é€šéé † äººæ°—
    // ä¾‹: 1 5 7 ãƒã‚­ã‚·ãƒãƒ ãƒ‘ãƒ¯ãƒ¼ ç‰¡4 55.0 500kg -1 ç”ºç”°ç›´å¸Œ æ—æ­£äºº 2:28.0 - 39.3 - 1
    const match = line.match(/^(\d+)[\s\u3000]+(\d+)[\s\u3000]+(\d+)[\s\u3000]+(.+?)[\s\u3000]+[ç‰¡ç‰ã‚»]\d+[\s\u3000]+([\d.]+)[\s\u3000]+(\d+)kg[\s\u3000]+([+-Â±ï¼‹ï¼]?\d*)[\s\u3000]+(.+?)[\s\u3000]+(.+?)[\s\u3000]+([\d:.]+)[\s\u3000]+(.*?)[\s\u3000]+([\d.]+)[\s\u3000]+(.*)[\s\u3000]+(\d+)\s*$/);

    if (match) {
      results.push({
        rank: parseInt(match[1], 10),
        bracket: parseInt(match[2], 10),
        number: parseInt(match[3], 10),
        name: match[4].trim(),
        jockey: match[8].trim(),
        trainer: match[9].trim(),
        time: match[10].trim(),
        margin: match[11].trim() || '-',
        lastFurlong: match[12].trim(),
        popularity: parseInt(match[14], 10)
      });
    }
  }

  if (results.length === 0) throw new Error('ç€é †ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  return results;
}

function extractPayouts(text) {
  const payouts = {};

  // æ‰•æˆ»é‡‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºï¼ˆæ–‡æœ«ã¾ã§å…¨ã¦å–å¾—ï¼‰
  const payoutMatch = text.match(/æ‰•æˆ»é‡‘[\s\S]*$/);
  if (!payoutMatch) return payouts;

  const payoutSection = payoutMatch[0];
  const lines = payoutSection.split('\n').filter(l => l.trim());

  // ç¬¬1ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šå˜å‹ã€œé¦¬å˜ï¼ˆæ¨ªä¸¦ã³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  let table1HeaderIndex = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('å˜å‹') && lines[i].includes('é¦¬å˜')) {
      table1HeaderIndex = i;
      break;
    }
  }

  if (table1HeaderIndex > -1) {
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’åé›†ï¼ˆè¤‡å‹ã¯3è¡Œã€ä»–ã¯1è¡Œï¼‰
    const dataRows = [];
    for (let i = table1HeaderIndex + 1; i < lines.length; i++) {
      const line = lines[i];
      if (/^[\d-]/.test(line) && !line.includes('çµ„ç•ª')) {
        dataRows.push(line);
      } else if (dataRows.length > 0) {
        break; // ãƒ‡ãƒ¼ã‚¿è¡ŒãŒçµ‚ã‚ã£ãŸã‚‰åœæ­¢
      }
    }

    // 1è¡Œç›®: å˜å‹ã€è¤‡å‹1ã€æ è¤‡ã€æ™®é€šé¦¬è¤‡ã€æ å˜ã€é¦¬å˜
    if (dataRows.length >= 1) {
      const values = dataRows[0].split(/[\s\u3000]+/).filter(v => v);

      // å˜å‹: values[0-2]
      if (values.length >= 3 && values[0] !== '-') {
        payouts.tansho = {
          number: parseInt(values[0], 10),
          payout: parseInt(values[1].replace(/,/g, ''), 10),
          popularity: parseInt(values[2], 10)
        };
      }

      // è¤‡å‹1: values[3-5]
      if (values.length >= 6 && values[3] !== '-') {
        payouts.fukusho = [{
          number: parseInt(values[3], 10),
          payout: parseInt(values[4].replace(/,/g, ''), 10),
          popularity: parseInt(values[5], 10)
        }];
      }

      // æ è¤‡: values[6-8]
      if (values.length >= 9 && values[6] !== '-') {
        payouts.wakufuku = {
          combination: values[6],
          payout: parseInt(values[7].replace(/,/g, ''), 10),
          popularity: parseInt(values[8], 10)
        };
      }

      // æ™®é€šé¦¬è¤‡: values[9-11]
      if (values.length >= 12 && values[9] !== '-') {
        payouts.umaren = {
          combination: values[9],
          payout: parseInt(values[10].replace(/,/g, ''), 10),
          popularity: parseInt(values[11], 10)
        };
      }

      // æ å˜: values[12-14]
      if (values.length >= 15 && values[12] !== '-') {
        payouts.wakutan = {
          combination: values[12],
          payout: parseInt(values[13].replace(/,/g, ''), 10),
          popularity: parseInt(values[14], 10)
        };
      }

      // é¦¬å˜: values[15-17]
      if (values.length >= 18 && values[15] !== '-') {
        payouts.umatan = {
          combination: values[15],
          payout: parseInt(values[16].replace(/,/g, ''), 10),
          popularity: parseInt(values[17], 10)
        };
      }
    }

    // 2è¡Œç›®: è¤‡å‹2
    if (dataRows.length >= 2) {
      const values = dataRows[1].split(/[\s\u3000]+/).filter(v => v);
      if (values.length >= 3 && values[0] !== '-') {
        if (!payouts.fukusho) payouts.fukusho = [];
        payouts.fukusho.push({
          number: parseInt(values[0], 10),
          payout: parseInt(values[1].replace(/,/g, ''), 10),
          popularity: parseInt(values[2], 10)
        });
      }
    }

    // 3è¡Œç›®: è¤‡å‹3
    if (dataRows.length >= 3) {
      const values = dataRows[2].split(/[\s\u3000]+/).filter(v => v);
      if (values.length >= 3 && values[0] !== '-') {
        if (!payouts.fukusho) payouts.fukusho = [];
        payouts.fukusho.push({
          number: parseInt(values[0], 10),
          payout: parseInt(values[1].replace(/,/g, ''), 10),
          popularity: parseInt(values[2], 10)
        });
      }
    }
  }

  // ç¬¬2ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šãƒ¯ã‚¤ãƒ‰ã€ä¸‰é€£è¤‡ã€ä¸‰é€£å˜ï¼ˆæ¨ªä¸¦ã³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  let table2HeaderIndex = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('ãƒ¯ã‚¤ãƒ‰') && lines[i].includes('ä¸‰é€£è¤‡')) {
      table2HeaderIndex = i;
      break;
    }
  }

  if (table2HeaderIndex > -1) {
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’åé›†ï¼ˆãƒ¯ã‚¤ãƒ‰ã¯3è¡Œï¼‰
    const dataRows = [];
    for (let i = table2HeaderIndex + 1; i < lines.length; i++) {
      const line = lines[i];
      if (/^[\d-]/.test(line) && !line.includes('çµ„ç•ª')) {
        dataRows.push(line);
      } else if (dataRows.length > 0) {
        break;
      }
    }

    // 1è¡Œç›®: ãƒ¯ã‚¤ãƒ‰1ã€ä¸‰é€£è¤‡ã€ä¸‰é€£å˜
    if (dataRows.length >= 1) {
      const values = dataRows[0].split(/[\s\u3000]+/).filter(v => v);

      // ãƒ¯ã‚¤ãƒ‰1: values[0-2]
      if (values.length >= 3 && values[0] !== '-') {
        payouts.wide = [{
          combination: values[0],
          payout: parseInt(values[1].replace(/,/g, ''), 10),
          popularity: parseInt(values[2], 10)
        }];
      }

      // ä¸‰é€£è¤‡: values[3-5]
      if (values.length >= 6 && values[3] !== '-') {
        payouts.sanrenpuku = {
          combination: values[3],
          payout: parseInt(values[4].replace(/,/g, ''), 10),
          popularity: parseInt(values[5], 10)
        };
      }

      // ä¸‰é€£å˜: values[6-8]
      if (values.length >= 9 && values[6] !== '-') {
        payouts.sanrentan = {
          combination: values[6],
          payout: parseInt(values[7].replace(/,/g, ''), 10),
          popularity: parseInt(values[8], 10)
        };
      }
    }

    // 2è¡Œç›®: ãƒ¯ã‚¤ãƒ‰2
    if (dataRows.length >= 2) {
      const values = dataRows[1].split(/[\s\u3000]+/).filter(v => v);
      if (values.length >= 3 && values[0] !== '-') {
        if (!payouts.wide) payouts.wide = [];
        payouts.wide.push({
          combination: values[0],
          payout: parseInt(values[1].replace(/,/g, ''), 10),
          popularity: parseInt(values[2], 10)
        });
      }
    }

    // 3è¡Œç›®: ãƒ¯ã‚¤ãƒ‰3
    if (dataRows.length >= 3) {
      const values = dataRows[2].split(/[\s\u3000]+/).filter(v => v);
      if (values.length >= 3 && values[0] !== '-') {
        if (!payouts.wide) payouts.wide = [];
        payouts.wide.push({
          combination: values[0],
          payout: parseInt(values[1].replace(/,/g, ''), 10),
          popularity: parseInt(values[2], 10)
        });
      }
    }
  }

  return payouts;
}

// ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆä¸ŠãŒã‚Š3Fã€ä¸ŠãŒã‚Š4Fã€ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ï¼‰
function extractTimeData(text) {
  const timeData = {};

  // ä¸ŠãŒã‚Š3F
  const last3FMatch = text.match(/ä¸ŠãŒã‚Š3F[\s\u3000]+([\d.]+)/);
  if (last3FMatch) {
    timeData.last3F = parseFloat(last3FMatch[1]);
  }

  // ä¸ŠãŒã‚Š4F
  const last4FMatch = text.match(/ä¸ŠãŒã‚Š4F[\s\u3000]+([\d.]+)/);
  if (last4FMatch) {
    timeData.last4F = parseFloat(last4FMatch[1]);
  }

  // ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã¾ãŸã¯ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šï¼‰
  const furlongMatch = text.match(/ãƒãƒ­ãƒ³ã‚¿ã‚¤ãƒ [\s\u3000]+([\d.,-]+)/);
  if (furlongMatch) {
    const furlongStr = furlongMatch[1];
    // ã‚«ãƒ³ãƒã¾ãŸã¯ãƒã‚¤ãƒ•ãƒ³ã§åˆ†å‰²
    const furlongs = furlongStr.split(/[,-]/).map(f => parseFloat(f.trim())).filter(f => !isNaN(f));
    if (furlongs.length > 0) {
      timeData.furlongTimes = furlongs;
    }
  }

  return Object.keys(timeData).length > 0 ? timeData : null;
}

// ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †æŠ½å‡º
function extractCornerData(text) {
  const corners = [];

  // ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
  const cornerSection = text.match(/ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †[\s\S]*?(?=\n\n|æ‰•æˆ»é‡‘|$)/);
  if (!cornerSection) return null;

  const lines = cornerSection[0].split('\n');

  for (let line of lines) {
    // å„ã‚³ãƒ¼ãƒŠãƒ¼ã®å½¢å¼: "ï¼“è§’    10,4,3,14,13,1,5,9,2,7,6,12,11,8"
    // ã¾ãŸã¯: "ï¼’å‘¨ç›®ï¼“è§’    9,14,10,4,7,13,12,3,5,2,1,11,8,6"
    const cornerMatch = line.match(/(ï¼’å‘¨ç›®)?([ï¼‘ï¼’ï¼“ï¼”])è§’[\s\u3000]+([\d,]+)/);
    if (cornerMatch) {
      const isSecondLap = !!cornerMatch[1];
      const cornerNumber = cornerMatch[2];
      const orderStr = cornerMatch[3];

      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®é¦¬ç•ªå·ã‚’é…åˆ—ã«å¤‰æ›
      const order = orderStr.split(',').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));

      corners.push({
        corner: isSecondLap ? `2å‘¨ç›®${cornerNumber}è§’` : `${cornerNumber}è§’`,
        order
      });
    }
  }

  return corners.length > 0 ? corners : null;
}

// ãƒ¬ãƒ¼ã‚¹è§£èª¬è‡ªå‹•ç”Ÿæˆé–¢æ•°ï¼ˆSEOæœ€é©åŒ–ãƒ»ç«¶é¦¬ç”¨èªä½¿ç”¨ï¼‰
function generateRaceCommentary(race) {
  if (!race.results || race.results.length === 0) return '';

  const winner = race.results[0];
  const second = race.results[1];
  const third = race.results[2];
  const favorite = race.results.find(h => h.popularity === 1);

  // é€ƒã’é¦¬ã‚’ç‰¹å®šï¼ˆã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ã®æœ€åˆã®é¦¬ï¼‰
  let escapeHorse = null;
  if (race.cornerData && race.cornerData.length > 0) {
    const firstCorner = race.cornerData[0];
    const escapeNumber = firstCorner.order[0];
    escapeHorse = race.results.find(h => h.number === escapeNumber);
  }

  // é€ƒã’é¦¬ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯3ç€ä»¥å†…ã§æœ€ã‚‚äººæ°—è–„ã®é¦¬ã‚’ä»®å®š
  if (!escapeHorse) {
    const topThree = race.results.slice(0, 3);
    escapeHorse = topThree.reduce((prev, curr) =>
      (curr.popularity > prev.popularity) ? curr : prev
    );
  }

  let commentary = '';

  // é€ƒã’é¦¬ã®æƒ…å ±ï¼ˆå‹ã¡é¦¬ã¨ç•°ãªã‚‹å ´åˆï¼‰
  if (escapeHorse && escapeHorse.number !== winner.number) {
    commentary += `${escapeHorse.number}ç•ª${escapeHorse.name}ãŒå‹¢ã„ã‚ˆããƒãƒŠã‚’åˆ‡ã‚Šã€`;

    // 2å‘¨ç›®ãŒã‚ã‚Œã°è©³ç´°è¿½åŠ 
    if (race.cornerData && race.cornerData.length > 3) {
      const secondLapCorner = race.cornerData.find(c => c.corner.includes('2å‘¨ç›®'));
      if (secondLapCorner) {
        const secondLapLeader = race.results.find(h => h.number === secondLapCorner.order[0]);
        if (secondLapLeader && secondLapLeader.number !== escapeHorse.number) {
          commentary += `2å‘¨ç›®ã‹ã‚‰ã¯${secondLapLeader.popularity}ç•ªäººæ°—ã®${secondLapLeader.number}ç•ª${secondLapLeader.name}ãŒå…ˆé ­ã«ç«‹ã¡ã€`;
        }
      }
    }
  }

  // ç€å·®ã®è¡¨ç¾ã‚’å¤‰æ›
  function getMarginText(margin) {
    if (!margin || margin === '-') return '';
    if (margin === 'ã‚¯ãƒ“' || margin === 'ãƒãƒŠ' || margin === 'ã‚¢ã‚¿ãƒ') return margin + 'å·®';
    return margin;
  }

  // å‹ã¡é¦¬ã®æƒ…å ±
  if (winner.popularity === 1) {
    commentary += `1ç•ªäººæ°—${winner.number}ç•ª${winner.name}ãŒ`;

    // ã‚´ãƒ¼ãƒ«å¯¸å‰ã®æ”»é˜²
    if (second && second.number !== winner.number) {
      const marginText = getMarginText(winner.margin);
      if (marginText === 'ã‚¯ãƒ“å·®' || marginText === 'ãƒãƒŠå·®' || marginText === 'ã‚¢ã‚¿ãƒå·®') {
        commentary += `ã‚´ãƒ¼ãƒ«å¯¸å‰ã§${second.number}ç•ª${second.name}ã‚’${marginText}ã§å·®ã—åˆ‡ã‚Š`;
      } else {
        commentary += `ç›´ç·šã§${second.number}ç•ª${second.name}ã‚’æ•ã‚‰ãˆã¦`;
      }
    }
    commentary += `å„ªå‹ã€‚`;

    // ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿
    if (race.timeData?.last3F) {
      commentary += `ä¸ŠãŒã‚Š3ãƒãƒ­ãƒ³${race.timeData.last3F}ã®è„šã‚’ä½¿ã„ã€`;
    }
    commentary += `å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}ã§å¿«å‹ã€‚`;

  } else {
    // æ³¢ä¹±æ±ºç€ã®å ´åˆ
    const marginText = getMarginText(winner.margin);

    if (marginText === 'ã‚¯ãƒ“å·®' || marginText === 'ãƒãƒŠå·®' || marginText === 'ã‚¢ã‚¿ãƒå·®') {
      commentary += `ã‚´ãƒ¼ãƒ«å¯¸å‰ã§${winner.popularity}ç•ªäººæ°—ã®${winner.number}ç•ª${winner.name}ãŒ`;
      if (second) {
        commentary += `${marginText}ã§å·®ã—åˆ‡ã‚Šå‹ã¡`;
      }
    } else {
      commentary += `${winner.popularity}ç•ªäººæ°—ã®${winner.number}ç•ª${winner.name}ãŒè¿½ã„è¾¼ã¿ã‹ã‚‰`;
    }

    // ä¸ŠãŒã‚Š3Fæƒ…å ±
    if (race.timeData?.last3F) {
      commentary += `ã€ä¸ŠãŒã‚Š3ãƒãƒ­ãƒ³${race.timeData.last3F}`;
    }

    commentary += ` å‹ã¡ã‚¿ã‚¤ãƒ ${winner.time}`;

    // 1ç•ªäººæ°—ã®æƒ…å ±ã‚’å¿…ãšå«ã‚ã‚‹
    if (favorite && favorite.number !== winner.number) {
      if (favorite.rank <= 3) {
        commentary += `ã€1ç•ªäººæ°—${favorite.number}ç•ª${favorite.name}ã¯${favorite.rank}ç€`;
      } else {
        commentary += `ã€1ç•ªäººæ°—${favorite.number}ç•ª${favorite.name}ã¯${favorite.rank}ç€ã«æ•—ã‚ŒãŸ`;
      }
    }

    commentary += `ã€‚æ³¢ä¹±ã®æ±ºç€ã¨ãªã£ãŸã€‚`;
  }

  // é…å½“æƒ…å ±ï¼ˆé«˜é…å½“ã¯å¼·èª¿ï¼‰
  if (race.payouts?.sanrentan) {
    const payout = race.payouts.sanrentan.payout;
    if (payout >= 50000) {
      commentary += `ä¸‰é€£å˜ã®æ‰•ã„æˆ»ã—ã¯${payout.toLocaleString()}å††ã®è¶…é«˜é…å½“ï¼`;
    } else if (payout >= 10000) {
      commentary += `ä¸‰é€£å˜ã®æ‰•ã„æˆ»ã—ã¯${payout.toLocaleString()}å††ã®é«˜é…å½“ã€‚`;
    } else {
      commentary += `ä¸‰é€£å˜ã¯${payout.toLocaleString()}å††ã€‚`;
    }
  } else if (race.payouts?.tansho) {
    const payout = race.payouts.tansho.payout;
    if (payout >= 5000) {
      commentary += `å˜å‹${payout.toLocaleString()}å††ã®é«˜é…å½“ã€‚`;
    } else {
      commentary += `å˜å‹${payout.toLocaleString()}å††ã€‚`;
    }
  }

  return commentary;
}

// äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
async function fetchPredictionData(date) {
  try {
    const [year, month] = date.split('-');
    const predUrl = `https://raw.githubusercontent.com/apol0510/keiba-data-shared/main/nankan/predictions/${year}/${month}/${date}.json`;
    const response = await fetch(predUrl);
    if (!response.ok) return null;
    return await response.json();
  } catch (error) {
    return null;
  }
}

// è³¼å…¥ç‚¹æ•°è¨ˆç®—é–¢æ•°ï¼ˆå‡ºèµ°é ­æ•°ã‹ã‚‰ï¼‰
function calculatePoints(horses) {
  if (!horses) return 10;
  if (horses <= 6) return 8;
  if (horses <= 9) return 9;
  if (horses <= 12) return 10;
  if (horses <= 14) return 11;
  if (horses <= 16) return 12;
  return 12;
}

// çš„ä¸­åˆ¤å®šé–¢æ•°ï¼ˆé¦¬å˜main/subåˆ¤å®šï¼‰
function checkHit(prediction, result) {
  if (!prediction || !result) return { hit: false, hitType: null, payout: 0 };

  const umatanCombo = result.payouts?.umatan?.combination;
  if (!umatanCombo) return { hit: false, hitType: null, payout: 0 };

  // mainçš„ä¸­åˆ¤å®š
  if (prediction.bettingLines?.umatan?.main?.includes(umatanCombo)) {
    return {
      hit: true,
      hitType: 'main',
      payout: result.payouts.umatan.payout || 0
    };
  }

  // subçš„ä¸­åˆ¤å®š
  if (prediction.bettingLines?.umatan?.sub?.includes(umatanCombo)) {
    return {
      hit: true,
      hitType: 'sub',
      payout: result.payouts.umatan.payout || 0
    };
  }

  return { hit: false, hitType: null, payout: 0 };
}

// archiveResults.jsonç”Ÿæˆé–¢æ•°
function generateArchiveResults(parsedData, predictionData) {
  const [year, month, day] = parsedData.date.split('-');

  let totalRaces = 0;
  let hitRaces = 0;
  let totalPayout = 0;
  let totalPoints = 0;
  const races = [];

  parsedData.races.forEach(race => {
    totalRaces++;

    // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const prediction = predictionData?.races?.find(p => p.raceNumber === race.raceNumber);

    // è³¼å…¥ç‚¹æ•°è¨ˆç®—
    const betPoints = calculatePoints(race.horses);
    totalPoints += betPoints;

    // çš„ä¸­åˆ¤å®š
    const hitResult = checkHit(prediction, race);

    if (hitResult.hit) {
      hitRaces++;
      totalPayout += hitResult.payout;
    }

    races.push({
      raceNumber: `${race.raceNumber}R`,
      raceName: race.raceName || '-',
      betType: 'é¦¬å˜',
      betPoints: betPoints,
      hit: hitResult.hit,
      hitType: hitResult.hitType,
      payout: hitResult.payout
    });
  });

  const purchaseAmount = totalPoints * 100;
  const recoveryRate = purchaseAmount > 0 ? Math.round((totalPayout / purchaseAmount) * 100) : 0;
  const perfectHit = totalRaces > 0 && hitRaces === totalRaces;

  return {
    [year]: {
      [month]: {
        [day]: {
          venue: parsedData.venue,
          totalRaces: totalRaces,
          hitRaces: hitRaces,
          perfectHit: perfectHit,
          totalPayout: totalPayout,
          recoveryRate: recoveryRate,
          races: races
        }
      }
    }
  };
}
---

<BaseLayout
  title="çµæœç®¡ç†ç”»é¢"
  description="å—é–¢å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸçµæœã‚’è‡ªå‹•è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¾ã™"
>
  <section class="admin-section">
    <div class="container">
      <h1 class="page-title">ğŸ‡ å—é–¢ç«¶é¦¬ çµæœç®¡ç†</h1>
      <p class="page-description">
        å—é–¢å…¬å¼ã‚µã‚¤ãƒˆã®çµæœã‚’å…¨æ–‡ã‚³ãƒ”ãƒšã—ã¦ã€è‡ªå‹•è§£æã—ã¾ã™ã€‚<br>
        <strong>â€» å…¨æ–‡ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼ˆæ—¥ä»˜ãƒ»ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãƒ»ç€é †è¡¨ãƒ»æ‰•æˆ»é‡‘ã™ã¹ã¦ï¼‰</strong>
      </p>

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card form-card">
        <h2>ğŸ“‹ å—é–¢å…¬å¼çµæœã‚’å…¨æ–‡ã‚³ãƒ”ãƒš</h2>
        <form method="POST">
          <div class="form-group">
            <label for="copiedText">ã‚³ãƒ”ãƒšã‚¨ãƒªã‚¢</label>
            <textarea
              id="copiedText"
              name="copiedText"
              rows="20"
              required
              class="form-textarea"
              placeholder="2026å¹´1æœˆ23æ—¥ ç¬¬10å› èˆ¹æ©‹ç«¶é¦¬ ç¬¬5æ—¥ ãƒ€2,200mï¼ˆå¤–ï¼‰ ï¼ˆ14é ­ï¼‰ ç™ºèµ°æ™‚åˆ»20:50
ã‚¬ãƒ¼ãƒãƒƒãƒˆï¼’ï¼’ï¼ï¼ ï¼¢ï¼’ï¼¢ï¼“ é¸æŠœé¦¬
ç€    æ     é¦¬ç•ª    é¦¬å    æ€§é½¢    è² æ‹…    é¦¬ä½“é‡    å¢—æ¸›    é¨æ‰‹    èª¿æ•™å¸«    ã‚¿ã‚¤ãƒ     ç€å·®    ä¸ŠãŒã‚Š3F    ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †    äººæ°—
1    5    7    ãƒã‚­ã‚·ãƒãƒ ãƒ‘ãƒ¯ãƒ¼    ç‰¡4    55.0    500kg    -1    ç”ºç”°ç›´å¸Œ    æ—æ­£äºº    2:28.0    -    39.3    -    1
2    6    9    ãƒ’ãƒ­ã‚·ã‚²ã‚¸ãƒ£ãƒƒã‚¯    ç‰¡7    57.0    528kg    ï¼‹6    ç¬ é‡é›„å¤§    å±±ä¸­å°Šå¾³    2:28.1    ã‚¯ãƒ“    40.1    -    11
...
ï¼ˆå…¨æ–‡ã‚³ãƒ”ãƒ¼ï¼‰"
            ></textarea>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-full">
            ğŸ” è‡ªå‹•è§£æ
          </button>
        </form>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      {errorMessage && (
        <div class="card error-card">
          <h3>âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <p>{errorMessage}</p>
          <p class="error-hint">
            <strong>è§£æ±ºæ–¹æ³•:</strong><br>
            âœ… æ—¥ä»˜è¡Œã‹ã‚‰æ‰•æˆ»é‡‘ã¾ã§å…¨æ–‡ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„<br>
            âœ… ã€Œ2026å¹´1æœˆ23æ—¥ã€ã®å½¢å¼ã§æ—¥ä»˜ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª<br>
            âœ… ã€Œèˆ¹æ©‹ç«¶é¦¬ã€ã€Œå¤§äº•ç«¶é¦¬ã€ã€Œå·å´ç«¶é¦¬ã€ã€Œæµ¦å’Œç«¶é¦¬ã€ã®ã„ãšã‚Œã‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          </p>
        </div>
      )}

      <!-- çµæœè¡¨ç¤º -->
      {result && (
        <div class="results-section">
          <div class="race-card card">
            <h2 class="section-title">âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</h2>

            <!-- ãƒ¬ãƒ¼ã‚¹æƒ…å ± -->
            <div class="race-info-summary">
              <h3>ğŸ“… ãƒ¬ãƒ¼ã‚¹æƒ…å ±</h3>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">æ—¥ä»˜:</span>
                  <span class="info-value">{result.parsedData.date}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ç«¶é¦¬å ´:</span>
                  <span class="info-value">{result.parsedData.venue}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ãƒ¬ãƒ¼ã‚¹:</span>
                  <span class="info-value">
                    ç¬¬{result.parsedData.races[0].raceNumber}R {result.parsedData.races[0].raceName}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">è·é›¢:</span>
                  <span class="info-value">
                    {result.parsedData.races[0].surface}{result.parsedData.races[0].distance}m
                    {result.parsedData.races[0].track && `ï¼ˆ${result.parsedData.races[0].track}ï¼‰`}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">é ­æ•°:</span>
                  <span class="info-value">{result.parsedData.races[0].horses}é ­</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ç™ºèµ°:</span>
                  <span class="info-value">{result.parsedData.races[0].startTime}</span>
                </div>
              </div>
            </div>

            <!-- ãƒ¬ãƒ¼ã‚¹è§£èª¬ -->
            {result.parsedData.races[0].commentary && (
              <div class="commentary-display">
                <h3>ğŸ“ ãƒ¬ãƒ¼ã‚¹è§£èª¬ï¼ˆè‡ªå‹•ç”Ÿæˆãƒ»SEOæœ€é©åŒ–ï¼‰</h3>
                <p class="commentary-text">{result.parsedData.races[0].commentary}</p>
              </div>
            )}

            <!-- ç€é †è¡¨ç¤º -->
            <div class="results-display">
              <h3>ğŸ ç€é †</h3>
              <div class="results-table">
                <div class="table-header">
                  <span>ç€é †</span>
                  <span>æ </span>
                  <span>é¦¬ç•ª</span>
                  <span>é¦¬å</span>
                  <span>é¨æ‰‹</span>
                  <span>ã‚¿ã‚¤ãƒ </span>
                  <span>äººæ°—</span>
                </div>
                {result.parsedData.races[0].results.map((horse) => (
                  <div class={`table-row rank-${horse.rank}`}>
                    <span class="rank">{horse.rank}ç€</span>
                    <span>{horse.bracket}</span>
                    <span class="horse-number">{horse.number}</span>
                    <span class="horse-name">{horse.name}</span>
                    <span>{horse.jockey}</span>
                    <span>{horse.time}</span>
                    <span>{horse.popularity}äººæ°—</span>
                  </div>
                ))}
              </div>
            </div>

            <!-- æ‰•æˆ»é‡‘è¡¨ç¤º -->
            <div class="payouts-display">
              <h3>ğŸ’° æ‰•æˆ»é‡‘</h3>
              <div class="payouts-grid">
                {result.parsedData.races[0].payouts.tansho && (
                  <div class="payout-item">
                    <span class="payout-type">å˜å‹</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.tansho.number}ç•ª</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.tansho.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.fukusho && result.parsedData.races[0].payouts.fukusho.map((fukusho) => (
                  <div class="payout-item">
                    <span class="payout-type">è¤‡å‹</span>
                    <span class="payout-combo">{fukusho.number}ç•ª</span>
                    <span class="payout-value">{fukusho.payout.toLocaleString()}å††</span>
                  </div>
                ))}
                {result.parsedData.races[0].payouts.wakufuku && (
                  <div class="payout-item">
                    <span class="payout-type">æ è¤‡</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.wakufuku.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.wakufuku.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.umaren && (
                  <div class="payout-item">
                    <span class="payout-type">é¦¬è¤‡</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.umaren.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.umaren.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.wakutan && (
                  <div class="payout-item">
                    <span class="payout-type">æ å˜</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.wakutan.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.wakutan.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.umatan && (
                  <div class="payout-item">
                    <span class="payout-type">é¦¬å˜</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.umatan.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.umatan.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.wide && result.parsedData.races[0].payouts.wide.map((wide) => (
                  <div class="payout-item">
                    <span class="payout-type">ãƒ¯ã‚¤ãƒ‰</span>
                    <span class="payout-combo">{wide.combination}</span>
                    <span class="payout-value">{wide.payout.toLocaleString()}å††</span>
                  </div>
                ))}
                {result.parsedData.races[0].payouts.sanrenpuku && (
                  <div class="payout-item">
                    <span class="payout-type">ä¸‰é€£è¤‡</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.sanrenpuku.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.sanrenpuku.payout.toLocaleString()}å††</span>
                  </div>
                )}
                {result.parsedData.races[0].payouts.sanrentan && (
                  <div class="payout-item">
                    <span class="payout-type">ä¸‰é€£å˜</span>
                    <span class="payout-combo">{result.parsedData.races[0].payouts.sanrentan.combination}</span>
                    <span class="payout-value">{result.parsedData.races[0].payouts.sanrentan.payout.toLocaleString()}å††</span>
                  </div>
                )}
              </div>
            </div>

            <!-- JSONå‡ºåŠ› -->
            <div class="json-output">
              <h3>JSONå‡ºåŠ›</h3>
              <textarea
                readonly
                rows="20"
                class="json-textarea"
              >{result.json}</textarea>
              <textarea
                readonly
                style="display: none;"
                class="archive-json-textarea"
              >{result.archiveJson}</textarea>
              <div class="button-group">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="navigator.clipboard.writeText(document.querySelector('.json-textarea').value).then(() => alert('JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))"
                >
                  ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button
                  type="button"
                  id="saveToGitBtn"
                  class="btn btn-primary"
                  onclick="saveToKeibaDataShared()"
                >
                  ğŸš€ ä¿å­˜ã—ã¦Git Push
                </button>
              </div>
              <div id="saveStatus" class="save-status" style="display: none;"></div>
              <p class="save-hint">
                <strong>ã€ŒğŸš€ ä¿å­˜ã—ã¦Git Pushã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨:</strong><br>
                1. è‡ªå‹•çš„ã« keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜<br>
                2. Git ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ãŒè‡ªå‹•å®Ÿè¡Œ<br>
                3. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å³åº§ã«åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ ğŸ‰
              </p>
            </div>
          </div>
        </div>
      )}

      <!-- ä½¿ç”¨æ–¹æ³• -->
      <div class="card info-card">
        <h2>ä½¿ç”¨æ–¹æ³•</h2>
        <ol>
          <li><strong>å—é–¢å…¬å¼ã‚µã‚¤ãƒˆ</strong>ã§çµæœãƒšãƒ¼ã‚¸ã‚’é–‹ã</li>
          <li>æ—¥ä»˜è¡Œã‹ã‚‰æ‰•æˆ»é‡‘ã¾ã§<strong>å…¨æ–‡é¸æŠãƒ»ã‚³ãƒ”ãƒ¼</strong></li>
          <li>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã«<strong>ãƒšãƒ¼ã‚¹ãƒˆ</strong></li>
          <li>ã€Œè‡ªå‹•è§£æã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèª</li>
          <li>JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦<code>keiba-data-shared</code>ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜</li>
          <li>Git ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã§å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±æœ‰å®Œäº† ğŸ‰</li>
        </ol>

        <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
        <ul>
          <li>å¿…ãš<strong>å…¨æ–‡ã‚³ãƒ”ãƒ¼</strong>ã—ã¦ãã ã•ã„ï¼ˆéƒ¨åˆ†ã‚³ãƒ”ãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼‰</li>
          <li>æ—¥ä»˜ãƒ»ç«¶é¦¬å ´ãƒ»ãƒ¬ãƒ¼ã‚¹ç•ªå·ãƒ»ç€é †è¡¨ãƒ»æ‰•æˆ»é‡‘ãŒã™ã¹ã¦å«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    .admin-section {
      padding: var(--spacing-2xl) 0;
      min-height: 100vh;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }

    .page-description {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-2xl);
    }

    .form-card {
      max-width: 1000px;
      margin: 0 auto var(--spacing-xl);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .form-textarea {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .error-card {
      max-width: 800px;
      margin: 0 auto var(--spacing-xl);
      border: 2px solid var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .error-hint {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    .results-section {
      margin-top: var(--spacing-2xl);
    }

    .race-card {
      max-width: 1200px;
      margin: 0 auto;
    }

    .section-title {
      font-size: 1.75rem;
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    .race-info-summary {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .commentary-display {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
      border-left: 4px solid var(--primary-end);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .commentary-display h3 {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-md);
      color: var(--primary-end);
    }

    .commentary-text {
      line-height: 1.8;
      color: var(--text-primary);
      font-size: 1.05rem;
      letter-spacing: 0.02em;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .info-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .info-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .results-display,
    .payouts-display {
      margin-bottom: var(--spacing-xl);
    }

    .results-display h3,
    .payouts-display h3 {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-md);
    }

    .results-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .table-header,
    .table-row {
      display: grid;
      grid-template-columns: 60px 40px 60px 1fr 120px 100px 60px;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      align-items: center;
    }

    .table-header {
      font-weight: 700;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    .table-row {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .table-row.rank-1 {
      border-left: 4px solid #fbbf24;
    }

    .table-row.rank-2 {
      border-left: 4px solid #9ca3af;
    }

    .table-row.rank-3 {
      border-left: 4px solid #cd7f32;
    }

    .rank {
      font-weight: 700;
    }

    .horse-number {
      font-weight: 700;
      color: var(--primary-end);
    }

    .horse-name {
      font-weight: 600;
    }

    .payouts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-md);
    }

    .payout-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
    }

    .payout-type {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .payout-combo {
      font-size: 1.125rem;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .payout-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success);
    }

    .json-output {
      margin-top: var(--spacing-xl);
    }

    .json-textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }

    .save-hint {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
    }

    .save-hint code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
    }

    .info-card {
      max-width: 1200px;
      margin: var(--spacing-xl) auto 0;
    }

    .info-card ol,
    .info-card ul {
      margin-left: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .info-card li {
      margin-bottom: var(--spacing-sm);
    }

    .info-card code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
    }

    .w-full {
      width: 100%;
    }

    .mt-2 {
      margin-top: var(--spacing-md);
    }

    .button-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .button-group .btn {
      flex: 1;
    }

    .save-status {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
    }

    .save-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }

    .save-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }

    .save-status.loading {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-end);
      color: var(--primary-end);
    }
  </style>

  <script is:inline>
    async function saveToKeibaDataShared() {
      const btn = document.getElementById('saveToGitBtn');
      const statusDiv = document.getElementById('saveStatus');
      const jsonTextarea = document.querySelector('.json-textarea');
      const archiveJsonTextarea = document.querySelector('.archive-json-textarea');

      if (!jsonTextarea) {
        alert('JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const resultsJSON = jsonTextarea.value;
      const archiveResultsJSON = archiveJsonTextarea ? archiveJsonTextarea.value : null;

      // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
      btn.disabled = true;
      btn.textContent = 'â³ ä¿å­˜ä¸­...';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      statusDiv.style.display = 'block';
      statusDiv.className = 'save-status loading';
      statusDiv.textContent = 'ğŸš€ keiba-data-shared ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ä¸­...';

      try {
        // Netlify Functionã‚’å‘¼ã³å‡ºã—
        const response = await fetch('/.netlify/functions/save-results', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            resultsJSON,
            archiveResultsJSON
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // æˆåŠŸ
          statusDiv.className = 'save-status success';
          statusDiv.innerHTML = `
            âœ… ${data.message}<br>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ${data.filePath}<br>
            <strong>ãƒªãƒã‚¸ãƒˆãƒª:</strong> <a href="${data.repoUrl}" target="_blank">${data.repoUrl}</a><br>
            <strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> <a href="${data.commitUrl}" target="_blank">GitHubã§ç¢ºèª</a><br>
            <strong>Raw URL:</strong> <a href="${data.rawUrl}" target="_blank">ãƒ‡ãƒ¼ã‚¿URL</a>
          `;
          btn.textContent = 'âœ… ä¿å­˜å®Œäº†';
        } else {
          // ã‚¨ãƒ©ãƒ¼
          statusDiv.className = 'save-status error';
          statusDiv.innerHTML = `
            âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'}<br>
            ${data.hint ? `<strong>ãƒ’ãƒ³ãƒˆ:</strong> ${data.hint}` : ''}
          `;
          btn.disabled = false;
          btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
        }
      } catch (error) {
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
        statusDiv.className = 'save-status error';
        statusDiv.innerHTML = `
          âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}<br>
          <strong>å¯¾å‡¦æ³•:</strong> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„
        `;
        btn.disabled = false;
        btn.textContent = 'ğŸš€ ä¿å­˜ã—ã¦Git Push';
      }
    }
  </script>
</BaseLayout>
